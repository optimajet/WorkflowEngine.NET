function WorkflowDesigner(e){var t=this;this.Settings=e,window.localStorage||WorkflowDesignerCommon.defineLocalStorage(),this.GetName=function(){return t.Settings.name},this.error=function(e){alert(e)},this.refresh=function(){var e=void 0!==this.data&&void 0!==this.data.__loadParams?this.data.__loadParams:this.loadParams;void 0===e?alert("You might use refresh method after called load method only."):this.load(e)},this.getParam=function(e){return localStorage["WorkflowDesigner_"+e]},this.setParam=function(e,t){var i="WorkflowDesigner_"+e;localStorage[i]=t},this.load=function(e){var i=new Array;this.loadParams=e,this.schemecode=e.schemecode,this.processid=e.processid,this.schemeid=e.schemeid,e.readonly&&(this.Settings.readonly=e.readonly),i.push({name:"schemecode",value:this.schemecode}),i.push({name:"processid",value:this.processid}),i.push({name:"schemeid",value:this.schemeid}),i.push({name:"operation",value:"load"});$.ajax({url:this.Settings.apiurl,data:i,async:!0,success:function(i){var n={};try{n=JSON.parse(i)}catch(e){return void t.error(i)}return n.isError?void t.error(n.errorMessage):(n.__loadParams=e,t.data=n,void t.render())},error:function(e,i,n){t.error(i+" "+n)}})},this.exists=function(e){var i=new Array;this.schemecode=e.schemecode,this.processid=e.processid,this.schemeid=e.schemeid,e.readonly&&(this.Settings.readonly=e.readonly),i.push({name:"schemecode",value:this.schemecode}),i.push({name:"processid",value:this.processid}),i.push({name:"schemeid",value:this.schemeid}),i.push({name:"operation",value:"exists"});var n=$.ajax({url:this.Settings.apiurl,data:i,async:!1,error:function(e,i,n){t.error(i+" "+n)}}).responseText;try{return JSON.parse(n)}catch(e){return t.error(n),!1}},this.create=function(){var e=new Array;e.push({name:"operation",value:"load"});$.ajax({url:this.Settings.apiurl,data:e,async:!0,success:function(e){try{t.data=JSON.parse(e)}catch(i){t.error(e)}t.render()}})},this.render=function(){var e=!1;t.Graph&&(t.Graph.destroy(),void 0!=t.data&&void 0!=t.data.__loadParams&&(void 0!=t.data.__loadParams.isFullScreen&&(e=t.data.__loadParams.isFullScreen),void 0!=t.data.__loadParams.readonly&&(this.Settings.readonly=t.data.__loadParams.readonly)));var i=[WorkflowDesignerActivityManager,WorkflowDesignerTransitionManager];if(this.Settings.printable||i.push(WorkflowDesignerBackground),this.Settings.notrendertoolbar||i.push(WorkflowDesignerToolbar),t.Settings.printable&&void 0!=t.data){var n=0,o=0;$(t.data.Activities).each(function(e){var t=parseInt(this.DesignerSettings.X),i=parseInt(this.DesignerSettings.Y);t>n&&(n=t),i>o&&(o=i)}),t.Settings.graphwidth=n+t.Settings.DefaultActivityWidth,t.Settings.graphheight=o+t.Settings.DefaultActivityHeight}t.Graph=new WorkflowGraph(this.Settings.renderTo,t,t.Settings,i),t.Graph.setFullScreen(e),void 0!=t.data&&(WorkflowDesignerCommon.DataCorrection(t.data),void 0!=t.data.__loadParams&&void 0!=t.data.__loadParams.graphData&&(t.Graph.graphData=t.data.__loadParams.graphData,t.Graph.graphDataIndex=t.data.__loadParams.graphDataIndex),t.Graph.Draw(t.data))},this.save=function(e){if(t.Settings.readonly)return void alert(WorkflowDesignerConstants.ErrorReadOnlySaveText);var i=new Array;i.push({name:"schemecode",value:this.schemecode}),i.push({name:"processid",value:this.processid}),i.push({name:"schemeid",value:this.schemeid}),i.push({name:"operation",value:"save"}),i.push({name:"data",value:JSON.stringify(this.data)});$.ajax({url:this.Settings.apiurl,data:i,async:!0,type:"post",success:function(i){var n={};try{n=JSON.parse(i)}catch(e){return void t.error(i)}return n.isError?void t.error(n.errorMessage):(t.data=n,t.render(),void(e&&setTimeout(function(){e(t)},100)))}})},this.downloadscheme=function(e){var t=new Array;t.push({name:"operation",value:"downloadscheme"}),t.push({name:"data",value:JSON.stringify(this.data)}),WorkflowDesignerCommon.download(this.Settings.apiurl,t,"post")},this.uploadscheme=function(e,i){var n=this.GetName()+"_uploadiframe",o=document.createElement("iframe");o.setAttribute("id",n),o.setAttribute("name",n),o.setAttribute("width","0"),o.setAttribute("height","0"),o.setAttribute("border","0"),o.setAttribute("style","width: 0; height: 0; border: none;"),e.parentNode.appendChild(o),window.frames[n].name=n;var a=document.getElementById(n),r=function(){a.detachEvent?a.detachEvent("onload",r):a.removeEventListener("load",r,!1),a.contentDocument?content=a.contentDocument.body.innerText:a.contentWindow?content=a.contentWindow.document.body.innerHTML:a.document&&(content=a.document.body.innerHTML),setTimeout(function(){a.parentNode.removeChild(a)},250);var e={};try{e=JSON.parse(content)}catch(e){return void t.error(content)}return e.isError?void t.error(e.errorMessage):(t.data=e,t.render(),void(i&&i(t)))};a.addEventListener&&a.addEventListener("load",r,!0),a.attachEvent&&a.attachEvent("onload",r),e.setAttribute("target",n),e.setAttribute("action",this.createurl("uploadscheme")),e.setAttribute("method","post"),e.setAttribute("enctype","multipart/form-data"),e.setAttribute("encoding","multipart/form-data"),e.submit()},this.createurl=function(e){var t=this.Settings.apiurl,i="?";return t.indexOf("?")>=0&&(i="&"),t+=i+"operation="+e,i="&",void 0!=this.schemeid&&(t+=i+"schemeid="+this.schemeid),void 0!=this.processid&&(t+=i+"processid="+this.processid),void 0!=this.schemecode&&(t+=i+"schemecode="+this.schemecode),t},this.validate=function(){var e=void 0,i=$.grep(t.data.Activities,function(e){return 1==e.IsInitial});return 1!=i.length&&(e=WorkflowDesignerConstants.ErrorActivityIsInitialCountText),e},this.destroy=function(){this.schemecode=void 0,this.processid=void 0,this.schemeid=void 0,this.data=void 0,this.Graph.destroy()},this.compile=function(e,i){e={Name:e.Name,Type:e.Type,IsGlobal:e.IsGlobal,IsAsync:e.IsAsync,ActionCode:e.ActionCode,Usings:e.Usings};var n=new Array;n.push({name:"schemecode",value:this.schemecode}),n.push({name:"processid",value:this.processid}),n.push({name:"schemeid",value:this.schemeid}),n.push({name:"operation",value:"compile"}),n.push({name:"data",value:JSON.stringify(e)});$.ajax({url:this.Settings.apiurl,data:n,async:!0,type:"post",success:function(e){try{e=JSON.parse(e)}catch(i){t.error(e)}i&&setTimeout(function(){i(e)},100)}})},this.deleteGlobalCodeAction=function(e,i){var n=new Array;n.push({name:"operation",value:"deleteglobalcodeaction"}),n.push({name:"names",value:JSON.stringify(e)});$.ajax({url:this.Settings.apiurl,data:n,async:!0,type:"post",success:function(e){try{e=JSON.parse(e)}catch(i){t.error(e)}i&&setTimeout(function(){i(e)},100)}})},this.getemptytype=function(e,t){var i=new Array;i.push({name:"operation",value:"getemptytype"}),i.push({name:"data",value:JSON.stringify(e)});$.ajax({url:this.Settings.apiurl,data:i,async:!0,type:"post",success:function(e){t&&setTimeout(function(){t(e)},100)}})},this.requestautocompletesuggestions=function(e,t){var i=new Array;i.push({name:"operation",value:"getautocompletesuggestions"}),i.push({name:"category",value:e}),i.push({name:"value",value:t});var n=$.ajax({url:this.Settings.apiurl,data:i,async:!1,type:"post"});return JSON.parse(n.responseText)},this.readonlymode=function(e){var t=this;void 0===e||null==e?(t.Settings.notrendertoolbar=!1,t.Settings.notshowwindows=!1,t.Settings.disableobjectmovements=!1):(void 0!=e.notrendertoolbar?t.Settings.notrendertoolbar=e.notrendertoolbar:t.Settings.notrendertoolbar=!1,void 0!=e.notshowwindows?t.Settings.notshowwindows=e.notshowwindows:t.Settings.notshowwindows=!1,void 0!=e.disableobjectmovements?t.Settings.disableobjectmovements=e.disableobjectmovements:t.Settings.disableobjectmovements=!1),t.Settings.readonly=!0,t.Settings.printable&&(t.Settings.graphheight=t.Settings.originalgraphheighth,t.Settings.graphwidth=t.Settings.originalgraphwidth,t.Settings.printable=!1),t.render()},this.printablemode=function(){var e=this;e.Settings.printable||(e.Settings.originalgraphheighth=e.Settings.graphheight,e.Settings.originalgraphwidth=e.Settings.graphwidth),e.Settings.notrendertoolbar=!0,e.Settings.notshowwindows=!0,e.Settings.disableobjectmovements=!1,e.Settings.readonly=!0,e.Settings.printable=!0,e.render()},this.editablemode=function(){var e=this;e.Settings.notrendertoolbar=!1,e.Settings.notshowwindows=!1,e.Settings.disableobjectmovements=!1,e.Settings.readonly=!1,e.Settings.printable&&(e.Settings.graphheight=e.Settings.originalgraphheighth,e.Settings.graphwidth=e.Settings.originalgraphwidth,e.Settings.printable=!1),e.render()},void 0!=e.notrendertoolbar&&(this.Settings.notrendertoolbar=e.notrendertoolbar),void 0!=e.notshowwindows&&(this.Settings.notshowwindows=e.notshowwindows),void 0!=e.disableobjectmovements&&(this.Settings.disableobjectmovements=e.disableobjectmovements),void 0===this.Settings.mode?this.editablemode():"readonly"===this.Settings.mode.toLowerCase()?this.readonlymode(e):"printable"===this.Settings.mode.toLowerCase()?this.printablemode():this.editablemode(),this.autoarrangement=function(){var e=this.Graph.GetComponentByType("WorkflowDesignerToolbar");void 0!=e&&e.AutoArrangement()},this.downloadschemeBPMN=function(e){var t=new Array;t.push({name:"operation",value:"downloadschemebpmn"}),t.push({name:"data",value:JSON.stringify(this.data)}),WorkflowDesignerCommon.download(this.Settings.apiurl,t,"post")},this.uploadschemeBPMN=function(e,i){var n=this.GetName()+"_uploadiframe",o=document.createElement("iframe");o.setAttribute("id",n),o.setAttribute("name",n),o.setAttribute("width","0"),o.setAttribute("height","0"),o.setAttribute("border","0"),o.setAttribute("style","width: 0; height: 0; border: none;"),e.parentNode.appendChild(o),window.frames[n].name=n;var a=document.getElementById(n),r=function(){a.detachEvent?a.detachEvent("onload",r):a.removeEventListener("load",r,!1),a.contentDocument?content=a.contentDocument.body.innerText:a.contentWindow?content=a.contentWindow.document.body.innerHTML:a.document&&(content=a.document.body.innerHTML),setTimeout(function(){a.parentNode.removeChild(a)},250);var e={};try{e=JSON.parse(content)}catch(e){return void t.error(content)}return e.isError?void t.error(e.errorMessage):(t.data=e,t.render(),void(i&&i(t)))};a.addEventListener&&a.addEventListener("load",r,!0),a.attachEvent&&a.attachEvent("onload",r),e.setAttribute("target",n),e.setAttribute("action",this.createurl("uploadschemebpmn")),e.setAttribute("method","post"),e.setAttribute("enctype","multipart/form-data"),e.setAttribute("encoding","multipart/form-data"),e.submit()}}function WorkflowDesignerOverviewMap(){this.type="WorkflowDesignerOverviewMap";var e=this;this.init=function(t){this.graph=t,this.Layer=new Konva.Layer,this.Layer.scale(.5),this.graph.Stage.add(this.Layer),this.Layer.setZIndex(1e3);var i=this.graph.Stage.width(),n=this.graph.Stage.height(),o=void 0!=this.graph.Settings.overviewMapWidth?this.graph.Settings.overviewMapWidth:WorkflowDesignerConstants.OverviewMap.width,a=void 0!=this.graph.Settings.overviewMapHeight?this.graph.Settings.overviewMapHeight:WorkflowDesignerConstants.OverviewMap.height;e.background=new Konva.Image({x:i-o-5,y:n-a-5,width:o,height:a,fill:"white",shadowEnabled:!0,shadowBlur:5,shadowOpacity:.3}),e.Layer.add(e.background)},this.draw=function(){this.GraphRedrawAll()},this.GraphRedrawAll=function(){console.log("GraphRedrawAll")}}function WorkflowDesignerForm(e){this.type="WorkflowDesignerForm",this.parameters=e,this.id=WorkflowDesignerCommon.createUUID(),this.isReadOnly=function(){return this.parameters.readonly},this.showModal=function(e,t){var i=this;i.window=$('<div class="ui modal WorkflowDesignerDialog"></div>'),void 0!=WorkflowDesignerConstants.FormMaxHeight&&""!=WorkflowDesignerConstants.FormMaxHeight&&i.window.css("max-height",WorkflowDesignerConstants.FormMaxHeight),void 0!=this.parameters.width&&""!=this.parameters.width&&i.window.width(this.parameters.width),i.window.id=this.id;var n=void 0;"table"===this.parameters.type?n=this.generateTable(this.parameters):"form"===this.parameters.type&&(n=this.generateForm(this.parameters)),void 0==n&&(n=new Array),void 0!=i.parameters.top&&n.unshift(i.parameters.top),void 0!=i.parameters.bottom&&n.push(i.parameters.bottom),void 0!=this.parameters.renderFinalFunc&&this.parameters.renderFinalFunc(n,i);var o=i.getEditData(i.parameters);i.window.append($('<div class="header">'+this.parameters.title+"</div>")),i.window.append($('<div class="content scrolling"></div>').append(n));var a=$('<div class="actions"></div>');i.isReadOnly()?a.append('<div class="ui secondary  cancel button">'+WorkflowDesignerConstants.ButtonTextClose+"</div>"):(a.append('<div class="ui primary ok button">'+WorkflowDesignerConstants.ButtonTextSave+"</div>"),a.append('<div class="ui secondary cancel button">'+WorkflowDesignerConstants.ButtonTextCancel+"</div>")),i.window.append(a);var r=function(){if(i.ClearError(),void 0!=e&&!i.isReadOnly()){var t=i.getEditData(i.parameters);return!!e(t,i.parameters)&&(i.allowDestroy=!0,!0)}},s=function(){if(!i.isReadOnly()){var e=i.getEditData(i.parameters);return JSON.stringify(o)===JSON.stringify(e)?(i.allowDestroy=!0,!0):(i.ConfirmDialog(WorkflowDesignerConstants.CloseWithoutSaving,WorkflowDesignerConstants.ButtonTextYes,function(){i.allowDestroy=!0,WorkflowDesignerCommon.modal(i.window,"hide")},WorkflowDesignerConstants.ButtonTextNo,function(){return!0}),!1)}};WorkflowDesignerCommon.modal(i.window,{closable:!1,onApprove:r,onDeny:s,allowMultiple:t,onHidden:function(){1==i.allowDestroy&&i.destroy()},dimmerSettings:{opacity:.2,duration:{show:0,hide:0}},transition:"fade"}),WorkflowDesignerCommon.modal(i.window,"show"),WorkflowDesignerCommon.modal(i.window,"refresh")},this.destroy=function(){$(".WorkflowDesignerDialogautoComplete").remove(),this.window.remove()},this.ConfirmDialog=function(e,t,i,n,o){var a=$('<div class="ui mini modal WorkflowDesignerConfirmDialog"></div>');a.append($('<div class="header">'+WorkflowDesignerConstants.DialogConfirmText+"</div>")),a.append($('<div class="content scrolling"><p>'+e+"</p></div>"));var r=$('<div class="actions"></div>').append('<div class="ui primary ok button">'+t+"</div>").append('<div class="ui secondary  cancel button">'+n+"</div>");a.append(r),WorkflowDesignerCommon.modal(a,{onApprove:function(){i()},onDeny:function(){o()},allowMultiple:!0,dimmerSettings:{opacity:.2,duration:{show:0,hide:0}},transition:"fade"}),WorkflowDesignerCommon.modal(a,"show")},this.InfoDialog=function(e,t,i){var n="ui modal WorkflowDesignerConfirmDialog";void 0!=i&&(n+=" "+i);var o=$('<div class="'+n+'"></div>');o.append($('<div class="header">'+e+"</div>")),o.append($('<div class="content scrolling"><p>'+t+"</p></div>"));var a=$('<div class="actions"></div>').append('<div class="ui primary ok button">'+WorkflowDesignerConstants.EditCodeLabel.OK+"</div>");o.append(a),WorkflowDesignerCommon.modal(o,{allowMultiple:!0,dimmerSettings:{opacity:.2,duration:{show:0,hide:0}},transition:"fade"}),WorkflowDesignerCommon.modal(o,"show")},this.getEditData=function(e){var t,i=this;if("form"==e.type||"group"==e.type)t={},e.elements.forEach(function(e){void 0!=e.field&&(t["control_"+e.field]=e.control),"table"==e.type||"form"==e.type?t[e.field]=i.getEditData(e):"group"==e.type?i.objAssign(t,i.getEditData(e)):i.SetValueByPropertyName(t,e.field,i.getEasyControlValue(e))});else if("table"==e.type){void 0==t&&(t=[]);var n=e.control;if(e.elements.forEach(function(e){var o=i.getElementCode(e),a="[name="+o+"]",r=n.find(a);if(void 0!=r)for(var s=0;s<r.length;s++)void 0==t[s]&&(t[s]={}),t[s]["control_"+e.field]=r[s],"table"==e.type||"form"==e.type?t[s][e.field]=i.getEditData({type:e.type,control:$(r[s]),elements:e.elements}):i.SetValueByPropertyName(t[s],e.field,i.getEasyControlValue({type:e.type,control:r[s]}))}),e.keyproperty)for(var o=n.children("tbody").children("tr"),a=0;a<o.length;a++)void 0==t[a]&&(t[a]={}),t[a].keyproperty=$(o[a]).attr("keyproperty")}return t},this.generateForm=function(e,t){var i=this,n="group"==e.type?$('<div class="fields">'):$('<div class="ui form">');n.attr("name",i.getElementCode(e));var o=new Array;return e.elements.forEach(function(n){var a=$('<div class="field">');void 0!=n.width&&a.width(n.width),void 0==t&&(t="");var r=t+"_"+n.field,s=void 0;if(void 0!=n.name&&(s=$("<label></label>"),s[0].innerHTML=n.name,a.append(s)),"table"==n.type){n.fieldFunc?n.data=n.fieldFunc(e.data):n.data=e.data[n.field];var l=i.generateTable(n,r);a.append(l)}else if("form"==n.type){n.fieldFunc?n.data=n.fieldFunc(e.data):n.data=e.data[n.field];var l=i.generateForm(n,r);a.append(l)}else if("group"==n.type){n.fieldFunc?n.data=n.fieldFunc(e.data):n.data=e.data;var l=i.generateForm(n,r);a.append(l)}else{var d=i.generateEasyControls(n,i.GetValueByPropertyName(e.data,n.field),r);void 0!=s&&(s[0].for=d[0].id),n.control=d[0],a.append(d[0])}o.push(a)}),e.control=n,n.append(o),n},this.generateTable=function(e,t){var i=this,n=$('<table class="ui form WorkflowDesignerTable"></table>');n.attr("name",i.getElementCode(e));var o=$("<thead></thead>"),a=$("<tr></tr>");e.elements.forEach(function(e){var t=$("<th></th>");t[0].innerHTML=e.name,void 0!=e.width&&(t[0].width=e.width),a.append(t)}),this.isReadOnly()||a.append("<th></th>"),o.append(a),n.append(o);var r=function(o){void 0!=e.beforerowadded&&e.beforerowadded(o,i);var a=$("<tr></tr>");e.keyproperty&&a.attr("keyproperty",o[e.keyproperty]),void 0==t&&(t="");var r=t+WorkflowDesignerCommon.createUUID();if(e.elements.forEach(function(e){if("table"==e.type){e.fieldFunc?e.data=e.fieldFunc(o):e.data=o[e.field];var t=i.generateTable(e,r);a.append($("<td></td>").append(t))}else{var n=i.generateEasyControls(e,i.GetValueByPropertyName(o,e.field),r,o);a.append($("<td></td>").append(n))}}),!i.isReadOnly()){var s=$('<a class="btnDelete"></a>');s[0].innerHTML=WorkflowDesignerConstants.ButtonTextDelete,s[0].href="#",s.on("click",function(){return(void 0==e.onrowdelete||0!=e.onrowdelete(a,i))&&(a.remove(),WorkflowDesignerCommon.modal(i.window,"refresh"),!1)}),a.append($("<td></td>").append(s))}n.append(a),void 0!=e.onrowadded&&e.onrowadded(a,i)};void 0!=e.data&&e.data.forEach(function(e){r(e)}),e.control=n;var s=new Array;if(s.push(n),!this.isReadOnly()){var l=$('<a class="btnAdd"></a>');l[0].innerHTML=WorkflowDesignerConstants.ButtonTextCreate,l[0].href="#",l.on("click",function(){var t={};return e.datadefault&&(t=e.datadefault),r(t),WorkflowDesignerCommon.modal(i.window,"refresh"),!1}),s.push(l)}return s},this.generateEasyControls=function(e,t,i,n){var o=this;if("input"===e.type){var a=$('<input type="text"></input>');return a[0].id=this.generateid(e.field,i),a[0].name=o.getElementCode(e),void 0!=t&&(a[0].value=t),o.isReadOnly()&&a.attr("readonly",!0),this.addAutoComplete(e,a),a}if("checkbox"===e.type){var a=$('<input type="checkbox"></input>');return a[0].id=this.generateid(e.field,i),a[0].checked=t,a[0].name=o.getElementCode(e),o.isReadOnly()&&a.attr("disabled","disabled"),a=$('<div class="ui checkbox"></div>').append(a).append("<label></label>")}if("select"==e.type){var a=$('<select class="ui selection dropdown"></select>');return a[0].id=this.generateid(e.field,i),a[0].name=o.getElementCode(e),a.append($("<option></option>")),void 0!=e.datasource&&e.datasource.forEach(function(i){var n=$("<option></option>");void 0==e.displayfield?(n[0].value=i,n[0].innerHTML=i):(n[0].value=i[e.displayfield],n[0].innerHTML=i[e.displayfield]),n[0].value==t&&(n[0].selected="selected"),o.isReadOnly()&&a.attr("disabled","disabled"),a.append(n)}),a}if("textarea"===e.type){var a=$('<textarea rows="6" style="width: 100%;"></textarea>');return a[0].id=o.generateid(e.field,i),a[0].name=o.getElementCode(e),void 0!=t&&(a[0].value=t),this.isReadOnly()&&a.attr("readonly",!0),a}return"json"===e.type?o.generateJSONControl(e,t,i,n):"code"===e.type?o.generateCodeControl(e,t,i,n):void 0},this.generateJSONControl=function(e,i,n,o){var a=$('<input type="text"></input>');a[0].id=this.generateid(e.field,n),a[0].name=t.getElementCode(e),void 0!=i&&(a[0].value=i),t.isReadOnly()&&a.attr("readonly",!0);var r=$('<a class="btnCodeActions"></a>');r[0].id=a[0].id+"_button";var s=$('<div class="ui modal WorkflowDesignerDialogChild"><div class="header">'+WorkflowDesignerConstants.EditJSONLabel.Title+'</div><div id="'+a[0].id+'_editor" style="height:'+WorkflowDesignerConstants.EditJSONSettings.CodeHeight+'px">'+a[0].value+"</div></div>");s[0].id=a[0].id+"_form";var l=$('<div class="actions"></div>');if(!a[0].readOnly){var d=$('<div class="ui button">'+WorkflowDesignerConstants.EditJSONLabel.Format+"</div>");d.click(function(){var e=ace.edit(a[0].id+"_editor"),i=ace.edit(a[0].id+"_editor").getValue();e.setValue(t.toPrettyJSON(i)),e.clearSelection()}),l.append(d)}if(void 0!=e.getemptytype&&!a[0].readOnly){var c=$('<div class="ui button">'+WorkflowDesignerConstants.EditJSONLabel.CreateEmptyType+"</div>");c.click(function(){var i=e;void 0!=i.getemptytype&&i.getemptytype(t,a[0],function(e){if(void 0!=e&&""!==e){var i=ace.edit(a[0].id+"_editor");i.setValue(t.toPrettyJSON(e)),i.clearSelection()}})}),l.append(c)}return a[0].readOnly?l.append('<div class="ui secondary cancel button">'+WorkflowDesignerConstants.ButtonTextClose+"</div>"):(l.append('<div class="ui primary ok button">'+WorkflowDesignerConstants.ButtonTextSave+"</div>"),l.append('<div class="ui secondary cancel button">'+WorkflowDesignerConstants.ButtonTextCancel+"</div>")),s.append(l),r.on("click",function(e){WorkflowDesignerCommon.modal(t.window,"hide"),WorkflowDesignerCommon.modal(s,{closable:!1,allowMultiple:!0,onApprove:function(){var e=ace.edit(a[0].id+"_editor").getValue();a[0].value=t.toCompactJSON(e)},onHidden:function(){setTimeout(function(){WorkflowDesignerCommon.modal(t.window,"show")},10)},dimmerSettings:{opacity:.2,duration:{show:0,hide:0}},transition:"fade"}),WorkflowDesignerCommon.modal(s,"show");var i=ace.edit(a[0].id+"_editor");a[0].readOnly?i.setOptions({readOnly:!0}):i.setOptions({readOnly:!1}),i.getSession().setMode("ace/mode/json"),i.setValue(t.toPrettyJSON(a[0].value)),i.clearSelection()}),this.addAutoComplete(e,a),$('<div style="width:100%;"></div>').append($('<div style="width:16px; float:right; margin-right:7px;margin-top: 10px;"></div>').append(r)).append($('<div style="margin-right:30px"></div>').append(a))},this.generateCodeControl=function(e,i,n,o){void 0==i&&(i="");var a=$('<button class="ui button basic">'+WorkflowDesignerConstants.EditCodeLabel.EditCodeButton+"</button>");a[0].id=this.generateid(e.field,n),a[0].name=t.getElementCode(e),a[0].code={},a[0].code.code=decodeURIComponent(i);var r=o.Usings;r=void 0==r?t.parameters.graph.data.AdditionalParams.Usings.join(";")+";":decodeURIComponent(r),a[0].code.usings=r;var s=t.isReadOnly()?' readonly="true"':"",l=$('<div class="ui large modal WorkflowDesignerDialogChild">');l[0].id=a[0].id+"_form",l.append('<div class="header">'+WorkflowDesignerConstants.EditCodeLabel.Title+"</div>");var d=$('<div class="content scrolling"></div>'),c=$('<a class="ui button">'+WorkflowDesignerConstants.EditCodeLabel.ShowUsings+"</a>");d.append(c);var h=$('<div id="'+a[0].id+'_usings" style="padding-top: 6px;display:none"/>');h.append('<textarea style="width:100%;height: 100px; max-width:inherit;" id="'+a[0].id+'_usingsedit"'+s+">asdfasdfasd</textarea>"),d.append(h),d.append('<div id="'+a[0].id+'_function_upper" />'),d.append('<div id="'+a[0].id+'_editor" style="height:'+WorkflowDesignerConstants.EditCodeSettings.CodeHeight+'px" '+s+"></div>"),d.append('<div id="'+a[0].id+'_function_lower">}</div>'),c.on("click",function(e){h.is(":visible")?(h.hide(),c[0].innerText=WorkflowDesignerConstants.EditCodeLabel.ShowUsings):(h.show(),c[0].innerText=WorkflowDesignerConstants.EditCodeLabel.HideUsings),WorkflowDesignerCommon.modal(l,"refresh")}),l.append(d);var m=$('<div class="actions"></div>');if(!WorkflowDesignerForm.isjava){var g=$('<div class="ui button">'+WorkflowDesignerConstants.EditCodeLabel.Compile+"</div>");m.append(g),g.on("click",function(){for(var e=t.getEditData(t.parameters),i=void 0,n=0;n<e.length;n++)if(e[n].control_ActionCode.id==a[0].id){i=e[n];break}if(void 0!=i){i.ActionCode=encodeURIComponent(ace.edit(a[0].id+"_editor").getValue()),i.Usings=encodeURIComponent($("#"+a[0].id+"_usingsedit")[0].value.replace(/(\r\n|\n|\r)/gm,""));var o=function(e){var i=e.Success?WorkflowDesignerConstants.EditCodeLabel.Success:WorkflowDesignerConstants.EditCodeLabel.Error,n=e.Success?WorkflowDesignerConstants.EditCodeLabel.CompileSucceeded:e.Message;return t.InfoDialog(i,n,e.Success?"mini":void 0),!1};t.parameters.graph.designer.compile(i,o)}})}return a[0].readOnly?m.append('<div class="ui secondary cancel button">'+WorkflowDesignerConstants.ButtonTextClose+"</div>"):(m.append('<div class="ui primary ok button">'+WorkflowDesignerConstants.ButtonTextSave+"</div>"),m.append('<div class="ui secondary cancel button">'+WorkflowDesignerConstants.ButtonTextCancel+"</div>")),l.append(m),a.on("click",function(e){WorkflowDesignerCommon.modal(l,{closable:!1,allowMultiple:!0,onApprove:function(){a[0].code={},a[0].code.code=ace.edit(a[0].id+"_editor").getValue(),a[0].code.usings=$("#"+a[0].id+"_usingsedit")[0].value.replace(/(\r\n|\n|\r)/gm,"")},onHidden:function(){setTimeout(function(){WorkflowDesignerCommon.modal(t.window,"show")},10)},dimmerSettings:{opacity:.2,duration:{show:0,hide:0}},transition:"fade"});var i=ace.edit(a[0].id+"_editor");$("#"+a[0].id+"_usingsedit")[0].value=t.htmlEncode(t.modifyUsingString(a[0].code.usings)),$("#"+a[0].id+"_usings").accordion({collapsible:!0,active:!1,heightStyle:"content scrolling"}),WorkflowDesignerConstants.isjava&&(c.hide(),$("#"+a[0].id+"_usings").hide());var o=$("#"+t.generateid("Type",n))[0].value.toLowerCase(),r=$("#"+t.generateid("Name",n))[0].value,s=$("#"+t.generateid("IsAsync",n))[0].checked;r=""===r?"???":"<b>"+r+"</b>";var d="{";if(WorkflowDesignerConstants.isjava)"action"===o&&(d="function "+r+"(processInstance, runtime, parameter) {"),"condition"===o&&(d="function "+r+"(processInstance, runtime, parameter) {"),"ruleget"===o&&(d="function "+r+"(processInstance, runtime, parameter) {"),"rulecheck"===o&&(d="function "+r+"(processInstance, runtime, identityId, parameter) {");else{if("action"===o){var h=s?"async Task ":"void ",m=s?" (ProcessInstance processInstance, WorkflowRuntime runtime, string parameter, CancellationToken token) {":" (ProcessInstance processInstance, WorkflowRuntime runtime, string parameter) {";d=h+r+m}if("condition"===o){var g=s?"async Task&lt;bool&gt; ":"bool ",u=s?" (ProcessInstance processInstance, WorkflowRuntime runtime, string parameter, CancellationToken token) {":" (ProcessInstance processInstance, WorkflowRuntime runtime, string parameter) {";d=g+r+u}"ruleget"===o&&(d="IEnumerable&lt;string&gt; "+r+" (ProcessInstance processInstance, WorkflowRuntime runtime, string parameter) {"),"rulecheck"===o&&(d="bool "+r+" (ProcessInstance processInstance, WorkflowRuntime runtime, string identityId, string parameter) {")}$("#"+a[0].id+"_function_upper").html(d);var i=ace.edit(a[0].id+"_editor");i.getSession().setMode(WorkflowDesignerConstants.isjava?"ace/mode/javascript":"ace/mode/csharp"),i.setValue(a[0].code.code),i.clearSelection(),t.isReadOnly()?i.setOptions({readOnly:!0}):(i.setOptions({readOnly:!1}),i.focus()),WorkflowDesignerCommon.modal(t.window,"hide"),WorkflowDesignerCommon.modal(l,"show")}),a},this.addAutoComplete=function(e,t){if(void 0!=e.datasource){var n;n=Array.isArray(e.datasource)?function(t,n){t=t.toLowerCase();var o=e.datasource,a=[];for(i=0;i<o.length;i++)~o[i].toLowerCase().indexOf(t)&&a.push(o[i]);n(a)}:e.datasource;var o={minChars:0,source:n,menuClass:"WorkflowDesignerDialogautoComplete",element:t};t.autoComplete(o)}},this.modifyUsingString=function(e){var t=e.substring(e.length-1);return";"===t&&(e=e.substring(0,e.length-1)),e.split(";").join(";\r\n")+";"},this.getEasyControlValue=function(e){return"input"==e.type?e.control.value:"json"==e.type?e.control.value:"code"==e.type?e.control.code:"checkbox"==e.type?"div"==e.control.localName?e.control.children[0].checked:e.control.checked:"select"==e.type?e.control.value:"textarea"==e.type?e.control.value:void 0},this.generateid=function(e,t){return t?e+"_"+t+"_"+this.id:e+"_"+this.id},this.GetValueByPropertyName=function(e,t){if(void 0!=e){if(t.indexOf(".")<0)return e[t];var i=e;return t.split(".").forEach(function(e){void 0!=i&&(i=i[e])}),i}},this.SetValueByPropertyName=function(e,t,i){if(t.indexOf(".")<0)return e[t]=i;for(var n=e,o=t.split("."),a=0;a<o.length;a++){var r=o[a];a==o.length-1?n[r]=i:(void 0==n[r]&&(n[r]={}),n=n[r])}},this.ClearError=function(){var e=this.window.find(".field-validation-error");e.attr("title",""),e.removeClass("field-validation-error")},this.ControlAddError=function(e,t){var i=$(e);i.addClass("field-validation-error"),i.attr("title",t)},this.CheckRequired=function(e,t,i){var n=this,o=!0;return e.forEach(function(e){t.forEach(function(t){""==n.GetValueByPropertyName(e,t)&&(n.ControlAddError(e["control_"+t],i),o=!1)})}),o},this.CheckUnique=function(e,t,i){for(var n=this,o=!0,a=0;a<e.length;a++)for(var r=a+1;r<e.length;r++)this._checkUniqueEquals(e[a],e[r],t)&&(t.forEach(function(t){n.ControlAddError(e[a]["control_"+t],i),n.ControlAddError(e[r]["control_"+t],i)}),o=!1);return o},this._checkUniqueEquals=function(e,t,i){for(var n=0;n<i.length;n++){var o=i[n];if(e[o]!=t[o])return!1}return!0};var t=this;this.ClearTempField=function(e,i){void 0!=e&&(void 0==i&&(i=this.parameters.elements),i.forEach(function(n){$.isArray(e)?e.forEach(function(e){t.ClearTempField(e,i)}):void 0!=e["control_"+n.field]&&(e["control_"+n.field]=void 0),n.elements&&t.ClearTempField(e[n.field],n.elements)}))},this.getElementCode=function(e){return void 0!=e.code?e.code:e.field},this.htmlEncode=function(e){return $("<div/>").text(e).html()},this.htmlDecode=function(e){return $("<div/>").html(e).text()},this.toCompactJSON=function(e){try{return JSON.stringify(JSON.parse(e))}catch(t){try{return JSON5.stringify(JSON5.parse(e))}catch(t){return e}}},this.toPrettyJSON=function(e){try{return JSON.stringify(JSON.parse(e),null,"\t")}catch(t){try{return JSON5.stringify(JSON5.parse(e),null,"\t")}catch(t){return e}}},this.objAssign=function(e,t){"use strict";if(null==e)throw new TypeError("Cannot convert undefined or null to object");for(var i=Object(e),n=1;n<arguments.length;n++){var o=arguments[n];if(null!=o)for(var a in o)Object.prototype.hasOwnProperty.call(o,a)&&(i[a]=o[a])}return i}}function WorkflowDesignerTransitionManager(){this.type="WorkflowDesignerTransitionManager",this.init=function(e){this.graph=e,this.Layer=new Konva.Layer,this.graph.Stage.add(this.Layer),this.Layer.setZIndex(2),this.graph=e,this.APLayer=new Konva.Layer,this.graph.Stage.add(this.APLayer),this.APLayer.setZIndex(3)},this.ItemControls=new Array,this.draw=function(){null!=this.ItemControls&&this.ItemControls.forEach(function(e){e.destroy()}),this.ItemControls=new Array;var e=this;void 0!=this.graph.data.Transitions&&this.graph.data.Transitions.forEach(function(t){var i=e.graph.GetComponentByType("WorkflowDesignerActivityManager"),n=new WorkflowDesignerTransitionControl({from:i.find(t.From),to:i.find(t.To),item:t,graph:e.graph,manager:e});e.ItemControls.push(n),n.Draw()}),this.batchDraw()},this.batchDraw=function(){this.CorrectItems(),this.Layer.batchDraw(),this.APLayer.batchDraw()},this.CorrectItems=function(){for(var e=0;e<this.ItemControls.length;e++)for(var t=this.ItemControls[e],i=0;i<this.ItemControls.length;i++)if(e!=i){var n=this.ItemControls[i];t.start.x==n.start.x&&t.start.y==n.start.y&&(n.start.x+=5),t.end.x==n.end.x&&t.end.y==n.end.y&&(n.end.x+=5),t.middle.x==n.middle.x&&t.middle.y==n.middle.y&&(n.middle.x+=15)}},this.getIntersectingActivity=function(e){var t=this.graph.GetComponentByType("WorkflowDesignerActivityManager");return t.getIntersectingActivity(e)},this.LayerSetOffset=function(e){this.Layer.setOffset(e),this.APLayer.setOffset(e)},this.LayerScale=function(e){this.Layer.setScale({x:this.Layer.getScale().x+e,y:this.Layer.getScale().y+e}),this.APLayer.setScale({x:this.APLayer.getScale().x+e,y:this.APLayer.getScale().y+e})},this.LayerScaleNorm=function(){
this.Layer.setScale({x:1,y:1}),this.Layer.setOffset({x:0,y:0}),this.APLayer.setScale({x:1,y:1}),this.APLayer.setOffset({x:0,y:0})},this.DeselectAll=function(){this.ItemControls.forEach(function(e){e.Deselect()})},this.GetSelected=function(){var e=new Array;return this.ItemControls.forEach(function(t){t.selected&&e.push(t)}),e},this.SelectByPosition=function(e){this.ItemControls.forEach(function(t){t.getIntersectingRect(e)&&t.Select()})},this.SelectByItem=function(e){this.ItemControls.forEach(function(t){t.item==e&&t.Select()})},this.CreateNewTransition=function(e,t){var i=this;if(void 0==t){var n=e.control.getX()+e.rectangle.attrs.width,o=e.control.getY()+e.rectangle.attrs.height/2,a={x:n,y:o},r=new WorkflowDesignerTransitionManagerTempControl({x:a.x,y:a.y,manager:this});r.Draw(a.x+10,a.y),this.batchDraw();var s=function(e){var t=i.graph.CorrectPossition({x:e.evt.offsetX,y:e.evt.offsetY},i.Layer);r.Redraw(t),i.Layer.batchDraw()},l=function(t){var n={x:t.evt.offsetX,y:t.evt.offsetY},o=i.getIntersectingActivity(n);void 0!=o&&i.CreateNewTransition(e,o),r.Delete(),i.graph.Stage.off("mousemove.WorkflowDesignerTransitionManagerTempControl",s),i.graph.Stage.off("mouseup.WorkflowDesignerTransitionManagerTempControl",l),i.batchDraw(),i.graph.StoreGraphData()};return this.graph.Stage.on("mousemove.WorkflowDesignerTransitionManagerTempControl",s),this.graph.Stage.on("mouseup.WorkflowDesignerTransitionManagerTempControl",l),r}var d={Name:this.GetDefaultName(e.GetName(),t.GetName()),From:e.item,To:t.item,Trigger:{Type:"Auto"},Conditions:[{Type:"Always"}],AllowConcatenationType:"And",RestrictConcatenationType:"And",ConditionsConcatenationType:"And",Classifier:"NotSpecified",DesignerSettings:{}},c=new WorkflowDesignerTransitionControl({from:e,to:t,item:d,graph:i.graph,manager:i});return i.ItemControls.push(c),i.graph.data.Transitions.push(d),c.Draw(),c},this.GetDefaultName=function(e,t){for(var i=e+"_"+t+"_",n=1,o=0;o<this.graph.data.Transitions.length;o++){var a=this.graph.data.Transitions[o];a.Name==i+n&&(n++,o=-1)}return i+n}}function WorkflowDesignerActivityControl(e){var t=this;this.manager=e.manager,this.graph=e.graph,this.x=e.x,this.y=e.y,this.item=e.item,this.control=void 0,this.rectangle=void 0,this.text=void 0,this.createTransitionAndActivityButton=void 0,this.createTransitionButton=void 0,this.selected=!1,this.dependentTransitions=new Array,this.getX=function(){return this.rectangle.attrs.x+this.control.attrs.x},this.getY=function(){return this.rectangle.attrs.y+this.control.attrs.y},this.GetName=function(){return this.item.Name},this.SetName=function(e){this.item.Name=e},this.Draw=function(){var i=t.graph.Settings,n=!t.graph.Settings.disableobjectmovements;t.control=new Konva.Group({x:e.x,y:e.y,rotation:0,draggable:n,dragBoundFunc:function(e){var n=(i.DefaultMoveStep*t.manager.Layer.getScaleX(),i.DefaultMoveStep*t.manager.Layer.getScaleY()),e={x:Math.round(e.x/n)*n,y:Math.round(e.y/n)*n};if(t.selected){var o=this.getAbsolutePosition();t.manager.ObjectMove({sender:t,changepos:{x:e.x-o.x,y:e.y-o.y}})}return e}});var o=WorkflowDesignerConstants.ActivityColor,a=WorkflowDesignerConstants.ActivityTextColor,r=!0;t.item.IsFinal&&(o=WorkflowDesignerConstants.ActivityFinalColor,a=WorkflowDesignerConstants.ActivityFinalTextColor,r=!1),t.item.IsInitial&&(o=WorkflowDesignerConstants.ActivityInitialColor,a=WorkflowDesignerConstants.ActivityInitialTextColor,r=!1),t.graph.GetCurrentActivity()==t.item.Name&&(o=WorkflowDesignerConstants.SelectColor,a=WorkflowDesignerConstants.SelectTextColor,r=!1),t.graph.isCurrentActivityForSubprocess(t.item.Name)&&(o=WorkflowDesignerConstants.SelectSubProcessColor,a=WorkflowDesignerConstants.SelectSubProcessTextColor,r=!1),t.rectangle=new Konva.Rect({x:0,y:0,width:this.graph.Settings.DefaultActivityWidth,height:this.graph.Settings.DefaultActivityHeight,fill:o,cornerRadius:5}),t.control.add(t.rectangle),Array.isArray(t.item.Implementation)&&t.item.Implementation.length>0&&(t.impImage=new Konva.Image({x:t.rectangle.attrs.width-20,y:38,image:r?t.manager.ImageImplementation:t.manager.ImageImplementationWhite,width:15,height:15}),t.control.add(t.impImage)),Array.isArray(t.item.PreExecutionImplementation)&&t.item.PreExecutionImplementation.length>0&&(t.impImage2=new Konva.Image({x:t.rectangle.attrs.width-35,y:38,image:r?t.manager.ImageImplementation:t.manager.ImageImplementationWhite,width:15,height:15}),t.control.add(t.impImage2)),t.text=new Konva.Text({x:10,y:10,text:this.GetName(),fontSize:12,fontFamily:"Arial",fontStyle:"bold",fill:a}),void 0==t.item.State&&(t.item.State=""),t.stateText=new Konva.Text({x:10,y:25,text:t.item.State,fontSize:12,fontFamily:"Arial",fill:a}),t.control.add(t.text),t.control.add(t.stateText);var s="";1==t.item.IsInitial&&(s.length>0&&(s+=" "),s+=WorkflowDesignerConstants.ActivityFormLabel.IsInitial),1==t.item.IsFinal&&(s.length>0&&(s+=" "),s+=WorkflowDesignerConstants.ActivityFormLabel.IsFinal),1==t.item.IsForSetState&&(s.length>0&&(s+=" - "),s+=WorkflowDesignerConstants.ActivityFormLabel.IsForSetState),""!=s&&(t.typeText=new Konva.Text({x:10,y:40,text:s,fontSize:12,fontFamily:"Arial",fill:a}),t.control.add(t.typeText)),1==t.graph.getParam("exinfo")&&t.createExInfo(t.control),t.graph.Settings.disableobjectmovements||(this.control.on("dragend",this.Sync),this.control.on("dragmove",this._onMove),this.control.on("click",this._onClick),this.control.on("touchend",this._onClick)),this.control.on("dblclick",this._onDblClick);var l=t.graph.Settings.imagefolder,d=[{img:l+"wfe.settings.png",click:function(){t.ShowProperties()}}];t.graph.Settings.readonly||(d.push({img:l+"wfe.transition.png",click:function(){t._onCreateTransition()}}),d.push({img:l+"wfe.activity.png",click:function(){t._onCreateTransitionAndActivity()}}),d.push({img:l+"wfe.clone.png",click:function(){t.manager.Clone(t)}}),d.push({img:l+"wfe.delete.png",click:function(){t._onDelete()}}));var c={x:t.rectangle.getWidth()-30*d.length,y:-40};t.bar=WorkflowDesignerBar(t.manager.Layer,d,c),t.control.add(t.bar),t.bar.hide(),t.manager.Layer.add(t.control)},this.Delete=function(){this.control.destroy(),this.graph.data.Activities.splice(this.graph.data.Activities.indexOf(this.item),1),this.manager.ItemControls.splice(this.manager.ItemControls.indexOf(this),1);for(var e=new Array,t=0;t<this.dependentTransitions.length;t++)e.push(this.dependentTransitions[t]);for(var t=0;t<e.length;t++)e[t].Delete()},this.Select=function(){if(1!=this.selected){var e=this;this.rectangle.setStrokeWidth(4),this.rectangle.setStroke(WorkflowDesignerConstants.SelectColor),e.bar!=unescape&&e.bar.show(),this.selected=!0}},this.Deselect=function(){0!=this.selected&&(this.rectangle.setStrokeWidth(0),this.rectangle.setStroke(this.rectangle.fill()),void 0!=t.bar&&t.bar.hide(),this.selected=!1)},this.ObjectMove=function(e){var i=this.control.getAbsolutePosition();if(i.x+=e.x,i.y+=e.y,this.control.setAbsolutePosition(i),this.Sync(),!(t.dependentTransitions.length<1))for(var n=0;n<t.dependentTransitions.length;n++){var o=t.dependentTransitions[n];o.middle=void 0,o.Draw()}},this._onMove=function(){if(!(t.dependentTransitions.length<1)){var e=20,i=!1;if(void 0==t.oldpos)t.oldpos=t.control.getPosition();else{var n=t.control.getPosition();(Math.abs(n.x-t.oldpos.x)>e||Math.abs(n.y-t.oldpos.y)>e)&&(i=!0)}for(var o=0;o<t.dependentTransitions.length;o++){var a=t.dependentTransitions[o];i&&(a.middle=void 0,a.item.DesignerSettings={}),a.Draw()}t.manager.redrawTransitions()}},this._onClick=function(e){var i=t.selected;e.evt.ctrlKey||t.graph.DeselectAll(),i?t.Deselect():t.Select(),t.graph.onSelectionChanged(!i),t.manager.batchDraw()},this._onDblClick=function(){t.graph.DeselectAll(),t.Select(),t.manager.batchDraw(),t.graph.Settings.notshowwindows||t.ShowProperties()},this._onDelete=function(){var e=this;e.graph.confirm(WorkflowDesignerConstants.DeleteConfirmCurrent,function(){e.Delete(),e.graph.onSelectionChanged(),e.graph.redrawAll(),e.graph.StoreGraphData()})},this._onCreateTransitionAndActivity=function(){t.manager.createTransitionAndActivity(t),t.graph.StoreGraphData()},this._onCreateTransition=function(){t.manager.createTransition(t)},this.RegisterTransition=function(e){for(var t=!1,i=0;i<this.dependentTransitions.length;i++)if(this.dependentTransitions[i].GetName()==e.GetName()){t=!0;break}t||this.dependentTransitions.push(e)},this.UnregisterTransition=function(e){for(var t=new Array,i=0;i<this.dependentTransitions.length;i++)this.dependentTransitions[i].GetName()!=e.GetName()&&t.push(this.dependentTransitions[i]);this.dependentTransitions=t},this.RegisterTransition=function(e){for(var t=!1,i=0;i<this.dependentTransitions.length;i++)if(this.dependentTransitions[i].GetName()==e.GetName()){t=!0;break}t||this.dependentTransitions.push(e)},this.UnregisterTransition=function(e){for(var t=new Array,i=0;i<this.dependentTransitions.length;i++)this.dependentTransitions[i].GetName()!=e.GetName()&&t.push(this.dependentTransitions[i]);this.dependentTransitions=t},this.getRectPos=function(){var e=this.rectangle.getAbsolutePosition(),t=e.x,i=e.y,n=t+this.rectangle.getWidth()*this.manager.Layer.getScaleX(),o=i+this.rectangle.getHeight()*this.manager.Layer.getScaleY();return{xl:t,yl:i,xr:n,yr:o}},this.getIntersectingActivity=function(e){var t=this.getRectPos();return e.x>=t.xl&&e.x<t.xr&&e.y>=t.yl&&e.y<t.yr},this.getIntersectingActivityRect=function(e){var t=this.getRectPos();return!(e.xl>t.xr||e.xr<t.xl||e.yl>t.yr||e.yr<t.yl)},this.ShowProperties=function(){var e=WorkflowDesignerConstants.ActivityFormLabel,i=[{name:e.ImpOrder,code:"impOrder",field:"Order",type:"input",width:"40px"},{name:e.ImpAction,code:"impAction",field:"ActionName",type:"select",datasource:t.graph.getActionNames()},{name:e.ImpActionParameter,code:"impparam",field:"ActionParameter",type:"json",openautocompleteonclick:!0,datasource:function(e,i){var n=$(this.element[0]).closest("tr"),o=n.find("[name=impAction]")[0].value;i(t.graph.getAutoCompleteSuggestions("actionparameter",o,e.term))}}],n={type:"form",title:e.Title,width:"800px",data:this.item,elements:[{name:e.Name,field:"Name",type:"input"},{name:e.State,field:"State",type:"input"},{type:"group",elements:[{name:e.IsInitial,field:"IsInitial",type:"checkbox"},{name:e.IsFinal,field:"IsFinal",type:"checkbox"},{name:e.IsForSetState,field:"IsForSetState",type:"checkbox"},{name:e.IsAutoSchemeUpdate,field:"IsAutoSchemeUpdate",type:"checkbox"}]},{name:e.Implementation,field:"Implementation",type:"table",elements:i,onrowadded:function(e){var t=e.find("[name=impOrder]");""===t[0].value&&(t[0].value=e.parent().children().length)}},{name:e.PreExecutionImplementation,field:"PreExecutionImplementation",type:"table",elements:i,onrowadded:function(e){var t=e.find("[name=impOrder]");""===t[0].value&&(t[0].value=e.parent().children().length)}}],graph:t.graph,readonly:t.graph.Settings.readonly},o=new WorkflowDesignerForm(n),a=function(e,i){var n=!0;return n&=e.CheckRequired([i],["Name"],WorkflowDesignerConstants.FieldIsRequired),t.graph.data.Activities.forEach(function(o){o!=t.item&&o.Name==i.Name&&(n=!1,e.ControlAddError(i.control_Name,WorkflowDesignerConstants.FieldMustBeUnique))}),e.CheckRequired(i.Implementation,["ActionName","Order"],WorkflowDesignerConstants.FieldIsRequired)||(n=!1),e.CheckRequired(i.PreExecutionImplementation,["ActionName","Order"],WorkflowDesignerConstants.FieldIsRequired)||(n=!1),n},r=function(e){return!!a(o,e)&&(o.ClearTempField(e),t.item.Name=e.Name,t.item.State=e.State,t.item.IsInitial=e.IsInitial,t.item.IsFinal=e.IsFinal,t.item.IsForSetState=e.IsForSetState,t.item.IsAutoSchemeUpdate=e.IsAutoSchemeUpdate,t.item.Implementation=e.Implementation,t.item.PreExecutionImplementation=e.PreExecutionImplementation,WorkflowDesignerCommon.DataCorrection(t.graph.data),t.graph.Draw(t.graph.data),t.graph.StoreGraphData(),!0)};o.showModal(r)},this.Sync=function(){void 0==t.item.DesignerSettings&&(t.item.DesignerSettings={});var e=t.control.getPosition();t.item.DesignerSettings.X=e.x,t.item.DesignerSettings.Y=e.y,t.oldpos=void 0},this.createExInfo=function(e){var i="";Array.isArray(t.item.Implementation)&&t.item.Implementation.length>0&&t.item.Implementation.forEach(function(e){i.length>0&&(i+=", "),i+=e.ActionName});var n="";if(Array.isArray(t.item.PreExecutionImplementation)&&t.item.PreExecutionImplementation.length>0&&(t.item.PreExecutionImplementation.forEach(function(e){n.length>0&&(n+=", "),n+=e.ActionName}),""==i&&(i=WorkflowDesignerConstants.None)),i.length>0){var o=new Konva.Text({x:10,y:this.graph.Settings.DefaultActivityHeight+5,text:i,fontFamily:"Arial",fontSize:12,fill:"#4A4A4A",fontStyle:"bold"});if(e.add(o),n.length>0){var a=new Konva.Text({x:10,y:this.graph.Settings.DefaultActivityHeight+o.getHeight()+5,text:n,fontFamily:"Arial",fontSize:12,fill:"#4A4A4A",fontStyle:"italic"});e.add(a)}}},this.destroy=function(){this.control.destroy()}}function WorkflowGraph(e,t,i,n){var o=this;o.container=e,o.designer=t,o.suggestionsCache=new Object,void 0==i&&(i=new Object),void 0==i.Container&&(i.Container="container"),void 0==i.graphwidth&&(i.graphwidth=1024),void 0==i.graphheight&&(i.graphheight=768),void 0==i.DefaultActivityWidth&&(i.DefaultActivityWidth=200),void 0==i.DefaultActivityHeight&&(i.DefaultActivityHeight=60),void 0==i.DefaultMoveStep&&(i.DefaultMoveStep=10),void 0==i.imagefolder&&(i.imagefolder="/images/"),this.Settings=i,this.Settings.ContainerStage=this.container+"_stage",$("#"+this.container).append("<div id='"+this.Settings.ContainerStage+"' class='workflowenginecontainerstage'></div>"),this.Stage=new Konva.Stage({container:this.Settings.ContainerStage,width:parseInt(this.Settings.graphwidth),height:parseInt(this.Settings.graphheight)}),this.getParam=function(e){var t=this.designer.getParam(e);return"true"===t||"false"!==t&&t},this.setParam=function(e,t){this.designer.setParam(e,t)},this.Components=new Array,this.AddComponent=function(e){var t=new e;return t.init(this),o.Components.push(t),t},this.GetComponentByType=function(e){for(var t=0;t<this.Components.length;t++)if(this.Components[t].type==e)return this.Components[t]},this.ComponentsExecute=function(e,t){o.Components.forEach(function(i){i[e]&&i[e](t)})},n&&n.forEach(function(e){o.AddComponent(e)}),this.Draw=function(e){o.data=e,0==o.graphData.length&&o.StoreGraphData(),o.onSelectionChanged(),o.ComponentsExecute("draw")},this.GraphLayerSetOffset=function(e,t){o.ComponentsExecute("LayerSetOffset",{x:e,y:t}),o.redrawAll()},this.GraphLayerScale=function(e){o.ComponentsExecute("LayerScale",e),o.redrawAll()},this.GraphLayerScaleNorm=function(){o.ComponentsExecute("LayerScaleNorm"),o.redrawAll()},this.Refresh=function(){o.designer.refresh()},this.onFullScreenClick=function(){void 0!==this.data.__loadParams&&this.data.__loadParams.isFullScreen?(this.setFullScreen(!1),this.data.__loadParams.isFullScreen=!1):(this.setFullScreen(!0),void 0===this.data.__loadParams&&(this.data.__loadParams={}),this.data.__loadParams.isFullScreen=!0),this.redrawAll()},this.setFullScreen=function(e){var t=$("#"+this.container);void 0==this._toolbar&&(this._toolbar=this.GetComponentByType("WorkflowDesignerToolbar"));var i=this._toolbar;if(e){this.originalContainerStyle=t.attr("style"),void 0==this.originalContainerStyle&&(this.originalContainerStyle=""),this.originalWidth=this.Stage.width(),this.originalHeight=this.Stage.height();var n=$(window).width()-2,o=$(window).height()-2;this.Stage.hide(),this.Stage.width(n),this.Stage.height(o),void 0!=i&&(i.setItemActive("fullscreen",!0),i.changeWidth(n)),t.css({position:"absolute",top:0,left:0,width:n,height:o,"z-index":1e4,background:"white"}),this.Stage.show()}else void 0!=this.originalContainerStyle&&void 0!=this.originalWidth&&void 0!=this.originalHeight&&(this.Stage.hide(),t.attr("style",this.originalContainerStyle),this.Stage.width(this.originalWidth),this.Stage.height(this.originalHeight),void 0!=i&&(i.setItemActive("fullscreen",!1),i.changeWidth(this.originalWidth)),this.Stage.show())},this.DeselectAll=function(){o.ComponentsExecute("DeselectAll"),o.onSelectionChanged(!1),o.redrawAll()},this.redrawAll=function(){o.Stage.batchDraw()},this.CorrectPossition=function(e,t){return 0==t.getScaleX()||0==t.getScaleY()?{x:t.getOffsetX(),y:0}:{x:e.x/t.getScaleX()+t.getOffsetX(),y:e.y/t.getScaleY()+t.getOffsetY()}},this.DeleteSelected=function(){var e=this,t=new Array;this.Components.forEach(function(e){e.GetSelected&&(t=t.concat(e.GetSelected()))}),t.length>0&&e.confirm(WorkflowDesignerConstants.DeleteConfirm,function(){t.forEach(function(e){e.Delete()}),e.onSelectionChanged(!1),e.redrawAll()})},this.confirm=function(e,t){var i=$('<div class="ui mini modal"></div>');i.append($('<div class="content"><p>'+e+"</p></div>"));var n=$('<div class="actions"></div>').append('<div class="ui primary ok button">'+WorkflowDesignerConstants.ButtonTextYes+"</div>").append('<div class="ui secondary  cancel button">'+WorkflowDesignerConstants.ButtonTextCancel+"</div>");i.append(n),WorkflowDesignerCommon.modal(i,{onApprove:function(){t()}}),WorkflowDesignerCommon.modal(i,"show")},this.destroy=function(){if(void 0!=this.originalContainerStyle){var e=$("#"+this.container);e.attr("style",this.originalContainerStyle)}void 0!=this.data&&(void 0==this.data.__loadParams&&(this.data.__loadParams={}),this.data.__loadParams.graphData=this.graphData,this.data.__loadParams.graphDataIndex=this.graphDataIndex),this.Stage.destroy()},this.GetCurrentActivity=function(){if(void 0!=o.data&&void 0!=o.data.AdditionalParams&&void 0!=o.data.AdditionalParams.ProcessParameters)for(var e=0;e<o.data.AdditionalParams.ProcessParameters.length;e++){var t=o.data.AdditionalParams.ProcessParameters[e];if("CurrentActivity"===t.Name)return t.Value}},this.isCurrentActivityForSubprocess=function(e){if(void 0==o.data||void 0==o.data.AdditionalParams||!Array.isArray(o.data.AdditionalParams.SubprocessCurrentActivities))return!1;for(var t=0;t<o.data.AdditionalParams.SubprocessCurrentActivities.length;t++)if(e===o.data.AdditionalParams.SubprocessCurrentActivities[t])return!0;return!1},this.getActionNames=function(){for(var e=this,t=new Array,i=0;i<e.data.CodeActions.length;i++){var n=e.data.CodeActions[i];"action"===n.Type.toLowerCase()&&t.push(n.Name)}return e.data.AdditionalParams.Actions.concat(t)},this.getConditionNames=function(){for(var e=this,t=new Array,i=0;i<e.data.CodeActions.length;i++){var n=e.data.CodeActions[i];"condition"===n.Type.toLowerCase()&&t.push(n.Name)}return e.data.AdditionalParams.Conditions.concat(t)},this.getActorNames=function(){for(var e=this,t=new Array,i=0;i<e.data.CodeActions.length;i++){var n=e.data.CodeActions[i];"ruleget"!==n.Type.toLowerCase()&&"rulecheck"!==n.Type.toLowerCase()||t.push(n.Name)}return e.unique(e.data.AdditionalParams.Rules.concat(t))},this.getTypeNames=function(){for(var e=this,t=new Array,i=0;i<e.data.Parameters.length;i++){var n=e.data.Parameters[i];t.push(decodeURIComponent(n.Type))}return e.unique(e.data.AdditionalParams.Types.concat(t))},this.getAutoCompleteSuggestions=function(e,t,i){var n;return void 0===t||""===t?new Array:(void 0!=this.suggestionsCache[e]&&void 0!=this.suggestionsCache[e][t]?n=this.suggestionsCache[e][t]:(void 0==this.suggestionsCache[e]&&(this.suggestionsCache[e]=new Object),n=this.designer.requestautocompletesuggestions(e,t),this.suggestionsCache[e][t]=n),$.grep(n,function(e){return e.toLowerCase().indexOf(i.toLowerCase())>=0}))},this.getNonSystemParameters=function(){for(var e=this,t=new Array,i=0;i<e.data.Parameters.length;i++){var n=e.data.Parameters[i];"system"!=n.Purpose.toLowerCase()&&t.push(n)}return t},this.unique=function(e){return $.grep(e,function(t,i){return i===$.inArray(t,e)})},this.graphData=[],this.graphDataIndex=-1,this.StoreGraphData=function(){var e=void 0;void 0!=this.data.__loadParams&&(e=this.data.__loadParams.graphData,this.data.__loadParams.graphData=void 0);var t=JSON.stringify(this.data);if(void 0!=e&&(this.data.__loadParams.graphData=e),this.graphDataIndex<0||this.graphData[this.graphDataIndex]!=t){this.graphDataIndex++,this.graphData.length>this.graphDataIndex&&this.graphData.splice(this.graphDataIndex,this.graphData.length-this.graphDataIndex),this.graphData.push(t);var i=200;void 0!=WorkflowDesignerConstants.UndoDepth&&(i=WorkflowDesignerConstants.UndoDepth),this.graphData.length>i&&(this.graphData.splice(0,1),this.graphDataIndex--)}this.heckToolbarButtonState()},this.ClearGraphData=function(){this.graphData=[],this.graphDataIndex=-1},this.Undo=function(){this.graphDataIndex>0&&this.changeGraphDataIndex(this.graphDataIndex-1)},this.Redo=function(){this.graphData.length>this.graphDataIndex&&this.changeGraphDataIndex(this.graphDataIndex+1)},this.changeGraphDataIndex=function(e){if(this.graphData.length>e){var t=JSON.parse(this.graphData[e]);WorkflowDesignerCommon.DataCorrection(t),this.designer.data=t,this.Draw(t),this.graphDataIndex=e}this.heckToolbarButtonState()},this.heckToolbarButtonState=function(){void 0==this._toolbal&&(this._toolbal=o.GetComponentByType("WorkflowDesignerToolbar"));var e=this._toolbal;void 0!=e&&(e.setItemDisabled("undo",this.graphDataIndex<=0),e.setItemDisabled("redo",this.graphData.length<=this.graphDataIndex+1),e.Layer.batchDraw())},this.onSelectionChanged=function(e){void 0==this._toolbal&&(this._toolbal=o.GetComponentByType("WorkflowDesignerToolbar"));var t=this._toolbal;if(void 0!=t){var i;if(void 0==e){var n=o.GetComponentByType("WorkflowDesignerActivityManager"),a=o.GetComponentByType("WorkflowDesignerTransitionManager"),r=n.GetSelected(),s=a.GetSelected();i=r.length>0||s.length>0}else i=e;t.setItemDisabled("copy",!i),t.setItemDisabled("delete",!i)}}}function WorkflowDesignerTransitionControl(e){var t=this;this.manager=e.manager,this.graph=e.graph,this.from=e.from,this.to=e.to,this.item=e.item,this.setFrom=function(e){this.from=e,this.item.From=e.item},this.setTo=function(e){this.to=e,this.item.To=e.item},this.GetName=function(){return this.item.Name},this.SetName=function(e){this.item.Name=e},this.control=void 0,this.arrow=void 0,this.line=void 0,void 0!=this.item.DesignerSettings&&void 0!=this.item.DesignerSettings.X&&void 0!=this.item.DesignerSettings.Y?this.middle={x:Number(this.item.DesignerSettings.X),y:Number(this.item.DesignerSettings.Y)}:this.middle=void 0,this.from.RegisterTransition(this),this.to.RegisterTransition(this),this.start=void 0,this.end=void 0,this.angle=void 0,this.activePoint=void 0,this.touchpoints=[],this.DrawTransition=function(e,t){var i,n,o,a,r=this,s=this.from.rectangle;this.to.rectangle;i=Number(this.from.getX()),n=Number(this.from.getY()),o=Number(this.to.getX()),a=Number(this.to.getY());var l=Number(s.attrs.width/2),d=Number(s.attrs.height/2),c=25,h=i+l,m=n+d,g=o+l,u=a+d;if(this.direction={start:0,end:0},this.from==this.to)this.start={x:h+l,y:m-d+14},this.end={x:g+l-25,y:u-d},this.direction.end=1,void 0==this.middle&&(this.middle={x:h+l+d,y:m-2*d});else{var p=!1;void 0==this.middle&&(p=!0,this.middle={x:(h+g)/2,y:(m+u)/2});var f=h,v=m,y=g,w=u;if(m-d-c>this.middle.y&&u-d-c>this.middle.y?(v=m-d,w=u-d,this.direction.start=1,this.direction.end=1):m+d+c<this.middle.y&&u+d+c<this.middle.y?(v=m+d,w=u+d,this.direction.start=1,this.direction.end=1):h-l-c>this.middle.x&&g-l-c>this.middle.x?(f=h-l,y=g-l):h+l+c<this.middle.x&&g+l+c<this.middle.x?(f=h+l,y=g+l):(h+l+c<this.middle.x?f+=l:h-l-c>this.middle.x?f-=l:m+d+c<this.middle.y?(v+=d,this.direction.start=1):m-d-c>this.middle.y?(v-=d,this.direction.start=1):f<=this.middle.x?f+=l:f-=l,g+l+c<this.middle.x?y+=l:g-l-c>this.middle.x?y-=l:u+d+c<this.middle.y?(w+=d,this.direction.end=1):u-d-c>this.middle.y?(w-=d,this.direction.end=1):(v>=this.middle.y?w+=d:w-=d,this.direction.end=1)),void 0!=e&&(f=e.x,v=e.y,p=!0),void 0!=t&&(y=t.x,w=t.y,p=!0),this.start={x:f,y:v},this.end={x:y,y:w},p){this.middle={x:(f+y)/2,y:(v+w)/2};for(var C=0;C<r.manager.ItemControls.length;C++){var b=r.manager.ItemControls[C];b!=r&&b.middle.x==r.middle.x&&b.middle.y==r.middle.y&&(0==r.direction.start?r.middle.y+=40:r.middle.x+=40)}}void 0==e&&(0==this.direction.start?this.middle.y>v+d-7?v+=d-7:this.middle.y<v-d+7?v-=d-7:v=this.middle.y:this.middle.x>f+l-10?f+=l-10:this.middle.x<f-l+10?f-=l-10:f=this.middle.x),void 0==t&&(0==this.direction.end?this.middle.y>w+d-7?w+=d-7:this.middle.y<w-d+7?w-=d-7:w=this.middle.y:this.middle.x>y+l-10?y+=l-10:this.middle.x<y-l+10?y-=l-10:y=this.middle.x),this.start={x:f,y:v},this.end={x:y,y:w}}var S=this.GetColor();if(this.points=this.GetPoints([this.start.x,this.start.y,this.middle.x,this.middle.y,this.end.x,this.end.y],this.direction),this.angle=Math.atan2(this.points[this.points.length-1]-this.points[this.points.length-3],this.points[this.points.length-2]-this.points[this.points.length-4]),void 0==this.control){this.control=new Konva.Group({x:0,y:0,rotation:0}),this.arrow=WorkflowDesignerCommon.createArrowByAngle(this.end.x,this.end.y,this.angle,15,S);var D={points:this.points,stroke:S,strokeWidth:2,lineCap:"round",lineJoin:"round"};this.item.IsFork&&(D.dash=[10,10]),this.line=new Konva.Line(D),this.control.add(this.line),this.control.add(this.arrow),this.manager.Layer.add(this.control)}else WorkflowDesignerCommon.updateArrowByAngle(this.arrow,this.end.x,this.end.y,this.angle,15,S),this.line.setPoints(this.points)},this.GetPoints=function(e,t){if(e[0]==e[2]==e[4]||e[1]==e[3]==e[5])return e;var i=new Array;return e[0]==e[2]||e[1]==e[3]?i.push(e[0],e[1],e[2],e[3]):(i.push(e[0],e[1]),0==t.start?i.push(e[2],e[1]):i.push(e[0],e[3]),i.push(e[2],e[3])),0==t.end&&i[i.length-2]!=e[4]?i.push(i[i.length-2],e[5]):1==t.end&&i[i.length-1]!=e[5]&&i.push(e[4],i[i.length-1]),i.push(e[4],e[5]),i},this.GetColor=function(){var e=void 0==this.item.Classifier?"notspecified":this.item.Classifier.toLowerCase();return"notspecified"==e?"#7F8C8D":"direct"==e?"#27AE60":"#2980B9"},this.DrawActivePoint=function(){if(this.activePoint)this._moveActivePoint(this.middle.x,this.middle.y);else{var e=this._createActivePoint(this.middle.x,this.middle.y,this.control);t.manager.APLayer.add(e),this.activePoint=e}},this.DrawTouchPoints=function(){.1*this._getLineLength(this.start.x,this.start.y,this.end.x,this.end.y);if(void 0==this.touchpoints[0]||this.touchpoints[0].isdestroyed){var e=this._createTouchPoint(this.points,this.control,!1);t.manager.APLayer.add(e),this.touchpoints[0]=e}else this._moveTouchPoints(this.touchpoints[0],this.points,!1);if(void 0==this.touchpoints[1]||this.touchpoints[1].isdestroyed){var i=this._createTouchPoint(this.points,this.control,!0);t.manager.APLayer.add(i),this.touchpoints[1]=i}else this._moveTouchPoints(this.touchpoints[1],this.points,!0)},this.Draw=function(e,t){this.DrawTransition(e,t),this.DrawActivePoint(),this.graph.Settings.readonly||this.DrawTouchPoints()},this.DeleteTouchPoint=function(e){for(var t=0;t<this.touchpoints.length;t++)this.touchpoints[t].isend===e&&(this.touchpoints[t].destroy(),this.touchpoints[t].isdestroyed=!0)},this.Delete=function(){this.from.UnregisterTransition(this),this.to.UnregisterTransition(this),this.control.destroy(),void 0!=this.activePoint.ToolTip&&this.activePoint.ToolTip.destroy(),this.activePoint.destroy();for(var e=0;e<this.touchpoints.length;e++)this.touchpoints[e].destroy();var t=this.graph.data.Transitions.indexOf(this.item);t>=0&&this.graph.data.Transitions.splice(t,1),t=this.manager.ItemControls.indexOf(this),t>=0&&this.manager.ItemControls.splice(t,1)},this._onDelete=function(){t.graph.confirm(WorkflowDesignerConstants.DeleteConfirmCurrent,function(){t.Delete(),t.graph.onSelectionChanged(),t.graph.redrawAll(),t.graph.StoreGraphData()})},this.Select=function(){if(1!=this.selected){var e=this;if(e.oldstroke=this.line.getStroke(),e.line.setStroke(WorkflowDesignerConstants.SelectColor),e.line.setStrokeWidth(3),void 0==e.bar){var t=e.graph.Settings.imagefolder,i=-15,n=[{img:t+"wfe.settings.png",click:function(){e.ShowProperties()}}];e.graph.Settings.readonly||(n.push({img:t+"wfe.delete.png",click:function(){e._onDelete()}}),i=-30),e.bar=WorkflowDesignerBar(e.manager.APLayer,n,{x:i,y:-50}),e.activePoint.add(e.bar)}else this.bar.show();e.selected=!0}},this.Deselect=function(){0!=this.selected&&(this.line.setStrokeWidth(2),void 0!=this.oldstroke&&this.line.setStroke(this.oldstroke),void 0!=this.bar&&this.bar.hide(),this.selected=!1)},this._moveTouchPoints=function(e,t,i){var n=i?{x:t[t.length-2],y:t[t.length-1]}:{x:t[0],y:t[1]},o=i?{x:t[t.length-4],y:t[t.length-3]}:{x:t[2],y:t[3]},a={x:0,y:0},r=i?24:10;n.x==o.x?n.y<o.y?a.y=r:a.y=-r:n.y==o.y&&(n.x<o.x?a.x=r:a.x=-r),e.setPosition(n),e.circle.setPosition(a)},this._createTouchPoint=function(e,t,i){var n=this,o=i?{x:e[e.length-2],y:e[e.length-1]}:{x:e[0],y:e[1]},a=i?{x:e[e.length-4],y:e[e.length-3]}:{x:e[2],y:e[3]},r={x:0,y:0},s=i?24:10;o.x==a.x?o.y<a.y?r.y=s:r.y=-s:o.y==a.y&&(o.x<a.x?r.x=s:r.x=-s);var l=new Konva.Group({x:o.x,y:o.y,draggable:!0});l.isend=i;var d=this.GetColor(),c=new Konva.Circle({x:r.x,y:r.y,radius:5,fill:d});l.add(c),l.circle=c,l.transition=t;var h=function(){var e=n.graph.CorrectPossition(c.getAbsolutePosition(),n.manager.Layer);i?n.DrawTransition(void 0,e):n.DrawTransition(e,void 0),n.DrawActivePoint(),n.DeleteTouchPoint(!i),n.manager.batchDraw()};return l.on("dragmove",function(){h()}),l.on("dragend",function(){var e=c.getAbsolutePosition(),t=n.manager.getIntersectingActivity(e);void 0!=t&&(n.middle=void 0,n.Sync(),i?(n.to.UnregisterTransition(n),n.setTo(t),n.to.RegisterTransition(n)):(n.from.UnregisterTransition(n),n.setFrom(t),n.from.RegisterTransition(n)),n.graph.StoreGraphData()),n.Draw(),n.manager.batchDraw()}),l},this._moveActivePoint=function(e,t){this.activePoint.setPosition({x:e,y:t})},this._createActivePoint=function(e,t,i){var n=this,o=!n.graph.Settings.disableobjectmovements,a=new Konva.Group({x:e,y:t,draggable:o}),r="",s=this.item.Trigger.Type.toLowerCase();"auto"===s?r+="A":"command"===s?r+="C":"timer"===s&&(r+="T");var l=this.item.Conditions[0].Type.toLowerCase();"always"===l?r+="A":"action"===l?r+="C":"otherwise"===l&&(r+="O"),Array.isArray(this.item.Restrictions)&&this.item.Restrictions.length>0&&(r+="R");var d=new Konva.Rect({x:3==r.length?-22:-16,y:-15,width:3==r.length?47:34,height:30,fill:n.GetColor(),cornerRadius:15});a.add(d);var c=new Konva.Text({x:3==r.length?-16:-10,y:-7,text:r,fontSize:16,fontFamily:"Arial",fill:"#FFFFFF",fontStyle:"bold"});a.add(c),a.transition=i;var h=function(e,t){var i=n.graph.CorrectPossition(a.getAbsolutePosition(),n.manager.Layer);n.middle=i,n.DrawTransition(),n.graph.Settings.readonly||n.DrawTouchPoints(),e&&(n.DrawActivePoint(),n.Sync()),n.manager.batchDraw()},m=function(e){if(!n.graph.Settings.disableobjectmovements){var t=n.selected;e.evt.ctrlKey||n.graph.DeselectAll(),t?n.Deselect():n.Select(),void 0!=n.activePoint.ToolTip&&n.activePoint.ToolTip.hide(),n.graph.onSelectionChanged(),n.manager.batchDraw()}};if(a.on("click",m),a.on("touchend",m),a.on("dblclick",function(){n.graph.DeselectAll(),n.Select(),n.manager.batchDraw(),n.graph.Settings.notshowwindows||n.ShowProperties()}),a.on("dragstart",function(){n.graph.Settings.disableobjectmovements||void 0!=n.activePoint.ToolTip&&n.activePoint.ToolTip.hide()}),a.on("dragmove",function(){n.graph.Settings.disableobjectmovements||h(!1)}),a.on("dragend",function(){n.graph.Settings.disableobjectmovements||h(!0)}),1==n.graph.getParam("exinfo"))n.createExInfo(a);else{var g=this.item.Trigger.Type;void 0!=n.item.Trigger&&void 0!=n.item.Trigger.Command&&"Command"===n.item.Trigger.Type&&(g+=" "+n.item.Trigger.Command.Name),void 0!=n.item.Trigger&&void 0!=n.item.Trigger.Timer&&"Timer"===n.item.Trigger.Type&&(g+=" "+n.item.Trigger.Timer.Name),g+="\r\n"+this.item.Conditions[0].Type,void 0!=n.item.Conditions[0]&&"Action"===n.item.Conditions[0].Type&&(g+=" "+n.item.Conditions[0].Action.ActionName),WorkflowDesignerTooltip(n.manager.APLayer,a,g,17)}return a},this.createExInfo=function(e){var i="";if(void 0!=t.item.Trigger&&void 0!=t.item.Trigger.Command&&"Command"===t.item.Trigger.Type&&(Array.isArray(t.item.Restrictions)&&t.item.Restrictions.length>0&&t.item.Restrictions.forEach(function(e){if(void 0!=e.Actor){var t=e.Actor.Name;
"Restrict"==e.Type&&(t="("+t+")"),i.length>0&&(i+=", "),i+=t}}),i.length>0&&(i+=" -> "),i+=t.item.Trigger.Command.Name),void 0!=t.item.Trigger&&void 0!=t.item.Trigger.Timer&&"Timer"===t.item.Trigger.Type){i+=" "+t.item.Trigger.Timer.Name;var n=t.item.Trigger.Timer.Value;void 0!=n&&""!=n&&(i+=" "+n)}if(i.length>0){var o=new Konva.Text({x:0,y:-30,text:i,fontFamily:"Arial",fontSize:12,fill:"#4A4A4A",fontStyle:"bold"});o.setX(-Number(o.getWidth()/2)),e.add(o)}var a="";if(Array.isArray(t.item.Conditions)&&t.item.Conditions.length>0&&t.item.Conditions.forEach(function(e){if(void 0!=e.Action){var t=e.Action.ActionName;1==e.ConditionInversion&&(t="("+t+")"),a.length>0&&(a+=", "),a+=t}}),a.length>0){var o=new Konva.Text({x:0,y:20,text:a,fontFamily:"Arial",fontSize:12,fill:"#4A4A4A",fontStyle:"bold"});o.setX(-Number(o.getWidth()/2)),e.add(o)}},this._getLineLength=function(e,t,i,n){return Math.sqrt(Math.pow(i-e,2)+Math.pow(n-t,2))},this._getBendingKoeff=function(e,t,i,n,o,a){var r=t-n,s=i-e,l=e*n-i*t;s<=0&&(r=-r,s=-s,l=-l);var d=-(l+r*o)/s,c=d<a?-1:1,h=this._getLineLength(e,t,i,n),m=(e+i)/2,g=(t+n)/2,u=this._getLineLength(m,g,o,a),p=u/h*c;return 0==s&&(p=-p),p},this.getIntersectingRect=function(e){var t=this.activePoint.getAbsolutePosition();return t.x>=e.xl&&t.x<e.xr&&t.y>=e.yl&&t.y<e.yr},this.ShowProperties=function(){var e=WorkflowDesignerConstants.TransitionFormLabel,i={type:"form",title:e.Title,data:this.item,readonly:this.graph.Settings.readonly,elements:[{type:"group",elements:[{name:e.Name,field:"Name",type:"input",width:"100%"},{name:e.Classifier,field:"Classifier",type:"select",width:"100%",datasource:["Direct","Reverse","NotSpecified"]}]},{type:"group",elements:[{name:e.From,field:"From.Name",type:"select",displayfield:"Name",datasource:t.graph.data.Activities,width:"100%"},{name:e.To,field:"To.Name",type:"select",displayfield:"Name",datasource:t.graph.data.Activities,width:"100%"}]},{field:"Trigger",code:"trigger",type:"form",datadefault:{Type:"Command"},elements:[{type:"group",elements:[{name:e.Trigger,code:"triggertype",field:"Type",type:"select",datasource:["Auto","Command","Timer"]},{name:e.TriggerCommand,code:"triggercommand",field:"Command.Name",type:"select",displayfield:"Name",datasource:t.graph.data.Commands},{name:e.TriggerTimer,code:"triggertimer",field:"Timer.Name",type:"select",displayfield:"Name",datasource:t.graph.data.Timers}]}]},{name:e.Restrictions,field:"Restrictions",code:"restrictions",type:"table",datadefault:{Type:"Allow"},elements:[{name:e.RestrictionsType,code:"resttype",field:"Type",type:"select",datasource:["Allow","Restrict"]},{name:e.RestrictionsActor,code:"restactor",field:"Actor.Name",type:"select",displayfield:"Name",datasource:t.graph.data.Actors}]},{type:"group",elements:[{name:e.AllowConcatenationType,field:"AllowConcatenationType",type:"select",datasource:["And","Or"]},{name:e.RestrictConcatenationType,field:"RestrictConcatenationType",type:"select",datasource:["And","Or"]}]},{name:e.Condition,field:"Conditions",code:"condition",type:"table",datadefault:{Type:"Always",ResultOnPreExecution:"Null"},elements:[{name:e.ConditionType,code:"conditiontype",field:"Type",type:"select",datasource:["Always","Action","Otherwise"]},{name:e.ConditionAction,code:"conditionaction",field:"Action.ActionName",type:"select",datasource:t.graph.getConditionNames()},{name:e.ConditionActionParameter,code:"conditionactionparameter",field:"Action.ActionParameter",type:"json",openautocompleteonclick:!0,datasource:function(e,i){var n=$(this.element[0]).closest("tr"),o=n.find("[name=conditionaction]")[0].value;i(t.graph.getAutoCompleteSuggestions("conditionparameter",o,e.term))}},{name:e.ConditionInversion,code:"conditioninversion",field:"ConditionInversion",type:"checkbox"},{name:e.ResultOnPreExecution,code:"conditionresult",field:"ResultOnPreExecution",type:"select",datasource:["True","False"]}],onrowadded:function(e){var t=e.find("[name=conditiontype]"),i=e.find("[name=conditionaction]"),n=e.find("[name=conditionresult]"),o=e.find("[name=conditionactionparameter]").parent().parent(),a=e.find("[name=conditioninversion]").parent(),r=function(){var e=t[0].value;"Action"==e?(i.show(),n.show(),o.show(),a.show()):(i.hide(),n.hide(),o.hide(),a.hide())};t.on("change",r),r()}},{type:"group",elements:[{name:e.ConditionsConcatenationType,field:"ConditionsConcatenationType",type:"select",datasource:["And","Or"]}]},{type:"group",elements:[{name:e.IsFork,field:"IsFork",code:"isfork",type:"checkbox"},{name:e.MergeViaSetState,field:"MergeViaSetState",code:"mergeviasetstate",type:"checkbox"},{name:e.DisableParentStateControl,field:"DisableParentStateControl",code:"disableparentstatecontrol",type:"checkbox"}]}],renderFinalFunc:function(e,t){var i=e.find("[name=restrictions]").parent(),n=e.find("[name=triggertype]"),o=e.find("[name=isfork]"),a=e.find("[name=triggercommand]"),r=e.find("[name=triggertimer]"),s=e.find("[name=AllowConcatenationType]").parent().parent(),l=e.find("[name=ConditionsConcatenationType]").parent().parent(),d=e.find("[name=mergeviasetstate]").parent().parent(),c=e.find("[name=disableparentstatecontrol]").parent().parent(),h=function(){var e=function(e){return e.prev()},o=n[0].value;"Command"==o?(a.show(),e(a).show(),r.hide(),e(r).hide(),i.show()):"Timer"==o?(a.hide(),e(a).hide(),r.show(),e(r).show(),i.hide(),s.hide()):(a.hide(),e(a).hide(),r.hide(),e(r).hide(),i.hide(),s.hide()),WorkflowDesignerCommon.modal(t.window,"refresh")};n.on("change",h),h();var m=function(){var e=o[0].checked;e?(d.show(),c.show()):(d.hide(),c.hide())};o.on("change",m),m();var g=s.find("[name=AllowConcatenationType]")[0].value.toLowerCase(),u=s.find("[name=RestrictConcatenationType]")[0].value.toLowerCase(),p=l.find("[name=ConditionsConcatenationType]")[0].value.toLowerCase();"and"===g&&"and"===u&&s.hide();var f=e.find("[name=restrictions]").parent(),v=$('<a class="btnConcatParameters"></a>');v[0].innerText=WorkflowDesignerConstants.TransitionFormLabel.ShowConcatParameters,v.on("click",function(){s.is(":visible")?(s.hide(),v[0].innerText=WorkflowDesignerConstants.TransitionFormLabel.ShowConcatParameters):(s.show(),v[0].innerText=WorkflowDesignerConstants.TransitionFormLabel.HideConcatParameters),WorkflowDesignerCommon.modal(t.window,"refresh")}),f.append("&nbsp;"),f.append(v),"and"===p&&l.hide();var y=e.find("[name=condition]").parent(),w=$('<a class="btnConcatParameters"></a>');w[0].innerText=WorkflowDesignerConstants.TransitionFormLabel.ShowConcatParameters,w.on("click",function(){l.is(":visible")?(l.hide(),w[0].innerText=WorkflowDesignerConstants.TransitionFormLabel.ShowConcatParameters):(l.show(),w[0].innerText=WorkflowDesignerConstants.TransitionFormLabel.HideConcatParameters),WorkflowDesignerCommon.modal(t.window,"refresh")}),y.append("&nbsp;"),y.append(w),WorkflowDesignerCommon.modal(t.window,"refresh")},graph:t.graph},n=new WorkflowDesignerForm(i),o=function(e,i){var n=!0;n&=e.CheckRequired([i],["Name"],WorkflowDesignerConstants.FieldIsRequired),n&=e.CheckRequired([i],["Classifier"],WorkflowDesignerConstants.FieldIsRequired);var o=["Type"];"Command"==i.Trigger.Type?o.push("Command.Name"):"Timer"==i.Trigger.Type&&o.push("Timer.Name"),n&=e.CheckRequired([i.Trigger],o,WorkflowDesignerConstants.FieldIsRequired),i.Conditions.forEach(function(t){o=["Type"],"Action"==t.Type&&o.push("Action.ActionName"),n&=e.CheckRequired([t],o,WorkflowDesignerConstants.FieldIsRequired),"Always"==t.Type&&i.Conditions.length>1?(n=!1,e.ControlAddError(t.control_Type,WorkflowDesignerConstants.AlwaysConditionShouldBeSingle)):"Otherwise"==t.Type&&i.Conditions.length>1&&(n=!1,e.ControlAddError(t.control_Type,WorkflowDesignerConstants.OtherwiseConditionShouldBeSingle))});var a=i.control_Conditions.parent().children("label");return!i.Conditions.length>0?(a.attr("title",WorkflowDesignerConstants.TransitionFormLabel.ConditionsListShouldNotBeEmpty),a.css("cssText","color: red !important;"),n=!1):(a.attr("title",void 0),a.css("color","")),t.graph.data.Transitions.forEach(function(o){o!=t.item&&o.Name==i.Name&&(n=!1,e.ControlAddError(i.control_Name,WorkflowDesignerConstants.FieldMustBeUnique))}),e.CheckRequired(i.Restrictions,["Type","Actor.Name"],WorkflowDesignerConstants.FieldIsRequired)||(n=!1),n},a=function(e){return!!o(n,e)&&(n.ClearTempField(e),t.item.Name=e.Name,t.item.From={Name:e.From.Name},t.item.To={Name:e.To.Name},t.item.Classifier=e.Classifier,t.item.Restrictions=e.Restrictions,t.item.Trigger=e.Trigger,t.item.Conditions=e.Conditions,t.item.IsFork=e.IsFork,t.item.MergeViaSetState=e.MergeViaSetState,t.item.DisableParentStateControl=e.DisableParentStateControl,t.item.ConditionsConcatenationType=e.ConditionsConcatenationType,t.item.AllowConcatenationType=e.AllowConcatenationType,t.item.RestrictConcatenationType=e.RestrictConcatenationType,WorkflowDesignerCommon.DataCorrection(t.graph.data),t.graph.Draw(t.graph.data),t.graph.StoreGraphData(),!0)};n.showModal(a)},this.Sync=function(){t.item.DesignerSettings.Bending=t.bending,void 0!=t.middle&&(t.item.DesignerSettings.X=t.middle.x,t.item.DesignerSettings.Y=t.middle.y)},this.destroy=function(){this.control.destroy(),this.activePoint.destroy(),this.touchpoints.forEach(function(e){e.destroy()}),void 0!=this.bar&&this.bar.destroy()}}function WorkflowDesignerTransitionManagerTempControl(e){this.x=e.x,this.y=e.y,this.manager=e.manager,this.control=void 0,this.Draw=function(e,t){this.control=new Konva.Group({x:0,y:0,rotation:0}),this.line=new Konva.Line({points:[this.x,this.y,e,t],stroke:"#FFCC99",strrokeWidth:1});var i=Math.atan2(t-this.y,e-this.x);this.arrow=WorkflowDesignerCommon.createArrowByAngle(e,t,i,20,"#FFCC99"),this.control.add(this.line),this.control.add(this.arrow),this.manager.Layer.add(this.control)},this.Redraw=function(e){this.line.setPoints([this.x,this.y,e.x,e.y]);var t=Math.atan2(e.y-this.y,e.x-this.x);WorkflowDesignerCommon.updateArrowByAngle(this.arrow,e.x,e.y,t,20,"#FFCC99")},this.Delete=function(){this.control.destroy()}}function WorkflowDesignerActivityManager(){this.type="WorkflowDesignerActivityManager",this.init=function(e){this.graph=e,this.Layer=new Konva.Layer,this.graph.Stage.add(this.Layer),this.Layer.setZIndex(1),this.ImageImplementation=WorkflowDesignerCommon.loadImage(this.graph.Settings.imagefolder+"wfe.implementation.png"),this.ImageImplementationWhite=WorkflowDesignerCommon.loadImage(this.graph.Settings.imagefolder+"wfe.implementation.white.png")},this.ItemControls=new Array,this.draw=function(){null!=this.ItemControls&&this.ItemControls.forEach(function(e){e.destroy()}),this.ItemControls=new Array;var e=this;void 0!=this.graph.data.Activities&&this.graph.data.Activities.forEach(function(t){var i,n;if(""!=t.DesignerSettings.X&&""!=t.DesignerSettings.Y)i=Number(t.DesignerSettings.X),n=Number(t.DesignerSettings.Y);else{var o=e.GetDefaultPosition();i=o.x,n=o.y}var a=new WorkflowDesignerActivityControl({x:i,y:n,item:t,graph:e.graph,manager:e});e.ItemControls.push(a),a.Draw(),a.Sync()}),this.Layer.batchDraw()},this.CreateNewActivity=function(e,t){void 0==e&&(e=this.GetDefaultPosition()),void 0==t&&(t={IsAutoSchemeUpdate:!0,IsForSetState:!0}),void 0==t.Name&&(t.Name=this.GetDefaultName()),0==this.graph.data.Activities.length&&(t.IsInitial=!0),t.DesignerSettings&&(t.DesignerSettings=new{X:e.x,Y:e.y});var i=new WorkflowDesignerActivityControl({x:e.x,y:e.y,item:t,graph:this.graph,manager:this});return this.graph.data.Activities.push(t),this.ItemControls.push(i),i.Draw(),i.Sync(),i},this.GetDefaultName=function(){for(var e=WorkflowDesignerConstants.ActivityNamePrefix,t=1,i=0;i<this.graph.data.Activities.length;i++){var n=this.graph.data.Activities[i];n.Name==e+t&&(t++,i=-1)}return e+t},this.GetDefaultPosition=function(){for(var e=this.graph.CorrectPossition({x:60,y:100},this.Layer),t=2*this.graph.Settings.DefaultMoveStep/this.Layer.getScaleX(),i=0;i<this.ItemControls.length;i++){var n=this.ItemControls[i].control.getPosition();n.x==e.x&&n.y==e.y&&(e.x+=t,e.y+=t,i=-1)}return e},this.find=function(e){if("object"==typeof e&&void 0!=e.Name)return this.find(e.Name);for(var t=0;t<this.ItemControls.length;t++)if(this.ItemControls[t].GetName()==e)return this.ItemControls[t]},this.getIntersectingActivity=function(e){for(var t=0;t<this.ItemControls.length;t++){var i=this.ItemControls[t];if(i.getIntersectingActivity(e))return i}},this.LayerSetOffset=function(e){this.Layer.setOffset(e)},this.LayerScale=function(e){this.Layer.setScale({x:this.Layer.getScale().x+e,y:this.Layer.getScale().y+e})},this.LayerScaleNorm=function(){this.Layer.setScale({x:1,y:1}),this.Layer.setOffset({x:0,y:0})},this.redrawTransitions=function(){return void 0==this.cTransition&&(this.cTransition=this.graph.GetComponentByType("WorkflowDesignerTransitionManager")),this.cTransition.batchDraw()},this.batchDraw=function(){this.Layer.batchDraw()},this.DeselectAll=function(){this.ItemControls.forEach(function(e){e.Deselect()})},this.GetSizeForSaveAsImage=function(e){for(var t=0;t<this.ItemControls.length;t++){var i=this.ItemControls[t],n=i.rectangle.getAbsolutePosition(),o=n.x,a=n.y,r=o+i.rectangle.getWidth()*this.Layer.getScaleX(),s=a+i.rectangle.getHeight()*this.Layer.getScaleX();o<e.x1&&(e.x1=o),a<e.y1&&(e.y1=a),r>e.x2&&(e.x2=r),s>e.y2&&(e.y2=s)}return e},this.GetSelected=function(){var e=new Array;return this.ItemControls.forEach(function(t){t.selected&&e.push(t)}),e},this.SelectByPosition=function(e){this.ItemControls.forEach(function(t){t.getIntersectingActivityRect(e)&&t.Select()})},this.SelectByItem=function(e){this.ItemControls.forEach(function(t){t.item==e&&t.Select()})},this.ObjectMove=function(e){this.ItemControls.forEach(function(t){t.selected&&e.sender!=t&&t.ObjectMove(e.changepos)}),this.redrawTransitions()},this.createTransitionAndActivity=function(e){var t={x:e.control.getX()+e.rectangle.attrs.width+100,y:e.control.getY()},i=this.CreateNewActivity(t),n=this.graph.GetComponentByType("WorkflowDesignerTransitionManager");n.CreateNewTransition(e,i),this.graph.redrawAll()},this.createTransition=function(e){var t=this.graph.GetComponentByType("WorkflowDesignerTransitionManager");return t.CreateNewTransition(e)},this.Clone=function(e){var t=JSON.parse(JSON.stringify(e.item));t.DesignerSettings.Y+=160,t.Name=this.CopySelectedGenUniqueValue(t.Name,this.graph.data.Activities,"Name"),this.graph.data.Activities.push(t),this.graph.Draw(this.graph.data),this.SelectByItem(t)},this.CopySelectedGenUniqueValue=function(e,t,i){for(var n=e,o=1;!0;o++){for(var a=!1,r=0;r<t.length;r++)if(t[r][i]==n){a=!0;break}if(!a)break;n=e+"_"+o}return n}}function WorkflowDesignerBackground(){this.type="WorkflowDesignerBackground",this.init=function(e){var t=this;this.graph=e,this.BackgroundLayer=new Konva.Layer,this.graph.Stage.add(this.BackgroundLayer),this.BackgroundLayer.setZIndex(0),this.SelectionLayer=new Konva.Layer,this.graph.Stage.add(this.SelectionLayer),this.SelectionLayer.setZIndex(1),WorkflowDesignerCommon.loadImage(this.graph.Settings.imagefolder+"wfe.grid.png",function(e){t.RectBG.setFillPatternImage(e),t.BackgroundLayer.batchDraw()}),this.RectBG=new Konva.Rect({x:0,y:0,width:5e3,height:5e3,draggable:!1,dragBoundFunc:function(e){var i=t.graph.Settings.DefaultMoveStep*t.BackgroundLayer.getScaleX(),n=t.graph.Settings.DefaultMoveStep*t.BackgroundLayer.getScaleY(),o={x:Math.round(e.x/i)*i,y:Math.round(e.y/n)*n};return t.graph.GraphLayerSetOffset(-o.x/t.BackgroundLayer.getScaleX(),-o.y/t.BackgroundLayer.getScaleY()),o},designerparam:"background"}),this.BackgroundLayer.add(this.RectBG),this.BackgroundLayer.batchDraw(),this.graph.Stage.on("mousedown.background",function(e){"background"===e.target.attrs.designerparam&&(1!=t._movemodeenabled?t._mousedownpos=t.graph.CorrectPossition({x:e.evt.offsetX,y:e.evt.offsetY},t.SelectionLayer):t.graph.DeselectAll())}),this.graph.Stage.on("mousemove.background",function(e){if(1!=t._movemodeenabled&&void 0!=t._mousedownpos){var i=t.graph.CorrectPossition({x:e.evt.offsetX,y:e.evt.offsetY},t.SelectionLayer);t.DrawSelectionRect(i)}}),this.graph.Stage.on("mouseup.background",function(e){if(!t._movemodeenabled&&void 0!=t._mousedownpos){var i=t.getSelectionRectPos();void 0==i?e.evt.ctrlKey||t.graph.DeselectAll():(Math.abs(i.xl-i.xr)>10||Math.abs(i.yl-i.yr)>10)&&(t.graph.DeselectAll(),t.graph.ComponentsExecute("SelectByPosition",i),t.graph.onSelectionChanged())}t._mousedownpos=void 0,t.DeleteSelectionRect()})},this.setMoveModeEnabled=function(e){this._movemodeenabled=Boolean(e),this.RectBG.setDraggable(this._movemodeenabled),this.graph.setParam("movemodeenabled",this._movemodeenabled)},this.setPosition=function(e){this.RectBG.setPosition({x:-e.x,y:-e.y}),this.graph.ComponentsExecute("LayerSetOffset",{x:e.x,y:e.y})},this.LayerScale=function(e){this.BackgroundLayer.setScale({x:this.BackgroundLayer.getScale().x+e,y:this.BackgroundLayer.getScale().y+e})},this.LayerScaleNorm=function(){this.BackgroundLayer.setScale({x:1,y:1}),this.SelectionLayer.setScale({x:1,y:1}),this.RectBG.setPosition({x:0,y:0})},this.DrawSelectionRect=function(e){void 0==this.RectSelection?(this.RectSelection=new Konva.Rect({x:this._mousedownpos.x,y:this._mousedownpos.y,width:e.x-this._mousedownpos.x,height:e.y-this._mousedownpos.y,draggable:!1,fill:"#66CCFF",opacity:.2}),this.SelectionLayer.add(this.RectSelection)):(this.RectSelection.setWidth(e.x-this._mousedownpos.x),this.RectSelection.setHeight(e.y-this._mousedownpos.y)),this.SelectionLayer.batchDraw()},this.DeleteSelectionRect=function(e){this.RectSelection&&(this.RectSelection.destroy(),this.RectSelection=void 0,this.SelectionLayer.batchDraw())},this.getSelectionRectPos=function(){if(void 0!=this.RectSelection){var e=this.RectSelection.getAbsolutePosition(),t=e.x,i=e.y,n=t+this.RectSelection.getWidth()*this.SelectionLayer.getScaleX(),o=i+this.RectSelection.getHeight()*this.SelectionLayer.getScaleX();return{xl:Math.min(t,n),yl:Math.min(i,o),xr:Math.max(t,n),yr:Math.max(i,o)}}}}function WorkflowDesignerTooltip(e,t,i,n,o){t.destroyToolTip=function(){void 0!=this.ToolTip&&(this.ToolTip.destroy(),this.ToolTip=void 0,e.batchDraw())};var a=function(e,t){if(0==t.getScaleX()||0==t.getScaleY())return{x:t.getOffsetX(),y:0};var i=void 0==o?0:o;return{x:e.x/t.getScaleX()+t.getOffsetX()+i,y:e.y/t.getScaleY()+t.getOffsetY()}};t.on("mouseover",function(){if(void 0!=t.ToolTip){var o=a(t.getAbsolutePosition(),e);t.ToolTip.position({x:o.x+t.getWidth()/2,y:o.y+n,opacity:1}),t.ToolTip.show()}else{var o=a(t.getAbsolutePosition(),e),r=new Konva.Label({x:o.x+t.getWidth()/2,y:o.y+n,opacity:1});r.add(new Konva.Tag({fill:"#3D4D59",pointerDirection:"up",pointerWidth:13,pointerHeight:7,lineJoin:"round",shadowColor:"#3D4D59",shadowBlur:10,shadowOffset:10,shadowOpacity:0,cornerRadius:5})),r.add(new Konva.Text({text:i,fontFamily:"Arial",fontSize:12,padding:5,fill:"white"})),e.add(r),t.ToolTip=r}e.batchDraw()}),t.on("mouseleave",function(){void 0!=t.ToolTip&&(t.ToolTip.hide(),e.batchDraw())})}function WorkflowDesignerBar(e,t,i,n){var o="v"==n,a=new Konva.Group({x:i.x,y:i.y}),r=new Konva.Rect({x:0,y:0,width:o?30:30*t.length,height:o?30*t.length:30,fill:WorkflowDesignerConstants.BarColor,cornerRadius:5});a.add(r);var s=5,l=5,d=0;return t.forEach(function(t){if(t.offset=d,1==t.separator){d+=10;var i=o?[s,t.offset+l,s+20,t.offset+l]:[t.offset+s,l,t.offset+s,20+l];t.cObject=new Konva.Line({points:i,stroke:WorkflowDesignerConstants.BarSeparatorColor,strokeWidth:2}),a.add(t.cObject)}else d+=30,WorkflowDesignerCommon.loadImage(t.img,function(i){var n=o?{x:s,y:t.offset+l}:{x:s+t.offset,y:l};[t.offset+s,l,t.offset+s,20+l],t.group=new Konva.Group({x:n.x-s,y:n.y-l,width:30,height:30}),t.bg=new Konva.Rect({x:0,y:0,width:30,height:30,cornerRadius:5}),1==t.active&&t.bg.setFill(WorkflowDesignerConstants.ButtonActive),t.group.add(t.bg),t.cImageToolbar=new Konva.Image({x:s,y:l,image:i,width:20,height:20,strokeWidth:0}),t.group.add(t.cImageToolbar);var r=function(){void 0!=t.cImageToolbar.ToolTip&&t.cImageToolbar.ToolTip.hide(),void 0!=t.click&&t.click()};t.group.on("click",r),t.group.on("touchend",r),t.group.on("mouseover",function(){t.bg.setFill(WorkflowDesignerConstants.ButtonActive),e.batchDraw()}),t.group.on("mouseleave",function(){void 0!=t.active&&0!=t.active||(t.bg.setFill(""),e.batchDraw())}),t.group.add(t.cImageToolbar),a.add(t.group),void 0!=t.title&&""!=t.title&&WorkflowDesignerTooltip(e,t.cImageToolbar,t.title,30),e.batchDraw()})}),1==o?r.setHeight(d):r.setWidth(d),a}function WorkflowDesignerToolbar(){this.type="WorkflowDesignerToolbar";var e=this;this.init=function(t){this.graph=t,this.Layer=new Konva.Layer,this.graph.Stage.add(this.Layer),this.Layer.setZIndex(10),this.InitItems(),e.background=new Konva.Rect({x:0,y:0,width:this.graph.Settings.graphwidth,height:50,fill:WorkflowDesignerConstants.BarColor,shadowEnabled:!0,shadowBlur:5,shadowOpacity:.3}),e.Layer.add(e.background);var i=0,n=15;this.MainToolbarDraw(i,n),e.SideToolbar=WorkflowDesignerBar(e.Layer,e.SideItems,{x:e.graph.Settings.graphwidth-60,y:70},"v"),e.Layer.add(e.SideToolbar),this.CreateInfoBlock({x:this.graph.Settings.graphwidth-100,y:n-13});var o=this.GetWorkflowDesignerBackground();void 0!=o&&o.RectBG.setDraggable(!1),1==this.graph.getParam("movemodeenabled")&&e.ToolbarMovePress(),1==this.graph.getParam("exinfo")&&e.ToolbarExInfoPress()},this.MainToolbarDraw=function(e,t){var i=this,n=0;this.Items.forEach(function(o){o.offset=n,1==o.separator?(n+=1,o.cObject=new Konva.Line({points:[e+o.offset,0,e+o.offset,50],stroke:WorkflowDesignerConstants.BarSeparatorColor,strokeWidth:2}),i.Layer.add(o.cObject)):(n+=50,WorkflowDesignerCommon.loadImage(o.img,function(n){o.group=new Konva.Group({x:e+o.offset,y:t-15,width:50,height:50}),o.bg=new Konva.Rect({x:0,y:0,width:50,height:50,cornerRadius:0}),o.group.add(o.bg),1==o.active&&o.bg.setFill(WorkflowDesignerConstants.ButtonActive),o.cImageToolbar=new Konva.Image({x:15,y:15,image:n,width:20,height:20,strokeWidth:0}),1==o.disabled&&o.cImageToolbar.opacity(.3),o.group.add(o.cImageToolbar),o.group.on("click",function(){o.disabled!==!0&&void 0!=o.click&&o.click(o)}),o.group.on("touchend",function(){o.disabled!==!0&&void 0!=o.click&&o.click(o)}),o.group.on("mouseover",function(){1!=o.disabled&&(o.bg.setFill(WorkflowDesignerConstants.ButtonActive),i.Layer.batchDraw())}),o.group.on("mouseleave",function(){void 0!=o.active&&0!=o.active||(o.bg.setFill(""),i.Layer.batchDraw())}),i.Layer.add(o.group),WorkflowDesignerTooltip(i.Layer,o.group,o.title,55,0==o.offset?20:0),i.Layer.batchDraw()}))})},this.draw=function(){this.GraphRedrawAll()},this.GraphRedrawAll=function(){this.UpdateInfoBlock(),this.Layer.batchDraw()},this.changeWidth=function(e){this.background.width(e),this.info.position({x:e-100,y:2}),this.SideToolbar.position({x:e-60,y:70})},this.CreateInfoBlock=function(e){this.infoText=new Konva.Text({text:this.GetInfoBlockText(),fontFamily:"Arial",fontSize:12,padding:5,fill:"black"}),this.infoTextValue=new Konva.Text({text:this.GetInfoBlockTextValue(),fontFamily:"Arial",fontSize:12,padding:5,fill:"black",x:60}),this.info=new Konva.Group(e),this.info.add(this.infoText),this.info.add(this.infoTextValue),this.Layer.add(this.info)},this.UpdateInfoBlock=function(e){this.infoTextValue.setText(this.GetInfoBlockTextValue())},this.GetInfoBlockText=function(){return WorkflowDesignerConstants.InfoBlockLabel.Activity+"\r\n"+WorkflowDesignerConstants.InfoBlockLabel.Transition+"\r\n"+WorkflowDesignerConstants.InfoBlockLabel.Command},this.GetInfoBlockTextValue=function(){var e=0,t=0,i=0;void 0!=this.graph.data&&(e=this.graph.data.Activities.length,t=this.graph.data.Transitions.length,i=this.graph.data.Commands.length);var n=[e,t,i],o="";return n.forEach(function(e){for(var t="",i=e.toString(),n=0;n<4-i.length;n++)t+="  ";o.length>0&&(o+="\r\n"),o+=t+i}),o},this.ToolbarMovePress=function(){var e=this.GetWorkflowDesignerBackground();e.setMoveModeEnabled(!e._movemodeenabled);var t=this.GetItemByCode("move");e._movemodeenabled?(t.active=!0,void 0!=t.bg&&t.bg.setFill(WorkflowDesignerConstants.ButtonActive)):(t.active=void 0,void 0!=t.bg&&t.bg.setFill("")),this.Layer.batchDraw()},this.ToolbarExInfoPress=function(){var e=this.GetItemByCode("exinfo");this.exinfo?(e.active=void 0,void 0!=e.bg&&e.bg.setFill(""),this.exinfo=!1,this.graph.setParam("exinfo",!1)):(e.active=!0,void 0!=e.bg&&e.bg.setFill(WorkflowDesignerConstants.ButtonActive),this.exinfo=!0,this.graph.setParam("exinfo",!0)),void 0!=this.graph.Draw&&this.graph.Draw(this.graph.data)},this.GetWorkflowDesignerBackground=function(){return this.graph.GetComponentByType("WorkflowDesignerBackground")},this.CreateActivity=function(){var e=this.graph.GetComponentByType("WorkflowDesignerActivityManager");e.CreateNewActivity(),this.graph.redrawAll(),this.graph.StoreGraphData()},this.AutoArrangement=function(){if(0!=e.graph.data.Activities.length){var t=new Array;e.graph.data.Activities.forEach(function(e){e.IsInitial&&t.push(e)}),e.graph.data.Activities.forEach(function(i){if(!i.IsInitial){for(var n=!0,o=0;o<e.graph.data.Transitions.length;o++){var a=e.graph.data.Transitions[o];if("Direct"==a.Classifier&&a.To==i){n=!1;break}}n&&t.push(i)}}),0==t.length&&t.push(e.graph.data.Activities[0]);var i={x:80,y:120},n={x:300,y:140},o=Array(),a=function(t,i,r){var s={x:i.x,y:i.y};r||(s.x+=n.x);for(var l=new Array,d=0;d<t.length;d++){var c=t[d];void 0==c.DesignerSettings&&(c.DesignerSettings={}),!r&&$.inArray(c,o)>=0||(c.DesignerSettings.X=s.x,o.push(c),l.push(c))}for(var d=0;d<l.length;d++){var c=l[d];d>0&&(s.y+=n.y);var h=new Array;e.graph.data.Transitions.forEach(function(e){"Direct"==e.Classifier&&e.From==c&&h.push(e.To)}),c.DesignerSettings.Y=s.y;var m=a(h,{x:s.x,y:s.y});s.y=m.y}return{x:s.x,y:s.y}};a(t,i,!0),e.graph.data.Transitions.forEach(function(e){void 0==e.DesignerSettings&&(e.DesignerSettings={}),e.DesignerSettings.X=void 0,e.DesignerSettings.Y=void 0}),e.graph.Draw(e.graph.data),this.graph.StoreGraphData()}},this.CopySelectedGenUniqueValue=function(e,t,i){for(var n=e,o=1;!0;o++){for(var a=!1,r=0;r<t.length;r++)if(t[r][i]==n){a=!0;break}if(!a)break;n=e+"_"+o}return n},this.CopySelected=function(){var t=this.graph.GetComponentByType("WorkflowDesignerActivityManager"),i=this.graph.GetComponentByType("WorkflowDesignerTransitionManager"),n=t.GetSelected(),o=i.GetSelected();if(0!=n.length||0!=o.length){var a=[];n.forEach(function(t){var i=JSON.parse(JSON.stringify(t.item));i.DesignerSettings.Y+=160,i.Name=e.CopySelectedGenUniqueValue(i.Name,e.graph.data.Activities,"Name"),a.push({oldItem:t.item,newItem:i}),e.graph.data.Activities.push(i)});var r=[];o.forEach(function(t){for(var i=t.item.From,n=t.item.To,o=0;o<a.length;o++)i==a[o].oldItem&&(i=a[o].newItem),n==a[o].oldItem&&(n=a[o].newItem);var s=JSON.parse(JSON.stringify(t.item));s.Name=e.CopySelectedGenUniqueValue(s.Name,e.graph.data.Transitions,"Name"),s.From=i,s.To=n,r.push({oldItem:t.item,newItem:s}),e.graph.data.Transitions.push(s)}),WorkflowDesignerCommon.DataCorrection(e.graph.data),e.graph.Draw(e.graph.data),a.forEach(function(e){t.SelectByItem(e.newItem)}),r.forEach(function(e){i.SelectByItem(e.newItem)}),this.graph.StoreGraphData(),this.graph.onSelectionChanged(!0)}},this.EditLocalization=function(){var t=WorkflowDesignerConstants.LocalizationFormLabel,i={type:"table",title:t.Title,width:"800px",data:this.graph.data.Localization,datadefault:{Culture:WorkflowDesignerConstants.DefaultCulture,Type:"State"},elements:[{name:t.ObjectName,field:"ObjectName",type:"input"},{name:t.Type,field:"Type",type:"select",displayfield:"Name",valuefield:"Value",datasource:[{Name:t.Types[0],Value:"Command"},{Name:t.Types[1],Value:"State"},{Name:t.Types[2],Value:"Parameter"}]},{name:t.IsDefault,field:"IsDefault",type:"checkbox"},{name:t.Culture,field:"Culture",type:"input"},{name:t.Value,field:"Value",type:"input"}],readonly:this.graph.Settings.readonly},n=new WorkflowDesignerForm(i),o=function(t,o){return!(!n.CheckRequired(t,["ObjectName","Type","Culture","Value"],WorkflowDesignerConstants.FieldIsRequired)||!n.CheckUnique(t,["ObjectName","Type","Culture"],WorkflowDesignerConstants.FieldMustBeUnique))&&(n.ClearTempField(t),e.SyncTable(e.graph.data.Localization,t,i),e.graph.StoreGraphData(),!0)};n.showModal(o)},this.EditTimer=function(){var t=WorkflowDesignerConstants.TimerFormLabel,i={type:"table",title:t.Title,width:"800px",data:this.graph.data.Timers,keyproperty:"Name",elements:[{name:t.Name,field:"Name",type:"input"},{name:t.Type,field:"Type",type:"select",datasource:this.graph.data.AdditionalParams.TimerTypes},{name:t.Value,field:"Value",type:"input"},{name:t.NotOverrideIfExists,field:"NotOverrideIfExists",type:"checkbox"}],readonly:this.graph.Settings.readonly},n=new WorkflowDesignerForm(i),o=function(t,o){return!(!n.CheckRequired(t,["Name","Type","Value"],WorkflowDesignerConstants.FieldIsRequired)||!n.CheckUnique(t,["Name"],WorkflowDesignerConstants.FieldMustBeUnique))&&(n.ClearTempField(t),void 0==e.graph.data.Timers&&(e.graph.data.Timers=[]),e.SyncTable(e.graph.data.Timers,t,i),e.graph.Draw(e.graph.data),e.graph.StoreGraphData(),!0)};n.showModal(o)},this.EditActors=function(){var e=this,t=WorkflowDesignerConstants.ActorFormLabel,i={type:"table",title:t.Title,width:"800px",data:this.graph.data.Actors,keyproperty:"Name",elements:[{name:t.Name,field:"Name",type:"input"},{name:t.Rule,field:"Rule",type:"select",datasource:this.graph.getActorNames()},{name:t.Value,field:"Value",type:"json",openautocompleteonclick:!0,datasource:function(t,i){var n=$(this.element[0]).closest("tr"),o=n.find("[name=Rule]")[0].value;i(e.graph.getAutoCompleteSuggestions("ruleparameter",o,t.term))}}],graph:e.graph,readonly:this.graph.Settings.readonly},n=new WorkflowDesignerForm(i),o=function(t,o){return!(!n.CheckRequired(t,["Name","Rule"],WorkflowDesignerConstants.FieldIsRequired)||!n.CheckUnique(t,["Name"],WorkflowDesignerConstants.FieldMustBeUnique))&&(n.ClearTempField(t),e.SyncTable(e.graph.data.Actors,t,i),e.graph.Draw(e.graph.data),e.graph.StoreGraphData(),!0)};n.showModal(o)},this.EditParameters=function(){var e=WorkflowDesignerConstants.ParameterFormLabel,t=this,i=function(e,i,n){for(var o=void 0,a=e.getEditData(e.parameters),r=0;r<a.length;r++){var s=a[r];if(s.control_InitialValue.id===i.id){o=s.Type;break}}void 0!=o&&t.graph.designer.getemptytype(encodeURIComponent(o),n)},n={type:"table",title:e.Title,data:this.graph.data.Parameters,datadefault:{Purpose:"Persistence"},keyproperty:"Name",elements:[{name:e.Name,field:"Name",type:"input"},{name:e.Type,field:"Type",type:"input",datasource:this.graph.getTypeNames(),width:"35%"},{name:e.Purpose,field:"Purpose",type:"select",displayfield:"Name",datasource:[{Name:"Temporary"},{Name:"Persistence"},{Name:"System"}]},{name:e.InitialValue,field:"InitialValue",type:"json",width:"25%",getemptytype:i}],top:$('<div style="float: right; margin-bottom: 15px;"></div>'),beforerowadded:function(e){void 0!=e.Type&&(e.Type=decodeURIComponent(e.Type))},onrowadded:function(e){var t=e.find("[name=Purpose]"),i=t[0];t.change(function(){r(e)}),void 0!=i&&"System"!==i.value&&e.find('[name=Purpose] option[value="System"]').remove(),r(e)},graph:t.graph,readonly:this.graph.Settings.readonly},o=function(){for(var e=$(d.window.find(".WorkflowDesignerTable"))[0],t=0;t<e.rows.length;t++){var i=$(e.rows[t]),n=i.find("[name=Purpose]")[0];void 0!=n&&"System"===n.value&&i.hide()}},a=function(){for(var e=$(d.window.find(".WorkflowDesignerTable"))[0],t=0;t<e.rows.length;t++){var i=$(e.rows[t]),n=i.find("[name=Purpose]")[0];void 0!=n&&"System"===n.value&&i.show()}},r=function(e){var t=e.find("[name=Purpose]")[0];void 0!=t&&"System"===t.value?(e.find(":input").attr("readonly",!0),e.find("[name=Purpose]").attr("disabled",!0),e.find("[name=InitialValue]").val(""),e.find(".btnDelete").remove()):void 0!=t&&"Temporary"===t.value?(e.find("[name=InitialValue]").attr("readonly",!0),e.find("[name=InitialValue]").val("")):void 0!=t&&"Persistence"===t.value&&e.find("[name=InitialValue]").attr("readonly",!1)},s=function(){for(var e=$(d.window.find(".WorkflowDesignerTable"))[0],t=0;t<e.rows.length;t++){var i=$(e.rows[t]);r(i)}},l=function(e,i){if(d.CheckRequired(e,["Name","Type","Purpose","Parameter"],WorkflowDesignerConstants.FieldIsRequired)&&d.CheckUnique(e,["Name"],WorkflowDesignerConstants.FieldMustBeUnique)){
d.ClearTempField(e),t.SyncTable(t.graph.data.Parameters,e,n);for(var o=0;o<t.graph.data.Parameters.length;o++){var a=t.graph.data.Parameters[o].Type;t.graph.data.Parameters[o].Type=encodeURIComponent(a)}return t.graph.Draw(t.graph.data),t.graph.StoreGraphData(),!0}return!1},d=new WorkflowDesignerForm(n),c=$('<div class="ui slider checkbox"></div>'),h=$('<input type="checkbox" />');h.click(function(e,t){var i=h[0].checked;i?a():o(),WorkflowDesignerCommon.modal(d.window,"refresh")}),c.append(h),c.append("<label>"+WorkflowDesignerConstants.ParameterFormLabel.ShowSystemParameters+"</label>"),n.top.append(c),d.showModal(l),o(),s(),WorkflowDesignerCommon.modal(d.window,"refresh")},this.EditCodeActions=function(){var t=WorkflowDesignerConstants.CodeActionsFormLabel,i={type:"table",title:t.Title,data:this.graph.data.CodeActions,datadefault:{},elements:[{name:t.Name,field:"Name",type:"input"},{name:t.Type,field:"Type",type:"select",displayfield:"Name",datasource:[{Name:"Action"},{Name:"Condition"},{Name:"RuleGet"},{Name:"RuleCheck"}]},{name:t.IsGlobal,field:"IsGlobal",type:"checkbox"}],graph:e.graph,readonly:this.graph.Settings.readonly,onrowadded:function(e,t){var i=e.find("[name=Type]");i[0];i.change(function(){o(e)}),o(e);var n=e.find("[name=IsGlobal]");n.change(function(){0==this.checked&&t.InfoDialog(WorkflowDesignerConstants.Warning,WorkflowDesignerConstants.CodeActionsFormLabel.UnGlobalMessage,"mini")})},onrowdelete:function(e,t){var i=e.find("[name=IsGlobal]");i[0].checked&&t.InfoDialog(WorkflowDesignerConstants.Warning,WorkflowDesignerConstants.CodeActionsFormLabel.GlobalDeleteMessage,"mini")}};WorkflowDesignerConstants.isjava||i.elements.push({name:t.IsAsync,field:"IsAsync",type:"checkbox"}),i.elements.push({name:t.ActionCode,field:"ActionCode",type:"code"});var n=new WorkflowDesignerForm(i),o=function(e){if(!WorkflowDesignerConstants.isjava){var t=e.find("[name=Type]")[0],i=e.find("[name=IsAsync]");void 0===t||"RuleGet"!==t.value&&"RuleCheck"!==t.value?i.attr("disabled",!1):(i.attr("disabled",!0),i.attr("checked",!1))}},a=function(t,o){for(var a=0;a<t.length;a++){var r=t[a];void 0===r.ActionCode||void 0!==r.ActionCode.code&&r.ActionCode.code||("Action"===r.Type?r.ActionCode.code="return;":"Condition"===r.Type?r.ActionCode.code="return false;":"RuleGet"===r.Type?r.ActionCode.code="return new List<string>();":"RuleCheck"===r.Type&&(r.ActionCode.code="return false;"))}if(n.CheckRequired(t,["Name","Type","ActionCode.code"],WorkflowDesignerConstants.FieldIsRequired)&&n.CheckUnique(t,["Name","Type","IsGlobal"],WorkflowDesignerConstants.FieldMustBeUnique)){n.ClearTempField(t);var s=e.getGlobalCodeActionsForDelete(e.graph.data.CodeActions,t);e.SyncTable(e.graph.data.CodeActions,t,i);for(var l=0;l<e.graph.data.CodeActions.length;l++){var d=e.graph.data.CodeActions[l].ActionCode;e.graph.data.CodeActions[l].ActionCode=encodeURIComponent(d.code),WorkflowDesignerConstants.isjava||(e.graph.data.CodeActions[l].Usings=encodeURIComponent(d.usings))}return s.length>0&&e.graph.designer.deleteGlobalCodeAction(s,function(e){return 1==e.isError&&n.InfoDialog(WorkflowDesignerConstants.EditCodeLabel.Error,e.errorMessage),!1}),e.graph.Draw(e.graph.data),e.graph.StoreGraphData(),!0}return!1};n.showModal(a)},this.getGlobalCodeActionsForDelete=function(e,t){var i=[];return e.forEach(function(n){if(n.IsGlobal){for(var o=!1,a=0;a<e.length;a++)if(n.Name==e[a].Name&&n.IsGlobal!=e[a].IsGlobal){o=!0;break}for(var r=!1,a=0;a<t.length;a++)if(1==o){if(n.Name==t[a].Name&&t[a].IsGlobal){r=!0;break}}else if(n.Name==t[a].Name){r=!0;break}0==r&&i.push(n.Name)}}),i},this.EditCommands=function(){var e=WorkflowDesignerConstants.CommandFormLabel,t=this,i=function(e,i,n){for(var o=void 0,a=void 0,r=e.getEditData(e.parameters),s=0;s<r.length;s++){var l=r[s];if(void 0!=l.InputParameters)for(var d=0;d<l.InputParameters.length;d++)if(l.InputParameters[d].control_DefaultValue.id===i.id){a=l.InputParameters[d].Parameter.Name;break}}if(void 0!=a)for(var c=t.graph.data.Parameters,s=0;s<c.length;s++)if(c[s].Name===a){o=c[s].Type;break}void 0!=o&&t.graph.graph.getemptytype(o,n)},n={type:"table",title:e.Title,width:"900px",data:this.graph.data.Commands,datadefault:{},keyproperty:"Name",elements:[{name:e.Name,field:"Name",type:"input"},{name:e.InputParameters,field:"InputParameters",type:"table",elements:[{name:e.InputParametersName,code:"ipname",field:"Name",type:"input"},{name:e.InputParametersParameter,code:"ipparameter",field:"Parameter.Name",type:"select",displayfield:"Name",datasource:this.graph.getNonSystemParameters()},{name:e.InputParametersIsRequired,code:"iisrequired",field:"IsRequired",type:"checkbox"},{name:e.InputParametersDefaultValue,code:"idefaultvalue",field:"DefaultValue",type:"json",width:"40%",getemptytype:i}]}],graph:t.graph,readonly:this.graph.Settings.readonly},o=new WorkflowDesignerForm(n),a=function(e,t){var i=!0;return i&=e.CheckRequired(t,["Name"],WorkflowDesignerConstants.FieldIsRequired),i&=e.CheckUnique(t,["Name"],WorkflowDesignerConstants.FieldMustBeUnique),t.forEach(function(t){e.CheckRequired(t.InputParameters,["Name","Parameter.Name"],WorkflowDesignerConstants.FieldIsRequired)||(i=!1)}),i},r=function(e){return!!a(o,e)&&(o.ClearTempField(e),t.SyncTable(t.graph.data.Commands,e,n),WorkflowDesignerCommon.DataCorrection(t.graph.data),t.graph.Draw(t.graph.data),t.graph.StoreGraphData(),!0)};o.showModal(r)},this.EditAdditionalParameters=function(){var e=WorkflowDesignerConstants.AdditionalParamsFormLabel,t={type:"form",title:e.Title,width:"800px",data:this.graph.data.AdditionalParams,readonly:!0,elements:[{name:e.IsObsolete,field:"IsObsolete",type:"checkbox"},{name:e.DefiningParameters,field:"DefiningParameters",type:"textarea"},{name:e.ProcessParameters,field:"ProcessParameters",type:"table",elements:[{name:e.ProcessParametersName,field:"Name",type:"input"},{name:e.ProcessParametersValue,field:"Value",type:"input"}]}]},i=new WorkflowDesignerForm(t),n=function(e,t){return!0};i.showModal(n)},this.Items=[],this.SideItems=[],this.InitItems=function(){var t=this.graph.Settings.imagefolder;this.graph.Settings.readonly||(this.Items.push({title:WorkflowDesignerConstants.ToolbarLabel.CreateActivity,img:t+"wfe.add.png",click:function(){e.CreateActivity()}}),this.Items.push({code:"copy",disabled:!0,title:WorkflowDesignerConstants.ToolbarLabel.CopySelected,img:t+"wfe.clone.png",click:function(){e.CopySelected()}}),this.Items.push({code:"delete",disabled:!0,title:WorkflowDesignerConstants.ToolbarLabel.Delete,img:t+"wfe.delete.png",click:function(){e.graph.DeleteSelected()}}),this.Items.push({separator:!0}),this.Items.push({code:"undo",title:WorkflowDesignerConstants.ToolbarLabel.Undo,img:t+"wfe.undo.png",click:function(){e.graph.Undo()}}),this.Items.push({code:"redo",title:WorkflowDesignerConstants.ToolbarLabel.Redo,img:t+"wfe.redo.png",click:function(){e.graph.Redo()}}),this.Items.push({separator:!0})),this.graph.Settings.notshowwindows||(this.Items.push({title:WorkflowDesignerConstants.ToolbarLabel.Actors,img:t+"wfe.actors.png",click:function(){e.EditActors()}}),this.Items.push({title:WorkflowDesignerConstants.ToolbarLabel.Commands,img:t+"wfe.commands.png",click:function(){e.EditCommands()}}),this.Items.push({title:WorkflowDesignerConstants.ToolbarLabel.Timers,img:t+"wfe.timers.png",click:function(){e.EditTimer()}}),this.Items.push({title:WorkflowDesignerConstants.ToolbarLabel.CodeActions,img:t+"wfe.codeactions.png",click:function(){e.EditCodeActions()}}),this.Items.push({title:WorkflowDesignerConstants.ToolbarLabel.Parameters,img:t+"wfe.parameters.png",click:function(){e.EditParameters()}}),this.Items.push({separator:!0}),this.Items.push({title:WorkflowDesignerConstants.ToolbarLabel.AdditionalParameters,img:t+"wfe.context.png",click:function(){e.EditAdditionalParameters()}}),this.Items.push({title:WorkflowDesignerConstants.ToolbarLabel.Localization,img:t+"wfe.localization.png",click:function(){e.EditLocalization()}}),this.Items.push({separator:!0})),this.graph.Settings.disableobjectmovements||(this.Items.push({title:WorkflowDesignerConstants.ToolbarLabel.AutoArrangement,img:t+"wfe.autoarrangment.png",click:function(){e.AutoArrangement()}}),this.Items.push({separator:!0})),this.Items.push({title:WorkflowDesignerConstants.ToolbarLabel.Refresh,img:t+"wfe.refresh.png",click:function(){e.graph.Refresh()}}),this.Items.push({code:"exinfo",title:WorkflowDesignerConstants.ToolbarLabel.Info,img:t+"wfe.information.png",click:function(){e.ToolbarExInfoPress()}}),this.Items.push({title:WorkflowDesignerConstants.ToolbarLabel.Legend,img:t+"wfe.help.png",click:function(){e.ShowLegend()}}),this.SideItems=[{title:WorkflowDesignerConstants.ToolbarLabel.ZoomIn,img:t+"wfe.zoomin.png",click:function(){e.graph.GraphLayerScale(.1)}},{title:WorkflowDesignerConstants.ToolbarLabel.ZoomOut,img:t+"wfe.zoomout.png",click:function(){e.graph.GraphLayerScale(-.1)}},{title:WorkflowDesignerConstants.ToolbarLabel.ZoomPositionDefault,img:t+"wfe.defaultzoom.png",click:function(){e.graph.GraphLayerScaleNorm()}},{separator:!0},{code:"move",title:WorkflowDesignerConstants.ToolbarLabel.Move,img:t+"wfe.move.png",click:function(){e.ToolbarMovePress()}},{code:"fullscreen",title:WorkflowDesignerConstants.ToolbarLabel.FullScreen,img:t+"wfe.fullscreen.png",click:function(){e.graph.onFullScreenClick()}}],e.graph.Stage.getContent().addEventListener("wheel",function(t){var i=e.GetWorkflowDesignerBackground(),n=i.BackgroundLayer.scaleX(),o={x:t.offsetX/n-i.RectBG.x(),y:t.offsetY/n-i.RectBG.y()},a=.1,r=t.deltaY>0?-a:a,s=n+r,l={x:o.x-o.x/s,y:o.y-o.y/s},d={x:((1-n)*t.offsetX/n-i.RectBG.x())/s,y:((1-n)*t.offsetY/n-i.RectBG.y())/s};l.x+=d.x,l.y+=d.y,e.graph.ComponentsExecute("LayerScale",r),e.graph.ComponentsExecute("setPosition",l),e.graph.redrawAll()})},this.GetItemByCode=function(e){for(var t=0;t<this.Items.length;t++){var i=this.Items[t];if(i.code==e)return i}for(var t=0;t<this.SideItems.length;t++){var i=this.SideItems[t];if(i.code==e)return i}},this.SyncTable=function(e,t,i){if(void 0==i.keyproperty){e.splice(0,e.length);for(var n=0;n<t.length;n++){var o={};i.elements.forEach(function(e){o[e.field]=t[n][e.field]}),e.push(o)}}else{for(var n=e.length-1;n>=0;n--){var a=$.grep(t,function(t){return e[n][i.keyproperty]==t.keyproperty});0==a.length?e.splice(n,1):i.elements.forEach(function(t){e[n][t.field]=a[0][t.field]})}for(var n=0;n<t.length;n++){var a=$.grep(e,function(e){return t[n][i.keyproperty]==e[i.keyproperty]});if(0==a.length){var o={};i.elements.forEach(function(e){o[e.field]=t[n][e.field]}),e.push(o)}}}},this.ShowLegend=function(){var e=this.graph.Settings.imagefolder,t=$('<image src="'+e+'wfe.legend.png" height="'+.7*this.graph.Stage.getHeight()+'"/>'),i=$('<div class="ui modal"></div>').append($('<div class="content" style="text-align: center;"></div>').append(t));WorkflowDesignerCommon.modal(i,"show")},this.setItemDisabled=function(e,t){for(var i=0;i<this.Items.length;i++)if(this.Items[i].code==e){this.Items[i].disabled=t,void 0!=this.Items[i].cImageToolbar&&this.Items[i].cImageToolbar.opacity(1==t?.3:1);break}for(var i=0;i<this.SideItems.length;i++)if(this.SideItems[i].code==e){this.SideItems[i].disabled=t,void 0!=this.Items[i].cImageToolbar&&this.Items[i].cImageToolbar.opacity(1==t?.3:1);break}},this.setItemActive=function(e,t){for(var i=0;i<this.Items.length;i++)if(this.Items[i].code==e){this.Items[i].active=t,void 0!=this.Items[i].bg&&this.Items[i].bg.setFill(1==t?WorkflowDesignerConstants.ButtonActive:"");break}for(var i=0;i<this.SideItems.length;i++)if(this.SideItems[i].code==e){this.SideItems[i].active=t,void 0!=this.SideItems[i].bg&&this.SideItems[i].bg.setFill(1==t?WorkflowDesignerConstants.ButtonActive:"");break}}}function WorkflowDesignerKeyboard(){this.type="WorkflowDesignerKeyboard",this.init=function(e){this.graph=e}}var WorkflowDesignerConstants={ActivityColor:"#ECF0F1",ActivityTextColor:"#2D3436",ActivityInitialColor:"#27AE60",ActivityInitialTextColor:"#FFFFFF",ActivityFinalColor:"#2980B9",ActivityFinalTextColor:"#FFFFFF",ActivityShape:"#CECECE",SelectColor:"#F39C12",SelectTextColor:"#FFFFFF",SelectSubProcessColor:"#e3b015",SelectSubProcessTextColor:"#FFFFFF",ButtonActive:"#D4D8D9",BarColor:"#EDF1F2",BarSeparatorColor:"#D9DEE0",DeleteConfirm:"Are you sure you want to delete selected item(s)?",DeleteConfirmCurrent:"Are you sure you want to delete this item?",FieldIsRequired:"Field is required!",FieldMustBeUnique:"Field must be unique!",ButtonTextDelete:"Delete",ButtonTextCreate:"Create",ButtonTextSave:"Save",ButtonTextYes:"Yes",ButtonTextNo:"No",ButtonTextCancel:"Cancel",ButtonTextClose:"Close",ButtonTextUndo:"Undo",ButtonTextRedo:"Redo",SaveConfirm:"Save changes?",CloseWithoutSaving:"Close without saving?",DialogConfirmText:"Question",None:"None",Warning:"Warning",InfoBlockLabel:{Activity:"Activities: ",Transition:"Transitions: ",Command:"Commands: "},ActivityNamePrefix:"Activity_",ActivityFormLabel:{Title:"Activity",Name:"Name",State:"State",IsInitial:"Initial",IsFinal:"Final",IsForSetState:"For set state",IsAutoSchemeUpdate:"Auto scheme update",Implementation:"Implementation",PreExecutionImplementation:"PreExecution Implementation",ImpOrder:"Order",ImpAction:"Action",ImpActionParameter:"Action parameter",AlwaysConditionShouldBeSingle:"Always condition should be single",OtherwiseConditionShouldBeSingle:"Otherwise condition should be single"},TransitionFormLabel:{Title:"Transition",Name:"Name",From:"From activity",To:"To activity",Classifier:"Classifier",Restrictions:"Restrictions",RestrictionsType:"Type",RestrictionsActor:"Actor",Condition:"Condition",ConditionType:"Type",ConditionAction:"Action",ResultOnPreExecution:"Result on PreExecution",Trigger:"Trigger",TriggerType:"Type",TriggerCommand:"Command",TriggerTimer:"Timer",ConditionActionParameter:"Action parameter",ConditionInversion:"Invert action result",ConditionsConcatenationType:"Conditions concatenation type",AllowConcatenationType:"Concat allow as",RestrictConcatenationType:"Concat restrict as",ConditionsListShouldNotBeEmpty:"Conditions list should not be empty",IsFork:"Is fork",MergeViaSetState:"Merge subprocess via set state",DisableParentStateControl:"Disable parent process control",ShowConcatParameters:"Show concatenation",HideConcatParameters:"Hide concatenation"},LocalizationFormLabel:{Title:"Localization",ObjectName:"ObjectName",Type:"Type",IsDefault:"IsDefault",Culture:"Culture",Value:"Value",Types:["Command","State","Parameter"]},TimerFormLabel:{Title:"Timers",Name:"Name",Type:"Type",Value:"Value",Types:["Command","State","Parameter"],NotOverrideIfExists:"Do not override timer if exists"},ParameterFormLabel:{Title:"Parameters",Name:"Name",Type:"Type",Purpose:"Purpose",Value:"Value",InitialValue:"InitialValue",ShowSystemParameters:"Show system parameters"},ActorFormLabel:{Title:"Actors",Name:"Name",Rule:"Rule",Value:"Value"},CommandFormLabel:{Title:"Command",Name:"Name",InputParameters:"Input Parameters",InputParametersName:"Name",InputParametersIsRequired:"Required",InputParametersParameter:"Parameter",InputParametersDefaultValue:"Default"},AdditionalParamsFormLabel:{Title:"Additional Parameters",IsObsolete:"IsObsolete",DefiningParameters:"Defining parameters",ProcessParameters:"Process parameters",ProcessParametersName:"Name",ProcessParametersValue:"Value"},CodeActionsFormLabel:{Title:"Code actions",Name:"Name",ActionCode:"Action code",IsGlobal:"Is global",IsAsync:"Async",Type:"Type",GlobalDeleteMessage:"You've deleted the Global CodeAction.<br/><b>Other schemes won't be able to call this CodeAction!</b>",UnGlobalMessage:"You've changed the state of the global flag.<br/>There will be created a Local CodeAction based on this Global CodeAction after saving this scheme."},ToolbarLabel:{CreateActivity:"Create activity",CopySelected:"Copy selected",Undo:"Undo",Redo:"Redo",Move:"Move",ZoomIn:"Zoom In",ZoomOut:"Zoom Out",ZoomPositionDefault:"Zoom default",FullScreen:"Full Screen",Refresh:"Refresh",AutoArrangement:"Auto arrangement",Actors:"Actors",Commands:"Commands",Parameters:"Parameters",Localization:"Localization",Timers:"Timers",AdditionalParameters:"Additional Parameters",CodeActions:"Code actions",Info:"Extended info",Delete:"Delete",Clone:"Clone",Settings:"Settings",CreateTransition:"Create a transition",CreateActivityTransition:"Create an activity and a transition",Legend:"Legend"},ErrorActivityIsInitialCountText:"One element must be marked flag Initial",ErrorReadOnlySaveText:"The Designer in ReadOnly mode, you can't save it.",FormMaxHeight:700,EditCodeSettings:{Height:600,Width:1e3,CodeHeight:390,MessageBoxHeight:400,MessageBoxWidth:600,SuccessBoxHeight:150,SuccessBoxWidth:300},EditCodeLabel:{Title:"Edit code",EditCodeButton:"Edit code",Usings:"Usings",Compile:"Compile",CompileSucceeded:"Compilation succeeded.",Success:"Success",Error:"Error",OK:"OK",ShowUsings:"Show usings",HideUsings:"Hide usings"},EditJSONSettings:{Height:600,Width:1e3,CodeHeight:480},EditJSONLabel:{Title:"Edit value in JSON",CreateEmptyType:"Create",Format:"Format"},isjava:!1,OverviewMap:{show:!0,width:300,height:150},UndoDepth:200,DefaultCulture:"en-US"},WorkflowDesignerCommon={modal:function(e,t){void 0!=e.semanticmodal?e.semanticmodal(t):void 0!=e.modal?e.modal(t):console.error("SemanticUI is not defined!")},createArrowByAngle:function(e,t,i,n,o){void 0==o&&(o="red");var a=new Konva.Wedge({x:e,y:t,radius:n,angle:40,fill:o,rotation:180*i/Math.PI-200});return a},updateArrowByAngle:function(e,t,i,n,o,a){void 0==a&&(a="red"),e.setPosition({x:t,y:i}),e.setRadius(o),e.setFill(a),e.setRotation(180*n/Math.PI-200)},createUUID:function(){for(var e=[],t="0123456789abcdef",i=0;i<36;i++)e[i]=t.substr(Math.floor(16*Math.random()),1);e[14]="4",e[19]=t.substr(3&e[19]|8,1),e[8]=e[13]=e[18]=e[23]="-";var n=e.join("");return n},DataCorrection:function(e){void 0==e.AdditionalParams&&(e.AdditionalParams={}),void 0==e.AdditionalParams.Actions&&(e.AdditionalParams.Actions=[]),void 0==e.AdditionalParams.Conditions&&(e.AdditionalParams.Conditions=[]),void 0==e.AdditionalParams.Rules&&(e.AdditionalParams.Rules=[]);var t=function(e,t){if(void 0!=e){var i=$.grep(t,function(t){return t==e});0==i.length&&t.push(e)}},i=function(e,t,i){if(void 0!=e&&void 0!=t){var n=$.grep(t,function(t){return e==t[i]});return n.length>0?n[0]:void 0}};e.Activities.forEach(function(i){void 0!=i.Implementation&&(i.Implementation.forEach(function(i){t(i.Name,e.AdditionalParams.Actions)}),i.PreExecutionImplementation.forEach(function(i){t(i.Name,e.AdditionalParams.Actions)}))}),e.Transitions.forEach(function(n){void 0!=n.From&&(n.From=i(n.From.Name,e.Activities,"Name")),void 0!=n.To&&(n.To=i(n.To.Name,e.Activities,"Name")),void 0!=n.Restrictions&&n.Restrictions.forEach(function(t){t.Actor=i(t.Actor.Name,e.Actors,"Name")}),void 0!=n.Condition&&void 0!=n.Condition.Action&&t(n.Condition.Action.Name,e.AdditionalParams.Actions),void 0!=n.Trigger&&void 0!=n.Trigger.Command&&(n.Trigger.Command=i(n.Trigger.Command.Name,e.Commands,"Name")),void 0!=n.Trigger&&void 0!=n.Trigger.Timer&&(n.Trigger.Timer=i(n.Trigger.Timer.Name,e.Timers,"Name"))}),e.Commands.forEach(function(t){void 0!=t.InputParameters&&t.InputParameters.forEach(function(t){t.Parameter=i(t.Parameter.Name,e.Parameters,"Name")})}),e.Actors.forEach(function(i){void 0!=i.Rule&&t(i.Rule,e.AdditionalParams.Rules)})},download:function(e,t,i){if(e&&t){var n=new Array;t.forEach(function(e){var t=$('<input type="hidden"/>');t.attr("name",e.name),t.attr("value",e.value),n.push(t)});var o=$('<form action="'+e+'" method="'+(i||"post")+'"></form>');o.append(n),o.appendTo("body").submit().remove()}},defineLocalStorage:function(){Object.defineProperty(window,"localStorage",new function(){var e=[],t={};Object.defineProperty(t,"getItem",{value:function(e){return e?this[e]:null},writable:!1,configurable:!1,enumerable:!1}),Object.defineProperty(t,"key",{value:function(t){return e[t]},writable:!1,configurable:!1,enumerable:!1}),Object.defineProperty(t,"setItem",{value:function(e,t){e&&(document.cookie=escape(e)+"="+escape(t)+"; expires=Tue, 19 Jan 2038 03:14:07 GMT; path=/")},writable:!1,configurable:!1,enumerable:!1}),Object.defineProperty(t,"length",{get:function(){return e.length},configurable:!1,enumerable:!1}),Object.defineProperty(t,"removeItem",{value:function(e){e&&(document.cookie=escape(e)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/")},writable:!1,configurable:!1,enumerable:!1}),Object.defineProperty(t,"clear",{value:function(){if(e.length)for(var t in e)document.cookie=escape(t)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/"},writable:!1,configurable:!1,enumerable:!1}),this.get=function(){var i;for(var n in t)i=e.indexOf(n),i===-1?t.setItem(n,t[n]):e.splice(i,1),delete t[n];for(e;e.length>0;e.splice(0,1))t.removeItem(e[0]);for(var o,a,r=0,s=document.cookie.split(/\s*;\s*/);r<s.length;r++)o=s[r].split(/\s*=\s*/),o.length>1&&(t[a=unescape(o[0])]=unescape(o[1]),e.push(a));return t},this.configurable=!1,this.enumerable=!0})},imageCache:[],loadImage:function(e,t){for(var i,n=0;n<WorkflowDesignerCommon.imageCache.length;n++){var o=WorkflowDesignerCommon.imageCache[n];if(o.src==e){i=o;break}}return void 0!=i?(void 0!=t&&t(i),i):(i=new Image,void 0!=t&&(i.onload=function(){t(i)}),i.src=e,i)}};!function(e,t,i,n){"use strict";t="undefined"!=typeof t&&t.Math==Math?t:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")(),e.fn.semanticmodal=function(o){var a,r=e(this),s=e(t),l=e(i),d=e("body"),c=r.selector||"",h=(new Date).getTime(),m=[],g=arguments[0],u="string"==typeof g,p=[].slice.call(arguments,1),f=t.requestAnimationFrame||t.mozRequestAnimationFrame||t.webkitRequestAnimationFrame||t.msRequestAnimationFrame||function(e){setTimeout(e,0)};return r.each(function(){var r,v,y,w,C,b,S,D,T,k=e.isPlainObject(o)?e.extend(!0,{},e.fn.semanticmodal.settings,o):e.extend({},e.fn.semanticmodal.settings),A=k.selector,x=k.className,I=k.namespace,P=k.error,W="."+I,N="module-"+I,L=e(this),F=e(k.context),E=L.find(A.close),R=this,O=L.data(N),B=!1;T={initialize:function(){T.verbose("Initializing dimmer",F),T.create.id(),T.create.dimmer(),T.refreshModals(),T.bind.events(),k.observeChanges&&T.observeChanges(),T.instantiate()},instantiate:function(){T.verbose("Storing instance of modal"),O=T,L.data(N,O)},create:{dimmer:function(){var t={debug:k.debug,dimmerName:"modals"},i=e.extend(!0,t,k.dimmerSettings);return e.fn.dimmer===n?void T.error(P.dimmer):(T.debug("Creating dimmer"),w=F.dimmer(i),k.detachable?(T.verbose("Modal is detachable, moving content into dimmer"),w.dimmer("add content",L)):T.set.undetached(),void(C=w.dimmer("get dimmer")))},id:function(){S=(Math.random().toString(16)+"000000000").substr(2,8),b="."+S,T.verbose("Creating unique id for element",S)}},destroy:function(){T.verbose("Destroying previous modal"),L.removeData(N).off(W),s.off(b),C.off(b),E.off(W),F.dimmer("destroy")},observeChanges:function(){"MutationObserver"in t&&(D=new MutationObserver(function(e){T.debug("DOM tree modified, refreshing"),T.refresh()}),D.observe(R,{childList:!0,subtree:!0}),T.debug("Setting up mutation observer",D))},refresh:function(){T.remove.scrolling(),T.cacheSizes(),T.set.screenHeight(),T.set.type(),T.set.position()},refreshModals:function(){v=L.siblings(A.modal),r=v.add(L)},attachEvents:function(t,i){var n=e(t);i=e.isFunction(T[i])?T[i]:T.toggle,n.length>0?(T.debug("Attaching modal events to element",t,i),n.off(W).on("click"+W,i)):T.error(P.notFound,t)},bind:{events:function(){T.verbose("Attaching events"),L.on("click"+W,A.close,T.event.close).on("click"+W,A.approve,T.event.approve).on("click"+W,A.deny,T.event.deny),s.on("resize"+b,T.event.resize)}},get:{id:function(){return(Math.random().toString(16)+"000000000").substr(2,8)}},event:{approve:function(){return B||k.onApprove.call(R,e(this))===!1?void T.verbose("Approve callback returned false cancelling hide"):(B=!0,void T.hide(function(){B=!1}))},deny:function(){return B||k.onDeny.call(R,e(this))===!1?void T.verbose("Deny callback returned false cancelling hide"):(B=!0,void T.hide(function(){B=!1}))},close:function(){T.hide()},click:function(t){var n=e(t.target),o=n.closest(A.modal).length>0,a=e.contains(i.documentElement,t.target);!o&&a&&(T.debug("Dimmer clicked, hiding all modals"),T.is.active()&&(T.remove.clickaway(),k.allowMultiple?T.hide():T.hideAll()))},debounce:function(e,t){clearTimeout(T.timer),T.timer=setTimeout(e,t)},keyboard:function(e){var t=e.which,i=27;t==i&&(k.closable?(T.debug("Escape key pressed hiding modal"),T.hide()):T.debug("Escape key pressed, but closable is set to false"),e.preventDefault())},resize:function(){w.dimmer("is active")&&(T.is.animating()||T.is.active())&&f(T.refresh)}},toggle:function(){T.is.active()||T.is.animating()?T.hide():T.show()},show:function(t){t=e.isFunction(t)?t:function(){},T.refreshModals(),T.set.dimmerSettings(),T.showModal(t)},hide:function(t){t=e.isFunction(t)?t:function(){},T.refreshModals(),T.hideModal(t)},showModal:function(t){t=e.isFunction(t)?t:function(){},T.is.animating()||!T.is.active()?(T.showDimmer(),T.cacheSizes(),T.set.position(),T.set.screenHeight(),T.set.type(),T.set.clickaway(),!k.allowMultiple&&T.others.active()?T.hideOthers(T.showModal):(k.allowMultiple&&k.detachable&&L.detach().appendTo(C),k.onShow.call(R),k.transition&&e.fn.transition!==n&&L.transition("is supported")?(T.debug("Showing modal with css animations"),L.transition({debug:k.debug,animation:k.transition+" in",queue:k.queue,duration:k.duration,useFailSafe:!0,onComplete:function(){k.onVisible.apply(R),k.keyboardShortcuts&&T.add.keyboardShortcuts(),T.save.focus(),T.set.active(),k.autofocus&&T.set.autofocus(),t()}})):T.error(P.noTransition))):T.debug("Modal is already visible")},hideModal:function(t,i){return t=e.isFunction(t)?t:function(){},T.debug("Hiding modal"),k.onHide.call(R,e(this))===!1?void T.verbose("Hide callback returned false cancelling hide"):void((T.is.animating()||T.is.active())&&(k.transition&&e.fn.transition!==n&&L.transition("is supported")?(T.remove.active(),L.transition({debug:k.debug,animation:k.transition+" out",queue:k.queue,duration:k.duration,useFailSafe:!0,onStart:function(){T.others.active()||i||T.hideDimmer(),k.keyboardShortcuts&&T.remove.keyboardShortcuts()},onComplete:function(){k.onHidden.call(R),T.restore.focus(),t()}})):T.error(P.noTransition)))},showDimmer:function(){w.dimmer("is animating")||!w.dimmer("is active")?(T.debug("Showing dimmer"),w.dimmer("show")):T.debug("Dimmer already visible")},hideDimmer:function(){return w.dimmer("is animating")||w.dimmer("is active")?void w.dimmer("hide",function(){T.remove.clickaway(),T.remove.screenHeight()}):void T.debug("Dimmer is not visible cannot hide")},hideAll:function(t){var i=r.filter("."+x.active+", ."+x.animating);t=e.isFunction(t)?t:function(){},i.length>0&&(T.debug("Hiding all visible modals"),T.hideDimmer(),i.semanticmodal("hide modal",t))},hideOthers:function(t){var i=v.filter("."+x.active+", ."+x.animating);t=e.isFunction(t)?t:function(){},i.length>0&&(T.debug("Hiding other modals",v),i.semanticmodal("hide modal",t,!0))},others:{active:function(){return v.filter("."+x.active).length>0},animating:function(){return v.filter("."+x.animating).length>0}},add:{keyboardShortcuts:function(){T.verbose("Adding keyboard shortcuts"),l.on("keyup"+W,T.event.keyboard)}},save:{focus:function(){y=e(i.activeElement).blur()}},restore:{focus:function(){y&&y.length>0&&y.focus()}},remove:{active:function(){L.removeClass(x.active)},clickaway:function(){k.closable&&C.off("click"+b)},bodyStyle:function(){""===d.attr("style")&&(T.verbose("Removing style attribute"),d.removeAttr("style"))},screenHeight:function(){T.debug("Removing page height"),d.css("height","")},keyboardShortcuts:function(){T.verbose("Removing keyboard shortcuts"),l.off("keyup"+W)},scrolling:function(){w.removeClass(x.scrolling),L.removeClass(x.scrolling)}},cacheSizes:function(){L.addClass(x.loading);var o=L.prop("scrollHeight"),a=L.outerHeight();T.cache!==n&&0===a||(T.cache={pageHeight:e(i).outerHeight(),height:a+k.offset,scrollHeight:o+k.offset,contextHeight:"body"==k.context?e(t).height():w.height()},T.cache.topOffset=-(T.cache.height/2)),L.removeClass(x.loading),T.debug("Caching modal and container sizes",T.cache)},can:{fit:function(){var e=T.cache.contextHeight,t=T.cache.contextHeight/2,i=T.cache.topOffset,n=T.cache.scrollHeight,o=T.cache.height,a=k.padding,r=t+i;return n>o?r+n+a<e:o+2*a<e}},is:{active:function(){return L.hasClass(x.active)},animating:function(){return L.transition("is supported")?L.transition("is animating"):L.is(":visible")},scrolling:function(){return w.hasClass(x.scrolling)},modernBrowser:function(){return!(t.ActiveXObject||"ActiveXObject"in t)}},set:{autofocus:function(){var e=L.find("[tabindex], :input").filter(":visible"),t=e.filter("[autofocus]"),i=t.length>0?t.first():e.first();i.length>0&&i.focus()},clickaway:function(){k.closable&&C.on("click"+b,T.event.click)},dimmerSettings:function(){if(e.fn.dimmer===n)return void T.error(P.dimmer);var t={debug:k.debug,dimmerName:"modals",variation:!1,closable:"auto",duration:{show:k.duration,hide:k.duration}},i=e.extend(!0,t,k.dimmerSettings);k.inverted?(i.variation=i.variation!==n?i.variation+" inverted":"inverted",C.addClass(x.inverted)):C.removeClass(x.inverted),k.blurring?w.addClass(x.blurring):w.removeClass(x.blurring),F.dimmer("setting",i)},screenHeight:function(){T.can.fit()?d.css("height",""):(T.debug("Modal is taller than page content, resizing page height"),d.css("height",T.cache.height+2*k.padding))},active:function(){L.addClass(x.active)},scrolling:function(){w.addClass(x.scrolling),L.addClass(x.scrolling)},type:function(){T.can.fit()?(T.verbose("Modal fits on screen"),T.others.active()||T.others.animating()||T.remove.scrolling()):(T.verbose("Modal cannot fit on screen setting to scrolling"),T.set.scrolling())},position:function(){T.verbose("Centering modal on page",T.cache),T.can.fit()?L.css({top:"",marginTop:T.cache.topOffset}):L.css({marginTop:"",top:l.scrollTop()})},undetached:function(){w.addClass(x.undetached)}},setting:function(t,i){if(T.debug("Changing setting",t,i),e.isPlainObject(t))e.extend(!0,k,t);else{if(i===n)return k[t];e.isPlainObject(k[t])?e.extend(!0,k[t],i):k[t]=i}},internal:function(t,i){if(e.isPlainObject(t))e.extend(!0,T,t);else{if(i===n)return T[t];T[t]=i}},debug:function(){!k.silent&&k.debug&&(k.performance?T.performance.log(arguments):(T.debug=Function.prototype.bind.call(console.info,console,k.name+":"),T.debug.apply(console,arguments)))},verbose:function(){!k.silent&&k.verbose&&k.debug&&(k.performance?T.performance.log(arguments):(T.verbose=Function.prototype.bind.call(console.info,console,k.name+":"),T.verbose.apply(console,arguments)))},error:function(){k.silent||(T.error=Function.prototype.bind.call(console.error,console,k.name+":"),T.error.apply(console,arguments))},performance:{log:function(e){var t,i,n;k.performance&&(t=(new Date).getTime(),n=h||t,i=t-n,h=t,m.push({Name:e[0],Arguments:[].slice.call(e,1)||"",Element:R,"Execution Time":i})),clearTimeout(T.performance.timer),T.performance.timer=setTimeout(T.performance.display,500)},display:function(){var t=k.name+":",i=0;h=!1,clearTimeout(T.performance.timer),e.each(m,function(e,t){i+=t["Execution Time"]}),t+=" "+i+"ms",c&&(t+=" '"+c+"'"),(console.group!==n||console.table!==n)&&m.length>0&&(console.groupCollapsed(t),console.table?console.table(m):e.each(m,function(e,t){console.log(t.Name+": "+t["Execution Time"]+"ms")}),console.groupEnd()),m=[]}},invoke:function(t,i,o){var r,s,l,d=O;return i=i||p,o=R||o,"string"==typeof t&&d!==n&&(t=t.split(/[\. ]/),r=t.length-1,e.each(t,function(i,o){var a=i!=r?o+t[i+1].charAt(0).toUpperCase()+t[i+1].slice(1):t;if(e.isPlainObject(d[a])&&i!=r)d=d[a];else{if(d[a]!==n)return s=d[a],!1;if(!e.isPlainObject(d[o])||i==r)return d[o]!==n&&(s=d[o],!1);d=d[o]}})),e.isFunction(s)?l=s.apply(o,i):s!==n&&(l=s),e.isArray(a)?a.push(l):a!==n?a=[a,l]:l!==n&&(a=l),s}},u?(O===n&&T.initialize(),T.invoke(g)):(O!==n&&O.invoke("destroy"),T.initialize())}),a!==n?a:this},e.fn.semanticmodal.settings={name:"Modal",namespace:"modal",silent:!1,
debug:!1,verbose:!1,performance:!0,observeChanges:!1,allowMultiple:!1,detachable:!0,closable:!0,autofocus:!0,inverted:!1,blurring:!1,dimmerSettings:{closable:!1,useCSS:!0},keyboardShortcuts:!0,context:"body",queue:!1,duration:500,offset:0,transition:"scale",padding:50,onShow:function(){},onVisible:function(){},onHide:function(){return!0},onHidden:function(){},onApprove:function(){return!0},onDeny:function(){return!0},selector:{close:"> .close",approve:".actions .positive, .actions .approve, .actions .ok",deny:".actions .negative, .actions .deny, .actions .cancel",modal:".ui.modal"},error:{dimmer:"UI Dimmer, a required component is not included in this page",method:"The method you called is not defined.",notFound:"The element you specified could not be found"},className:{active:"active",animating:"animating",blurring:"blurring",inverted:"inverted",loading:"loading",scrolling:"scrolling",undetached:"undetached"}}}(jQuery,window,document);