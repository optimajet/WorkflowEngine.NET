function WorkflowDesigner(e){var t=this;this.Settings=e,this.GetName=function(){return t.Settings.name},this.error=function(e){alert(e)},this.load=function(e){var i=new Array;this.schemecode=e.schemecode,this.processid=e.processid,this.schemeid=e.schemeid,e.readonly&&(this.Settings.readonly=e.readonly),i.push({name:"schemecode",value:this.schemecode}),i.push({name:"processid",value:this.processid}),i.push({name:"schemeid",value:this.schemeid}),i.push({name:"operation",value:"load"});$.ajax({url:this.Settings.apiurl,data:i,async:!0,success:function(e){var i={};try{i=JSON.parse(e)}catch(i){return void t.error(e)}return i.isError?void t.error(i.errorMessage):(t.data=i,void t.render())},error:function(e,i,n){t.error(i+" "+n)}})},this.exists=function(e){var i=new Array;this.schemecode=e.schemecode,this.processid=e.processid,this.schemeid=e.schemeid,e.readonly&&(this.Settings.readonly=e.readonly),i.push({name:"schemecode",value:this.schemecode}),i.push({name:"processid",value:this.processid}),i.push({name:"schemeid",value:this.schemeid}),i.push({name:"operation",value:"exists"});var n=$.ajax({url:this.Settings.apiurl,data:i,async:!1,error:function(e,i,n){t.error(i+" "+n)}}).responseText;try{return JSON.parse(n)}catch(e){return t.error(n),!1}},this.create=function(){var e=new Array;e.push({name:"operation",value:"load"});$.ajax({url:this.Settings.apiurl,data:e,async:!0,success:function(e){try{t.data=JSON.parse(e)}catch(i){t.error(e)}t.render()}})},this.render=function(){t.Graph&&t.Graph.destroy();var e=[WorkflowDesignerActivity,WorkflowDesignerTransition,WorkflowDesignerKeyboard];if(this.Settings.printable||e.push(WorkflowDesignerBackground),this.Settings.notrendertoolbar||e.push(WorkflowDesignerToolbar),t.Settings.printable&&void 0!=t.data){var i=0,n=0;$(t.data.Activities).each(function(e){var t=parseInt(this.DesignerSettings.X),o=parseInt(this.DesignerSettings.Y);t>i&&(i=t),o>n&&(n=o)}),t.Settings.graphwidth=i+t.Settings.DefaultActivityWidth,t.Settings.graphheight=n+t.Settings.DefaultActivityHeight}t.Graph=new WorkflowGraph(this.Settings.renderTo,t,t.Settings,e),void 0!=t.data&&(WorkflowDesignerCommon.DataCorrection(t.data),t.Graph.Draw(t.data))},this.save=function(e){if(t.Settings.readonly)return void alert(WorkflowDesignerConstants.ErrorReadOnlySaveText);var i=new Array;i.push({name:"schemecode",value:this.schemecode}),i.push({name:"processid",value:this.processid}),i.push({name:"schemeid",value:this.schemeid}),i.push({name:"operation",value:"save"}),i.push({name:"data",value:JSON.stringify(this.data)});$.ajax({url:this.Settings.apiurl,data:i,async:!0,type:"post",success:function(i){var n={};try{n=JSON.parse(i)}catch(e){return void t.error(i)}return n.isError?void t.error(n.errorMessage):(t.data=n,t.render(),void(e&&setTimeout(function(){e(t)},100)))}})},this.downloadscheme=function(e){var t=new Array;t.push({name:"operation",value:"downloadscheme"}),t.push({name:"data",value:JSON.stringify(this.data)}),WorkflowDesignerCommon.download(this.Settings.apiurl,t,"post")},this.uploadscheme=function(e,i){var n=this.GetName()+"_uploadiframe",o=document.createElement("iframe");o.setAttribute("id",n),o.setAttribute("name",n),o.setAttribute("width","0"),o.setAttribute("height","0"),o.setAttribute("border","0"),o.setAttribute("style","width: 0; height: 0; border: none;"),e.parentNode.appendChild(o),window.frames[n].name=n;var r=document.getElementById(n),a=function(){r.detachEvent?r.detachEvent("onload",a):r.removeEventListener("load",a,!1),r.contentDocument?content=r.contentDocument.body.innerHTML:r.contentWindow?content=r.contentWindow.document.body.innerHTML:r.document&&(content=r.document.body.innerHTML),setTimeout(function(){r.parentNode.removeChild(r)},250);var e={};try{e=JSON.parse(content)}catch(e){return void t.error(content)}return e.isError?void t.error(e.errorMessage):(t.data=e,t.render(),void(i&&i(t)))};r.addEventListener&&r.addEventListener("load",a,!0),r.attachEvent&&r.attachEvent("onload",a),e.setAttribute("target",n),e.setAttribute("action",this.createurl("uploadscheme")),e.setAttribute("method","post"),e.setAttribute("enctype","multipart/form-data"),e.setAttribute("encoding","multipart/form-data"),e.submit()},this.createurl=function(e){var t=this.Settings.apiurl,i="?";return t.indexOf("?")>=0&&(i="&"),t+=i+"operation="+e,i="&",void 0!=this.schemeid&&(t+=i+"schemeid="+this.schemeid),void 0!=this.processid&&(t+=i+"processid="+this.processid),void 0!=this.schemecode&&(t+=i+"schemecode="+this.schemecode),t},this.validate=function(){var e=void 0,i=$.grep(t.data.Activities,function(e){return 1==e.IsInitial});return 1!=i.length&&(e=WorkflowDesignerConstants.ErrorActivityIsInitialCountText),e},this.destroy=function(){this.schemecode=void 0,this.processid=void 0,this.schemeid=void 0,this.data=void 0,this.Graph.destroy()},this.compile=function(e,i){e={Name:e.Name,Type:e.Type,IsGlobal:e.IsGlobal,ActionCode:e.ActionCode,Usings:e.Usings};var n=new Array;n.push({name:"schemecode",value:this.schemecode}),n.push({name:"processid",value:this.processid}),n.push({name:"schemeid",value:this.schemeid}),n.push({name:"operation",value:"compile"}),n.push({name:"data",value:JSON.stringify(e)});$.ajax({url:this.Settings.apiurl,data:n,async:!0,type:"post",success:function(e){try{e=JSON.parse(e)}catch(i){t.error(e)}i&&setTimeout(function(){i(e)},100)}})},this.getemptytype=function(e,t){var i=new Array;i.push({name:"operation",value:"getemptytype"}),i.push({name:"data",value:JSON.stringify(e)});$.ajax({url:this.Settings.apiurl,data:i,async:!0,type:"post",success:function(e){t&&setTimeout(function(){t(e)},100)}})},this.requestautocompletesuggestions=function(e,t){var i=new Array;i.push({name:"operation",value:"getautocompletesuggestions"}),i.push({name:"category",value:e}),i.push({name:"value",value:t});var n=$.ajax({url:this.Settings.apiurl,data:i,async:!1,type:"post"});return JSON.parse(n.responseText)},this.readonlymode=function(e){var t=this;void 0===e||null==e?(t.Settings.notrendertoolbar=!1,t.Settings.notshowwindows=!1,t.Settings.disableobjectmovements=!1):(void 0!=e.notrendertoolbar?t.Settings.notrendertoolbar=e.notrendertoolbar:t.Settings.notrendertoolbar=!1,void 0!=e.notshowwindows?t.Settings.notshowwindows=e.notshowwindows:t.Settings.notshowwindows=!1,void 0!=e.disableobjectmovements?t.Settings.disableobjectmovements=e.disableobjectmovements:t.Settings.disableobjectmovements=!1),t.Settings.readonly=!0,t.Settings.printable&&(t.Settings.graphheight=t.Settings.originalgraphheighth,t.Settings.graphwidth=t.Settings.originalgraphwidth,t.Settings.printable=!1),t.render()},this.printablemode=function(){var e=this;e.Settings.printable||(e.Settings.originalgraphheighth=e.Settings.graphheight,e.Settings.originalgraphwidth=e.Settings.graphwidth),e.Settings.notrendertoolbar=!0,e.Settings.notshowwindows=!0,e.Settings.disableobjectmovements=!1,e.Settings.readonly=!0,e.Settings.printable=!0,e.render()},this.editablemode=function(){var e=this;e.Settings.notrendertoolbar=!1,e.Settings.notshowwindows=!1,e.Settings.disableobjectmovements=!1,e.Settings.readonly=!1,e.Settings.printable&&(e.Settings.graphheight=e.Settings.originalgraphheighth,e.Settings.graphwidth=e.Settings.originalgraphwidth,e.Settings.printable=!1),e.render()},void 0!=e.notrendertoolbar&&(this.Settings.notrendertoolbar=e.notrendertoolbar),void 0!=e.notshowwindows&&(this.Settings.notshowwindows=e.notshowwindows),void 0!=e.disableobjectmovements&&(this.Settings.disableobjectmovements=e.disableobjectmovements),void 0===this.Settings.mode?this.editablemode():"readonly"===this.Settings.mode.toLowerCase()?this.readonlymode(e):"printable"===this.Settings.mode.toLowerCase()?this.printablemode():this.editablemode()}function WorkflowDesignerActivity(){this.type="WorkflowDesignerActivity",this.init=function(e){this.designer=e,this.Layer=new Konva.Layer,this.designer.Stage.add(this.Layer),this.Layer.setZIndex(1),this.ImageCreateTransitionAndActivity=new Image,this.ImageCreateTransitionAndActivity.src=this.designer.Settings.imagefolder+"designer.createat.png",this.ImageCreateTransition=new Image,this.ImageCreateTransition.src=this.designer.Settings.imagefolder+"designer.createt.png",this.ImageDeleteActivity=new Image,this.ImageDeleteActivity.src=this.designer.Settings.imagefolder+"designer.delete.png"},this.ItemControls=new Array,this.draw=function(){null!=this.ItemControls&&this.ItemControls.forEach(function(e){e.control.destroy()}),this.ItemControls=new Array;var e=this;void 0!=this.designer.data.Activities&&this.designer.data.Activities.forEach(function(t){var i,n;if(""!=t.DesignerSettings.X&&""!=t.DesignerSettings.Y)i=Number(t.DesignerSettings.X),n=Number(t.DesignerSettings.Y);else{var o=e.GetDefaultPosition();i=o.x,n=o.y}var r=new WorkflowDesignerActivityControl({x:i,y:n,item:t,designer:e.designer,manager:e});e.ItemControls.push(r),r.Draw(),r.Sync()}),this.Layer.batchDraw()},this.CreateNewActivity=function(e,t){void 0==e&&(e=this.GetDefaultPosition()),void 0==t&&(t={IsAutoSchemeUpdate:!0,IsForSetState:!0}),void 0==t.Name&&(t.Name=this.GetDefaultName()),0==this.designer.data.Activities.length&&(t.IsInitial=!0),t.DesignerSettings&&(t.DesignerSettings=new{X:e.x,Y:e.y});var i=new WorkflowDesignerActivityControl({x:e.x,y:e.y,item:t,designer:this.designer,manager:this});return this.designer.data.Activities.push(t),this.ItemControls.push(i),i.Draw(),i.Sync(),i},this.GetDefaultName=function(){for(var e=WorkflowDesignerConstants.ActivityNamePrefix,t=1,i=0;i<this.designer.data.Activities.length;i++){var n=this.designer.data.Activities[i];n.Name==e+t&&(t++,i=-1)}return e+t},this.GetDefaultPosition=function(){for(var e=this.designer.CorrectPossition({x:50,y:70},this.Layer),t=this.designer.Settings.DefaultMoveStep/this.Layer.getScaleX(),i=0;i<this.ItemControls.length;i++){var n=this.ItemControls[i].control.getPosition();n.x==e.x&&n.y==e.y&&(e.x+=t,e.y+=t,i=-1)}return e},this.find=function(e){if("object"==typeof e&&void 0!=e.Name)return this.find(e.Name);for(var t=0;t<this.ItemControls.length;t++)if(this.ItemControls[t].GetName()==e)return this.ItemControls[t]},this.getIntersectingActivity=function(e){for(var t=0;t<this.ItemControls.length;t++){var i=this.ItemControls[t];if(i.getIntersectingActivity(e))return i}},this.LayerSetOffset=function(e){this.Layer.setOffset(e)},this.LayerScale=function(e){this.Layer.setScale({x:this.Layer.getScale().x+e,y:this.Layer.getScale().y+e})},this.LayerScaleNorm=function(e){this.Layer.setScale({x:1,y:1}),this.Layer.setOffset({x:0,y:0})},this.redrawTransitions=function(){return void 0==this.cTransition&&(this.cTransition=this.designer.GetComponentByType("WorkflowDesignerTransition")),this.cTransition.batchDraw()},this.batchDraw=function(){this.Layer.batchDraw()},this.DeselectAll=function(){this.ItemControls.forEach(function(e){e.Deselect()})},this.GetSizeForSaveAsImage=function(e){for(var t=0;t<this.ItemControls.length;t++){var i=this.ItemControls[t],n=i.rectangle.getAbsolutePosition(),o=n.x,r=n.y,a=o+i.rectangle.getWidth()*this.Layer.getScaleX(),s=r+i.rectangle.getHeight()*this.Layer.getScaleX();o<e.x1&&(e.x1=o),r<e.y1&&(e.y1=r),a>e.x2&&(e.x2=a),s>e.y2&&(e.y2=s)}return e},this.GetSelected=function(){var e=new Array;return this.ItemControls.forEach(function(t){t.selected&&e.push(t)}),e},this.SelectByPosition=function(e){this.ItemControls.forEach(function(t){t.getIntersectingActivityRect(e)&&t.Select()})},this.SelectByItem=function(e){this.ItemControls.forEach(function(t){t.item==e&&t.Select()})},this.ObjectMove=function(e){this.ItemControls.forEach(function(t){t.selected&&e.sender!=t&&t.ObjectMove(e.changepos)}),this.redrawTransitions()},this.createTransitionAndActivity=function(e){var t={x:e.control.getX()+e.rectangle.attrs.width+70,y:e.control.getY()},i=this.CreateNewActivity(t),n=this.designer.GetComponentByType("WorkflowDesignerTransition");n.CreateNewTransition(e,i),this.designer.redrawAll()},this.createTransition=function(e){var t=this.designer.GetComponentByType("WorkflowDesignerTransition");return t.CreateNewTransition(e)}}function WorkflowDesignerActivityControl(e){var t=this;this.manager=e.manager,this.designer=e.designer,this.x=e.x,this.y=e.y,this.item=e.item,this.control=void 0,this.rectangle=void 0,this.text=void 0,this.deleteButton=void 0,this.createTransitionAndActivityButton=void 0,this.createTransitionButton=void 0,this.selected=!1,this.dependentTransitions=new Array,this.getX=function(){return this.rectangle.attrs.x+this.control.attrs.x},this.getY=function(){return this.rectangle.attrs.y+this.control.attrs.y},this.GetName=function(){return this.item.Name},this.SetName=function(e){this.item.Name=e},this.Draw=function(){var i=t.designer.Settings,n=!t.designer.Settings.disableobjectmovements;t.control=new Konva.Group({x:e.x,y:e.y,rotation:0,draggable:n,dragBoundFunc:function(e){var n=(i.DefaultMoveStep*t.manager.Layer.getScaleX(),i.DefaultMoveStep*t.manager.Layer.getScaleY()),e={x:Math.round(e.x/n)*n,y:Math.round(e.y/n)*n};if(t.selected){var o=this.getAbsolutePosition();t.manager.ObjectMove({sender:t,changepos:{x:e.x-o.x,y:e.y-o.y}})}return e}});var o=WorkflowDesignerConstants.ActivityColor;t.item.IsFinal&&(o=WorkflowDesignerConstants.ActivityFinalColor),t.item.IsInitial&&(o=WorkflowDesignerConstants.ActivityInitialColor),t.designer.GetCurrentActivity()==t.item.Name&&(o=WorkflowDesignerConstants.ActivityCurrentColor),t.rectangle=new Konva.Rect({x:0,y:0,width:this.designer.Settings.DefaultActivityWidth,height:this.designer.Settings.DefaultActivityHeight,stroke:"#CECECE",strokeWidth:1,fill:o,shadowOpacity:.5,cornerRadius:5}),t.text=new Konva.Text({x:2,y:2,text:this.GetName(),fontSize:12,fontFamily:"Calibri",fill:"black"}),t.text.setX((t.rectangle.attrs.width-t.text.getWidth())/2),t.text.setY((t.rectangle.attrs.height-t.text.getHeight())/2-6),void 0==t.item.State&&(t.item.State=""),t.stateText=new Konva.Text({x:2,y:2,text:WorkflowDesignerConstants.ActivityFormLabel.State+": "+t.item.State,fontSize:12,fontFamily:"Calibri",fontStyle:"bold",fill:"black"}),t.stateText.setX((t.rectangle.attrs.width-t.stateText.getWidth())/2),t.stateText.setY(t.text.getY()+15),t.control.add(t.rectangle),t.control.add(t.text),t.control.add(t.stateText),t.designer.Settings.disableobjectmovements||(this.control.on("dragend",this.Sync),this.control.on("dragmove",this._onMove),this.control.on("click",this._onClick)),this.control.on("dblclick",this._onDblClick),t.designer.Settings.readonly||(t.deleteButton=new Konva.Image({x:t.rectangle.attrs.width-13,y:3,image:t.manager.ImageDeleteActivity,width:10,height:10}),t.createTransitionAndActivityButton=new Konva.Image({x:t.rectangle.attrs.width-13,y:t.rectangle.attrs.height-26,image:t.manager.ImageCreateTransitionAndActivity,width:10,height:10}),t.createTransitionButton=new Konva.Image({x:t.rectangle.attrs.width-13,y:t.rectangle.attrs.height-13,image:t.manager.ImageCreateTransition,width:10,height:10}),t.control.add(t.deleteButton),t.control.add(t.createTransitionAndActivityButton),t.control.add(t.createTransitionButton),this.deleteButton.on("click",this._onDelete),this.createTransitionAndActivityButton.on("click",this._onCreateTransitionAndActivity),this.createTransitionButton.on("click",this._onCreateTransition)),t.manager.Layer.add(t.control)},this.Delete=function(){this.control.destroy(),this.designer.data.Activities.splice(this.designer.data.Activities.indexOf(this.item),1),this.manager.ItemControls.splice(this.manager.ItemControls.indexOf(this),1);for(var e=new Array,t=0;t<this.dependentTransitions.length;t++)e.push(this.dependentTransitions[t]);for(var t=0;t<e.length;t++)e[t].Delete()},this.Select=function(){this.rectangle.setStrokeWidth(4),this.rectangle.setOpacity(.5),this.rectangle.setStroke(WorkflowDesignerConstants.SelectColor),this.selected=!0},this.Deselect=function(){this.rectangle.setStrokeWidth(1),this.rectangle.setOpacity(1),this.rectangle.setStroke("#CECECE"),this.selected=!1},this.ObjectMove=function(e){var i=this.control.getAbsolutePosition();if(i.x+=e.x,i.y+=e.y,this.control.setAbsolutePosition(i),this.Sync(),!(t.dependentTransitions.length<1))for(var n=0;n<t.dependentTransitions.length;n++){var o=t.dependentTransitions[n];o.middle=void 0,o.Draw()}},this._onMove=function(){if(!(t.dependentTransitions.length<1)){var e=20,i=!1;if(void 0==t.oldpos)t.oldpos=t.control.getPosition();else{var n=t.control.getPosition();(Math.abs(n.x-t.oldpos.x)>e||Math.abs(n.y-t.oldpos.y)>e)&&(i=!0)}for(var o=0;o<t.dependentTransitions.length;o++){var r=t.dependentTransitions[o];i&&(r.middle=void 0),r.Draw()}t.manager.redrawTransitions()}},this._onClick=function(e){var i=t.selected;e.evt.ctrlKey||t.designer.DeselectAll(),i?t.Deselect():t.Select(),t.manager.batchDraw()},this._onDblClick=function(){t.designer.DeselectAll(),t.Select(),t.manager.batchDraw(),t.designer.Settings.notshowwindows||t.ShowProperties()},this._onDelete=function(){confirm(WorkflowDesignerConstants.DeleteConfirm)&&(t.Delete(),t.designer.redrawAll())},this._onCreateTransitionAndActivity=function(){t.manager.createTransitionAndActivity(t)},this._onCreateTransition=function(){t.manager.createTransition(t)},this.RegisterTransition=function(e){for(var t=!1,i=0;i<this.dependentTransitions.length;i++)if(this.dependentTransitions[i].GetName()==e.GetName()){t=!0;break}t||this.dependentTransitions.push(e)},this.UnregisterTransition=function(e){for(var t=new Array,i=0;i<this.dependentTransitions.length;i++)this.dependentTransitions[i].GetName()!=e.GetName()&&t.push(this.dependentTransitions[i]);this.dependentTransitions=t},this.RegisterTransition=function(e){for(var t=!1,i=0;i<this.dependentTransitions.length;i++)if(this.dependentTransitions[i].GetName()==e.GetName()){t=!0;break}t||this.dependentTransitions.push(e)},this.UnregisterTransition=function(e){for(var t=new Array,i=0;i<this.dependentTransitions.length;i++)this.dependentTransitions[i].GetName()!=e.GetName()&&t.push(this.dependentTransitions[i]);this.dependentTransitions=t},this.getRectPos=function(){var e=this.rectangle.getAbsolutePosition(),t=e.x,i=e.y,n=t+this.rectangle.getWidth()*this.manager.Layer.getScaleX(),o=i+this.rectangle.getHeight()*this.manager.Layer.getScaleY();return{xl:t,yl:i,xr:n,yr:o}},this.getIntersectingActivity=function(e){var t=this.getRectPos();return e.x>=t.xl&&e.x<t.xr&&e.y>=t.yl&&e.y<t.yr},this.getIntersectingActivityRect=function(e){var t=this.getRectPos();return!(e.xl>t.xr||e.xr<t.xl||e.yl>t.yr||e.yr<t.yl)},this.ShowProperties=function(){var e=WorkflowDesignerConstants.ActivityFormLabel,i=[{name:e.ImpOrder,code:"impOrder",field:"Order",type:"input",width:"40px"},{name:e.ImpAction,code:"impAction",field:"ActionName",type:"select",datasource:t.designer.getActionNames()},{name:e.ImpActionParameter,code:"impparam",field:"ActionParameter",type:"json",openautocompleteonclick:!0,datasource:function(e,i){var n=$(this.element[0]).closest("tr"),o=n.find("[name=impAction]")[0].value;i(t.designer.getAutoCompleteSuggestions("actionparameter",o,e.term))}}],n={type:"form",title:e.Title,width:"800px",data:this.item,elements:[{name:e.Name,field:"Name",type:"input"},{name:e.State,field:"State",type:"input"},{name:e.IsInitial,field:"IsInitial",type:"checkbox"},{name:e.IsFinal,field:"IsFinal",type:"checkbox"},{name:e.IsForSetState,field:"IsForSetState",type:"checkbox"},{name:e.IsAutoSchemeUpdate,field:"IsAutoSchemeUpdate",type:"checkbox"},{name:e.Implementation,field:"Implementation",type:"table",elements:i,onrowadded:function(e){var t=e.find("[name=impOrder]");""===t[0].value&&(t[0].value=e.parent().children().length)}},{name:e.PreExecutionImplementation,field:"PreExecutionImplementation",type:"table",elements:i,onrowadded:function(e){var t=e.find("[name=impOrder]");""===t[0].value&&(t[0].value=e.parent().children().length)}}],designer:t.designer,readonly:t.designer.Settings.readonly},o=new WorkflowDesignerForm(n),r=function(e,i){var n=!0;return n&=e.CheckRequired([i],["Name"],WorkflowDesignerConstants.FieldIsRequired),t.designer.data.Activities.forEach(function(o){o!=t.item&&o.Name==i.Name&&(n=!1,e.ControlAddError(i.control_Name,WorkflowDesignerConstants.FieldMustBeUnique))}),e.CheckRequired(i.Implementation,["ActionName","Order"],WorkflowDesignerConstants.FieldIsRequired)||(n=!1),e.CheckRequired(i.PreExecutionImplementation,["ActionName","Order"],WorkflowDesignerConstants.FieldIsRequired)||(n=!1),n},a=function(e){return!!r(o,e)&&(o.ClearTempField(e),t.item.Name=e.Name,t.item.State=e.State,t.item.IsInitial=e.IsInitial,t.item.IsFinal=e.IsFinal,t.item.IsForSetState=e.IsForSetState,t.item.IsAutoSchemeUpdate=e.IsAutoSchemeUpdate,t.item.Implementation=e.Implementation,t.item.PreExecutionImplementation=e.PreExecutionImplementation,WorkflowDesignerCommon.DataCorrection(t.designer.data),t.designer.Draw(t.designer.data),!0)};o.showModal(a)},this.Sync=function(){void 0==t.item.DesignerSettings&&(t.item.DesignerSettings={});var e=t.control.getPosition();t.item.DesignerSettings.X=e.x,t.item.DesignerSettings.Y=e.y,t.oldpos=void 0}}function WorkflowDesignerBackground(){this.type="WorkflowDesignerBackground",this.init=function(e){var t=this;this.designer=e,this.BackgroundLayer=new Konva.Layer,this.designer.Stage.add(this.BackgroundLayer),this.BackgroundLayer.setZIndex(0),this.SelectionLayer=new Konva.Layer,this.designer.Stage.add(this.SelectionLayer),this.SelectionLayer.setZIndex(1);var i=new Image;i.onload=function(){t.RectBG.setFillPatternImage(i),t.BackgroundLayer.batchDraw()},i.src=this.designer.Settings.imagefolder+"grid.gif",this.RectBG=new Konva.Rect({x:0,y:0,width:5e3,height:5e3,draggable:!1,dragBoundFunc:function(e){var i=t.designer.Settings.DefaultMoveStep*t.BackgroundLayer.getScaleX(),n=t.designer.Settings.DefaultMoveStep*t.BackgroundLayer.getScaleY(),o={x:Math.round(e.x/i)*i,y:Math.round(e.y/n)*n};return t.designer.GraphLayerSetOffset(-o.x/t.BackgroundLayer.getScaleX(),-o.y/t.BackgroundLayer.getScaleY()),o},designerparam:"background"}),this.BackgroundLayer.add(this.RectBG),this.BackgroundLayer.batchDraw(),this.designer.Stage.on("mousedown.background",function(e){t._movemodeenabled||"background"!==e.target.attrs.designerparam||(t._mousedownpos=t.designer.CorrectPossition({x:e.evt.offsetX,y:e.evt.offsetY},t.SelectionLayer))}),this.designer.Stage.on("mousemove.background",function(e){if(!t._movemodeenabled&&t._mousedownpos){var i=t.designer.CorrectPossition({x:e.evt.offsetX,y:e.evt.offsetY},t.SelectionLayer);t.DrawSelectionRect(i)}}),this.designer.Stage.on("mouseup.background",function(e){if(!t._movemodeenabled&&void 0!=t._mousedownpos){var i=t.getSelectionRectPos();void 0==i?e.evt.ctrlKey||t.designer.DeselectAll():(Math.abs(i.xl-i.xr)>10||Math.abs(i.yl-i.yr)>10)&&(t.designer.DeselectAll(),t.designer.ComponentsExecute("SelectByPosition",i))}t._mousedownpos=void 0,t.DeleteSelectionRect()})},this.setMoveModeEnabled=function(e){this._movemodeenabled=e,this.RectBG.setDraggable(this._movemodeenabled)},this.LayerScale=function(e){this.BackgroundLayer.setScale({x:this.BackgroundLayer.getScale().x+e,y:this.BackgroundLayer.getScale().y+e})},this.LayerScaleNorm=function(e){this.BackgroundLayer.setScale({x:1,y:1}),this.SelectionLayer.setScale({x:1,y:1}),this.RectBG.setPosition({x:0,y:0})},this.DrawSelectionRect=function(e){this.RectSelection?(this.RectSelection.setWidth(e.x-this._mousedownpos.x),this.RectSelection.setHeight(e.y-this._mousedownpos.y)):(this.RectSelection=new Konva.Rect({x:this._mousedownpos.x,y:this._mousedownpos.y,width:e.x-this._mousedownpos.x,height:e.y-this._mousedownpos.y,draggable:!1,fill:"#66CCFF",opacity:.2}),this.SelectionLayer.add(this.RectSelection)),this.SelectionLayer.batchDraw()},this.DeleteSelectionRect=function(e){this.RectSelection&&(this.RectSelection.destroy(),this.RectSelection=void 0,this.SelectionLayer.batchDraw())},this.getSelectionRectPos=function(){if(void 0!=this.RectSelection){var e=this.RectSelection.getAbsolutePosition(),t=e.x,i=e.y,n=t+this.RectSelection.getWidth()*this.SelectionLayer.getScaleX(),o=i+this.RectSelection.getHeight()*this.SelectionLayer.getScaleX();return{xl:Math.min(t,n),yl:Math.min(i,o),xr:Math.max(t,n),yr:Math.max(i,o)}}}}function WorkflowDesignerKeyboard(){this.type="WorkflowDesignerKeyboard",this.init=function(e){this.designer=e}}function WorkflowDesignerToolbar(){this.type="WorkflowDesignerToolbar";var e=this;this.init=function(t){this.designer=t,this.Layer=new Konva.Layer,this.designer.Stage.add(this.Layer),this.Layer.setZIndex(10);var i=20,n=12,o=0;this.InitItems(),e.background=new Konva.Rect({x:0,y:0,width:this.designer.Settings.graphwidth,height:50,fill:"white",shadowEnabled:!0,shadowBlur:5,shadowOpacity:.3}),e.Layer.add(e.background),this.Items.forEach(function(t){t.index=o,o++,t.separator||(t.ImageToolbar=new Image,t.ImageToolbar.onload=function(){t.cImageToolbar=new Konva.Image({x:i+35*t.index,y:n,image:t.ImageToolbar,width:24,height:24,strokeWidth:0}),t.cImageToolbar.on("click",t.click),e.Layer.add(t.cImageToolbar),WorkflowDesignerTooltip(e.Layer,t.cImageToolbar,t.title,30),e.Layer.batchDraw()},t.ImageToolbar.src=e.designer.Settings.imagefolder+t.img,t.imgactive&&(t.ImageActiveToolbar=new Image,t.ImageActiveToolbar.src=e.designer.Settings.imagefolder+t.imgactive))}),this.CreateInfoBlock({x:this.designer.Settings.graphwidth-100,y:n-10});var r=this.GetWorkflowDesignerBackground();r.RectBG.setDraggable(!1)},this.draw=function(){this.GraphRedrawAll()},this.GraphRedrawAll=function(){this.UpdateInfoBlock(),this.Layer.batchDraw()},this.CreateInfoBlock=function(e){this.infoText=new Konva.Text({text:this.GetInfoBlockText(),fontFamily:"Calibri",fontSize:12,padding:5,fill:"black"}),this.infoTextValue=new Konva.Text({text:this.GetInfoBlockTextValue(),fontFamily:"Calibri",fontSize:12,padding:5,fill:"black",x:60}),this.info=new Konva.Group(e),this.info.add(this.infoText),this.info.add(this.infoTextValue),this.Layer.add(this.info)},this.UpdateInfoBlock=function(e){this.infoTextValue.setText(this.GetInfoBlockTextValue())},this.GetInfoBlockText=function(){return WorkflowDesignerConstants.InfoBlockLabel.Activity+"\r\n"+WorkflowDesignerConstants.InfoBlockLabel.Transition+"\r\n"+WorkflowDesignerConstants.InfoBlockLabel.Command},this.GetInfoBlockTextValue=function(){var e=0,t=0,i=0;void 0!=this.designer.data&&(e=this.designer.data.Activities.length,t=this.designer.data.Transitions.length,i=this.designer.data.Commands.length);var n=[e,t,i],o="";return n.forEach(function(e){for(var t="",i=e.toString(),n=0;n<4-i.length;n++)t+="  ";o.length>0&&(o+="\r\n"),o+=t+i}),o},this.ToolbarMovePress=function(){var e=this.GetWorkflowDesignerBackground();e.setMoveModeEnabled(!e._movemodeenabled);var t=this.GetItemByCode("move").cImageToolbar;e._movemodeenabled?(t.setStrokeWidth(4),t.setStrokeEnabled(!0),t.setStroke(WorkflowDesignerConstants.SelectColor)):(t.setStrokeEnabled(!1),t.setStroke("black")),this.Layer.batchDraw()},this.GetWorkflowDesignerBackground=function(){return this.designer.GetComponentByType("WorkflowDesignerBackground")},this.CreateActivity=function(){var e=this.designer.GetComponentByType("WorkflowDesignerActivity");e.CreateNewActivity(),this.designer.redrawAll()},this.AutoArrangement=function(){if(0!=e.designer.data.Activities.length){var t=new Array;e.designer.data.Activities.forEach(function(e){e.IsInitial&&t.push(e)}),e.designer.data.Activities.forEach(function(i){if(!i.IsInitial){for(var n=!0,o=0;o<e.designer.data.Transitions.length;o++){var r=e.designer.data.Transitions[o];if("Direct"==r.Classifier&&r.To==i){n=!1;break}}n&&t.push(i)}}),0==t.length&&t.push(e.designer.data.Activities[0]);var i={x:80,y:80},n={x:250,y:150},o=Array(),r=function(t,i,a){var s={x:i.x,y:i.y};a||(s.x+=n.x);for(var d=new Array,l=0;l<t.length;l++){var c=t[l];void 0==c.DesignerSettings&&(c.DesignerSettings={}),!a&&$.inArray(c,o)>=0||(c.DesignerSettings.X=s.x,o.push(c),d.push(c))}for(var l=0;l<d.length;l++){var c=d[l];l>0&&(s.y+=n.y);var h=new Array;e.designer.data.Transitions.forEach(function(e){"Direct"==e.Classifier&&e.From==c&&h.push(e.To)}),c.DesignerSettings.Y=s.y;var m=r(h,{x:s.x,y:s.y});s.y=m.y}return{x:s.x,y:s.y}};r(t,i,!0),e.designer.data.Transitions.forEach(function(e){void 0==e.DesignerSettings&&(e.DesignerSettings={}),e.DesignerSettings.X=void 0,e.DesignerSettings.Y=void 0}),e.designer.Draw(e.designer.data)}},this.CopySelectedGenUniqueValue=function(e,t,i){for(var n=e,o=1;!0;o++){for(var r=!1,a=0;a<t.length;a++)if(t[a][i]==n){r=!0;break}if(!r)break;n=e+"_"+o}return n},this.CopySelected=function(){var t=this.designer.GetComponentByType("WorkflowDesignerActivity"),i=this.designer.GetComponentByType("WorkflowDesignerTransition"),n=t.GetSelected(),o=i.GetSelected(),r=[];n.forEach(function(t){var i=JSON.parse(JSON.stringify(t.item));i.DesignerSettings.Y+=150,i.Name=e.CopySelectedGenUniqueValue(i.Name,e.designer.data.Activities,"Name"),r.push({oldItem:t.item,newItem:i}),e.designer.data.Activities.push(i)});var a=[];o.forEach(function(t){for(var i=t.item.From,n=t.item.To,o=0;o<r.length;o++)i==r[o].oldItem&&(i=r[o].newItem),n==r[o].oldItem&&(n=r[o].newItem);var s=JSON.parse(JSON.stringify(t.item));s.Name=e.CopySelectedGenUniqueValue(s.Name,e.designer.data.Transitions,"Name"),s.From=i,s.To=n,a.push({oldItem:t.item,newItem:s}),e.designer.data.Transitions.push(s)}),WorkflowDesignerCommon.DataCorrection(e.designer.data),e.designer.Draw(e.designer.data),r.forEach(function(e){t.SelectByItem(e.newItem)}),a.forEach(function(e){i.SelectByItem(e.newItem)})},this.EditLocalization=function(){var t=WorkflowDesignerConstants.LocalizationFormLabel,i={type:"table",title:t.Title,width:"800px",data:this.designer.data.Localization,datadefault:{Culture:"en-US",Type:"State"},elements:[{name:t.ObjectName,field:"ObjectName",type:"input"},{name:t.Type,field:"Type",type:"select",displayfield:"Name",valuefield:"Value",datasource:[{Name:t.Types[0],Value:"Command"},{Name:t.Types[1],Value:"State"},{Name:t.Types[2],Value:"Parameter"}]},{name:t.IsDefault,field:"IsDefault",type:"checkbox"},{name:t.Culture,field:"Culture",type:"input"},{name:t.Value,field:"Value",type:"input"}],readonly:this.designer.Settings.readonly},n=new WorkflowDesignerForm(i),o=function(t,o){return!(!n.CheckRequired(t,["ObjectName","Type","Culture","Value"],WorkflowDesignerConstants.FieldIsRequired)||!n.CheckUnique(t,["ObjectName","Type","Culture"],WorkflowDesignerConstants.FieldMustBeUnique))&&(n.ClearTempField(t),e.SyncTable(e.designer.data.Localization,t,i),!0)};n.showModal(o)},this.EditTimer=function(){var t=WorkflowDesignerConstants.TimerFormLabel,i={type:"table",title:t.Title,width:"800px",data:this.designer.data.Timers,keyproperty:"Name",elements:[{name:t.Name,field:"Name",type:"input"},{name:t.Type,field:"Type",type:"select",datasource:this.designer.data.AdditionalParams.TimerTypes},{name:t.Value,field:"Value",type:"input"},{name:t.NotOverrideIfExists,field:"NotOverrideIfExists",type:"checkbox"}],readonly:this.designer.Settings.readonly},n=new WorkflowDesignerForm(i),o=function(t,o){return!(!n.CheckRequired(t,["Name","Type","Value"],WorkflowDesignerConstants.FieldIsRequired)||!n.CheckUnique(t,["Name"],WorkflowDesignerConstants.FieldMustBeUnique))&&(n.ClearTempField(t),void 0==e.designer.data.Timers&&(e.designer.data.Timers=[]),e.SyncTable(e.designer.data.Timers,t,i),!0)};n.showModal(o)},this.EditActors=function(){var e=this,t=WorkflowDesignerConstants.ActorFormLabel,i={type:"table",title:t.Title,width:"800px",data:this.designer.data.Actors,keyproperty:"Name",elements:[{name:t.Name,field:"Name",type:"input"},{name:t.Rule,field:"Rule",type:"select",datasource:this.designer.getActorNames()},{name:t.Value,field:"Value",type:"json",openautocompleteonclick:!0,datasource:function(t,i){var n=$(this.element[0]).closest("tr"),o=n.find("[name=Rule]")[0].value;i(e.designer.getAutoCompleteSuggestions("ruleparameter",o,t.term))}}],designer:e.designer,readonly:this.designer.Settings.readonly},n=new WorkflowDesignerForm(i),o=function(t,o){return!(!n.CheckRequired(t,["Name","Rule"],WorkflowDesignerConstants.FieldIsRequired)||!n.CheckUnique(t,["Name"],WorkflowDesignerConstants.FieldMustBeUnique))&&(n.ClearTempField(t),e.SyncTable(e.designer.data.Actors,t,i),
!0)};n.showModal(o)},this.EditParameters=function(){var e=WorkflowDesignerConstants.ParameterFormLabel,t=this,i=function(e,i,n){for(var o=void 0,r=e.getEditData(e.parameters),a=0;a<r.length;a++){var s=r[a];if(s.control_InitialValue.id===i.id){o=s.Type;break}}void 0!=o&&t.designer.designer.getemptytype(encodeURIComponent(o),n)},n={type:"table",title:e.Title,width:"900px",data:this.designer.data.Parameters,datadefault:{Purpose:"Persistence"},keyproperty:"Name",elements:[{name:e.Name,field:"Name",type:"input"},{name:e.Type,field:"Type",type:"input",datasource:this.designer.getTypeNames(),width:"35%"},{name:e.Purpose,field:"Purpose",type:"select",displayfield:"Name",datasource:[{Name:"Temporary"},{Name:"Persistence"},{Name:"System"}]},{name:e.InitialValue,field:"InitialValue",type:"json",width:"25%",getemptytype:i}],top:$('<div style="float: right;"></div>'),beforerowadded:function(e){void 0!=e.Type&&(e.Type=decodeURIComponent(e.Type))},onrowadded:function(e){var t=e.find("[name=Purpose]"),i=t[0];t.change(function(){s(e)}),void 0!=i&&"System"!==i.value&&e.find('[name=Purpose] option[value="System"]').remove(),s(e)},designer:t.designer,readonly:this.designer.Settings.readonly},o=new WorkflowDesignerForm(n),r=function(){for(var e=$(o.window.find(".WorkflowDesignerTable"))[0],t=0;t<e.rows.length;t++){var i=$(e.rows[t]),n=i.find("[name=Purpose]")[0];void 0!=n&&"System"===n.value&&i.hide()}},a=function(){for(var e=$(o.window.find(".WorkflowDesignerTable"))[0],t=0;t<e.rows.length;t++){var i=$(e.rows[t]),n=i.find("[name=Purpose]")[0];void 0!=n&&"System"===n.value&&i.show()}},s=function(e){var t=e.find("[name=Purpose]")[0];void 0!=t&&"System"===t.value?(e.find(":input").attr("readonly",!0),e.find("[name=Purpose]").attr("disabled",!0),e.find("[name=InitialValue]").val(""),e.find(".btnDelete").remove()):void 0!=t&&"Temporary"===t.value?(e.find("[name=InitialValue]").attr("readonly",!0),e.find("[name=InitialValue]").val("")):void 0!=t&&"Persistence"===t.value&&e.find("[name=InitialValue]").attr("readonly",!1)},d=function(){for(var e=$(o.window.find(".WorkflowDesignerTable"))[0],t=0;t<e.rows.length;t++){var i=$(e.rows[t]);s(i)}};n.top.append('<input type="checkbox" id="check1"/><label for="check1">'+WorkflowDesignerConstants.ParameterFormLabel.ShowSystemParameters+"</label>"),n.top.buttonset().click(function(e,t){var i=n.top.buttonset().first()[0].childNodes[0].checked;i?a():r()});var l=function(e,i){if(o.CheckRequired(e,["Name","Type","Purpose","Parameter"],WorkflowDesignerConstants.FieldIsRequired)&&o.CheckUnique(e,["Name"],WorkflowDesignerConstants.FieldMustBeUnique)){o.ClearTempField(e),t.SyncTable(t.designer.data.Parameters,e,n);for(var r=0;r<t.designer.data.Parameters.length;r++){var a=t.designer.data.Parameters[r].Type;t.designer.data.Parameters[r].Type=encodeURIComponent(a)}return!0}return!1};o.showModal(l),r(),d()},this.EditCodeActions=function(){var t=WorkflowDesignerConstants.CodeActionsFormLabel,i={type:"table",title:t.Title,width:"800px",data:this.designer.data.CodeActions,datadefault:{},elements:[{name:t.Name,field:"Name",type:"input"},{name:t.Type,field:"Type",type:"select",displayfield:"Name",datasource:[{Name:"Action"},{Name:"Condition"},{Name:"RuleGet"},{Name:"RuleCheck"}]},{name:t.IsGlobal,field:"IsGlobal",type:"checkbox"},{name:t.ActionCode,field:"ActionCode",type:"code"}],designer:e.designer,readonly:this.designer.Settings.readonly},n=new WorkflowDesignerForm(i),o=function(t,o){if(n.CheckRequired(t,["Name","Type","ActionCode.code"],WorkflowDesignerConstants.FieldIsRequired)&&n.CheckUnique(t,["Name","Type"],WorkflowDesignerConstants.FieldMustBeUnique)){n.ClearTempField(t),e.SyncTable(e.designer.data.CodeActions,t,i);for(var r=0;r<e.designer.data.CodeActions.length;r++){var a=e.designer.data.CodeActions[r].ActionCode;e.designer.data.CodeActions[r].ActionCode=encodeURIComponent(a.code),WorkflowDesignerConstants.isjava||(e.designer.data.CodeActions[r].Usings=encodeURIComponent(a.usings))}return!0}return!1};n.showModal(o)},this.EditCommands=function(){var e=WorkflowDesignerConstants.CommandFormLabel,t=this,i=function(e,i,n){for(var o=void 0,r=void 0,a=e.getEditData(e.parameters),s=0;s<a.length;s++){var d=a[s];if(void 0!=d.InputParameters)for(var l=0;l<d.InputParameters.length;l++)if(d.InputParameters[l].control_DefaultValue.id===i.id){r=d.InputParameters[l].Parameter.Name;break}}if(void 0!=r)for(var c=t.designer.data.Parameters,s=0;s<c.length;s++)if(c[s].Name===r){o=c[s].Type;break}void 0!=o&&t.designer.designer.getemptytype(o,n)},n={type:"table",title:e.Title,width:"900px",data:this.designer.data.Commands,datadefault:{},keyproperty:"Name",elements:[{name:e.Name,field:"Name",type:"input"},{name:e.InputParameters,field:"InputParameters",type:"table",elements:[{name:e.InputParametersName,code:"ipname",field:"Name",type:"input"},{name:e.InputParametersParameter,code:"ipparameter",field:"Parameter.Name",type:"select",displayfield:"Name",datasource:this.designer.getNonSystemParameters()},{name:e.InputParametersIsRequired,code:"iisrequired",field:"IsRequired",type:"checkbox"},{name:e.InputParametersDefaultValue,code:"idefaultvalue",field:"DefaultValue",type:"json",width:"40%",getemptytype:i}]}],designer:t.designer,readonly:this.designer.Settings.readonly},o=new WorkflowDesignerForm(n),r=function(e,t){var i=!0;return i&=e.CheckRequired(t,["Name"],WorkflowDesignerConstants.FieldIsRequired),i&=e.CheckUnique(t,["Name"],WorkflowDesignerConstants.FieldMustBeUnique),t.forEach(function(t){e.CheckRequired(t.InputParameters,["Name","Parameter.Name"],WorkflowDesignerConstants.FieldIsRequired)||(i=!1)}),i},a=function(e){return!!r(o,e)&&(o.ClearTempField(e),t.SyncTable(t.designer.data.Commands,e,n),WorkflowDesignerCommon.DataCorrection(t.designer.data),t.GraphRedrawAll(),!0)};o.showModal(a)},this.EditAdditionalParameters=function(){var e=WorkflowDesignerConstants.AdditionalParamsFormLabel,t={type:"form",title:e.Title,width:"800px",data:this.designer.data.AdditionalParams,readonly:!0,elements:[{name:e.IsObsolete,field:"IsObsolete",type:"checkbox"},{name:e.DefiningParameters,field:"DefiningParameters",type:"textarea"},{name:e.ProcessParameters,field:"ProcessParameters",type:"table",elements:[{name:e.ProcessParametersName,field:"Name",type:"input"},{name:e.ProcessParametersValue,field:"Value",type:"input"}]}]},i=new WorkflowDesignerForm(t),n=function(e,t){return!0};i.showModal(n)},this.Items=new Array,this.InitItems=function(){this.designer.Settings.readonly||(this.Items.push({title:WorkflowDesignerConstants.ToolbarLabel.CreateActivity,img:"designer.tb.add.png",click:function(){e.CreateActivity()}}),this.Items.push({title:WorkflowDesignerConstants.ButtonTextDelete,img:"designer.tb.delete.png",click:function(){e.designer.DeleteSelected()}}),this.Items.push({title:WorkflowDesignerConstants.ToolbarLabel.CopySelected,img:"designer.tb.copy.png",click:function(){e.CopySelected()}}),this.Items.push({separator:!0})),this.Items.push({title:WorkflowDesignerConstants.ToolbarLabel.Move,img:"designer.tb.move.png",code:"move",click:function(){e.ToolbarMovePress()}}),this.Items.push({title:WorkflowDesignerConstants.ToolbarLabel.ZoomIn,img:"designer.tb.zoomIn.png",click:function(){e.designer.GraphLayerScale(.1)}}),this.Items.push({title:WorkflowDesignerConstants.ToolbarLabel.ZoomOut,img:"designer.tb.zoomOut.png",click:function(){e.designer.GraphLayerScale(-.1)}}),this.Items.push({title:WorkflowDesignerConstants.ToolbarLabel.ZoomPositionDefault,img:"designer.tb.zoomnorm.png",click:function(){e.designer.GraphLayerScaleNorm()}}),this.designer.Settings.disableobjectmovements||this.Items.push({title:WorkflowDesignerConstants.ToolbarLabel.AutoArrangement,img:"designer.tb.arrangment.png",click:function(){e.AutoArrangement()}}),this.Items.push({separator:!0}),this.designer.Settings.notshowwindows||(this.Items.push({title:WorkflowDesignerConstants.ToolbarLabel.Actors,img:"designer.tb.actor.png",click:function(){e.EditActors()}}),this.Items.push({title:WorkflowDesignerConstants.ToolbarLabel.Commands,img:"designer.tb.command.png",click:function(){e.EditCommands()}}),this.Items.push({title:WorkflowDesignerConstants.ToolbarLabel.Parameters,img:"designer.tb.parameter.png",click:function(){e.EditParameters()}}),this.Items.push({title:WorkflowDesignerConstants.ToolbarLabel.Localization,img:"designer.tb.locale.png",click:function(){e.EditLocalization()}}),this.Items.push({title:WorkflowDesignerConstants.ToolbarLabel.Timers,img:"designer.tb.timer.png",click:function(){e.EditTimer()}}),this.Items.push({title:WorkflowDesignerConstants.ToolbarLabel.CodeActions,img:"designer.tb.codeactions.png",click:function(){e.EditCodeActions()}}),this.Items.push({title:WorkflowDesignerConstants.ToolbarLabel.AdditionalParameters,img:"designer.tb.additionalparameters.png",click:function(){e.EditAdditionalParameters()}}))},this.GetItemByCode=function(e){for(var t=0;t<this.Items.length;t++){var i=this.Items[t];if(i.code==e)return i}},this.SyncTable=function(e,t,i){if(void 0==i.keyproperty){e.splice(0,e.length);for(var n=0;n<t.length;n++){var o={};i.elements.forEach(function(e){o[e.field]=t[n][e.field]}),e.push(o)}}else{for(var n=e.length-1;n>=0;n--){var r=$.grep(t,function(t){return e[n][i.keyproperty]==t.keyproperty});0==r.length?e.splice(n,1):i.elements.forEach(function(t){e[n][t.field]=r[0][t.field]})}for(var n=0;n<t.length;n++){var r=$.grep(e,function(e){return t[n][i.keyproperty]==e[i.keyproperty]});if(0==r.length){var o={};i.elements.forEach(function(e){o[e.field]=t[n][e.field]}),e.push(o)}}}}}function WorkflowDesignerTooltip(e,t,i,n){t.destroyToolTip=function(){void 0!=this.ToolTip&&(this.ToolTip.destroy(),this.ToolTip=void 0,e.batchDraw())},t.on("mouseover",function(){if(void 0==t.ToolTip){var o=new Konva.Label({x:t.getX()+t.getWidth()/2,y:t.getY()+n,opacity:.75});o.add(new Konva.Tag({fill:"black",pointerDirection:"up",pointerWidth:10,pointerHeight:10,lineJoin:"round",shadowColor:"black",shadowBlur:10,shadowOffset:10,shadowOpacity:.5})),o.add(new Konva.Text({text:i,fontFamily:"Calibri",fontSize:12,padding:5,fill:"white"})),e.add(o),t.ToolTip=o,e.batchDraw()}}),t.on("mouseleave",function(){t.destroyToolTip()})}function WorkflowDesignerTransition(){this.type="WorkflowDesignerTransition",this.init=function(e){this.designer=e,this.Layer=new Konva.Layer,this.designer.Stage.add(this.Layer),this.Layer.setZIndex(2),this.designer=e,this.APLayer=new Konva.Layer,this.designer.Stage.add(this.APLayer),this.APLayer.setZIndex(3),this.ImageDelete=new Image,this.ImageDelete.src=this.designer.Settings.imagefolder+"designer.delete.png"},this.ItemControls=new Array,this.draw=function(){null!=this.ItemControls&&this.ItemControls.forEach(function(e){e.destroy()}),this.ItemControls=new Array;var e=this;void 0!=this.designer.data.Transitions&&this.designer.data.Transitions.forEach(function(t){var i=e.designer.GetComponentByType("WorkflowDesignerActivity"),n=new WorkflowDesignerTransitionControl({from:i.find(t.From),to:i.find(t.To),item:t,designer:e.designer,manager:e});e.ItemControls.push(n),n.Draw()}),this.batchDraw()},this.batchDraw=function(){this.CorrectItems(),this.Layer.batchDraw(),this.APLayer.batchDraw()},this.CorrectItems=function(){for(var e=0;e<this.ItemControls.length;e++)for(var t=this.ItemControls[e],i=0;i<this.ItemControls.length;i++)if(e!=i){var n=this.ItemControls[i];t.start.x==n.start.x&&t.start.y==n.start.y&&(n.start.x+=5),t.end.x==n.end.x&&t.end.y==n.end.y&&(n.end.x+=5),t.middle.x==n.middle.x&&t.middle.y==n.middle.y&&(n.middle.x+=15)}},this.getIntersectingActivity=function(e){var t=this.designer.GetComponentByType("WorkflowDesignerActivity");return t.getIntersectingActivity(e)},this.LayerSetOffset=function(e,t){this.Layer.setOffset(e,t),this.APLayer.setOffset(e,t)},this.LayerScale=function(e){this.Layer.setScale({x:this.Layer.getScale().x+e,y:this.Layer.getScale().y+e}),this.APLayer.setScale({x:this.APLayer.getScale().x+e,y:this.APLayer.getScale().y+e})},this.LayerScaleNorm=function(e){this.Layer.setScale({x:1,y:1}),this.Layer.setOffset({x:0,y:0}),this.APLayer.setScale({x:1,y:1}),this.APLayer.setOffset({x:0,y:0})},this.DeselectAll=function(){this.ItemControls.forEach(function(e){e.Deselect()})},this.GetSelected=function(){var e=new Array;return this.ItemControls.forEach(function(t){t.selected&&e.push(t)}),e},this.SelectByPosition=function(e){this.ItemControls.forEach(function(t){t.getIntersectingRect(e)&&t.Select()})},this.SelectByItem=function(e){this.ItemControls.forEach(function(t){t.item==e&&t.Select()})},this.CreateNewTransition=function(e,t){var i=this;if(void 0==t){var n=e.control.getX()+e.rectangle.attrs.width,o=e.control.getY()+e.rectangle.attrs.height/2,r={x:n,y:o},a=new WorkflowDesignerTransitionTempControl({x:r.x,y:r.y,manager:this});a.Draw(r.x+10,r.y),this.batchDraw();var s=function(e){var t=i.designer.CorrectPossition({x:e.evt.offsetX,y:e.evt.offsetY},i.Layer);a.Redraw(t),i.Layer.batchDraw()},d=function(t){var n={x:t.evt.offsetX,y:t.evt.offsetY},o=i.getIntersectingActivity(n);void 0!=o&&i.CreateNewTransition(e,o),a.Delete(),i.designer.Stage.off("mousemove.WorkflowDesignerTransitionTempControl",s),i.designer.Stage.off("mouseup.WorkflowDesignerTransitionTempControl",d),i.batchDraw()};return this.designer.Stage.on("mousemove.WorkflowDesignerTransitionTempControl",s),this.designer.Stage.on("mouseup.WorkflowDesignerTransitionTempControl",d),a}var l={Name:this.GetDefaultName(e.GetName(),t.GetName()),From:e.item,To:t.item,Trigger:{Type:"Auto"},Conditions:[{Type:"Always"}],AllowConcatenationType:"And",RestrictConcatenationType:"And",ConditionsConcatenationType:"And",Classifier:"Direct",DesignerSettings:{}},c=new WorkflowDesignerTransitionControl({from:e,to:t,item:l,designer:i.designer,manager:i});return i.ItemControls.push(c),this.designer.data.Transitions.push(l),c.Draw(),c},this.GetDefaultName=function(e,t){for(var i=e+"_"+t+"_",n=1,o=0;o<this.designer.data.Transitions.length;o++){var r=this.designer.data.Transitions[o];r.Name==i+n&&(n++,o=-1)}return i+n}}function WorkflowDesignerTransitionControl(e){var t=this;this.manager=e.manager,this.designer=e.designer,this.from=e.from,this.to=e.to,this.item=e.item,this.setFrom=function(e){this.from=e,this.item.From=e.item},this.setTo=function(e){this.to=e,this.item.To=e.item},this.GetName=function(){return this.item.Name},this.SetName=function(e){this.item.Name=e},this.control=void 0,this.arrow=void 0,this.line=void 0,void 0!=this.item.DesignerSettings&&void 0!=this.item.DesignerSettings.X&&void 0!=this.item.DesignerSettings.Y?this.middle={x:Number(this.item.DesignerSettings.X),y:Number(this.item.DesignerSettings.Y)}:this.middle=void 0,this.from.RegisterTransition(this),this.to.RegisterTransition(this),this.start=void 0,this.end=void 0,this.angle=void 0,this.activePoint=void 0,this.touchpoints=[],this.DrawTransition=function(e,t){var i,n,o,r,a=this,s=this.from.rectangle;this.to.rectangle;i=Number(this.from.getX()),n=Number(this.from.getY()),o=Number(this.to.getX()),r=Number(this.to.getY());var d=Number(s.attrs.width/2),l=Number(s.attrs.height/2),c=25,h=i+d,m=n+l,g=o+d,u=r+l;if(this.direction={start:0,end:0},this.from==this.to)this.start={x:h+d,y:m-l+14},this.end={x:g+d-25,y:u-l},this.direction.end=1,void 0==this.middle&&(this.middle={x:h+d+l,y:m-2*l});else{var f=!1;void 0==this.middle&&(f=!0,this.middle={x:(h+g)/2,y:(m+u)/2});var p=h,y=m,v=g,w=u;if(m-l-c>this.middle.y&&u-l-c>this.middle.y?(y=m-l,w=u-l,this.direction.start=1,this.direction.end=1):m+l+c<this.middle.y&&u+l+c<this.middle.y?(y=m+l,w=u+l,this.direction.start=1,this.direction.end=1):h-d-c>this.middle.x&&g-d-c>this.middle.x?(p=h-d,v=g-d):h+d+c<this.middle.x&&g+d+c<this.middle.x?(p=h+d,v=g+d):(h+d+c<this.middle.x?p+=d:h-d-c>this.middle.x?p-=d:m+l+c<this.middle.y?(y+=l,this.direction.start=1):m-l-c>this.middle.y?(y-=l,this.direction.start=1):p<=this.middle.x?p+=d:p-=d,g+d+c<this.middle.x?v+=d:g-d-c>this.middle.x?v-=d:u+l+c<this.middle.y?(w+=l,this.direction.end=1):u-l-c>this.middle.y?(w-=l,this.direction.end=1):(y>=this.middle.y?w+=l:w-=l,this.direction.end=1)),void 0!=e&&(p=e.x,y=e.y,f=!0),void 0!=t&&(v=t.x,w=t.y,f=!0),this.start={x:p,y:y},this.end={x:v,y:w},f){this.middle={x:(p+v)/2,y:(y+w)/2};for(var C=0;C<a.manager.ItemControls.length;C++){var T=a.manager.ItemControls[C];T!=a&&T.middle.x==a.middle.x&&T.middle.y==a.middle.y&&(0==a.direction.start?a.middle.y+=40:a.middle.x+=40)}}void 0==e&&(0==this.direction.start?this.middle.y>y+l-7?y+=l-7:this.middle.y<y-l+7?y-=l-7:y=this.middle.y:this.middle.x>p+d-10?p+=d-10:this.middle.x<p-d+10?p-=d-10:p=this.middle.x),void 0==t&&(0==this.direction.end?this.middle.y>w+l-7?w+=l-7:this.middle.y<w-l+7?w-=l-7:w=this.middle.y:this.middle.x>v+d-10?v+=d-10:this.middle.x<v-d+10?v-=d-10:v=this.middle.x),this.start={x:p,y:y},this.end={x:v,y:w}}var S=this.GetColor();if(this.points=this.GetPoints([this.start.x,this.start.y,this.middle.x,this.middle.y,this.end.x,this.end.y],this.direction),this.angle=Math.atan2(this.points[this.points.length-1]-this.points[this.points.length-3],this.points[this.points.length-2]-this.points[this.points.length-4]),void 0==this.control){this.control=new Konva.Group({x:0,y:0,rotation:0}),this.arrow=WorkflowDesignerCommon.createArrowByAngle(this.end.x,this.end.y,this.angle,15,S);var b={points:this.points,stroke:S,strokeWidth:2,lineCap:"round",lineJoin:"round"};this.item.IsFork&&(b.dash=[10,10]),this.line=new Konva.Line(b),this.control.add(this.line),this.control.add(this.arrow),this.manager.Layer.add(this.control)}else WorkflowDesignerCommon.updateArrowByAngle(this.arrow,this.end.x,this.end.y,this.angle,15,S),this.line.setPoints(this.points)},this.GetPoints=function(e,t){if(e[0]==e[2]==e[4]||e[1]==e[3]==e[5])return e;var i=new Array;return e[0]==e[2]||e[1]==e[3]?i.push(e[0],e[1],e[2],e[3]):(i.push(e[0],e[1]),0==t.start?i.push(e[2],e[1]):i.push(e[0],e[3]),i.push(e[2],e[3])),0==t.end&&i[i.length-2]!=e[4]?i.push(i[i.length-2],e[5]):1==t.end&&i[i.length-1]!=e[5]&&i.push(e[4],i[i.length-1]),i.push(e[4],e[5]),i},this.GetColor=function(){var e=void 0==this.item.Classifier?"notspecified":this.item.Classifier.toLowerCase();return"notspecified"==e?"gray":"direct"==e?"#6EB04C":"#4F95EB"},this.DrawActivePoint=function(){if(this.activePoint)this._moveActivePoint(this.middle.x,this.middle.y);else{var e=this._createActivePoint(this.middle.x,this.middle.y,this.control);t.manager.APLayer.add(e),this.activePoint=e}},this.DrawTouchPoints=function(){.1*this._getLineLength(this.start.x,this.start.y,this.end.x,this.end.y);if(void 0==this.touchpoints[0]||this.touchpoints[0].isdestroyed){var e=this._createTouchPoint(this.points,this.control,!1);t.manager.APLayer.add(e),this.touchpoints[0]=e}else this._moveTouchPoints(this.touchpoints[0],this.points,!1);if(void 0==this.touchpoints[1]||this.touchpoints[1].isdestroyed){var i=this._createTouchPoint(this.points,this.control,!0);t.manager.APLayer.add(i),this.touchpoints[1]=i}else this._moveTouchPoints(this.touchpoints[1],this.points,!0)},this.Draw=function(e,t){this.DrawTransition(e,t),this.DrawActivePoint(),this.designer.Settings.readonly||this.DrawTouchPoints()},this.DeleteTouchPoint=function(e){for(var t=0;t<this.touchpoints.length;t++)this.touchpoints[t].isend===e&&(this.touchpoints[t].destroy(),this.touchpoints[t].isdestroyed=!0)},this.Delete=function(){this.from.UnregisterTransition(this),this.to.UnregisterTransition(this),this.control.destroy(),void 0!=this.activePoint.ToolTip&&this.activePoint.ToolTip.destroy(),this.activePoint.destroy();for(var e=0;e<this.touchpoints.length;e++)this.touchpoints[e].destroy();this.designer.data.Transitions.splice(this.designer.data.Transitions.indexOf(this.item),1),this.manager.ItemControls.splice(this.manager.ItemControls.indexOf(this),1)},this._onDelete=function(){confirm(WorkflowDesignerConstants.DeleteConfirm)&&(t.Delete(),t.designer.redrawAll())},this.Select=function(){this.oldstroke=this.line.getStroke(),this.line.setStroke(WorkflowDesignerConstants.SelectColor),this.line.setStrokeWidth(3),this.selected=!0},this.Deselect=function(){this.line.setStrokeWidth(2),void 0!=this.oldstroke&&this.line.setStroke(this.oldstroke),this.selected=!1},this._moveTouchPoints=function(e,t,i){var n=i?{x:t[t.length-2],y:t[t.length-1]}:{x:t[0],y:t[1]},o=i?{x:t[t.length-4],y:t[t.length-3]}:{x:t[2],y:t[3]},r={x:0,y:0},a=i?24:10;n.x==o.x?n.y<o.y?r.y=a:r.y=-a:n.y==o.y&&(n.x<o.x?r.x=a:r.x=-a),e.setPosition(n),e.circle.setPosition(r)},this._createTouchPoint=function(e,t,i){var n=this,o=i?{x:e[e.length-2],y:e[e.length-1]}:{x:e[0],y:e[1]},r=i?{x:e[e.length-4],y:e[e.length-3]}:{x:e[2],y:e[3]},a={x:0,y:0},s=i?24:10;o.x==r.x?o.y<r.y?a.y=s:a.y=-s:o.y==r.y&&(o.x<r.x?a.x=s:a.x=-s);var d=new Konva.Group({x:o.x,y:o.y,draggable:!0});d.isend=i;var l=this.GetColor(),c=new Konva.Circle({x:a.x,y:a.y,radius:5,fill:l});d.add(c),d.circle=c,d.transition=t;var h=function(){var e=n.designer.CorrectPossition(c.getAbsolutePosition(),n.manager.Layer);i?n.DrawTransition(void 0,e):n.DrawTransition(e,void 0),n.DrawActivePoint(),n.DeleteTouchPoint(!i),n.manager.batchDraw()};return d.on("dragmove",function(){h()}),d.on("dragend",function(){var e=c.getAbsolutePosition(),t=n.manager.getIntersectingActivity(e);void 0!=t&&(n.middle=void 0,n.Sync(),i?(n.to.UnregisterTransition(n),n.setTo(t),n.to.RegisterTransition(n)):(n.from.UnregisterTransition(n),n.setFrom(t),n.from.RegisterTransition(n))),n.Draw(),n.manager.batchDraw()}),d},this._moveActivePoint=function(e,t){this.activePoint.setPosition({x:e,y:t})},this._createActivePoint=function(e,t,i){var n=this,o=!n.designer.Settings.disableobjectmovements,r=new Konva.Group({x:e,y:t,draggable:o}),a=new Konva.Circle({x:0,y:0,radius:15,fill:"lightgray"});r.add(a);var s="",d=this.item.Trigger.Type.toLowerCase();"auto"===d?s+="A":"command"===d?s+="C":"timer"===d&&(s+="T");var l=this.item.Conditions[0].Type.toLowerCase();"always"===l?s+="A":"action"===l?s+="C":"otherwise"===l&&(s+="O");var c=new Konva.Text({x:-8,y:-8,text:s,fontSize:16,fontFamily:"Calibri",fill:"black",fontStyle:"bold"});if(r.add(c),!n.designer.Settings.readonly){var h=new Konva.Image({x:12,y:-20,image:this.manager.ImageDelete,width:10,height:10});h.on("click",this._onDelete),r.add(h)}r.transition=i;var m=function(e,t){var i=n.designer.CorrectPossition(r.getAbsolutePosition(),n.manager.Layer);n.middle=i,n.DrawTransition(),n.designer.Settings.readonly||n.DrawTouchPoints(),e&&(n.DrawActivePoint(),n.Sync()),n.manager.batchDraw()};r.on("click",function(e){if(!n.designer.Settings.disableobjectmovements){var t=n.selected;e.evt.ctrlKey||n.designer.DeselectAll(),t?n.Deselect():n.Select(),void 0!=n.activePoint.destroyToolTip&&n.activePoint.destroyToolTip(),n.manager.batchDraw()}}),r.on("dblclick",function(){n.designer.DeselectAll(),n.Select(),n.manager.batchDraw(),n.designer.Settings.notshowwindows||n.ShowProperties()}),r.on("dragstart",function(){n.designer.Settings.disableobjectmovements||void 0!=n.activePoint.destroyToolTip&&n.activePoint.destroyToolTip()}),r.on("dragmove",function(){n.designer.Settings.disableobjectmovements||m(!1)}),r.on("dragend",function(){n.designer.Settings.disableobjectmovements||m(!0)});var g="Trigger: "+this.item.Trigger.Type;return void 0!=n.item.Trigger&&void 0!=n.item.Trigger.Command&&"Command"===n.item.Trigger.Type&&(g+=" "+n.item.Trigger.Command.Name),void 0!=n.item.Trigger&&void 0!=n.item.Trigger.Timer&&"Timer"===n.item.Trigger.Type&&(g+=" "+n.item.Trigger.Timer.Name),g+="\r\nCondition: "+this.item.Conditions[0].Type,void 0!=n.item.Conditions[0]&&"Action"===n.item.Conditions[0].Type&&(g+=" "+n.item.Conditions[0].Action.ActionName),WorkflowDesignerTooltip(n.manager.APLayer,r,g,a.radius()+1),r},this._getLineLength=function(e,t,i,n){return Math.sqrt(Math.pow(i-e,2)+Math.pow(n-t,2))},this._getBendingKoeff=function(e,t,i,n,o,r){var a=t-n,s=i-e,d=e*n-i*t;s<=0&&(a=-a,s=-s,d=-d);var l=-(d+a*o)/s,c=l<r?-1:1,h=this._getLineLength(e,t,i,n),m=(e+i)/2,g=(t+n)/2,u=this._getLineLength(m,g,o,r),f=u/h*c;return 0==s&&(f=-f),f},this.getIntersectingRect=function(e){var t=this.activePoint.getAbsolutePosition();return t.x>=e.xl&&t.x<e.xr&&t.y>=e.yl&&t.y<e.yr},this.ShowProperties=function(){var e=WorkflowDesignerConstants.TransitionFormLabel,i={type:"form",title:e.Title,width:"800px",data:this.item,readonly:this.designer.Settings.readonly,elements:[{name:e.Name,field:"Name",type:"input"},{name:e.From,field:"From.Name",type:"select",displayfield:"Name",datasource:t.designer.data.Activities},{name:e.To,field:"To.Name",type:"select",displayfield:"Name",datasource:t.designer.data.Activities},{name:e.Classifier,field:"Classifier",type:"select",datasource:["Direct","Reverse","NotSpecified"]},{name:e.Restrictions,field:"Restrictions",code:"restrictions",type:"table",datadefault:{Type:"Allow"},elements:[{name:e.RestrictionsType,code:"resttype",field:"Type",type:"select",datasource:["Allow","Restrict"]},{name:e.RestrictionsActor,code:"restactor",field:"Actor.Name",type:"select",displayfield:"Name",datasource:t.designer.data.Actors}]},{name:e.AllowConcatenationType,field:"AllowConcatenationType",type:"select",datasource:["And","Or"]},{name:e.RestrictConcatenationType,field:"RestrictConcatenationType",type:"select",datasource:["And","Or"]},{name:e.Trigger,field:"Trigger",code:"trigger",type:"form",datadefault:{Type:"Command"},elements:[{name:e.TriggerType,code:"triggertype",field:"Type",type:"select",datasource:["Auto","Command","Timer"]},{name:e.TriggerCommand,code:"triggercommand",field:"Command.Name",type:"select",displayfield:"Name",datasource:t.designer.data.Commands},{name:e.TriggerTimer,code:"triggertimer",field:"Timer.Name",type:"select",displayfield:"Name",datasource:t.designer.data.Timers}]},{name:e.Condition,field:"Conditions",code:"condition",type:"table",datadefault:{Type:"Always",ResultOnPreExecution:"Null"},elements:[{name:e.ConditionType,code:"conditiontype",field:"Type",type:"select",datasource:["Always","Action","Otherwise"]},{name:e.ConditionAction,code:"conditionaction",field:"Action.ActionName",type:"select",datasource:t.designer.getConditionNames()},{name:e.ConditionActionParameter,code:"conditionactionparameter",field:"Action.ActionParameter",type:"json",openautocompleteonclick:!0,datasource:function(e,i){var n=$(this.element[0]).closest("tr"),o=n.find("[name=conditionaction]")[0].value;i(t.designer.getAutoCompleteSuggestions("conditionparameter",o,e.term))}},{name:e.ConditionInversion,code:"conditioninversion",field:"ConditionInversion",type:"checkbox"},{name:e.ResultOnPreExecution,code:"conditionresult",field:"ResultOnPreExecution",type:"select",datasource:["True","False"]}],onrowadded:function(e){var t=e.find("[name=conditiontype]"),i=e.find("[name=conditionaction]"),n=e.find("[name=conditionresult]"),o=e.find("[name=conditionactionparameter]").parent().parent(),r=e.find("[name=conditioninversion]"),a=function(){var e=t[0].value;"Action"==e?(i.show(),n.show(),o.show(),r.show()):(i.hide(),n.hide(),o.hide(),r.hide())};t.on("change",a),a()}},{name:e.ConditionsConcatenationType,field:"ConditionsConcatenationType",type:"select",datasource:["And","Or"]},{name:e.IsFork,field:"IsFork",code:"isfork",type:"checkbox"},{name:e.MergeViaSetState,field:"MergeViaSetState",code:"mergeviasetstate",type:"checkbox"},{name:e.DisableParentStateControl,field:"DisableParentStateControl",code:"disableparentstatecontrol",type:"checkbox"}],renderFinalFunc:function(e){var t=e.find("[name=restrictions]").parent().parent(),i=e.find("[name=triggertype]"),n=e.find("[name=isfork]"),o=e.find("[name=triggercommand]").parent().parent(),r=e.find("[name=triggertimer]").parent().parent(),a=$(e.find("[name=AllowConcatenationType]").parent().parent()),s=$(e.find("[name=RestrictConcatenationType]").parent().parent()),d=$(e.find("[name=ConditionsConcatenationType]").parent().parent()),l=e.find("[name=mergeviasetstate]").parent().parent(),c=e.find("[name=disableparentstatecontrol]").parent().parent(),h=function(){var e=i[0].value;"Command"==e?(o.show(),r.hide(),t.show()):"Timer"==e?(o.hide(),r.show(),t.hide(),a.hide(),s.hide()):(o.hide(),r.hide(),t.hide(),a.hide(),s.hide())};i.on("change",h),h();var m=function(){var e=n[0].checked;e?(l.show(),c.show()):(l.hide(),c.hide())};n.on("change",m),m();var g=a.find("[name=AllowConcatenationType]")[0].value.toLowerCase(),u=s.find("[name=RestrictConcatenationType]")[0].value.toLowerCase(),f=d.find("[name=ConditionsConcatenationType]")[0].value.toLowerCase();"and"===g&&a.hide(),"and"===u&&s.hide(),"and"===f&&d.hide();var p=$(e.find("[name=restrictions]").parent().parent().children()[0]),y=$("<button>Additional params</button>").button({icons:{primary:"ui-icon-wrench"},text:!1}).on("click",function(){a.is(":visible")&&"and"===g?a.hide():a.show(),s.is(":visible")&&"and"===u?s.hide():s.show()});p.append("&nbsp;"),p.append(y);var v=$(e.find("[name=condition]").parent().parent().children()[0]),w=$("<button>Additional params</button>").button({icons:{primary:"ui-icon-wrench"},text:!1}).on("click",function(){d.is(":visible")&&"and"===f?d.hide():d.show()});v.append("&nbsp;"),v.append(w)},designer:t.designer},n=new WorkflowDesignerForm(i),o=function(e,i){var n=!0;n&=e.CheckRequired([i],["Name"],WorkflowDesignerConstants.FieldIsRequired);var o=["Type"];"Command"==i.Trigger.Type?o.push("Command.Name"):"Timer"==i.Trigger.Type&&o.push("Timer.Name"),n&=e.CheckRequired([i.Trigger],o,WorkflowDesignerConstants.FieldIsRequired),i.Conditions.forEach(function(t){o=["Type"],"Action"==t.Type&&o.push("Action.ActionName"),n&=e.CheckRequired([t],o,WorkflowDesignerConstants.FieldIsRequired),"Always"==t.Type&&i.Conditions.length>1?(n=!1,e.ControlAddError(t.control_Type,WorkflowDesignerConstants.AlwaysConditionShouldBeSingle)):"Otherwise"==t.Type&&i.Conditions.length>1&&(n=!1,e.ControlAddError(t.control_Type,WorkflowDesignerConstants.OtherwiseConditionShouldBeSingle))});var r=$(i.control_Conditions.parent().parent().children()[0]).children("label");return!i.Conditions.length>0?(r.attr("title",WorkflowDesignerConstants.TransitionFormLabel.ConditionsListShouldNotBeEmpty),r.css("color","red"),n=!1):(r.attr("title",void 0),r.css("color","")),t.designer.data.Transitions.forEach(function(o){o!=t.item&&o.Name==i.Name&&(n=!1,e.ControlAddError(i.control_Name,WorkflowDesignerConstants.FieldMustBeUnique))}),e.CheckRequired(i.Restrictions,["Type","Actor.Name"],WorkflowDesignerConstants.FieldIsRequired)||(n=!1),n},r=function(e){return!!o(n,e)&&(n.ClearTempField(e),t.item.Name=e.Name,t.item.From.Name=e.From.Name,t.item.To.Name=e.To.Name,t.item.Classifier=e.Classifier,t.item.Restrictions=e.Restrictions,t.item.Trigger=e.Trigger,t.item.Conditions=e.Conditions,t.item.IsFork=e.IsFork,t.item.MergeViaSetState=e.MergeViaSetState,t.item.DisableParentStateControl=e.DisableParentStateControl,t.item.ConditionsConcatenationType=e.ConditionsConcatenationType,t.item.AllowConcatenationType=e.AllowConcatenationType,t.item.RestrictConcatenationType=e.RestrictConcatenationType,WorkflowDesignerCommon.DataCorrection(t.designer.data),t.designer.Draw(t.designer.data),!0)};n.showModal(r)},this.Sync=function(){t.item.DesignerSettings.Bending=t.bending,void 0!=t.middle&&(t.item.DesignerSettings.X=t.middle.x,t.item.DesignerSettings.Y=t.middle.y)},this.destroy=function(){this.control.destroy(),this.activePoint.destroy(),this.touchpoints.forEach(function(e){e.destroy()})}}function WorkflowDesignerTransitionTempControl(e){this.x=e.x,this.y=e.y,this.manager=e.manager,this.control=void 0,this.Draw=function(e,t){this.control=new Konva.Group({x:0,y:0,rotation:0}),this.line=new Konva.Line({points:[this.x,this.y,e,t],stroke:"#FFCC99",strrokeWidth:1});var i=Math.atan2(t-this.y,e-this.x);this.arrow=WorkflowDesignerCommon.createArrowByAngle(e,t,i,20,"#FFCC99"),this.control.add(this.line),this.control.add(this.arrow),this.manager.Layer.add(this.control)},this.Redraw=function(e){this.line.setPoints([this.x,this.y,e.x,e.y]);var t=Math.atan2(e.y-this.y,e.x-this.x);WorkflowDesignerCommon.updateArrowByAngle(this.arrow,e.x,e.y,t,20,"#FFCC99")},this.Delete=function(){this.control.destroy()}}function WorkflowDesignerForm(e){this.type="WorkflowDesignerForm",
this.parameters=e,this.id=WorkflowDesignerCommon.createUUID(),this.isReadOnly=function(){return this.parameters.readonly},this.showModal=function(e){var t=this;t.window=$("<div></div>"),t.window.id=this.id;var i=void 0;"table"===this.parameters.type?i=this.generateTable(this.parameters):"form"===this.parameters.type&&(i=this.generateForm(this.parameters)),void 0==i&&(i=new Array),void 0!=t.parameters.top&&i.unshift(t.parameters.top),void 0!=t.parameters.bottom&&i.push(t.parameters.bottom),t.window.append(i),void 0!=this.parameters.renderFinalFunc&&this.parameters.renderFinalFunc(i),t.window.dialog({modal:!0,title:this.parameters.title,width:this.parameters.width,maxHeight:WorkflowDesignerConstants.FormMaxHeight,beforeClose:function(i,n){if(t.ClearError(),void 0!=e&&!t.isReadOnly()){var o=t.getEditData(t.parameters);return e(o,t.parameters)}},close:function(e,t){$(this).dialog("destroy").remove()}})},this.getEditData=function(e){var t,i=this;if("form"==e.type)t={},e.elements.forEach(function(e){t["control_"+e.field]=e.control,"table"==e.type||"form"==e.type?t[e.field]=i.getEditData(e):i.SetValueByPropertyName(t,e.field,i.getEasyControlValue(e))});else if("table"==e.type){t=[];var n=e.control;if(e.elements.forEach(function(e){var o=i.getElementCode(e),r="[name="+o+"]",a=n.find(r);if(void 0!=a)for(var s=0;s<a.length;s++)void 0==t[s]&&(t[s]={}),t[s]["control_"+e.field]=a[s],"table"==e.type||"form"==e.type?t[s][e.field]=i.getEditData({type:e.type,control:$(a[s]),elements:e.elements}):i.SetValueByPropertyName(t[s],e.field,i.getEasyControlValue({type:e.type,control:a[s]}))}),e.keyproperty)for(var o=n.children("tbody").children("tr"),r=0;r<o.length;r++)void 0==t[r]&&(t[r]={}),t[r].keyproperty=$(o[r]).attr("keyproperty")}return t},this.generateForm=function(e,t){var i=this,n=$('<table class="WorkflowDesignerTable"></table>');n.attr("name",i.getElementCode(e));var o=new Array;return e.elements.forEach(function(n){var r=$("<tr></tr>");void 0==t&&(t="");var a=t+"_"+n.field,s=$("<label>oooo</label>");if(s[0].innerHTML=n.name,r.append($("<td></td>").append(s)),"table"==n.type){n.fieldFunc?n.data=n.fieldFunc(e.data):n.data=e.data[n.field];var d=i.generateTable(n,a);r.append($("<td></td>").append(d))}else if("form"==n.type){n.fieldFunc?n.data=n.fieldFunc(e.data):n.data=e.data[n.field];var d=i.generateForm(n,a);r.append($("<td></td>").append(d))}else{var l=i.generateEasyControls(n,i.GetValueByPropertyName(e.data,n.field),a);s[0].for=l[0].id,n.control=l[0],r.append($("<td></td>").append(l[0]))}o.push(r)}),e.control=n,n.append(o),n},this.generateTable=function(e,t){var i=this,n=$('<table class="WorkflowDesignerTable"></table>');n.attr("name",i.getElementCode(e));var o=$("<thead></thead>"),r=$("<tr></tr>");e.elements.forEach(function(e){var t=$("<th></th>");t[0].innerHTML=e.name,void 0!=e.width&&(t[0].width=e.width),r.append(t)}),this.isReadOnly()||r.append("<th></th>"),o.append(r),n.append(o);var a=function(o){void 0!=e.beforerowadded&&e.beforerowadded(o);var r=$("<tr></tr>");e.keyproperty&&r.attr("keyproperty",o[e.keyproperty]),void 0==t&&(t="");var a=t+WorkflowDesignerCommon.createUUID();if(e.elements.forEach(function(e){if("table"==e.type){e.fieldFunc?e.data=e.fieldFunc(o):e.data=o[e.field];var t=i.generateTable(e,a);r.append($("<td></td>").append(t))}else{var n=i.generateEasyControls(e,i.GetValueByPropertyName(o,e.field),a,o);r.append($("<td></td>").append(n))}}),!i.isReadOnly()){var s=$('<a class="btnDelete"></a>');s[0].innerHTML=WorkflowDesignerConstants.ButtonTextDelete,s[0].href="#",s.on("click",function(){return r.remove(),!1}),r.append($("<td></td>").append(s))}n.append(r),void 0!=e.onrowadded&&e.onrowadded(r)};void 0!=e.data&&e.data.forEach(function(e){a(e)}),e.control=n;var s=new Array;if(s.push(n),!this.isReadOnly()){var d=$('<a class="btnAdd"></a>');d[0].innerHTML=WorkflowDesignerConstants.ButtonTextCreate,d[0].href="#",d.on("click",function(){var t={};return e.datadefault&&(t=e.datadefault),a(t),!1}),s.push(d)}return s},this.generateEasyControls=function(e,t,i,n){var o=this;if("input"===e.type){var r=$('<input style="width: 100%;"></input>');return r[0].id=this.generateid(e.field,i),r[0].name=o.getElementCode(e),void 0!=t&&(r[0].value=t),o.isReadOnly()&&r.attr("readonly",!0),this.addAutoComplete(e,r),r}if("json"===e.type){var r=$('<input style="width:100%"></input>');r[0].id=this.generateid(e.field,i),r[0].name=o.getElementCode(e),void 0!=t&&(r[0].value=t),o.isReadOnly()&&r.attr("readonly",!0);var a=$('<button style=" border: 0; background:transparent;"><img src="'+o.parameters.designer.Settings.imagefolder+'designer.tb.codeactions.png" width="16" height="16" alt="submit" /></button>');a[0].id=r[0].id+"_button";var s=$('<div title="'+WorkflowDesignerConstants.EditJSONLabel.Title+'"><div id="'+r[0].id+'_editor" style="height:'+WorkflowDesignerConstants.EditJSONSettings.CodeHeight+'px">'+r[0].value+"</div></div>");return s[0].id=r[0].id+"_form",a.on("click",function(t){var i=s.dialog({autoOpen:!1,height:WorkflowDesignerConstants.EditJSONSettings.Height,width:WorkflowDesignerConstants.EditJSONSettings.Width,modal:!0,buttons:{},close:function(){var e=ace.edit(r[0].id+"_editor").getValue();r[0].value=o.toCompactJSON(e)}}),n=s.dialog("option","buttons");r[0].readOnly||$.extend(n,{format:{text:WorkflowDesignerConstants.EditJSONLabel.Format,click:function(){var e=ace.edit(r[0].id+"_editor").getValue();a.setValue(o.toPrettyJSON(e)),a.clearSelection()}}}),void 0==e.getemptytype||r[0].readOnly||$.extend(n,{createemptytype:{text:WorkflowDesignerConstants.EditJSONLabel.CreateEmptyType,click:function(){var t=e;void 0!=t.getemptytype&&t.getemptytype(o,r[0],function(e){void 0!=e&&""!==e&&(a.setValue(o.toPrettyJSON(e)),a.clearSelection())})}}}),s.dialog("option","buttons",n);var a=ace.edit(r[0].id+"_editor");r[0].readOnly?a.setOptions({readOnly:!0}):a.setOptions({readOnly:!1}),a.getSession().setMode("ace/mode/json"),a.setValue(o.toPrettyJSON(r[0].value)),a.clearSelection(),i.dialog("open")}),this.addAutoComplete(e,r),$('<div style="width:100%;"></div>').append($('<div style="width:16px; float:right; margin-right: 7px;"></div>').append(a)).append($('<div style="overflow: hidden;"></div>').append(r))}if("code"===e.type){void 0==t&&(t="");var r=$("<button>"+WorkflowDesignerConstants.EditCodeLabel.EditCodeButton+"</button>");r[0].id=this.generateid(e.field,i),r[0].name=o.getElementCode(e),r[0].code={},r[0].code.code=decodeURIComponent(t);var d=n.Usings;d=void 0==d?o.parameters.designer.data.AdditionalParams.Usings.join(";")+";":decodeURIComponent(d),r[0].code.usings=d;var l=o.isReadOnly()?' readonly="true"':"",s=$('<div style="padding-bottom:1px;" title="'+WorkflowDesignerConstants.EditCodeLabel.Title+'"><div id="'+r[0].id+'_usings"><h3>'+WorkflowDesignerConstants.EditCodeLabel.Usings+'</h3><div style="padding: 0 0;overflow: hidden"><textarea rows="10"  style="width:100%; max-width:inherit;" id="'+r[0].id+'_usingsedit"'+l+'></textarea></div></div><div id="'+r[0].id+'_function_upper"></div><div id="'+r[0].id+'_editor" style="height:'+WorkflowDesignerConstants.EditCodeSettings.CodeHeight+'px"'+l+">"+this.htmlEncode(r[0].code.code)+'</div><div id="'+r[0].id+'_function_lower">}</div></div>');s[0].id=r[0].id+"_form";var c={};return WorkflowDesignerForm.isjava||(c={compile:{text:WorkflowDesignerConstants.EditCodeLabel.Compile,click:function(){for(var e=o.getEditData(o.parameters),t=void 0,i=0;i<e.length;i++)if(e[i].control_ActionCode.id==r[0].id){t=e[i];break}if(void 0!=t){t.ActionCode=encodeURIComponent(ace.edit(r[0].id+"_editor").getValue()),t.Usings=encodeURIComponent($("#"+r[0].id+"_usingsedit")[0].value.replace(/(\r\n|\n|\r)/gm,""));var n=function(e){$('<div title="'+(e.Success?WorkflowDesignerConstants.EditCodeLabel.Success:WorkflowDesignerConstants.EditCodeLabel.Error)+'">'+(e.Success?WorkflowDesignerConstants.EditCodeLabel.CompileSucceeded:e.Message)+"</div>").dialog({modal:!0,height:e.Success?WorkflowDesignerConstants.EditCodeSettingsSuccessBoxHeight:WorkflowDesignerConstants.EditCodeSettings.MessageBoxHeight,width:e.Success?WorkflowDesignerConstants.EditCodeSettings.SuccessBoxWidth:WorkflowDesignerConstants.EditCodeSettings.MessageBoxWidth,buttons:{ok:{text:WorkflowDesignerConstants.EditCodeLabel.OK,click:function(){$(this).dialog("close")}}}})};o.parameters.designer.designer.compile(t,n)}}}}),r.on("click",function(e){var t=s.dialog({autoOpen:!1,height:WorkflowDesignerConstants.EditCodeSettings.Height,width:WorkflowDesignerConstants.EditCodeSettings.Width,modal:!0,buttons:c,close:function(){r[0].code={},r[0].code.code=ace.edit(r[0].id+"_editor").getValue(),r[0].code.usings=$("#"+r[0].id+"_usingsedit")[0].value.replace(/(\r\n|\n|\r)/gm,"")}});$("#"+r[0].id+"_usingsedit")[0].value=o.htmlEncode(o.modifyUsingString(r[0].code.usings)),$("#"+r[0].id+"_usings").accordion({collapsible:!0,active:!1,heightStyle:"content"}),WorkflowDesignerConstants.isjava&&$("#"+r[0].id+"_usings").hide();var n=$("#"+o.generateid("Type",i))[0].value.toLowerCase(),a=$("#"+o.generateid("Name",i))[0].value;""===a&&(a="???");var d="{";WorkflowDesignerConstants.isjava?("action"===n&&(d="function "+a+"(processInstance, runtime, parameter) {"),"condition"===n&&(d="function "+a+"(processInstance, runtime, parameter) {"),"ruleget"===n&&(d="function "+a+"(processInstance, runtime, parameter) {"),"rulecheck"===n&&(d="function "+a+"(processInstance, runtime, identityId, parameter) {")):("action"===n&&(d="void "+a+" (ProcessInstance processInstance, WorkflowRuntime runtime, string parameter) {"),"condition"===n&&(d="bool "+a+" (ProcessInstance processInstance, WorkflowRuntime runtime, string parameter) {"),"ruleget"===n&&(d="IEnumerable&lt;string&gt; "+a+" (ProcessInstance processInstance, WorkflowRuntime runtime, string parameter) {"),"rulecheck"===n&&(d="bool "+a+" (ProcessInstance processInstance, WorkflowRuntime runtime, string identityId, string parameter) {")),$("#"+r[0].id+"_function_upper").html(d);var l=ace.edit(r[0].id+"_editor");l.getSession().setMode(WorkflowDesignerConstants.isjava?"ace/mode/javascript":"ace/mode/csharp"),o.isReadOnly()?l.setOptions({readOnly:!0}):(l.setOptions({readOnly:!1}),l.focus()),t.dialog("open")}),r}if("checkbox"===e.type){var r=$('<input style="width: 100%;"></input>');return r[0].type="checkbox",r[0].id=this.generateid(e.field,i),r[0].checked=t,r[0].name=o.getElementCode(e),o.isReadOnly()&&r.attr("disabled","disabled"),r}if("select"==e.type){var r=$('<select style="width: 100%;"></select>');return r[0].id=this.generateid(e.field,i),r[0].name=o.getElementCode(e),r.append($("<option></option>")),void 0!=e.datasource&&e.datasource.forEach(function(i){var n=$("<option></option>");void 0==e.displayfield?(n[0].value=i,n[0].innerHTML=i):(n[0].value=i[e.displayfield],n[0].innerHTML=i[e.displayfield]),n[0].value==t&&(n[0].selected="selected"),o.isReadOnly()&&r.attr("disabled","disabled"),r.append(n)}),r}if("textarea"===e.type){var r=$('<textarea rows="6" style="width: 100%;"></textarea>');return r[0].id=o.generateid(e.field,i),r[0].name=o.getElementCode(e),void 0!=t&&(r[0].value=t),this.isReadOnly()&&r.attr("readonly",!0),r}},this.addAutoComplete=function(e,t){if(void 0!=e.datasource){var i={minLength:0,autoFocus:!0,source:e.datasource,open:function(e,i){$(this).autocomplete("option","appendTo",t[0].id),t[0].acwasopened||($(this).autocomplete("close"),t[0].acwasopened=!0,$(this).autocomplete("search",t[0].value))}};t.autocomplete(i),t.autocomplete("option","appendTo",t[0].id),e.openautocompleteonclick&&t.on("click",function(){$(this).autocomplete("search",t[0].value)})}},this.modifyUsingString=function(e){var t=e.substring(e.length-1);return";"===t&&(e=e.substring(0,e.length-1)),e.split(";").join(";\r\n")+";"},this.getEasyControlValue=function(e){return"input"==e.type?e.control.value:"json"==e.type?e.control.value:"code"==e.type?e.control.code:"checkbox"==e.type?e.control.checked:"select"==e.type?e.control.value:"textarea"==e.type?e.control.value:void 0},this.generateid=function(e,t){return t?e+"_"+t+"_"+this.id:e+"_"+this.id},this.GetValueByPropertyName=function(e,t){if(void 0!=e){if(t.indexOf(".")<0)return e[t];var i=e;return t.split(".").forEach(function(e){void 0!=i&&(i=i[e])}),i}},this.SetValueByPropertyName=function(e,t,i){if(t.indexOf(".")<0)return e[t]=i;for(var n=e,o=t.split("."),r=0;r<o.length;r++){var a=o[r];r==o.length-1?n[a]=i:(void 0==n[a]&&(n[a]={}),n=n[a])}},this.ClearError=function(){var e=this.window.find(".field-validation-error");e.attr("title",""),e.removeClass("field-validation-error")},this.ControlAddError=function(e,t){var i=$(e);i.addClass("field-validation-error"),i.attr("title",t)},this.CheckRequired=function(e,t,i){var n=this,o=!0;return e.forEach(function(e){t.forEach(function(t){""==n.GetValueByPropertyName(e,t)&&(n.ControlAddError(e["control_"+t],i),o=!1)})}),o},this.CheckUnique=function(e,t,i){for(var n=this,o=!0,r=0;r<e.length;r++)for(var a=r+1;a<e.length;a++)this._checkUniqueEquals(e[r],e[a],t)&&(t.forEach(function(t){n.ControlAddError(e[r]["control_"+t],i),n.ControlAddError(e[a]["control_"+t],i)}),o=!1);return o},this._checkUniqueEquals=function(e,t,i){for(var n=0;n<i.length;n++){var o=i[n];if(e[o]!=t[o])return!1}return!0};var t=this;this.ClearTempField=function(e,i){void 0!=e&&(void 0==i&&(i=this.parameters.elements),i.forEach(function(n){$.isArray(e)?e.forEach(function(e){t.ClearTempField(e,i)}):void 0!=e["control_"+n.field]&&(e["control_"+n.field]=void 0),n.elements&&t.ClearTempField(e[n.field],n.elements)}))},this.getElementCode=function(e){return void 0!=e.code?e.code:e.field},this.htmlEncode=function(e){return $("<div/>").text(e).html()},this.htmlDecode=function(e){return $("<div/>").html(e).text()},this.toCompactJSON=function(e){try{return JSON.stringify(JSON.parse(e))}catch(t){try{return JSON5.stringify(JSON5.parse(e))}catch(t){return e}}},this.toPrettyJSON=function(e){try{return JSON.stringify(JSON.parse(e),null,"\t")}catch(t){try{return JSON5.stringify(JSON5.parse(e),null,"\t")}catch(t){return e}}}}function WorkflowGraph(e,t,i,n){var o=this;o.container=e,o.designer=t,o.suggestionsCache=new Object,void 0==i&&(i=new Object),void 0==i.Container&&(i.Container="container"),void 0==i.graphwidth&&(i.graphwidth=1024),void 0==i.graphheight&&(i.graphheight=768),void 0==i.DefaultActivityWidth&&(i.DefaultActivityWidth=190),void 0==i.DefaultActivityHeight&&(i.DefaultActivityHeight=60),void 0==i.DefaultMoveStep&&(i.DefaultMoveStep=10),void 0==i.imagefolder&&(i.imagefolder="/images/"),this.Settings=i,this.Settings.ContainerStage=this.container+"_stage",$("#"+this.container).append("<div id='"+this.Settings.ContainerStage+"' class='workflowenginecontainerstage'></div>"),this.Stage=new Konva.Stage({container:this.Settings.ContainerStage,width:parseInt(this.Settings.graphwidth),height:parseInt(this.Settings.graphheight)}),this.Components=new Array,this.AddComponent=function(e){var t=new e;return t.init(this),o.Components.push(t),t},this.GetComponentByType=function(e){for(var t=0;t<this.Components.length;t++)if(this.Components[t].type==e)return this.Components[t]},this.ComponentsExecute=function(e,t){o.Components.forEach(function(i){i[e]&&i[e](t)})},n&&n.forEach(function(e){o.AddComponent(e)}),this.Draw=function(e){o.data=e,o.ComponentsExecute("draw")},this.GraphLayerSetOffset=function(e,t){o.ComponentsExecute("LayerSetOffset",{x:e,y:t}),o.redrawAll()},this.GraphLayerScale=function(e){o.ComponentsExecute("LayerScale",e),o.redrawAll()},this.GraphLayerScaleNorm=function(e){o.ComponentsExecute("LayerScaleNorm",e),o.redrawAll()},this.DeselectAll=function(){o.ComponentsExecute("DeselectAll"),o.redrawAll()},this.redrawAll=function(){o.ComponentsExecute("GraphRedrawAll"),o.Stage.batchDraw()},this.CorrectPossition=function(e,t){return 0==t.getScaleX()||0==t.getScaleY()?{x:t.getOffsetX(),y:0}:{x:e.x/t.getScaleX()+t.getOffsetX(),y:e.y/t.getScaleY()+t.getOffsetY()}},this.DeleteSelected=function(){var e=new Array;this.Components.forEach(function(t){t.GetSelected&&(e=e.concat(t.GetSelected()))}),e.length>0&&confirm(WorkflowDesignerConstants.DeleteConfirm)&&(e.forEach(function(e){e.Delete()}),this.redrawAll())},this.destroy=function(){this.Stage.destroy()},this.GetCurrentActivity=function(){if(void 0!=o.data&&void 0!=o.data.AdditionalParams&&void 0!=o.data.AdditionalParams.ProcessParameters)for(var e=0;e<o.data.AdditionalParams.ProcessParameters.length;e++){var t=o.data.AdditionalParams.ProcessParameters[e];if("CurrentActivity"===t.Name)return t.Value}},this.getActionNames=function(){for(var e=this,t=new Array,i=0;i<e.data.CodeActions.length;i++){var n=e.data.CodeActions[i];"action"===n.Type.toLowerCase()&&t.push(n.Name)}return e.data.AdditionalParams.Actions.concat(t)},this.getConditionNames=function(){for(var e=this,t=new Array,i=0;i<e.data.CodeActions.length;i++){var n=e.data.CodeActions[i];"condition"===n.Type.toLowerCase()&&t.push(n.Name)}return e.data.AdditionalParams.Conditions.concat(t)},this.getActorNames=function(){for(var e=this,t=new Array,i=0;i<e.data.CodeActions.length;i++){var n=e.data.CodeActions[i];"ruleget"!==n.Type.toLowerCase()&&"rulecheck"!==n.Type.toLowerCase()||t.push(n.Name)}return $.unique(e.data.AdditionalParams.Rules.concat(t))},this.getTypeNames=function(){for(var e=this,t=new Array,i=0;i<e.data.Parameters.length;i++){var n=e.data.Parameters[i];t.push(decodeURIComponent(n.Type))}return $.unique(e.data.AdditionalParams.Types.concat(t))},this.getAutoCompleteSuggestions=function(e,t,i){var n;return void 0===t||""===t?new Array:(void 0!=this.suggestionsCache[e]&&void 0!=this.suggestionsCache[e][t]?n=this.suggestionsCache[e][t]:(void 0==this.suggestionsCache[e]&&(this.suggestionsCache[e]=new Object),n=this.designer.requestautocompletesuggestions(e,t),this.suggestionsCache[e][t]=n),$.grep(n,function(e){return e.toLowerCase().indexOf(i.toLowerCase())>=0}))},this.getNonSystemParameters=function(){for(var e=this,t=new Array,i=0;i<e.data.Parameters.length;i++){var n=e.data.Parameters[i];"system"!=n.Purpose.toLowerCase()&&t.push(n)}return t}}var WorkflowDesignerConstants={SelectColor:"#CCCC00",ActivityColor:"#F2F3F5",ActivityInitialColor:"#CBF4B2",ActivityFinalColor:"#DDEAFA",ActivityCurrentColor:"#FFCC99",DeleteConfirm:"Are you sure you want to delete selected item(s)?",FieldIsRequired:"Field is required!",FieldMustBeUnique:"Field must be unique!",ButtonTextDelete:"Delete",ButtonTextCreate:"Create",InfoBlockLabel:{Activity:"Activity: ",Transition:"Transition: ",Command:"Command: "},ActivityNamePrefix:"Activity_",ActivityFormLabel:{Title:"Activity",Name:"Name",State:"State",IsInitial:"Initial",IsFinal:"Final",IsForSetState:"For set state",IsAutoSchemeUpdate:"Auto scheme update",Implementation:"Implementation",PreExecutionImplementation:"PreExecution Implementation",ImpOrder:"Order",ImpAction:"Action",ImpActionParameter:"Action parameter",AlwaysConditionShouldBeSingle:"Always condition should be single",OtherwiseConditionShouldBeSingle:"Otherwise condition should be single"},TransitionFormLabel:{Title:"Transition",Name:"Name",From:"From activity",To:"To activity",Classifier:"Classifier",Restrictions:"Restrictions",RestrictionsType:"Type",RestrictionsActor:"Actor",Condition:"Condition",ConditionType:"Type",ConditionAction:"Action",ResultOnPreExecution:"Result on PreExecution",Trigger:"Trigger",TriggerType:"Type",TriggerCommand:"Command",TriggerTimer:"Timer",ConditionActionParameter:"Action parameter",ConditionInversion:"Invert action result",ConditionsConcatenationType:"Conditions concatenation type",AllowConcatenationType:"Concat allow as",RestrictConcatenationType:"Concat restrict as",ConditionsListShouldNotBeEmpty:"Conditions list should not be empty",IsFork:"Is fork",MergeViaSetState:"Merge subprocess via set state",DisableParentStateControl:"Disable parent process control"},LocalizationFormLabel:{Title:"Localization",ObjectName:"ObjectName",Type:"Type",IsDefault:"IsDefault",Culture:"Culture",Value:"Value",Types:["Command","State","Parameter"]},TimerFormLabel:{Title:"Timers",Name:"Name",Type:"Type",Value:"Value",Types:["Command","State","Parameter"],NotOverrideIfExists:"Do not override timer if exists"},ParameterFormLabel:{Title:"Parameters",Name:"Name",Type:"Type",Purpose:"Purpose",Value:"Value",InitialValue:"InitialValue",ShowSystemParameters:"Show system parameters"},ActorFormLabel:{Title:"Actors",Name:"Name",Rule:"Rule",Value:"Value"},CommandFormLabel:{Title:"Command",Name:"Name",InputParameters:"Input Parameters",InputParametersName:"Name",InputParametersIsRequired:"Required",InputParametersParameter:"Parameter",InputParametersDefaultValue:"Default"},AdditionalParamsFormLabel:{Title:"Additional Parameters",IsObsolete:"IsObsolete",DefiningParameters:"Defining parameters",ProcessParameters:"Process parameters",ProcessParametersName:"Name",ProcessParametersValue:"Value"},CodeActionsFormLabel:{Title:"Code actions",Name:"Name",ActionCode:"Action code",IsGlobal:"Is global",Type:"Type"},ToolbarLabel:{CreateActivity:"Create activity",CopySelected:"Copy selected",Undo:"Undo",Redo:"Redo",Move:"Move",ZoomIn:"Zoom In",ZoomOut:"Zoom Out",ZoomPositionDefault:"Zoom and position default set",AutoArrangement:"Auto arrangement",Actors:"Actors",Commands:"Commands",Parameters:"Parameters",Localization:"Localization",Timers:"Timers",AdditionalParameters:"Additional Parameters",CodeActions:"Code actions"},ErrorActivityIsInitialCountText:"One element must be marked flag Initial",ErrorReadOnlySaveText:"The Designer in ReadOnly mode, you can't save it.",FormMaxHeight:500,EditCodeSettings:{Height:600,Width:1e3,CodeHeight:390,MessageBoxHeight:400,MessageBoxWidth:600,SuccessBoxHeight:150,SuccessBoxWidth:300},EditCodeLabel:{Title:"Edit code",EditCodeButton:"Edit code",Usings:"Usings",Compile:"Compile",CompileSucceeded:"Compilation succeeded.",Success:"Success",Error:"Error",OK:"OK"},EditJSONSettings:{Height:600,Width:1e3,CodeHeight:480},EditJSONLabel:{Title:"Edit value in JSON",CreateEmptyType:"Create",Format:"Format"},isjava:!1},WorkflowDesignerCommon={createArrowByAngle:function(e,t,i,n,o){void 0==o&&(o="red");var r=new Konva.Wedge({x:e,y:t,radius:n,angle:40,fill:o,rotation:180*i/Math.PI-200});return r},updateArrowByAngle:function(e,t,i,n,o,r){void 0==r&&(r="red"),e.setPosition({x:t,y:i}),e.setRadius(o),e.setFill(r),e.setRotation(180*n/Math.PI-200)},createUUID:function(){for(var e=[],t="0123456789abcdef",i=0;i<36;i++)e[i]=t.substr(Math.floor(16*Math.random()),1);e[14]="4",e[19]=t.substr(3&e[19]|8,1),e[8]=e[13]=e[18]=e[23]="-";var n=e.join("");return n},DataCorrection:function(e){void 0==e.AdditionalParams&&(e.AdditionalParams={}),void 0==e.AdditionalParams.Actions&&(e.AdditionalParams.Actions=[]),void 0==e.AdditionalParams.Conditions&&(e.AdditionalParams.Conditions=[]),void 0==e.AdditionalParams.Rules&&(e.AdditionalParams.Rules=[]);var t=function(e,t){if(void 0!=e){var i=$.grep(t,function(t){return t==e});0==i.length&&t.push(e)}},i=function(e,t,i){if(void 0!=e&&void 0!=t){var n=$.grep(t,function(t){return e==t[i]});return n.length>0?n[0]:void 0}};e.Activities.forEach(function(i){void 0!=i.Implementation&&(i.Implementation.forEach(function(i){t(i.Name,e.AdditionalParams.Actions)}),i.PreExecutionImplementation.forEach(function(i){t(i.Name,e.AdditionalParams.Actions)}))}),e.Transitions.forEach(function(n){void 0!=n.From&&(n.From=i(n.From.Name,e.Activities,"Name")),void 0!=n.To&&(n.To=i(n.To.Name,e.Activities,"Name")),void 0!=n.Restrictions&&n.Restrictions.forEach(function(t){t.Actor=i(t.Actor.Name,e.Actors,"Name")}),void 0!=n.Condition&&void 0!=n.Condition.Action&&t(n.Condition.Action.Name,e.AdditionalParams.Actions),void 0!=n.Trigger&&void 0!=n.Trigger.Command&&(n.Trigger.Command=i(n.Trigger.Command.Name,e.Commands,"Name")),void 0!=n.Trigger&&void 0!=n.Trigger.Timer&&(n.Trigger.Timer=i(n.Trigger.Timer.Name,e.Timers,"Name"))}),e.Commands.forEach(function(t){void 0!=t.InputParameters&&t.InputParameters.forEach(function(t){t.Parameter=i(t.Parameter.Name,e.Parameters,"Name")})}),e.Actors.forEach(function(i){void 0!=i.Rule&&t(i.Rule,e.AdditionalParams.Rules)})},download:function(e,t,i){if(e&&t){var n=new Array;t.forEach(function(e){var t=$('<input type="hidden"/>');t.attr("name",e.name),t.attr("value",e.value),n.push(t)});var o=$('<form action="'+e+'" method="'+(i||"post")+'"></form>');o.append(n),o.appendTo("body").submit().remove()}}};