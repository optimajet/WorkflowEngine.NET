function WorkflowDesigner(e){function t(){var e={actions:new Array,conditions:new Array,rules:new Array,referenceContainers:new Array},t=n.data;return t.Activities.forEach(function(i){void 0!=i.Implementation&&$.each(i.Implementation,function(n,a){if(t.AdditionalParams.Actions.includes(a.ActionName))return!0;var o=function(e){return"Action"===e.Type&&e.Name===a.ActionName};$.grep(t.CodeActions,o).length||(e.actions.includes(a.ActionName)||e.actions.push(a.ActionName),e.referenceContainers.includes(i.Name)||e.referenceContainers.push(i.Name))}),void 0!=i.PreExecutionImplementation&&$.each(i.PreExecutionImplementation,function(n,a){if(t.AdditionalParams.Actions.includes(a.ActionName))return!0;var o=function(e){return"Action"===e.Type&&e.Name===a.ActionName};$.grep(t.CodeActions,o).length||(e.actions.includes(a.ActionName)||e.actions.push(a.ActionName),e.referenceContainers.includes(i.Name)||e.referenceContainers.push(i.Name))})}),t.Transitions.forEach(function(i){$.each(i.Conditions,function(n,a){if(a.Action&&"Action"===a.Type){if(t.AdditionalParams.Conditions.includes(a.Action.ActionName))return!0;var o=function(e){return"Condition"===e.Type&&e.Name===a.Action.ActionName};$.grep(t.CodeActions,o).length||(e.conditions.includes(a.Action.ActionName)||e.conditions.push(a.Action.ActionName),e.referenceContainers.includes(i.Name)||e.referenceContainers.push(i.Name))}})}),t.Actors.forEach(function(i){if(void 0!=i.Rule&&!t.AdditionalParams.Rules.includes(i.Rule)){var n=function(e){return("RuleCheck"===e.Type||"RuleGet"===e.Type)&&e.Name===i.Rule};$.grep(t.CodeActions,n).length||(e.rules.includes(i.Rule)||e.rules.push(i.Rule),e.referenceContainers.includes(i.Name)||e.referenceContainers.push(i.Name))}}),e}function i(){var e=t();e.referenceContainers.length>0&&WorkflowDesignerWindows.ConfirmDialog(WorkflowDesignerConstants.BrokenReferencesDialogText,WorkflowDesignerConstants.ButtonTextYes,function(){var t=n.data;return t.AdditionalParams.Actions=t.AdditionalParams.Actions.concat(e.actions),t.AdditionalParams.Conditions=t.AdditionalParams.Conditions.concat(e.conditions),t.AdditionalParams.Rules=t.AdditionalParams.Rules.concat(e.rules),!0},WorkflowDesignerConstants.ButtonTextNo,function(){return!0})}var n=this;this.Settings=e,window.localStorage||WorkflowDesignerCommon.defineLocalStorage(),Array.prototype.includes||WorkflowDesignerCommon.defineArrayIncludes(),this.GetName=function(){return n.Settings.name},this.error=function(e,t){alert(e),void 0!==t&&null!==t&&console.log(e,t)},this.refresh=function(){var e=void 0!==this.data&&void 0!==this.data.__loadParams?this.data.__loadParams:this.loadParams;void 0===e?alert("You might use refresh method after called load method only."):this.load(e)},this.getParam=function(e){return localStorage["WorkflowDesigner_"+e]},this.setParam=function(e,t){var i="WorkflowDesigner_"+e;localStorage[i]=t},this.load=function(e){var t=new Array;this.loadParams=e,this.schemecode=e.schemecode,this.processid=e.processid,this.schemeid=e.schemeid,e.readonly&&(this.Settings.readonly=e.readonly),t.push({name:"schemecode",value:this.schemecode}),t.push({name:"processid",value:this.processid}),t.push({name:"schemeid",value:this.schemeid}),t.push({name:"operation",value:"load"});$.ajax({url:this.Settings.apiurl,data:t,async:!0,success:function(t){var a={};try{a=JSON.parse(t)}catch(e){return void n.error(t)}if(a.isError)return void n.error(a.errorMessage);a.__loadParams=e,n.data=a,e.processid&&n.data.IsSubprocessScheme||i(),n.render()},error:function(e,t,i){n.error(t+" "+i)}})},this.exists=function(e){var t=new Array;this.schemecode=e.schemecode,this.processid=e.processid,this.schemeid=e.schemeid,e.readonly&&(this.Settings.readonly=e.readonly),t.push({name:"schemecode",value:this.schemecode}),t.push({name:"processid",value:this.processid}),t.push({name:"schemeid",value:this.schemeid}),t.push({name:"operation",value:"exists"});var i=$.ajax({url:this.Settings.apiurl,data:t,async:!1,error:function(e,t,i){n.error(t+" "+i)}}).responseText;try{return JSON.parse(i)}catch(e){return n.error(i),!1}},this.create=function(){var e=new Array;e.push({name:"operation",value:"load"});$.ajax({url:this.Settings.apiurl,data:e,async:!0,success:function(e){try{n.data=JSON.parse(e)}catch(t){n.error(e)}n.render()}})},this.render=function(){var e=!1;n.Graph&&(n.Graph.destroy(),void 0!=n.data&&void 0!=n.data.__loadParams&&(void 0!=n.data.__loadParams.isFullScreen&&(e=n.data.__loadParams.isFullScreen),void 0!=n.data.__loadParams.readonly&&(this.Settings.readonly=n.data.__loadParams.readonly)));var t=[WorkflowDesignerActivityManager,WorkflowDesignerTransitionManager,WorkflowDesignerKeyboard];if(Array.isArray(n.Settings.externalComponents)&&n.Settings.externalComponents.forEach(function(e){t.push(e)}),this.Settings.printable||t.push(WorkflowDesignerBackground),this.Settings.notrendertoolbar||t.push(WorkflowDesignerToolbar),n.Settings.printable&&void 0!=n.data){var i=0,a=0;$(n.data.Activities).each(function(e){var t=parseInt(this.DesignerSettings.X),n=parseInt(this.DesignerSettings.Y);t>i&&(i=t),n>a&&(a=n)}),n.Settings.graphwidth=i+n.Settings.DefaultActivityWidth,n.Settings.graphheight=a+n.Settings.DefaultActivityHeight}n.Graph=new WorkflowGraph(this.Settings.renderTo,n,n.Settings,t),n.Graph.setFullScreen(e),void 0!=n.data&&(WorkflowDesignerCommon.DataCorrection(n.data),void 0!=n.data.__loadParams&&void 0!=n.data.__loadParams.graphData&&(n.Graph.graphData=n.data.__loadParams.graphData,n.Graph.graphDataIndex=n.data.__loadParams.graphDataIndex),n.Graph.Draw(n.data))},this.save=function(e,t){if(n.Settings.readonly)return void alert(WorkflowDesignerConstants.ErrorReadOnlySaveText);var i=new Array;i.push({name:"schemecode",value:this.schemecode}),i.push({name:"processid",value:this.processid}),i.push({name:"schemeid",value:this.schemeid}),i.push({name:"operation",value:"save"}),i.push({name:"data",value:JSON.stringify(this.data)});$.ajax({url:this.Settings.apiurl,data:i,async:!0,type:"post",success:function(i){var a={};try{a=JSON.parse(i)}catch(e){return void(void 0!==t?t(i):n.error(i))}if(a.isError)return void(void 0!==t?t(a.errorMessage,a.errorDetails):n.error(a.errorMessage,a.errorDetails));n.data=a,n.render(),e&&setTimeout(function(){e(n)},100)}})},this.downloadscheme=function(e){var t=new Array;t.push({name:"operation",value:"downloadscheme"}),t.push({name:"data",value:JSON.stringify(this.data)}),WorkflowDesignerCommon.download(this.Settings.apiurl,t,"post")},this.uploadscheme=function(e,t){var a=this.createurl("uploadscheme"),o=new FormData(e),r=new XMLHttpRequest;r.open("POST",a),r.onload=function(){var e=r.response,a={};try{a=JSON.parse(e)}catch(t){return void n.error(e)}if(a.isError)return void n.error(a.errorMessage);n.data=a,i(),n.render(),t&&t(n)},r.send(o)},this.createurl=function(e){var t=this.Settings.apiurl,i="?";return t.indexOf("?")>=0&&(i="&"),t+=i+"operation="+e,i="&",void 0!=this.schemeid&&(t+=i+"schemeid="+this.schemeid),void 0!=this.processid&&(t+=i+"processid="+this.processid),void 0!=this.schemecode&&(t+=i+"schemecode="+this.schemecode),t},this.validate=function(){if(1!=$.grep(n.data.Activities,function(e){return e.IsInitial}).length)return WorkflowDesignerConstants.ErrorActivityIsInitialCountText;if(n.data.CanBeInlined){if(0==$.grep(n.data.Activities,function(e){return e.IsFinal}).length)return WorkflowDesignerConstants.ErrorActivityIsFinalCountText}var e=t().referenceContainers;return $.each(n.data.Transitions,function(t,i){var n=!1;"Auto"!==i.Trigger.Type&&(("Timer"===i.Trigger.Type&&!i.Trigger.Timer||"Command"===i.Trigger.Type&&!i.Trigger.Command)&&e.push(i.Name),n=!0),null!==i.Restrictions&&void 0!==i.Restrictions&&$.each(i.Restrictions,function(t,a){a.Actor||n||(e.push(i.Name),n=!0)})}),$.each(n.data.Activities,function(t,i){"Inline"!==i.ActivityType||void 0!=i.SchemeCode&&""!==i.SchemeCode||e.push(i.Name)}),e.length>0?WorkflowDesignerConstants.ErrorInvalidObjectsSaveText(e.join(", ")):void 0},this.destroy=function(){this.schemecode=void 0,this.processid=void 0,this.schemeid=void 0,this.data=void 0,void 0!==this.Graph&&this.Graph.destroy()},this.compile=function(e,t){e={Name:e.Name,Type:e.Type,IsGlobal:e.IsGlobal,IsAsync:e.IsAsync,ActionCode:e.ActionCode,Usings:e.Usings};var i=new Array;i.push({name:"schemecode",value:this.schemecode}),i.push({name:"processid",value:this.processid}),i.push({name:"schemeid",value:this.schemeid}),i.push({name:"operation",value:"compile"}),i.push({name:"data",value:JSON.stringify(e)});$.ajax({url:this.Settings.apiurl,data:i,async:!0,type:"post",success:function(e){try{e=JSON.parse(e)}catch(t){n.error(e)}t&&setTimeout(function(){t(e)},100)}})},this.deleteGlobalCodeAction=function(e,t){var i=new Array;i.push({name:"operation",value:"deleteglobalcodeaction"}),i.push({name:"names",value:JSON.stringify(e)});$.ajax({url:this.Settings.apiurl,data:i,async:!0,type:"post",success:function(e){try{e=JSON.parse(e)}catch(t){n.error(e)}t&&setTimeout(function(){t(e)},100)}})},this.getemptytype=function(e,t){var i=new Array;i.push({name:"operation",value:"getemptytype"}),i.push({name:"data",value:JSON.stringify(e)});$.ajax({url:this.Settings.apiurl,data:i,async:!0,type:"post",success:function(e){t&&setTimeout(function(){t(e)},100)}})},this.requestcodeactionparameter=function(e,t){var i=new Array;i.push({name:"operation",value:"getcodeactionparameter"}),i.push({name:"type",value:e}),i.push({name:"name",value:t});for(var n=$.ajax({url:this.Settings.apiurl,data:i,async:!1,type:"post"}),a=JSON.parse(n.responseText),o=0;o<a.length;o+=1)null===a[o].Name&&(a[o].Name="");return a},this.requestautocompletesuggestions=function(e,t){var i=new Array;i.push({name:"operation",value:"getautocompletesuggestions"}),i.push({name:"category",value:e}),i.push({name:"value",value:t});var n=$.ajax({url:this.Settings.apiurl,data:i,async:!1,type:"post"});return JSON.parse(n.responseText)},this.readonlymode=function(e){var t=this;void 0===e||null==e?(t.Settings.notrendertoolbar=!1,t.Settings.notshowwindows=!1,t.Settings.disableobjectmovements=!1):(void 0!=e.notrendertoolbar?t.Settings.notrendertoolbar=e.notrendertoolbar:t.Settings.notrendertoolbar=!1,void 0!=e.notshowwindows?t.Settings.notshowwindows=e.notshowwindows:t.Settings.notshowwindows=!1,void 0!=e.disableobjectmovements?t.Settings.disableobjectmovements=e.disableobjectmovements:t.Settings.disableobjectmovements=!1),t.Settings.readonly=!0,t.Settings.printable&&(t.Settings.graphheight=t.Settings.originalgraphheighth,t.Settings.graphwidth=t.Settings.originalgraphwidth,t.Settings.printable=!1),t.render()},this.printablemode=function(){var e=this;e.Settings.printable||(e.Settings.originalgraphheighth=e.Settings.graphheight,e.Settings.originalgraphwidth=e.Settings.graphwidth),e.Settings.notrendertoolbar=!0,e.Settings.notshowwindows=!0,e.Settings.disableobjectmovements=!1,e.Settings.readonly=!0,e.Settings.printable=!0,e.render()},this.editablemode=function(){var e=this;e.Settings.notrendertoolbar=!1,e.Settings.notshowwindows=!1,e.Settings.disableobjectmovements=!1,e.Settings.readonly=!1,e.Settings.printable&&(e.Settings.graphheight=e.Settings.originalgraphheighth,e.Settings.graphwidth=e.Settings.originalgraphwidth,e.Settings.printable=!1),e.render()},void 0===this.Settings.mode||("readonly"===this.Settings.mode.toLowerCase()?this.readonlymode(e):"printable"===this.Settings.mode.toLowerCase()?this.printablemode():this.editablemode()),this.autoarrangement=function(){var e=this.Graph.GetComponentByType("WorkflowDesignerToolbar");void 0!=e&&e.AutoArrangement()},this.downloadschemeBPMN=function(e){var t=new Array;t.push({name:"operation",value:"downloadschemebpmn"}),t.push({name:"data",value:JSON.stringify(this.data)}),WorkflowDesignerCommon.download(this.Settings.apiurl,t,"post")},this.uploadschemeBPMN=function(e,t){var a=this.GetName()+"_uploadiframe",o=document.createElement("iframe");o.setAttribute("id",a),o.setAttribute("name",a),o.setAttribute("width","0"),o.setAttribute("height","0"),o.setAttribute("border","0"),o.setAttribute("style","width: 0; height: 0; border: none;"),e.parentNode.appendChild(o),window.frames[a].name=a;var r=document.getElementById(a),s=function(){r.detachEvent?r.detachEvent("onload",s):r.removeEventListener("load",s,!1),r.contentDocument?content=r.contentDocument.body.innerText:r.contentWindow?content=r.contentWindow.document.body.innerHTML:r.document&&(content=r.document.body.innerHTML),setTimeout(function(){r.parentNode.removeChild(r)},250);var e={};try{e=JSON.parse(content)}catch(e){return void n.error(content)}if(e.isError)return void n.error(e.errorMessage);n.data=e,i(),n.render(),t&&t(n)};r.addEventListener&&r.addEventListener("load",s,!0),r.attachEvent&&r.attachEvent("onload",s),e.setAttribute("target",a),e.setAttribute("action",this.createurl("uploadschemebpmn")),e.setAttribute("method","post"),e.setAttribute("enctype","multipart/form-data"),e.setAttribute("encoding","multipart/form-data"),e.submit()}}function WorkflowDesignerOverviewMap(){this.type="WorkflowDesignerOverviewMap";var e=this;this.init=function(t){this.graph=t,this.Layer=new Konva.Layer,this.Layer.scale(.5),this.graph.Stage.add(this.Layer),this.Layer.setZIndex(1e3);var i=this.graph.Stage.width(),n=this.graph.Stage.height(),a=void 0!=this.graph.Settings.overviewMapWidth?this.graph.Settings.overviewMapWidth:WorkflowDesignerConstants.OverviewMap.width,o=void 0!=this.graph.Settings.overviewMapHeight?this.graph.Settings.overviewMapHeight:WorkflowDesignerConstants.OverviewMap.height;e.background=new Konva.Image({x:i-a-5,y:n-o-5,width:a,height:o,fill:"white",shadowEnabled:!0,shadowBlur:5,shadowOpacity:.3}),e.Layer.add(e.background)},this.draw=function(){this.GraphRedrawAll()},this.GraphRedrawAll=function(){console.log("GraphRedrawAll")}}function WorkflowDesignerForm(e){this.type="WorkflowDesignerForm",this.parameters=e,this.id=WorkflowDesignerCommon.createUUID(),this.isReadOnly=function(){return this.parameters.readonly},this.showModal=function(e,t,i){var n=this;n.window=$('<div tabindex="0" class="ui modal WorkflowDesignerDialog"></div>'),void 0!=WorkflowDesignerConstants.FormMaxHeight&&""!=WorkflowDesignerConstants.FormMaxHeight&&n.window.css("max-height",WorkflowDesignerConstants.FormMaxHeight),void 0!=this.parameters.width&&""!=this.parameters.width&&n.window.width(this.parameters.width),n.window.id=this.id;var a=void 0;switch(this.parameters.type){case"table":a=this.generateTable(this.parameters);break;case"form":a=this.generateForm(this.parameters);break;case"tabs":a=this.generateTabs(this.parameters)}void 0==a&&(a=new Array),void 0!=n.parameters.top&&a.unshift(n.parameters.top),void 0!=n.parameters.bottom&&a.push(n.parameters.bottom),void 0!=this.parameters.renderFinalFunc&&this.parameters.renderFinalFunc(a,n);var o=n.getEditData(n.parameters);n.ClearTempField(o),n.window.append($('<div class="header">'+this.parameters.title+'<div class="headerbuttons"> <span class="close"></span> <span class="fillscreen"></span> </div>')),n.window.append($('<div class="content scrolling"></div>').append(a));var r=$('<div class="actions"></div>');n.isReadOnly()?r.append('<div class="ui secondary  cancel button">'+WorkflowDesignerConstants.ButtonTextClose+"</div>"):(r.append('<div class="ui primary ok button">'+WorkflowDesignerConstants.ButtonTextSave+"</div>"),r.append('<div class="ui secondary cancel button">'+WorkflowDesignerConstants.ButtonTextCancel+"</div>")),n.window.append(r);var s=function(){if(n.ClearError(),void 0!=e&&!n.isReadOnly()){return!!e(n.getEditData(n.parameters),n.parameters)&&(n.allowDestroy=!0,!0)}},l=function(){if(!n.isReadOnly()){var e=n.getEditData(n.parameters);return void 0!==i&&i(e,n.parameters),n.ClearTempField(e),JSON.stringify(o)===JSON.stringify(e)?(n.allowDestroy=!0,!0):(WorkflowDesignerWindows.ConfirmDialog(WorkflowDesignerConstants.CloseWithoutSaving,WorkflowDesignerConstants.ButtonTextYes,function(){n.allowDestroy=!0,WorkflowDesignerCommon.modal(n.window,"hide")},WorkflowDesignerConstants.ButtonTextNo,function(){return!0}),!1)}n.allowDestroy=!0};WorkflowDesignerCommon.modal(n.window,{closable:!1,onApprove:s,onDeny:l,allowMultiple:!0,onHidden:function(){n.allowDestroy&&n.destroy(),n.parameters.onHidden&&n.parameters.onHidden()},dimmerSettings:{opacity:.2,duration:{show:0,hide:0}},transition:"fade"}),WorkflowDesignerCommon.modal(n.window,"show"),WorkflowDesignerCommon.modal(n.window,"refresh"),void 0!=this.refreshFunc&&this.refreshFunc(),$(".item",n.window).tab({context:"parent"}),$(".ui.accordion",n.window).accordion({exclusive:!1}),$(".close",n.window).click(function(){(n.isReadOnly()||l())&&(n.allowDestroy=!0,WorkflowDesignerCommon.modal(n.window,"hide"))}),$(".fillscreen",n.window).click(function(){n.window.hasClass("fullscreen")?n.window.removeClass("fullscreen"):n.window.addClass("fullscreen"),setTimeout(function(){void 0!=n.refreshFunc&&n.refreshFunc()},500)})},this.destroy=function(){void 0!=this.destroyFunc&&this.destroyFunc(),$(".WorkflowDesignerDialogautoComplete").remove(),this.window.remove()},this.InfoDialog=function(e,t,i){var n="ui modal WorkflowDesignerConfirmDialog";void 0!=i&&(n+=" "+i);var a=$('<div tabindex="0" class="'+n+'"></div>');a.append($('<div class="header">'+e+"</div>")),a.append($('<div class="content scrolling"><p>'+t+"</p></div>"));var o=$('<div class="actions"></div>').append('<div tabindex="1" class="ui primary ok button">'+WorkflowDesignerConstants.EditCodeLabel.OK+"</div>");a.append(o),WorkflowDesignerCommon.modal(a,{allowMultiple:!0,dimmerSettings:{opacity:.2,duration:{show:0,hide:0}},transition:"fade"}),WorkflowDesignerCommon.modal(a,"show")},this.getEditData=function(e){var t,i=this;if("form"===e.type||"group"===e.type)t={},e.elements.forEach(function(e){void 0!=e.field&&(t["control_"+e.field]=e.control),"table"===e.type||"form"===e.type?t[e.field]=i.getEditData(e):"group"===e.type?i.objAssign(t,i.getEditData(e)):"scheme"===e.type||i.SetValueByPropertyName(t,e.field,i.getEasyControlValue(e))});else if("table"===e.type){void 0==t&&(t=[]);var n=e.control;if(e.elements.forEach(function(e){var a=i.getElementCode(e),o="[name="+a+"]",r=n.find(o);if(void 0!=r)for(var s=0;s<r.length;s++)void 0==t[s]&&(t[s]={}),t[s]["control_"+e.field]=r[s],"table"===e.type||"form"===e.type?t[s][e.field]=i.getEditData({type:e.type,control:$(r[s]),elements:e.elements}):i.SetValueByPropertyName(t[s],e.field,i.getEasyControlValue({type:e.type,control:r[s]}))}),e.keyproperty)for(var a=n.children("tbody").children("tr"),o=0;o<a.length;o++)void 0==t[o]&&(t[o]={}),t[o].keyproperty=$(a[o]).attr("keyproperty")}return t},this.generateTabs=function(e,t){var i=this,n=new Array,a=$('<div class="ui top attached tabular menu" />'),o=!0;e.elements.forEach(function(e){var t=$('<a class="item">'+e.name+"</a>");t.attr("data-tab",e.tabKey),o&&(t.addClass("active"),o=!1),a.append(t)}),n.push(a),o=!0;var r=null;return e.elements.forEach(function(e){var t=$('<div class="ui bottom attached tab segment" />');switch(t.attr("data-tab",e.tabKey),o&&(t.addClass("active"),o=!1),e.type){case"table":r=i.generateTable(e);break;case"form":r=i.generateForm(e);break;case"accordion":r=i.generateAccordion(e);break;default:r=null}t.append(r),n.push(t)}),n},this.generateAccordion=function(e,t){var i,n,a=this,o=$('<div class="ui accordion" />'),r=!0;return $.each(e.data,function(t,s){i=$('<div class="title"><i class="dropdown icon"></i>'+t+"</div>"),r&&i.addClass("active"),o.append(i),n=$('<div class="content" />'),r&&(n.addClass("active"),r=!1),e.elements.forEach(function(e){switch(e.type){case"table":e.data=s,n.append(a.generateTable(e))}}),o.append(n)}),o},this.generateForm=function(e,t){var i=this,n="group"==e.type?$('<div class="fields">'):$('<div class="ui form">');void 0!=e.width&&n.width(e.width),n.attr("name",i.getElementCode(e));var a=new Array;return e.elements.forEach(function(n){var o=$('<div class="field">');void 0!=n.width&&o.width(n.width),void 0==t&&(t="");var r=t+"_"+n.field,s=void 0;if(void 0!=n.name&&(s="table"===n.type?$('<h4 class="ui dividing header"></h4>'):$("<label></label>"),s[0].innerHTML=n.name,o.append(s)),"table"===n.type){n.data||(n.fieldFunc?n.data=n.fieldFunc(e.data):n.data=e.data[n.field]);var l=i.generateTable(n,r);o.append(l)}else if("form"===n.type){n.fieldFunc?n.data=n.fieldFunc(e.data):n.data=e.data[n.field];var l=i.generateForm(n,r);o.append(l)}else if("group"===n.type){n.fieldFunc?n.data=n.fieldFunc(e.data):n.data=e.data;var l=i.generateForm(n,r);o.append(l)}else if("accordion"===n.type){n.data||(n.fieldFunc?n.data=n.fieldFunc(e.data):n.data=e.data[n.field]);var l=i.generateAccordion(n,r);o.append(l)}else if("scheme"===n.type){var d=n.group+"_group",c=$('<div id="'+d+'"></div>'),h=$(window).height()-550;h<400&&(h=400),c.height(h),n.control=c[0],o.append(c[0]),i.refreshFunc=function(){void 0!=i.wfdesigner&&i.wfdesigner.destroy(),i.wfdesigner=new WorkflowDesigner({name:d,renderTo:d,imagefolder:i.parameters.graph.Settings.imagefolder,apiurl:i.parameters.graph.Settings.apiurl,graphwidth:c.width(),graphheight:h,readonly:!0,group:n.group,hideElementsToolbar:!0,hideLegend:!0,hideInfoBlock:!0}),i.wfdesigner.data=i.parameters.graph.data,i.wfdesigner.render()},i.destroyFunc=function(){c.remove(),void 0!=i.wfdesigner&&i.wfdesigner.destroy()}}else{var c=i.generateEasyControls(n,i.GetValueByPropertyName(e.data,n.field),r);void 0!=s&&(s[0].for=c[0].id),n.control=c[0],o.append(c[0])}a.push(o)}),e.control=n,n.append(a),n},this.generateTable=function(e,t){var i=this,n=$('<table class="ui form WorkflowDesignerTable"></table>');n.attr("name",i.getElementCode(e));var a=$("<thead></thead>"),o=$("<tr></tr>");if(!i.isReadOnly()){var r=$('<th class="movecol"></th>');o.append(r)}e.elements.forEach(function(e){var t=$("<th></th>");t[0].innerHTML=e.name,void 0!=e.width&&(t[0].width=e.width),o.append(t)}),this.isReadOnly()||o.append("<th></th>"),a.append(o),n.append(a);var s=function(a){void 0!=e.beforerowadded&&e.beforerowadded(a,i);var o=$("<tr></tr>");e.keyproperty&&o.attr("keyproperty",a[e.keyproperty]),void 0==t&&(t="");var r=t+WorkflowDesignerCommon.createUUID();if(!i.isReadOnly()){var s=$("<td class='movecol'><div class='btnmove'></div></td>");s.attr("draggable",!0),s.bind("dragstart",function(e){o.css("opacity",.5),n.row=o}).bind("dragover",function(e){e.preventDefault()}).bind("drop",function(e){if(e.preventDefault(),void 0!=n.row){var t=n.find("tr");t.index(n.row[0])>t.index(o[0])?n.row.insertBefore(o):n.row.insertAfter(o),n.row.css("opacity",""),n.row=void 0}}),o.append(s)}if(e.elements.forEach(function(t){if("table"===t.type){t.fieldFunc?t.data=t.fieldFunc(a):t.data=a[t.field];var n=i.generateTable(t,r);o.append($("<td></td>").append(n))}else{var s=i.generateEasyControls(t,i.GetValueByPropertyName(a,t.field),r,a);void 0!==e.onrowchanged&&s.change(function(){e.onrowchanged(o,i)}),o.append($("<td></td>").append(s))}}),!i.isReadOnly()){var l=$('<a class="btnDelete"></a>');l[0].innerHTML=WorkflowDesignerConstants.ButtonTextDelete,l[0].href="#",l.on("click",function(){return!(void 0!==e.onrowdelete&&!e.onrowdelete(o,i))&&(o.remove(),0==$("tr",$(n).find("tbody")).length&&n.css("display","none"),WorkflowDesignerCommon.modal(i.window,"refresh"),!1)}),o.append($("<td></td>").append(l))}n.append(o),void 0!==e.onrowadded&&e.onrowadded(o,i)};void 0!=e.data&&e.data.forEach(function(e){s(e)}),void 0!=e.data&&0!=e.data.length||n.css("display","none"),e.control=n;var l=new Array;if(l.push(n),!this.isReadOnly()){var d=$('<a class="btnAdd"></a>');d[0].innerHTML=WorkflowDesignerConstants.ButtonTextCreate,d[0].href="#",d.on("click",function(){var t={};return e.datadefault&&(t=e.datadefault),"none"==n.css("display")&&0==$("tr",$(n).find("tbody")).length&&n.css("display",""),s(t),WorkflowDesignerCommon.modal(i.window,"refresh"),!1}),l.push(d)}return l},this.generateEasyControls=function(e,t,i,n){var a=this,o=null;if("input"===e.type)return new InputControl(a).generate(e,t,i);if("checkbox"===e.type)return new CheckboxControl(a).generate(e,t,i);if("select"===e.type)return new SelectControl(a).generate(e,t,i);if("textarea"===e.type)return o=$('<textarea rows="6" style="width: 100%;"></textarea>'),o[0].id=a.generateid(e.field,i),o[0].name=a.getElementCode(e),void 0!=t&&(o[0].value=t),this.isReadOnly()&&o.attr("readonly",!0),o;if("json"===e.type)return new JsonControl(a,e,i).generateBasicControl(t);if("jsonparameter"===e.type)return new JsonControl(a,e,i).generateParameterControl(t,n);if("code"===e.type)return a.generateCodeControl(e,t,i,n);if("transitionclassifier"===e.type){switch(o=$('<img class="table-icon" />'),t){case 0:o.attr("src",a.parameters.graph.Settings.imagefolder+"wfe.transition.not-specified.png"),o.attr("alt","NotSpecified"),o.attr("title","NotSpecified");break;case 1:o.attr("src",a.parameters.graph.Settings.imagefolder+"wfe.transition.direct.png"),o.attr("alt","Direct"),o.attr("title","Direct");break;case 2:o.attr("src",a.parameters.graph.Settings.imagefolder+"wfe.transition.reverse.png"),o.attr("alt","Reverse"),o.attr("title","Reverse")}return o}return"parameters"===e.type?new ParametersControl(a).generate(e,t,i):"defaultvalue"===e.type?new DefaultValueControl(a,e,i).generate(t,n):void 0},this.generateCodeControl=function(e,i,n,a){void 0==i&&(i="");var o=$('<button class="ui button basic">'+WorkflowDesignerConstants.EditCodeLabel.EditCodeButton+"</button>");o[0].id=this.generateid(e.field,n),o[0].name=t.getElementCode(e),o[0].code={},o[0].code.code=decodeURIComponent(i);var r=a.Usings;r=void 0==r?t.parameters.graph.data.AdditionalParams.Usings.join(";")+";":decodeURIComponent(r),o[0].code.usings=r;var s=t.isReadOnly()?' readonly="true"':"",l=$('<div class="ui large modal WorkflowDesignerDialogChild">');l[0].id=o[0].id+"_form",l.append('<div class="header">'+WorkflowDesignerConstants.EditCodeLabel.Title+"</div>");var d=$('<div class="content scrolling"></div>'),c=$('<a class="ui button">'+WorkflowDesignerConstants.EditCodeLabel.ShowUsings+"</a>");d.append(c);var h=$('<div id="'+o[0].id+'_usings" style="padding-top: 6px;display:none"/>');h.append('<textarea style="width:100%;height: 100px; max-width:inherit;" id="'+o[0].id+'_usingsedit"'+s+">asdfasdfasd</textarea>"),d.append(h),d.append('<div id="'+o[0].id+'_function_upper" />'),d.append('<div id="'+o[0].id+'_editor" style="height:'+WorkflowDesignerConstants.EditCodeSettings.CodeHeight+'px" '+s+"></div>"),d.append('<div id="'+o[0].id+'_function_lower">}</div>'),c.on("click",function(e){h.is(":visible")?(h.hide(),c[0].innerText=WorkflowDesignerConstants.EditCodeLabel.ShowUsings):(h.show(),c[0].innerText=WorkflowDesignerConstants.EditCodeLabel.HideUsings),WorkflowDesignerCommon.modal(l,"refresh")}),l.append(d);var u=$('<div class="actions"></div>'),m=$('<div class="ui button">'+WorkflowDesignerConstants.EditCodeLabel.Compile+"</div>");return u.append(m),m.on("click",function(){for(var e=t.getEditData(t.parameters),i=void 0,n=0;n<e.length;n++)if(e[n].control_ActionCode.id==o[0].id){i=e[n];break}if(void 0!=i){i.ActionCode=encodeURIComponent(ace.edit(o[0].id+"_editor").getValue()),i.Usings=encodeURIComponent($("#"+o[0].id+"_usingsedit")[0].value.replace(/(\r\n|\n|\r)/gm,""));var a=function(e){var i=e.Success?WorkflowDesignerConstants.EditCodeLabel.Success:WorkflowDesignerConstants.EditCodeLabel.Error,n=e.Success?WorkflowDesignerConstants.EditCodeLabel.CompileSucceeded:e.Message;return t.InfoDialog(i,n,e.Success?"mini":void 0),!1};t.parameters.graph.designer.compile(i,a)}}),o[0].readOnly?u.append('<div class="ui secondary cancel button">'+WorkflowDesignerConstants.ButtonTextClose+"</div>"):(u.append('<div class="ui primary ok button">'+WorkflowDesignerConstants.ButtonTextSave+"</div>"),u.append('<div class="ui secondary cancel button">'+WorkflowDesignerConstants.ButtonTextCancel+"</div>")),l.append(u),o.on("click",function(e){WorkflowDesignerCommon.modal(l,{closable:!1,allowMultiple:!0,onApprove:function(){o[0].code={},o[0].code.code=ace.edit(o[0].id+"_editor").getValue(),o[0].code.usings=$("#"+o[0].id+"_usingsedit")[0].value.replace(/(\r\n|\n|\r)/gm,"")},onHidden:function(){setTimeout(function(){WorkflowDesignerCommon.modal(t.window,"show")},10)},dimmerSettings:{opacity:.2,duration:{show:0,hide:0}},transition:"fade"});var i=ace.edit(o[0].id+"_editor");$("#"+o[0].id+"_usingsedit")[0].value=t.htmlEncode(t.modifyUsingString(o[0].code.usings)),$("#"+o[0].id+"_usings").accordion({collapsible:!0,active:!1,heightStyle:"content scrolling"});var a=$("#"+t.generateid("Type",n))[0].value.toLowerCase(),r=$("#"+t.generateid("Name",n))[0].value,s=$("#"+t.generateid("IsAsync",n))[0].checked;r=""===r?"???":"<b>"+r+"</b>";var d="{";if("action"===a){d=(s?"async Task ":"void ")+r+(s?" (ProcessInstance processInstance, WorkflowRuntime runtime, string parameter, CancellationToken token) {":" (ProcessInstance processInstance, WorkflowRuntime runtime, string parameter) {")}if("condition"===a){d=(s?"async Task&lt;bool&gt; ":"bool ")+r+(s?" (ProcessInstance processInstance, WorkflowRuntime runtime, string parameter, CancellationToken token) {":" (ProcessInstance processInstance, WorkflowRuntime runtime, string parameter) {")}"ruleget"===a&&(d="IEnumerable&lt;string&gt; "+r+" (ProcessInstance processInstance, WorkflowRuntime runtime, string parameter) {"),"rulecheck"===a&&(d="bool "+r+" (ProcessInstance processInstance, WorkflowRuntime runtime, string identityId, string parameter) {"),$("#"+o[0].id+"_function_upper").html(d);var i=ace.edit(o[0].id+"_editor");i.getSession().setMode("ace/mode/csharp"),i.setValue(o[0].code.code),i.clearSelection(),t.isReadOnly()?i.setOptions({readOnly:!0}):(i.setOptions({readOnly:!1}),i.focus()),WorkflowDesignerCommon.modal(t.window,"hide"),WorkflowDesignerCommon.modal(l,"show")}),o},this.addAutoComplete=function(e,t){if(void 0!=e.datasource){var n;n=Array.isArray(e.datasource)?function(t,n){t=t.toLowerCase();var a=e.datasource,o=[];for(i=0;i<a.length;i++)~a[i].toLowerCase().indexOf(t)&&o.push(a[i]);n(o)}:e.datasource.bind(t);var a={minChars:0,source:n};t.autoComplete(a)}},this.modifyUsingString=function(e){return";"===e.substring(e.length-1)&&(e=e.substring(0,e.length-1)),e.split(";").join(";\r\n")+";"},this.getEasyControlValue=function(e){var t=this;if("input"===e.type)return e.control.value;if("json"===e.type||"jsonparameter"===e.type)return"div"===e.control.localName?$(e.control).find("input").val():e.control.value;if("code"===e.type)return e.control.code;if("parameters"===e.type)return e.control.parameters;if("checkbox"===e.type)return"div"===e.control.localName?e.indeterminable&&$(e.control).checkbox("is indeterminate")?null:e.control.children[0].checked:e.indeterminable&&$(e.control).parent().checkbox("is indeterminate")?null:e.control.checked;if("select"===e.type)return e.control.value;if("textarea"===e.type)return e.control.value;if("defaultvalue"===e.type){switch(e.control.type){case"text":return t.getEasyControlValue({type:"input",control:e.control});case"checkbox":return t.getEasyControlValue({type:"checkbox",control:e.control,indeterminable:!0});case"select-one":return t.getEasyControlValue({type:"select",control:e.control})}return null}},this.generateid=function(e,t){return t?e+"_"+t+"_"+this.id:e+"_"+this.id},this.GetValueByPropertyName=function(e,t){if(void 0!=e){if(t.indexOf(".")<0)return e[t];var i=e;return t.split(".").forEach(function(e){void 0!=i&&(i=i[e])}),i}},this.SetValueByPropertyName=function(e,t,i){if(t.indexOf(".")<0)return e[t]=i;for(var n=e,a=t.split("."),o=0;o<a.length;o++){var r=a[o];o==a.length-1?n[r]=i:(void 0==n[r]&&(n[r]={}),n=n[r])}},this.ClearError=function(){var e=this.window.find(".field-validation-error");e.attr("title",""),e.removeClass("field-validation-error"),this.window.find(".error-message").remove()},this.ControlAddError=function(e,t){var i=$(e);i.addClass("field-validation-error"),i.attr("title",t)},this.CheckRequired=function(e,t,i){var n=this,a=!0;return e.forEach(function(e){t.forEach(function(t){""==n.GetValueByPropertyName(e,t)&&(n.ControlAddError(e["control_"+t],i),a=!1)})}),a},this.CheckUnique=function(e,t,i){
for(var n=this,a=!0,o=0;o<e.length;o++)for(var r=o+1;r<e.length;r++)this._checkUniqueEquals(e[o],e[r],t)&&(t.forEach(function(t){n.ControlAddError(e[o]["control_"+t],i),n.ControlAddError(e[r]["control_"+t],i)}),a=!1);return a},this._checkUniqueEquals=function(e,t,i){for(var n=0;n<i.length;n++){var a=i[n];if(e[a]!=t[a])return!1}return!0};var t=this;this.ClearTempField=function(e,i){void 0!=e&&(void 0==i&&(i=this.parameters.elements),i.forEach(function(n){$.isArray(e)?e.forEach(function(e){t.ClearTempField(e,i)}):void 0!=e["control_"+n.field]&&delete e["control_"+n.field],n.elements&&(void 0==n.field?t.ClearTempField(e,n.elements):t.ClearTempField(e[n.field],n.elements))}))},this.getElementCode=function(e){return void 0!=e.code?e.code:e.field},this.htmlEncode=function(e){return $("<div/>").text(e).html()},this.htmlDecode=function(e){return $("<div/>").html(e).text()},this.toCompactJSON=function(e){try{return JSON.stringify(JSON.parse(e))}catch(t){try{return JSON5.stringify(JSON5.parse(e))}catch(t){return e}}},this.toPrettyJSON=function(e){try{return JSON.stringify(JSON.parse(e),null,"\t")}catch(t){try{return JSON5.stringify(JSON5.parse(e),null,"\t")}catch(t){return e}}},this.objAssign=function(e,t){"use strict";if(null==e)throw new TypeError("Cannot convert undefined or null to object");for(var i=Object(e),n=1;n<arguments.length;n++){var a=arguments[n];if(null!=a)for(var o in a)Object.prototype.hasOwnProperty.call(a,o)&&(i[o]=a[o])}return i}}function WorkflowDesignerTransitionManager(){this.type="WorkflowDesignerTransitionManager",this.init=function(e){var t=this;this.graph=e,this.Layer=new Konva.Layer,this.graph.Stage.add(this.Layer),this.Layer.setZIndex(2),this.graph=e,this.APLayer=new Konva.Layer,this.graph.Stage.add(this.APLayer),this.APLayer.setZIndex(3);var i=function(){t.APLayer.batchDraw(),t.Layer.batchDraw()};this.ImageTimer=WorkflowDesignerCommon.loadImage(this.graph.Settings.imagefolder+"wfe.transition.timer.png",i),this.ImageCondition=WorkflowDesignerCommon.loadImage(this.graph.Settings.imagefolder+"wfe.transition.condition.png",i),this.ImageActor=WorkflowDesignerCommon.loadImage(this.graph.Settings.imagefolder+"wfe.transtion.actor.png",i),this.ImageOtherwise=WorkflowDesignerCommon.loadImage(this.graph.Settings.imagefolder+"wfe.transition.otherwise.png",i)},this.ItemControls=new Array,this.draw=function(){null!=this.ItemControls&&this.ItemControls.forEach(function(e){e.destroy()}),this.ItemControls=new Array;var e=this;void 0!=this.graph.data.Transitions&&this.graph.data.Transitions.forEach(function(t){var i=e.graph.GetComponentByType("WorkflowDesignerActivityManager"),n=i.find(t.From),a=i.find(t.To),o=!1;if(void 0==n&&t.From.DesignerSettings.Group!=e.graph.Settings.group&&(n=i.findGroup(t.From.DesignerSettings.Group,e.graph.Settings.group),o=!0),void 0==a&&t.To.DesignerSettings.Group!=e.graph.Settings.group&&(a=i.findGroup(t.To.DesignerSettings.Group,e.graph.Settings.group),o=!0),void 0!=n&&void 0!=a&&(!o||n!=a)){var r=new WorkflowDesignerTransitionControl({from:n,to:a,item:t,graph:e.graph,manager:e,group:o});e.ItemControls.push(r),r.Draw()}}),this.batchDraw()},this.batchDraw=function(){this.CorrectItems(),this.Layer.batchDraw(),this.APLayer.batchDraw()},this.CorrectItems=function(){for(var e=0;e<this.ItemControls.length;e++)for(var t=this.ItemControls[e],i=0;i<this.ItemControls.length;i++)if(e!=i){var n=this.ItemControls[i];t.start.x==n.start.x&&t.start.y==n.start.y&&(n.start.x+=5),t.end.x==n.end.x&&t.end.y==n.end.y&&(n.end.x+=5),t.middle.x==n.middle.x&&t.middle.y==n.middle.y&&(n.middle.x+=15)}},this.getIntersectingActivity=function(e){return this.graph.GetComponentByType("WorkflowDesignerActivityManager").getIntersectingActivity(e)},this.LayerSetOffset=function(e){this.Layer.setOffset(e),this.APLayer.setOffset(e)},this.LayerScale=function(e){var t=(e.scale,e.delta);this.Layer.setScale({x:this.Layer.getScale().x+t,y:this.Layer.getScale().y+t}),this.APLayer.setScale({x:this.APLayer.getScale().x+t,y:this.APLayer.getScale().y+t})},this.LayerScaleNorm=function(){this.Layer.setScale({x:1,y:1}),this.Layer.setOffset({x:0,y:0}),this.APLayer.setScale({x:1,y:1}),this.APLayer.setOffset({x:0,y:0})},this.DeselectAll=function(){this.ItemControls.forEach(function(e){e.Deselect()})},this.SelectAll=function(){this.ItemControls.forEach(function(e){e.Select()})},this.GetSelected=function(){var e=new Array;return this.ItemControls.forEach(function(t){t.selected&&e.push(t)}),e},this.SelectByPosition=function(e){this.ItemControls.forEach(function(t){t.getIntersectingRect(e)&&t.Select()})},this.SelectByItem=function(e){this.ItemControls.forEach(function(t){t.item==e&&t.Select()})},this.CreateNewTransition=function(e,t){var i=this;if(void 0==t){var n=e.control.getX()+e.rectangle.attrs.width,a=e.control.getY()+e.rectangle.attrs.height/2,o={x:n,y:a},r=new WorkflowDesignerTransitionManagerTempControl({x:o.x,y:o.y,manager:this});r.Draw(o.x+10,o.y),this.batchDraw();var s=function(e){var t=i.graph.CorrectPossition({x:e.evt.offsetX,y:e.evt.offsetY},i.Layer);r.Redraw(t),i.Layer.batchDraw()},l=function(t){var n={x:t.evt.offsetX,y:t.evt.offsetY},a=i.getIntersectingActivity(n);void 0!=a&&i.CreateNewTransition(e,a),r.Delete(),i.graph.Stage.off("mousemove.WorkflowDesignerTransitionManagerTempControl",s),i.graph.Stage.off("mouseup.WorkflowDesignerTransitionManagerTempControl",l),i.batchDraw(),i.graph.StoreGraphData()};return this.graph.Stage.on("mousemove.WorkflowDesignerTransitionManagerTempControl",s),this.graph.Stage.on("mouseup.WorkflowDesignerTransitionManagerTempControl",l),r}var d={Name:this.GetDefaultName(e.GetName(),t.GetName()),From:e.item,To:t.item,Trigger:{Type:"Auto"},Conditions:[{Type:"Always"}],AllowConcatenationType:"And",RestrictConcatenationType:"And",ConditionsConcatenationType:"And",Classifier:"NotSpecified",DesignerSettings:{}},c=new WorkflowDesignerTransitionControl({from:e,to:t,item:d,graph:i.graph,manager:i});return i.ItemControls.push(c),i.graph.data.Transitions.push(d),c.Draw(),c},this.GetDefaultName=function(e,t){for(var i=e+"_"+t+"_",n=1,a=0;a<this.graph.data.Transitions.length;a++){this.graph.data.Transitions[a].Name==i+n&&(n++,a=-1)}return i+n}}function WorkflowDesignerActivityControl(e){var t=this;this.manager=e.manager,this.graph=e.graph,this.x=e.x,this.y=e.y,this.group=e.group,this.item=e.item,this.control=void 0,this.rectangle=void 0,this.text=void 0,this.createTransitionAndActivityButton=void 0,this.createTransitionButton=void 0,this.selected=!1,this.dependentTransitions=new Array,this.getX=function(){return this.rectangle.attrs.x+this.control.attrs.x},this.getY=function(){return this.rectangle.attrs.y+this.control.attrs.y},this.GetName=function(){return this.group&&null!==this.item.FirstTimeInlineName&&void 0!==this.item.FirstTimeInlineName?this.item.FirstTimeInlineName:this.item.Name},this.SetName=function(e){this.item.Name=e},this.Draw=function(){var i=t.graph.Settings,n=!t.graph.Settings.disableobjectmovements;if(void 0==this.graph.Settings.drawElements||void 0==this.graph.Settings.drawElements.activity||this.graph.Settings.drawElements.activity(this)===!1){t.control=new Konva.Group({x:e.x,y:e.y,rotation:0,draggable:n,dragBoundFunc:function(e){var n=(i.DefaultMoveStep*t.manager.Layer.getScaleX(),i.DefaultMoveStep*t.manager.Layer.getScaleY()),e={x:Math.round(e.x/n)*n,y:Math.round(e.y/n)*n};if(t.selected){var a=this.getAbsolutePosition();t.manager.ObjectMove({sender:t,changepos:{x:e.x-a.x,y:e.y-a.y}})}return e}});var a=WorkflowDesignerConstants.ActivityColor,o=WorkflowDesignerConstants.ActivityTextColor;t.item.IsFinal&&(a=WorkflowDesignerConstants.ActivityFinalColor,o=WorkflowDesignerConstants.ActivityFinalTextColor,!1),t.item.IsInitial&&(a=WorkflowDesignerConstants.ActivityInitialColor,o=WorkflowDesignerConstants.ActivityInitialTextColor,!1);(this.group?t.graph.IsGroupActive(t.item.DesignerSettings.Group):t.graph.GetCurrentActivity()==t.item.Name)&&(a=WorkflowDesignerConstants.SelectColor,o=WorkflowDesignerConstants.SelectTextColor,!1),t.graph.isCurrentActivityForSubprocess(t.item.Name)&&(a=WorkflowDesignerConstants.SelectSubProcessColor,o=WorkflowDesignerConstants.SelectSubProcessTextColor,!1);var r="Inline"===this.item.ActivityType||this.group;t.rectangle=new Konva.Rect({x:0,y:0,width:this.graph.Settings.DefaultActivityWidth,height:this.graph.Settings.DefaultActivityHeight,fill:a,cornerRadius:5,dash:r?[8,4]:void 0,stroke:r?WorkflowDesignerConstants.ActivityShape:void 0,strokeWidth:r?4:0}),t.control.add(t.rectangle),this.group||(Array.isArray(t.item.Implementation)&&t.item.Implementation.length>0&&t.control.add(new Konva.Text({x:t.rectangle.attrs.width-20,y:38,text:"E",fontSize:12,fontFamily:"Arial",fill:o,fontStyle:"bold"})),Array.isArray(t.item.PreExecutionImplementation)&&t.item.PreExecutionImplementation.length>0&&t.control.add(new Konva.Text({x:t.rectangle.attrs.width-30,y:38,text:"P",fontSize:12,fontFamily:"Arial",fill:o,fontStyle:"bold"}))),t.text=new Konva.Text({x:10,y:10,text:this.GetName(),fontSize:12,fontFamily:"Arial",fontStyle:"bold",fill:o}),void 0==t.item.State&&(t.item.State="");var s=this.group?t.item.OriginalSchemeCode:t.item.State;r&&(t.control.add(new Konva.Text({x:t.rectangle.attrs.width-20,y:10,text:"I",fontSize:12,fontFamily:"Arial",fill:o,fontStyle:"bold"})),void 0!=t.item.SchemeCode&&(s=t.item.SchemeCode)),t.stateText=new Konva.Text({x:10,y:25,text:s,fontSize:12,fontFamily:"Arial",fill:o}),t.control.add(t.text),t.control.add(t.stateText);var l="";1==t.item.IsInitial&&(l.length>0&&(l+=" "),l+=WorkflowDesignerConstants.ActivityFormLabel.IsInitial),1==t.item.IsFinal&&(l.length>0&&(l+=" "),l+=WorkflowDesignerConstants.ActivityFormLabel.IsFinal),1==t.graph.getParam("exinfo")&&(t.createExInfo(t.control),1==t.item.IsForSetState&&(l.length>0&&(l+=" - "),l+=WorkflowDesignerConstants.ActivityFormLabel.IsForSetState)),""!=l&&(t.typeText=new Konva.Text({x:10,y:40,text:l,fontSize:12,fontFamily:"Arial",fill:o}),t.control.add(t.typeText)),t.graph.Settings.disableobjectmovements||(this.control.on("dragend",this.Sync),this.control.on("dragmove",this._onMove),this.control.on("click",this._onClick),this.control.on("touchend",this._onClick)),this.control.on("dblclick",this._onDblClick);var d=t.graph.Settings.imagefolder,c=[];if(t.graph.Settings.notshowwindows||c.push({img:d+"wfe.settings.png",click:function(){t.ShowProperties()}}),t.graph.Settings.readonly||t.group||(c.push({img:d+"wfe.transition.png",click:function(){t._onCreateTransition()}}),c.push({img:d+"wfe.activity.png",click:function(){t._onCreateTransitionAndActivity()}}),c.push({img:d+"wfe.clone.png",click:function(){t.manager.Clone(t)}}),c.push({img:d+"wfe.delete.png",click:function(){t._onDelete()}})),c.length>0){var h={x:t.rectangle.getWidth()-30*c.length,y:-40};t.bar=WorkflowDesignerBar(t.manager.Layer,c,h),t.control.add(t.bar),t.bar.hide()}t.manager.Layer.add(t.control)}},this.Delete=function(){this.control.destroy(),this.graph.data.Activities.splice(this.graph.data.Activities.indexOf(this.item),1),this.manager.ItemControls.splice(this.manager.ItemControls.indexOf(this),1);for(var e=new Array,t=0;t<this.dependentTransitions.length;t++)e.push(this.dependentTransitions[t]);for(var t=0;t<e.length;t++)e[t].Delete()},this.Select=function(){if(!this.selected){var e=this;this.rectangle.setStrokeWidth(4),this.rectangle.setStroke(WorkflowDesignerConstants.SelectColor),void 0!=e.bar&&e.bar.show(),this.selected=!0}},this.Deselect=function(){if(this.selected){var e="Inline"===this.item.ActivityType||this.group;this.rectangle.setStrokeWidth(e?4:0),this.rectangle.setStroke(e?WorkflowDesignerConstants.ActivityShape:this.rectangle.fill()),void 0!=t.bar&&t.bar.hide(),this.selected=!1}},this.ObjectMove=function(e){var i=this.control.getAbsolutePosition();if(i.x+=e.x,i.y+=e.y,this.control.setAbsolutePosition(i),this.Sync(),!(t.dependentTransitions.length<1))for(var n=0;n<t.dependentTransitions.length;n++){var a=t.dependentTransitions[n];a.middle=void 0,a.Draw()}},this._onMove=function(){if(!(t.dependentTransitions.length<1)){var e=!1;if(void 0==t.oldpos)t.oldpos=t.control.getPosition();else{var i=t.control.getPosition();(Math.abs(i.x-t.oldpos.x)>20||Math.abs(i.y-t.oldpos.y)>20)&&(e=!0)}for(var n=0;n<t.dependentTransitions.length;n++){var a=t.dependentTransitions[n];e&&(a.middle=void 0,a.item.DesignerSettings={}),a.Draw()}t.manager.redrawTransitions()}},this._onClick=function(e){var i=t.selected;e.evt.ctrlKey||t.graph.DeselectAll(),i?t.Deselect():t.Select(),t.graph.onSelectionChanged(!i),t.manager.batchDraw()},this._onDblClick=function(){t.graph.DeselectAll(),t.Select(),t.manager.batchDraw(),t.graph.Settings.notshowwindows||t.ShowProperties()},this._onDelete=function(){var e=this;e.graph.confirm(WorkflowDesignerConstants.DeleteConfirmCurrent,function(){e.Delete(),e.graph.onSelectionChanged(),e.graph.redrawAll(),e.graph.StoreGraphData()})},this._onCreateTransitionAndActivity=function(){t.manager.createTransitionAndActivity(t),t.graph.StoreGraphData()},this._onCreateTransition=function(){t.manager.createTransition(t)},this.RegisterTransition=function(e){for(var t=!1,i=0;i<this.dependentTransitions.length;i++)if(this.dependentTransitions[i].GetName()==e.GetName()){t=!0;break}t||this.dependentTransitions.push(e)},this.UnregisterTransition=function(e){for(var t=new Array,i=0;i<this.dependentTransitions.length;i++)this.dependentTransitions[i].GetName()!=e.GetName()&&t.push(this.dependentTransitions[i]);this.dependentTransitions=t},this.RegisterTransition=function(e){for(var t=!1,i=0;i<this.dependentTransitions.length;i++)if(this.dependentTransitions[i].GetName()==e.GetName()){t=!0;break}t||this.dependentTransitions.push(e)},this.UnregisterTransition=function(e){for(var t=new Array,i=0;i<this.dependentTransitions.length;i++)this.dependentTransitions[i].GetName()!=e.GetName()&&t.push(this.dependentTransitions[i]);this.dependentTransitions=t},this.getRectPos=function(){var e=this.rectangle.getAbsolutePosition(),t=e.x,i=e.y;return{xl:t,yl:i,xr:t+this.rectangle.getWidth()*this.manager.Layer.getScaleX(),yr:i+this.rectangle.getHeight()*this.manager.Layer.getScaleY()}},this.getIntersectingActivity=function(e){var t=this.getRectPos();return e.x>=t.xl&&e.x<t.xr&&e.y>=t.yl&&e.y<t.yr},this.getIntersectingActivityRect=function(e){var t=this.getRectPos();return!(e.xl>t.xr||e.xr<t.xl||e.yl>t.yr||e.yr<t.yl)},this.ShowInlineProperties=function(){var e=WorkflowDesignerConstants.ActivityFormLabel,i=t.graph.data.AdditionalParams.InlinedSchemeCodes,n={type:"form",title:e.TitleForInline,width:"800px",data:this.item,elements:[{name:e.Name,field:"Name",type:"input"},{name:e.Scheme,field:"SchemeCode",type:"select",datasource:i,width:"100%"}],graph:t.graph,readonly:t.graph.Settings.readonly,saveFunc:function(e){t.item.Name=e.Name,t.item.SchemeCode=e.SchemeCode,WorkflowDesignerCommon.DataCorrection(t.graph.data),t.graph.Draw(t.graph.data),t.graph.StoreGraphData()}};if(void 0!=this.graph.Settings.forms&&void 0!=this.graph.Settings.forms.activity)this.graph.Settings.forms.activity(n);else{var a=new WorkflowDesignerForm(n),o=function(e,i){var n=!0;return n&=e.CheckRequired([i],["Name","Scheme"],WorkflowDesignerConstants.FieldIsRequired),t.graph.data.Activities.forEach(function(a){a!=t.item&&a.Name==i.Name&&(n=!1,e.ControlAddError(i.control_Name,WorkflowDesignerConstants.FieldMustBeUnique))}),n},r=function(e){return!!o(a,e)&&(a.ClearTempField(e),a.parameters.saveFunc(e),!0)};a.showModal(r)}},this.ShowProperties=function(){var e;if(this.group)return void this.ShowGroup();if("Inline"===this.item.ActivityType)return void this.ShowInlineProperties();var i=WorkflowDesignerConstants.ActivityFormLabel,n=[{name:i.ImpAction,code:"impAction",field:"ActionName",type:"select",datasource:t.graph.getActionNames(),onchange:function(e){var t=$(e),i=t.closest("tr").find("[name=impparam]").closest("td"),n=i.children(),a=n[0].rebuild($(e).val(),n.find("input").val());n.remove(),i.append(a)}},{name:i.ImpActionParameter,code:"impparam",field:"ActionParameter",type:"jsonparameter",graph:t.graph,parametertype:"Action",openautocompleteonclick:!0,datasource:function(e,i){var n=$(this).closest("tr"),a=n.find("[name=impAction]")[0].value;i(t.graph.getAutoCompleteSuggestions("actionparameter",a,e))}}],a={type:"form",title:i.Title,data:this.item,elements:[{type:"group",elements:[{name:i.Name,field:"Name",type:"input",width:"100%"},{name:i.State,field:"State",type:"input",width:"100%"}]},{type:"group",elements:[{name:i.IsInitial,field:"IsInitial",type:"checkbox"},{name:i.IsFinal,field:"IsFinal",type:"checkbox"},{name:i.IsForSetState,field:"IsForSetState",type:"checkbox"},{name:i.IsAutoSchemeUpdate,field:"IsAutoSchemeUpdate",type:"checkbox"}]},{name:i.Implementation,field:"Implementation",type:"table",elements:n},{name:i.PreExecutionImplementation,field:"PreExecutionImplementation",type:"table",elements:n},{name:i.Annotations,type:"table",field:"Annotations",keyproperty:"Name",elements:[{name:i.AnnotationName,field:"Name",type:"input"},{name:i.AnnotationValue,field:"JsonValue",type:"json"}]}],graph:t.graph,readonly:t.graph.Settings.readonly,saveFunc:function(e){if(Array.isArray(e.Implementation)){var i=1;e.Implementation.forEach(function(e){e.Order=i,i++})}if(Array.isArray(e.PreExecutionImplementation)){var i=1;e.PreExecutionImplementation.forEach(function(e){e.Order=i,i++})}t.item.Name=e.Name,t.item.State=e.State,t.item.IsInitial=e.IsInitial,t.item.IsFinal=e.IsFinal,t.item.IsForSetState=e.IsForSetState,t.item.IsAutoSchemeUpdate=e.IsAutoSchemeUpdate,t.item.Implementation=e.Implementation,t.item.PreExecutionImplementation=e.PreExecutionImplementation,t.item.Annotations=e.Annotations,WorkflowDesignerCommon.DataCorrection(t.graph.data),t.graph.Draw(t.graph.data),t.graph.StoreGraphData()}};if(void 0!=this.graph.Settings.forms&&void 0!=this.graph.Settings.forms.activity)this.graph.Settings.forms.activity(a);else{e=new WorkflowDesignerForm(a);var o=function(e,i){var n=!0;return n&=e.CheckRequired([i],["Name"],WorkflowDesignerConstants.FieldIsRequired),t.graph.data.Activities.forEach(function(a){a!=t.item&&a.Name==i.Name&&(n=!1,e.ControlAddError(i.control_Name,WorkflowDesignerConstants.FieldMustBeUnique))}),e.CheckRequired(i.Implementation,["ActionName","Order"],WorkflowDesignerConstants.FieldIsRequired)||(n=!1),e.CheckRequired(i.PreExecutionImplementation,["ActionName","Order"],WorkflowDesignerConstants.FieldIsRequired)||(n=!1),e.CheckRequired(i.Annotations,["Name"],WorkflowDesignerConstants.FieldIsRequired)||(n=!1),e.CheckUnique(i.Annotations,["Name"],WorkflowDesignerConstants.FieldMustBeUnique)||(n=!1),i.Annotations.forEach(function(a){a!=t.item&&a.Name==i.Name&&(n=!1,e.ControlAddError(i.control_Name,WorkflowDesignerConstants.FieldMustBeUnique))}),n},r=function(t){return!!o(e,t)&&(e.ClearTempField(t),e.parameters.saveFunc(t),!0)};e.showModal(r)}},this.ShowGroup=function(){new WorkflowDesignerForm({type:"form",title:this.GetName(),data:this.manager.graph.data,elements:[{type:"scheme",group:this.item.DesignerSettings.Group}],graph:t.graph,readonly:!0}).showModal()},this.Sync=function(){if(t.group){void 0==t.item.DesignerSettings.InlineElementSettings&&(t.item.DesignerSettings.InlineElementSettings={});var e=t.control.getPosition();t.item.DesignerSettings.InlineElementSettings.X=e.x,t.item.DesignerSettings.InlineElementSettings.Y=e.y}else{void 0==t.item.DesignerSettings&&(t.item.DesignerSettings={});var e=t.control.getPosition();t.item.DesignerSettings.X=e.x,t.item.DesignerSettings.Y=e.y}t.oldpos=void 0},this.createExInfo=function(e){var i="";Array.isArray(t.item.Implementation)&&t.item.Implementation.length>0&&t.item.Implementation.forEach(function(e){i.length>0&&(i+=", "),i+=e.ActionName});var n="";if(Array.isArray(t.item.PreExecutionImplementation)&&t.item.PreExecutionImplementation.length>0&&(t.item.PreExecutionImplementation.forEach(function(e){n.length>0&&(n+=", "),n+=e.ActionName}),""==i&&(i=WorkflowDesignerConstants.None)),i.length>0){var a=new Konva.Text({x:10,y:this.graph.Settings.DefaultActivityHeight+5,text:i,fontFamily:"Arial",fontSize:12,fill:"#4A4A4A",fontStyle:"bold"});if(e.add(a),n.length>0){var o=new Konva.Text({x:10,y:this.graph.Settings.DefaultActivityHeight+a.getHeight()+5,text:n,fontFamily:"Arial",fontSize:12,fill:"#4A4A4A",fontStyle:"italic"});e.add(o)}}},this.destroy=function(){this.control.destroy()}}function WorkflowGraph(e,t,i,n){var a=this;a.container=e,a.designer=t,a.suggestionsCache=new Object,a.parametersCache=new Object,void 0==i&&(i=new Object),void 0==i.Container&&(i.Container="container"),void 0==i.graphwidth&&(i.graphwidth=1024),void 0==i.graphheight&&(i.graphheight=768),void 0==i.DefaultActivityWidth&&(i.DefaultActivityWidth=200),void 0==i.DefaultActivityHeight&&(i.DefaultActivityHeight=60),void 0==i.DefaultMoveStep&&(i.DefaultMoveStep=10),void 0==i.imagefolder&&(i.imagefolder="/images/"),this.Settings=i,this.Settings.ContainerStage=this.container+"_stage",$("#"+this.container).append("<div id='"+this.Settings.ContainerStage+"' class='workflowenginecontainerstage'></div>"),this.Stage=new Konva.Stage({container:this.Settings.ContainerStage,width:parseInt(this.Settings.graphwidth),height:parseInt(this.Settings.graphheight)}),this.getParam=function(e){var t=this.designer.getParam(e);return"true"===t||"false"!==t&&t},this.setParam=function(e,t){this.designer.setParam(e,t)},this.Components=new Array,this.AddComponent=function(e){var t=new e;return t.init(this),a.Components.push(t),t},this.GetComponentByType=function(e){for(var t=0;t<this.Components.length;t++)if(this.Components[t].type==e)return this.Components[t]},this.ComponentsExecute=function(e,t){a.Components.forEach(function(i){i[e]&&i[e](t)})},n&&n.forEach(function(e){a.AddComponent(e)}),this.Draw=function(e){a.data=e,0==a.graphData.length&&a.StoreGraphData(),a.onSelectionChanged(),a.ComponentsExecute("draw")},this.GraphLayerSetOffset=function(e,t){a.ComponentsExecute("LayerSetOffset",{x:e,y:t}),a.redrawAll()},this.GraphLayerScale=function(e,t){void 0==a._bg&&(a._bg=a.GetComponentByType("WorkflowDesignerBackground"));var i=a._bg.BackgroundLayer.getScale(),n=i.x+e;n>.3&&n<2&&(a.ComponentsExecute("LayerScale",{scale:i.x,delta:e}),void 0!=t&&a.ComponentsExecute("setPosition",t),a.redrawAll())},this.GraphLayerScaleNorm=function(){a.ComponentsExecute("LayerScaleNorm",1),a.redrawAll()},this.GraphUpdatePosition=function(e){void 0==a._bg&&(a._bg=a.GetComponentByType("WorkflowDesignerBackground")),a._bg.updatePosition(e),a.redrawAll()},this.Refresh=function(){a.designer.refresh()},this.onFullScreenClick=function(){void 0!==this.data.__loadParams&&this.data.__loadParams.isFullScreen?(this.setFullScreen(!1),this.data.__loadParams.isFullScreen=!1):(this.setFullScreen(!0),void 0===this.data.__loadParams&&(this.data.__loadParams={}),this.data.__loadParams.isFullScreen=!0),this.redrawAll()},this.setFullScreen=function(e){var t=$("#"+this.container);void 0==this._toolbar&&(this._toolbar=this.GetComponentByType("WorkflowDesignerToolbar"));var i=this._toolbar;if(e){this.originalContainerStyle=t.attr("style"),void 0==this.originalContainerStyle&&(this.originalContainerStyle=""),this.originalWidth=this.Stage.width(),this.originalHeight=this.Stage.height();var n=$(window).width()-2,a=$(window).height()-2;this.Stage.hide(),this.Stage.width(n),this.Stage.height(a),void 0!=i&&(i.setItemActive("fullscreen",!0),i.changeSize(n,a)),t.css({position:"absolute",top:0,left:0,width:n,height:a,"z-index":1e3,background:"white"}),this.Stage.show()}else void 0!=this.originalContainerStyle&&void 0!=this.originalWidth&&void 0!=this.originalHeight&&(this.Stage.hide(),t.attr("style",this.originalContainerStyle),this.Stage.width(this.originalWidth),this.Stage.height(this.originalHeight),void 0!=i&&(i.setItemActive("fullscreen",!1),i.changeSize(this.originalWidth,this.originalHeight)),this.Stage.show())},this.DeselectAll=function(){a.ComponentsExecute("DeselectAll"),a.onSelectionChanged(!1),a.redrawAll()},this.SelectAll=function(){a.ComponentsExecute("SelectAll"),a.onSelectionChanged(!1),a.redrawAll()},this.redrawAll=function(){void 0==this._toolbal&&(this._toolbal=a.GetComponentByType("WorkflowDesignerToolbar")),void 0!=this._toolbal&&this._toolbal.draw(),a.Stage.batchDraw()},this.CorrectPossition=function(e,t){return 0==t.getScaleX()||0==t.getScaleY()?{x:t.getOffsetX(),y:0}:{x:e.x/t.getScaleX()+t.getOffsetX(),y:e.y/t.getScaleY()+t.getOffsetY()}},this.DeleteSelected=function(){var e=this,t=new Array;this.Components.forEach(function(e){e.GetSelected&&(t=t.concat(e.GetSelected()))}),t.length>0&&e.confirm(WorkflowDesignerConstants.DeleteConfirm,function(){t.forEach(function(e){e.Delete()}),e.onSelectionChanged(!1),e.StoreGraphData(),e.redrawAll()})},this.confirm=function(e,t){var i=$('<div class="ui mini modal"></div>');i.append($('<div class="content"><p>'+e+"</p></div>"));var n=$('<div class="actions"></div>').append('<div class="ui primary ok button">'+WorkflowDesignerConstants.ButtonTextYes+"</div>").append('<div class="ui secondary  cancel button">'+WorkflowDesignerConstants.ButtonTextCancel+"</div>");i.append(n),WorkflowDesignerCommon.modal(i,{onApprove:function(){t()}}),WorkflowDesignerCommon.modal(i,"show")},this.destroy=function(){if(void 0!=this.originalContainerStyle){$("#"+this.container).attr("style",this.originalContainerStyle)}void 0!=this.data&&(void 0==this.data.__loadParams&&(this.data.__loadParams={}),this.data.__loadParams.graphData=this.graphData,this.data.__loadParams.graphDataIndex=this.graphDataIndex),this.Stage.destroy(),this.ComponentsExecute("destroy")},this.GetCurrentActivity=function(){if(void 0!=a.data&&void 0!=a.data.AdditionalParams&&void 0!=a.data.AdditionalParams.ProcessParameters)for(var e=0;e<a.data.AdditionalParams.ProcessParameters.length;e++){var t=a.data.AdditionalParams.ProcessParameters[e];if("CurrentActivity"===t.Name)return t.Value}},this.isCurrentActivityForSubprocess=function(e){if(void 0==a.data||void 0==a.data.AdditionalParams||!Array.isArray(a.data.AdditionalParams.SubprocessCurrentActivities))return!1;for(var t=0;t<a.data.AdditionalParams.SubprocessCurrentActivities.length;t++)if(e===a.data.AdditionalParams.SubprocessCurrentActivities[t])return!0;return!1},this.IsGroupActive=function(e){var t=this.GetCurrentActivity();if(void 0==t)return!1;for(var i=0;i<a.data.Activities.length;i++){var n=a.data.Activities[i];if(t===n.Name)return a.CheckActive(n,e)}return!1},this.CheckActive=function(e,t){var i=this,n=e.DesignerSettings.Group;if(n===t)return!0;var a=null;if(void 0!==e.DesignerSettings.InlineElementSettings&&null!==e.DesignerSettings.InlineElementSettings&&void 0!==e.DesignerSettings.InlineElementSettings.Group&&null!==e.DesignerSettings.InlineElementSettings.Group)a=e;else for(var o=0;o<i.data.Activities.length;o++){var r=i.data.Activities[o];if(r.DesignerSettings.Group===n&&void 0!==r.DesignerSettings.InlineElementSettings&&null!==r.DesignerSettings.InlineElementSettings&&void 0!==r.DesignerSettings.InlineElementSettings.Group&&null!==r.DesignerSettings.InlineElementSettings.Group){a=r;break}}if(null===a)return!1;var s=a.DesignerSettings.InlineElementSettings.Group;if(s===t)return!0;for(var l=null,o=0;o<i.data.Activities.length;o++){var d=i.data.Activities[o];if(void 0!==d.DesignerSettings.InlineElementSettings&&null!==d.DesignerSettings.InlineElementSettings&&d.DesignerSettings.Group===s){l=d;break}}return null!==l&&i.CheckActive(l,t)},this.getActionParameterDefinition=function(e,t){for(var i=0;i<a.data.CodeActions.length;i++){var n=a.data.CodeActions[i];if(n.Type===t&&n.Name===e){if(n.ParameterDefinitions&&n.ParameterDefinitions.length>0)return n.ParameterDefinitions;break}}return a.getCodeactionParameter(t,e)},this.getActionNames=function(){for(var e=this,t=new Array,i=0;i<e.data.CodeActions.length;i++){var n=e.data.CodeActions[i];"action"===n.Type.toLowerCase()&&t.push(n.Name)}return e.data.AdditionalParams.Actions.concat(t)},this.getConditionNames=function(){for(var e=this,t=new Array,i=0;i<e.data.CodeActions.length;i++){var n=e.data.CodeActions[i];"condition"===n.Type.toLowerCase()&&t.push(n.Name)}return e.data.AdditionalParams.Conditions.concat(t)},this.getActorNames=function(){for(var e=this,t=new Array,i=0;i<e.data.CodeActions.length;i++){var n=e.data.CodeActions[i];"ruleget"!==n.Type.toLowerCase()&&"rulecheck"!==n.Type.toLowerCase()||t.push(n.Name)}return e.unique(e.data.AdditionalParams.Rules.concat(t))},this.getTypeNames=function(){for(var e=this,t=new Array,i=0;i<e.data.Parameters.length;i++){var n=e.data.Parameters[i];t.push(decodeURIComponent(n.Type))}return e.unique(e.data.AdditionalParams.Types.concat(t))},this.getCodeactionParameter=function(e,t){var i=null;return void 0!==this.parametersCache[e]&&void 0!==this.parametersCache[e][t]?i=this.parametersCache[e][t]:(void 0===this.parametersCache[e]&&(this.parametersCache[e]=new Object),i=this.designer.requestcodeactionparameter(e,t),this.parametersCache[e][t]=i),i},this.getAutoCompleteSuggestions=function(e,t,i){var n;return void 0===t||""===t?new Array:(void 0!=this.suggestionsCache[e]&&void 0!=this.suggestionsCache[e][t]?n=this.suggestionsCache[e][t]:(void 0==this.suggestionsCache[e]&&(this.suggestionsCache[e]=new Object),n=this.designer.requestautocompletesuggestions(e,t),this.suggestionsCache[e][t]=n),$.grep(n,function(e){return e.toLowerCase().indexOf(i.toLowerCase())>=0}))},this.getNonSystemParameters=function(){for(var e=this,t=new Array,i=0;i<e.data.Parameters.length;i++){var n=e.data.Parameters[i];"system"!=n.Purpose.toLowerCase()&&t.push(n)}return t},this.unique=function(e){return $.grep(e,function(t,i){return i===$.inArray(t,e)})},this.setInlinedFlag=function(e){this.data.CanBeInlined=e,a.StoreGraphData()},this.graphData=[],this.graphDataIndex=-1,this.StoreGraphData=function(){var e=void 0;void 0!=this.data.__loadParams&&(e=this.data.__loadParams.graphData,this.data.__loadParams.graphData=void 0);var t=JSON.stringify(this.data);if(void 0!=e&&(this.data.__loadParams.graphData=e),this.graphDataIndex<0||this.graphData[this.graphDataIndex]!=t){this.graphDataIndex++,this.graphData.length>this.graphDataIndex&&this.graphData.splice(this.graphDataIndex,this.graphData.length-this.graphDataIndex),this.graphData.push(t);var i=200;void 0!=WorkflowDesignerConstants.UndoDepth&&(i=WorkflowDesignerConstants.UndoDepth),this.graphData.length>i&&(this.graphData.splice(0,1),this.graphDataIndex--)}this.heckToolbarButtonState()},this.ClearGraphData=function(){this.graphData=[],this.graphDataIndex=-1},this.Undo=function(){this.graphDataIndex>0&&this.changeGraphDataIndex(this.graphDataIndex-1)},this.Redo=function(){this.graphData.length>this.graphDataIndex&&this.changeGraphDataIndex(this.graphDataIndex+1)},this.changeGraphDataIndex=function(e){if(this.graphData.length>e){var t=JSON.parse(this.graphData[e]);WorkflowDesignerCommon.DataCorrection(t),this.designer.data=t,this.Draw(t),this.graphDataIndex=e}this.heckToolbarButtonState()},this.heckToolbarButtonState=function(){void 0==this._toolbal&&(this._toolbal=a.GetComponentByType("WorkflowDesignerToolbar"));var e=this._toolbal;void 0!=e&&(e.setItemDisabled("undo",this.graphDataIndex<=0),e.setItemDisabled("redo",this.graphData.length<=this.graphDataIndex+1),e.onChangeScheme(),e.Layer.batchDraw())},this.onSelectionChanged=function(e){void 0==this._toolbal&&(this._toolbal=a.GetComponentByType("WorkflowDesignerToolbar"));var t=this._toolbal;if(void 0!=t){var i;if(void 0==e){var n=a.GetComponentByType("WorkflowDesignerActivityManager"),o=a.GetComponentByType("WorkflowDesignerTransitionManager"),r=n.GetSelected(),s=o.GetSelected();i=r.length>0||s.length>0}else i=e;t.setItemDisabled("copy",!i),t.setItemDisabled("delete",!i)}}}function WorkflowDesignerTransitionControl(e){var t=this;this.manager=e.manager,this.graph=e.graph,this.from=e.from,this.to=e.to,this.item=e.item,this.group=e.group,this.setFrom=function(e){this.from=e,this.item.From=e.item},this.setTo=function(e){this.to=e,this.item.To=e.item},this.GetName=function(){return this.item.Name},this.SetName=function(e){this.item.Name=e},
this.control=void 0,this.arrow=void 0,this.line=void 0,void 0!=this.item.DesignerSettings&&void 0!=this.item.DesignerSettings.X&&void 0!=this.item.DesignerSettings.Y&&(this.middle={x:Number(this.item.DesignerSettings.X),y:Number(this.item.DesignerSettings.Y)}),this.from.RegisterTransition(this),this.to.RegisterTransition(this),this.start=void 0,this.end=void 0,this.angle=void 0,this.activePoint=void 0,this.touchpoints=[],this.DrawTransition=function(e,t){var i,n,a,o,r=this,s=this.from.rectangle,l=this.to.rectangle;i=Number(this.from.getX()),n=Number(this.from.getY()),a=Number(this.to.getX()),o=Number(this.to.getY());var d=Number(s.attrs.width/2),c=Number(s.attrs.height/2),h=Number(l.attrs.width/2),u=Number(l.attrs.height/2),m=i+d,g=n+c,f=a+h,p=o+u;if(this.direction={start:0,end:0},this.from==this.to)this.start={x:m+d,y:g-c+14},this.end={x:f+h-25,y:p-u},this.direction.end=1,void 0==this.middle&&(this.middle={x:m+d+c,y:g-2*c});else{var v=!1;void 0==this.middle&&(v=!0,this.middle={x:(m+f)/2,y:(g+p)/2});var y=m,w=g,S=f,b=p;if(g-c-25>this.middle.y&&p-u-25>this.middle.y?(w=g-c,b=p-u,this.direction.start=1,this.direction.end=1):g+c+25<this.middle.y&&p+u+25<this.middle.y?(w=g+c,b=p+u,this.direction.start=1,this.direction.end=1):m-d-25>this.middle.x&&f-h-25>this.middle.x?(y=m-d,S=f-h):m+d+25<this.middle.x&&f+h+25<this.middle.x?(y=m+d,S=f+h):(m+d+25<this.middle.x?y+=d:m-d-25>this.middle.x?y-=d:g+c+25<this.middle.y?(w+=c,this.direction.start=1):g-c-25>this.middle.y?(w-=c,this.direction.start=1):y<=this.middle.x?y+=d:y-=d,f+h+25<this.middle.x?S+=h:f-h-25>this.middle.x?S-=h:p+u+25<this.middle.y?(b+=u,this.direction.end=1):p-u-25>this.middle.y?(b-=u,this.direction.end=1):(w>=this.middle.y?b+=u:b-=u,this.direction.end=1)),void 0!=e&&(y=e.x,w=e.y,v=!0),void 0!=t&&(S=t.x,b=t.y,v=!0),this.start={x:y,y:w},this.end={x:S,y:b},v){this.middle={x:(y+S)/2,y:(w+b)/2};for(var C=0;C<r.manager.ItemControls.length;C++){var D=r.manager.ItemControls[C];D!=r&&D.middle.x==r.middle.x&&D.middle.y==r.middle.y&&(0==r.direction.start?r.middle.y+=40:r.middle.x+=40)}}void 0==e&&(0==this.direction.start?this.middle.y>w+c-7?w+=c-7:this.middle.y<w-c+7?w-=c-7:w=this.middle.y:this.middle.x>y+d-10?y+=d-10:this.middle.x<y-d+10?y-=d-10:y=this.middle.x),void 0==t&&(0==this.direction.end?this.middle.y>b+u-7?b+=u-7:this.middle.y<b-u+7?b-=u-7:b=this.middle.y:this.middle.x>S+h-10?S+=h-10:this.middle.x<S-h+10?S-=h-10:S=this.middle.x),this.start={x:y,y:w},this.end={x:S,y:b}}this.points=this.GetPoints([this.start.x,this.start.y,this.middle.x,this.middle.y,this.end.x,this.end.y],this.direction);var T=this.GetColor();if(this.angle=Math.atan2(this.points[this.points.length-1]-this.points[this.points.length-3],this.points[this.points.length-2]-this.points[this.points.length-4]),void 0==this.control){this.control=new Konva.Group({x:0,y:0,rotation:0}),this.arrow=WorkflowDesignerCommon.createArrowByAngle(this.end.x,this.end.y,this.angle,15,T);var k={points:this.points,stroke:T,strokeWidth:2,lineCap:"round",lineJoin:"round"};this.item.IsFork&&(k.dash=[10,10]),this.line=new Konva.Line(k),this.control.add(this.line),this.control.add(this.arrow),this.manager.Layer.add(this.control)}else WorkflowDesignerCommon.updateArrowByAngle(this.arrow,this.end.x,this.end.y,this.angle,15,T),this.line.setPoints(this.points)},this.GetPoints=function(e,t){if(e[0]==e[2]==e[4]||e[1]==e[3]==e[5])return e;var i=new Array;return e[0]==e[2]||e[1]==e[3]?i.push(e[0],e[1],e[2],e[3]):(i.push(e[0],e[1]),0==t.start?i.push(e[2],e[1]):i.push(e[0],e[3]),i.push(e[2],e[3])),0==t.end&&i[i.length-2]!=e[4]?i.push(i[i.length-2],e[5]):1==t.end&&i[i.length-1]!=e[5]&&i.push(e[4],i[i.length-1]),i.push(e[4],e[5]),i},this.GetColor=function(){var e=void 0==this.item.Classifier?"notspecified":this.item.Classifier.toLowerCase();return"notspecified"==e?"#7F8C8D":"direct"==e?"#27AE60":"#2980B9"},this.DrawActivePoint=function(){if(this.activePoint)this._moveActivePoint(this.middle.x,this.middle.y);else{var e=void 0;void 0!=this.graph.Settings.drawElements&&void 0!=this.graph.Settings.drawElements.transitionActivePoint&&(e=this.graph.Settings.drawElements.transitionActivePoint(this,this.middle.x,this.middle.y)),e||(e=this.graph.Settings.transitionActivePointOldStyle?this._createActivePointOld(this.middle.x,this.middle.y,this.control):this._createActivePoint(this.middle.x,this.middle.y,this.control)),t.manager.APLayer.add(e),this.activePoint=e}},this.DrawTouchPoints=function(){this._getLineLength(this.start.x,this.start.y,this.end.x,this.end.y);if(void 0==this.touchpoints[0]||this.touchpoints[0].isdestroyed){var e=this._createTouchPoint(this.points,this.control,!1);t.manager.APLayer.add(e),this.touchpoints[0]=e}else this._moveTouchPoints(this.touchpoints[0],this.points,!1);if(void 0==this.touchpoints[1]||this.touchpoints[1].isdestroyed){var i=this._createTouchPoint(this.points,this.control,!0);t.manager.APLayer.add(i),this.touchpoints[1]=i}else this._moveTouchPoints(this.touchpoints[1],this.points,!0)},this.Draw=function(e,t){this.DrawTransition(e,t),this.DrawActivePoint(),this.graph.Settings.readonly||this.DrawTouchPoints()},this.DeleteTouchPoint=function(e){for(var t=0;t<this.touchpoints.length;t++)this.touchpoints[t].isend===e&&(this.touchpoints[t].destroy(),this.touchpoints[t].isdestroyed=!0)},this.Delete=function(){this.from.UnregisterTransition(this),this.to.UnregisterTransition(this),this.control.destroy(),void 0!=this.activePoint.ToolTip&&this.activePoint.ToolTip.destroy(),this.activePoint.destroy();for(var e=0;e<this.touchpoints.length;e++)this.touchpoints[e].destroy();var t=this.graph.data.Transitions.indexOf(this.item);t>=0&&this.graph.data.Transitions.splice(t,1),t=this.manager.ItemControls.indexOf(this),t>=0&&this.manager.ItemControls.splice(t,1)},this._onDelete=function(){t.graph.confirm(WorkflowDesignerConstants.DeleteConfirmCurrent,function(){t.Delete(),t.graph.onSelectionChanged(),t.graph.redrawAll(),t.graph.StoreGraphData()})},this.Select=function(){if(1!=this.selected){var e=this;if(e.oldstroke=this.line.getStroke(),e.line.setStroke(WorkflowDesignerConstants.SelectColor),e.line.setStrokeWidth(3),void 0==e.bar){var t=e.graph.Settings.imagefolder,i=-15,n=[];e.graph.Settings.notshowwindows||n.push({img:t+"wfe.settings.png",click:function(){e.ShowProperties()}}),e.graph.Settings.readonly||(n.push({img:t+"wfe.delete.png",click:function(){e._onDelete()}}),i=-30),n.length>0&&(e.bar=WorkflowDesignerBar(e.manager.APLayer,n,{x:i,y:-50}),e.activePoint.add(e.bar))}else this.bar.show();e.selected=!0}},this.Deselect=function(){0!=this.selected&&(this.line.setStrokeWidth(2),void 0!=this.oldstroke&&this.line.setStroke(this.oldstroke),void 0!=this.bar&&this.bar.hide(),this.selected=!1)},this._moveTouchPoints=function(e,t,i){var n=i?{x:t[t.length-2],y:t[t.length-1]}:{x:t[0],y:t[1]},a=i?{x:t[t.length-4],y:t[t.length-3]}:{x:t[2],y:t[3]},o={x:0,y:0},r=i?24:10;n.x==a.x?n.y<a.y?o.y=r:o.y=-r:n.y==a.y&&(n.x<a.x?o.x=r:o.x=-r),e.setPosition(n),e.circle.setPosition(o)},this._createTouchPoint=function(e,t,i){var n=this,a=i?{x:e[e.length-2],y:e[e.length-1]}:{x:e[0],y:e[1]},o=i?{x:e[e.length-4],y:e[e.length-3]}:{x:e[2],y:e[3]},r={x:0,y:0},s=i?24:10;a.x==o.x?a.y<o.y?r.y=s:r.y=-s:a.y==o.y&&(a.x<o.x?r.x=s:r.x=-s);var l=new Konva.Group({x:a.x,y:a.y,draggable:!0});l.isend=i;var d=this.GetColor(),c=new Konva.Circle({x:r.x,y:r.y,radius:5,fill:d});l.add(c),l.circle=c,l.transition=t;var h=function(){var e=n.graph.CorrectPossition(c.getAbsolutePosition(),n.manager.Layer);i?n.DrawTransition(void 0,e):n.DrawTransition(e,void 0),n.DrawActivePoint(),n.DeleteTouchPoint(!i),n.manager.batchDraw()};return l.on("dragmove",function(){h()}),l.on("dragend",function(){var e=c.getAbsolutePosition(),t=n.manager.getIntersectingActivity(e);void 0==t||t.group||(n.middle=void 0,n.Sync(),i?(n.to.UnregisterTransition(n),n.setTo(t),n.to.RegisterTransition(n)):(n.from.UnregisterTransition(n),n.setFrom(t),n.from.RegisterTransition(n)),n.graph.StoreGraphData()),n.Draw(),n.manager.batchDraw()}),l},this._moveActivePoint=function(e,t){this.activePoint.setPosition({x:e,y:t})},this._createActivePoint=function(e,t,i){var n=this,a=!n.graph.Settings.disableobjectmovements,o=new Konva.Group({x:e,y:t,draggable:a}),r="";isTimer=!1;var s=this.item.Trigger.Type.toLowerCase();"auto"===s?(r=WorkflowDesignerConstants.TransitionAuto,void 0==r&&(r="Auto")):"command"===s?this.item.Trigger&&this.item.Trigger.Command&&this.item.Trigger.Command.Name&&(r=this.item.Trigger.Command.Name,r.length>15&&(r=r.substr(0,15)+"...")):"timer"===s&&(isTimer=!0,this.item.Trigger&&this.item.Trigger.Timer&&this.item.Trigger.Timer.Name&&(r=this.item.Trigger.Timer.Name,r.length>15&&(r=r.substr(0,15)+"...")));var l=[],d=[];isTimer&&l.push(this.manager.ImageTimer),Array.isArray(this.item.Restrictions)&&this.item.Restrictions.length>0&&d.push(this.manager.ImageActor);var c=this.item.Conditions[0].Type.toLowerCase();"action"===c?d.push(this.manager.ImageCondition):"otherwise"===c&&d.push(this.manager.ImageOtherwise);var h=WorkflowDesignerCommon.getTextWidth(r,"bold 12px arial")+2,u=15*l.length,m=15*d.length,g=(h+u+m)/2,f=h+u+m+10,p=new Konva.Text({x:-g+u+1,y:-5,text:r,fontSize:12,fontFamily:"Arial",fill:"#FFFFFF",fontStyle:"bold"}),v=new Konva.Rect({x:-g-5,y:-12,width:f,height:25,fill:n.GetColor(),cornerRadius:15});o.add(v);for(var y=0;y<l.length;y++)o.add(new Konva.Image({x:-g+12*y+2,y:-5,image:l[y],width:10,height:10,strokeWidth:0}));for(var y=0;y<d.length;y++)o.add(new Konva.Image({x:-g+2+u+h+12*y,y:-5,image:d[y],width:10,height:10,strokeWidth:0}));o.add(p),o.transition=i;var w=function(e,t){var i=n.graph.CorrectPossition(o.getAbsolutePosition(),n.manager.Layer);n.middle=i,n.DrawTransition(),n.graph.Settings.readonly||n.DrawTouchPoints(),e&&(n.DrawActivePoint(),n.Sync()),n.manager.batchDraw()},S=function(e){if(!n.graph.Settings.disableobjectmovements){var t=n.selected;e.evt.ctrlKey||n.graph.DeselectAll(),t?n.Deselect():n.Select(),void 0!=n.activePoint.ToolTip&&n.activePoint.ToolTip.hide(),n.graph.onSelectionChanged(),n.manager.batchDraw()}};if(o.on("click",S),o.on("touchend",S),o.on("dblclick",function(){n.graph.DeselectAll(),n.Select(),n.manager.batchDraw(),n.graph.Settings.notshowwindows||n.ShowProperties()}),o.on("dragstart",function(){n.graph.Settings.disableobjectmovements||void 0!=n.activePoint.ToolTip&&n.activePoint.ToolTip.hide()}),o.on("dragmove",function(){n.graph.Settings.disableobjectmovements||w(!1)}),o.on("dragend",function(){n.graph.Settings.disableobjectmovements||w(!0)}),1==n.graph.getParam("exinfo"))n.createExInfo(o);else{var b=this.item.Trigger.Type;void 0!=n.item.Trigger&&void 0!=n.item.Trigger.Command&&"Command"===n.item.Trigger.Type&&(b+=" "+n.item.Trigger.Command.Name),void 0!=n.item.Trigger&&void 0!=n.item.Trigger.Timer&&"Timer"===n.item.Trigger.Type&&(b+=" "+n.item.Trigger.Timer.Name),b+="\r\n"+this.item.Conditions[0].Type,void 0!=n.item.Conditions[0]&&"Action"===n.item.Conditions[0].Type&&(b+=" "+n.item.Conditions[0].Action.ActionName),WorkflowDesignerTooltip(n.manager.APLayer,o,b,17)}return o},this._createActivePointOld=function(e,t,i){var n=this,a=!n.graph.Settings.disableobjectmovements,o=new Konva.Group({x:e,y:t,draggable:a}),r="",s=this.item.Trigger.Type.toLowerCase();"auto"===s?r+="A":"command"===s?r+="C":"timer"===s&&(r+="T");var l=this.item.Conditions[0].Type.toLowerCase();"always"===l?r+="A":"action"===l?r+="C":"otherwise"===l&&(r+="O"),Array.isArray(this.item.Restrictions)&&this.item.Restrictions.length>0&&(r+="R");var d=new Konva.Rect({x:3==r.length?-22:-16,y:-15,width:3==r.length?47:34,height:30,fill:n.GetColor(),cornerRadius:15});o.add(d);var c=new Konva.Text({x:3==r.length?-16:-10,y:-7,text:r,fontSize:16,fontFamily:"Arial",fill:"#FFFFFF",fontStyle:"bold"});o.add(c),o.transition=i;var h=function(e,t){var i=n.graph.CorrectPossition(o.getAbsolutePosition(),n.manager.Layer);n.middle=i,n.DrawTransition(),n.graph.Settings.readonly||n.DrawTouchPoints(),e&&(n.DrawActivePoint(),n.Sync()),n.manager.batchDraw()},u=function(e){if(!n.graph.Settings.disableobjectmovements){var t=n.selected;e.evt.ctrlKey||n.graph.DeselectAll(),t?n.Deselect():n.Select(),void 0!=n.activePoint.ToolTip&&n.activePoint.ToolTip.hide(),n.graph.onSelectionChanged(),n.manager.batchDraw()}};if(o.on("click",u),o.on("touchend",u),o.on("dblclick",function(){n.graph.DeselectAll(),n.Select(),n.manager.batchDraw(),n.graph.Settings.notshowwindows||n.ShowProperties()}),o.on("dragstart",function(){n.graph.Settings.disableobjectmovements||void 0!=n.activePoint.ToolTip&&n.activePoint.ToolTip.hide()}),o.on("dragmove",function(){n.graph.Settings.disableobjectmovements||h(!1)}),o.on("dragend",function(){n.graph.Settings.disableobjectmovements||h(!0)}),1==n.graph.getParam("exinfo"))n.createExInfo(o);else{var m=this.item.Trigger.Type;void 0!=n.item.Trigger&&void 0!=n.item.Trigger.Command&&"Command"===n.item.Trigger.Type&&(m+=" "+n.item.Trigger.Command.Name),void 0!=n.item.Trigger&&void 0!=n.item.Trigger.Timer&&"Timer"===n.item.Trigger.Type&&(m+=" "+n.item.Trigger.Timer.Name),m+="\r\n"+this.item.Conditions[0].Type,void 0!=n.item.Conditions[0]&&"Action"===n.item.Conditions[0].Type&&(m+=" "+n.item.Conditions[0].Action.ActionName),WorkflowDesignerTooltip(n.manager.APLayer,o,m,17)}return o},this.createExInfo=function(e){var i="";if(void 0!=t.item.Trigger&&void 0!=t.item.Trigger.Command&&"Command"===t.item.Trigger.Type&&(Array.isArray(t.item.Restrictions)&&t.item.Restrictions.length>0&&t.item.Restrictions.forEach(function(e){if(void 0!=e.Actor){var t=e.Actor.Name;"Restrict"==e.Type&&(t="("+t+")"),i.length>0&&(i+=", "),i+=t}}),i.length>0&&(i+=" -> "),i+=t.item.Trigger.Command.Name),void 0!=t.item.Trigger&&void 0!=t.item.Trigger.Timer&&"Timer"===t.item.Trigger.Type){var n=t.item.Trigger.Timer.Value;void 0!=n&&""!=n&&(i+=" "+n)}if(i.length>0){var a=new Konva.Text({x:0,y:-30,text:i,fontFamily:"Arial",fontSize:12,fill:"#4A4A4A",fontStyle:"bold"});a.setX(-Number(a.getWidth()/2)),e.add(a)}var o="";if(Array.isArray(t.item.Conditions)&&t.item.Conditions.length>0&&t.item.Conditions.forEach(function(e){if(void 0!=e.Action){var t=e.Action.ActionName;1==e.ConditionInversion&&(t="("+t+")"),o.length>0&&(o+=", "),o+=t}}),o.length>0){var a=new Konva.Text({x:0,y:20,text:o,fontFamily:"Arial",fontSize:12,fill:"#4A4A4A",fontStyle:"bold"});a.setX(-Number(a.getWidth()/2)),e.add(a)}},this._getLineLength=function(e,t,i,n){return Math.sqrt(Math.pow(i-e,2)+Math.pow(n-t,2))},this._getBendingKoeff=function(e,t,i,n,a,o){var r=t-n,s=i-e,l=e*n-i*t;s<=0&&(r=-r,s=-s,l=-l);var d=-(l+r*a)/s,c=d<o?-1:1,h=this._getLineLength(e,t,i,n),u=(e+i)/2,m=(t+n)/2,g=this._getLineLength(u,m,a,o),f=g/h*c;return 0==s&&(f=-f),f},this.getIntersectingRect=function(e){var t=this.activePoint.getAbsolutePosition();return t.x>=e.xl&&t.x<e.xr&&t.y>=e.yl&&t.y<e.yr},this.ShowProperties=function(){var e=WorkflowDesignerConstants.TransitionFormLabel,i={name:e.From,field:"From.Name",type:"select",displayfield:"Name",datasource:t.graph.data.Activities,width:"100%"};void 0!=this.item.From&&"Inline"===this.item.From.ActivityType&&(i={type:"group",width:"100%",elements:[i,{name:e.InlinedFinalActivityName,field:"InlinedFinalActivityName",type:"input",width:"100%"}]});var n={type:"form",title:e.Title,data:this.item,readonly:this.graph.Settings.readonly,elements:[{type:"group",elements:[{name:e.Name,field:"Name",type:"input",width:"100%"},{name:e.Classifier,field:"Classifier",type:"select",width:"100%",datasource:["Direct","Reverse","NotSpecified"]}]},{type:"group",elements:[i,{name:e.To,field:"To.Name",type:"select",displayfield:"Name",datasource:t.graph.data.Activities,width:"100%"}]},{field:"Trigger",code:"trigger",type:"form",datadefault:{Type:"Command"},elements:[{type:"group",elements:[{name:e.Trigger,code:"triggertype",field:"Type",type:"select",datasource:["Auto","Command","Timer"]},{name:e.TriggerCommand,code:"triggercommand",field:"Command.Name",type:"select",displayfield:"Name",datasource:t.graph.data.Commands},{name:e.TriggerTimer,code:"triggertimer",field:"Timer.Name",type:"select",displayfield:"Name",datasource:t.graph.data.Timers}]}]},{type:"group",elements:[{name:e.IsFork,field:"IsFork",code:"isfork",type:"checkbox"},{name:e.MergeViaSetState,field:"MergeViaSetState",code:"mergeviasetstate",type:"checkbox"},{name:e.DisableParentStateControl,field:"DisableParentStateControl",code:"disableparentstatecontrol",type:"checkbox"}]},{name:e.Restrictions,field:"Restrictions",code:"restrictions",type:"table",datadefault:{Type:"Allow"},elements:[{name:e.RestrictionsType,code:"resttype",field:"Type",type:"select",datasource:["Allow","Restrict"]},{name:e.RestrictionsActor,code:"restactor",field:"Actor.Name",type:"select",displayfield:"Name",datasource:t.graph.data.Actors}]},{type:"group",elements:[{name:e.AllowConcatenationType,field:"AllowConcatenationType",type:"select",datasource:["And","Or"]},{name:e.RestrictConcatenationType,field:"RestrictConcatenationType",type:"select",datasource:["And","Or"]}]},{name:e.Condition,field:"Conditions",code:"condition",type:"table",datadefault:{Type:"Always",ResultOnPreExecution:"Null"},elements:[{name:e.ConditionType,code:"conditiontype",field:"Type",type:"select",datasource:["Always","Action","Otherwise"]},{name:e.ConditionAction,code:"conditionaction",field:"Action.ActionName",type:"select",datasource:t.graph.getConditionNames(),onchange:function(e){var t=$(e),i=t.closest("tr").find("[name=conditionactionparameter]").closest("td"),n=i.children(),a=n[0].rebuild($(e).val(),n.find("input").val());n.remove(),i.append(a)}},{name:e.ConditionActionParameter,code:"conditionactionparameter",field:"Action.ActionParameter",type:"jsonparameter",graph:t.graph,parametertype:"Condition",openautocompleteonclick:!0,datasource:function(e,i){var n=$(this).closest("tr"),a=n.find("[name=conditionaction]")[0].value;i(t.graph.getAutoCompleteSuggestions("conditionparameter",a,e))}},{name:e.ConditionInversion,code:"conditioninversion",field:"ConditionInversion",type:"checkbox"},{name:e.ResultOnPreExecution,code:"conditionresult",field:"ResultOnPreExecution",type:"select",datasource:["True","False"]}],onrowadded:function(e){var t=e.find("[name=conditiontype]"),i=e.find("[name=conditionaction]"),n=e.find("[name=conditionresult]"),a=e.find("[name=conditionactionparameter]").parent().parent(),o=e.find("[name=conditioninversion]").parent(),r=function(){"Action"===t[0].value?(i.show(),n.show(),a.show(),o.show()):(i.hide(),n.hide(),a.hide(),o.hide())};t.on("change",r),r()}},{type:"group",elements:[{name:e.ConditionsConcatenationType,field:"ConditionsConcatenationType",type:"select",datasource:["And","Or"]}]},{name:e.Annotations,type:"table",field:"Annotations",keyproperty:"Name",elements:[{name:e.AnnotationName,field:"Name",type:"input"},{name:e.AnnotationValue,field:"JsonValue",type:"json"}]}],renderFinalFunc:function(e,t){var i=e.find("[name=restrictions]").parent(),n=e.find("[name=triggertype]"),a=e.find("[name=isfork]"),o=e.find("[name=triggercommand]"),r=e.find("[name=triggertimer]"),s=e.find("[name=AllowConcatenationType]").parent().parent(),l=e.find("[name=ConditionsConcatenationType]").parent().parent(),d=e.find("[name=mergeviasetstate]").parent().parent(),c=e.find("[name=disableparentstatecontrol]").parent().parent(),h=function(){var e=function(e){return e.prev()},a=n[0].value;"Command"==a?(o.show(),e(o).show(),r.hide(),e(r).hide(),i.show()):"Timer"==a?(o.hide(),e(o).hide(),r.show(),e(r).show(),i.hide(),s.hide()):(o.hide(),e(o).hide(),r.hide(),e(r).hide(),i.hide(),s.hide()),WorkflowDesignerCommon.modal(t.window,"refresh")};n.on("change",h),h();var u=function(){a[0].checked?(d.show(),c.show()):(d.hide(),c.hide())};a.on("change",u),u();var m=s.find("[name=AllowConcatenationType]")[0].value.toLowerCase(),g=s.find("[name=RestrictConcatenationType]")[0].value.toLowerCase(),f=l.find("[name=ConditionsConcatenationType]")[0].value.toLowerCase();"and"===m&&"and"===g&&s.hide();var p=e.find("[name=restrictions]").parent(),v=$('<a class="btnConcatParameters"></a>');v[0].innerText=WorkflowDesignerConstants.TransitionFormLabel.ShowConcatParameters,v.on("click",function(){s.is(":visible")?(s.hide(),v[0].innerText=WorkflowDesignerConstants.TransitionFormLabel.ShowConcatParameters):(s.show(),v[0].innerText=WorkflowDesignerConstants.TransitionFormLabel.HideConcatParameters),WorkflowDesignerCommon.modal(t.window,"refresh")}),p.append("&nbsp;"),p.append(v),"and"===f&&l.hide();var y=e.find("[name=condition]").parent(),w=$('<a class="btnConcatParameters"></a>');w[0].innerText=WorkflowDesignerConstants.TransitionFormLabel.ShowConcatParameters,w.on("click",function(){l.is(":visible")?(l.hide(),w[0].innerText=WorkflowDesignerConstants.TransitionFormLabel.ShowConcatParameters):(l.show(),w[0].innerText=WorkflowDesignerConstants.TransitionFormLabel.HideConcatParameters),WorkflowDesignerCommon.modal(t.window,"refresh")}),y.append("&nbsp;"),y.append(w),WorkflowDesignerCommon.modal(t.window,"refresh")},graph:t.graph,saveFunc:function(e){t.item.Name=e.Name,t.item.From={Name:e.From.Name},t.item.InlinedFinalActivityName=e.InlinedFinalActivityName,t.item.To={Name:e.To.Name},t.item.Classifier=e.Classifier,t.item.Restrictions=e.Restrictions,t.item.Trigger=e.Trigger,t.item.Conditions=e.Conditions,t.item.IsFork=e.IsFork,t.item.MergeViaSetState=e.MergeViaSetState,t.item.DisableParentStateControl=e.DisableParentStateControl,t.item.ConditionsConcatenationType=e.ConditionsConcatenationType,t.item.AllowConcatenationType=e.AllowConcatenationType,t.item.RestrictConcatenationType=e.RestrictConcatenationType,t.item.Annotations=e.Annotations,WorkflowDesignerCommon.DataCorrection(t.graph.data),t.graph.Draw(t.graph.data),t.graph.StoreGraphData()}};if(void 0!=this.graph.Settings.forms&&void 0!=this.graph.Settings.forms.transition)this.graph.Settings.forms.transition(n);else{var a=new WorkflowDesignerForm(n),o=function(e,i){var n=!0;n&=e.CheckRequired([i],["Name"],WorkflowDesignerConstants.FieldIsRequired),n&=e.CheckRequired([i],["Classifier"],WorkflowDesignerConstants.FieldIsRequired);var a=["Type"];"Command"==i.Trigger.Type?a.push("Command.Name"):"Timer"==i.Trigger.Type&&a.push("Timer.Name"),n&=e.CheckRequired([i.Trigger],a,WorkflowDesignerConstants.FieldIsRequired),i.Conditions.forEach(function(t){a=["Type"],"Action"==t.Type&&a.push("Action.ActionName"),n&=e.CheckRequired([t],a,WorkflowDesignerConstants.FieldIsRequired),"Always"==t.Type&&i.Conditions.length>1?(n=!1,e.ControlAddError(t.control_Type,WorkflowDesignerConstants.AlwaysConditionShouldBeSingle)):"Otherwise"==t.Type&&i.Conditions.length>1&&(n=!1,e.ControlAddError(t.control_Type,WorkflowDesignerConstants.OtherwiseConditionShouldBeSingle))});var o=i.control_Conditions.parent().children("h4");return!i.Conditions.length>0?(o.attr("title",WorkflowDesignerConstants.TransitionFormLabel.ConditionsListShouldNotBeEmpty),o.css("cssText","color: red !important;"),n=!1):(o.attr("title",void 0),o.css("color","")),t.graph.data.Transitions.forEach(function(a){a!=t.item&&a.Name==i.Name&&(n=!1,e.ControlAddError(i.control_Name,WorkflowDesignerConstants.FieldMustBeUnique))}),e.CheckRequired(i.Restrictions,["Type","Actor.Name"],WorkflowDesignerConstants.FieldIsRequired)||(n=!1),e.CheckRequired(i.Annotations,["Name"],WorkflowDesignerConstants.FieldIsRequired)||(n=!1),e.CheckUnique(i.Annotations,["Name"],WorkflowDesignerConstants.FieldMustBeUnique)||(n=!1),n},r=function(e){return!!o(a,e)&&(a.ClearTempField(e),a.parameters.saveFunc(e),!0)};a.showModal(r)}},this.Sync=function(){this.group||(t.item.DesignerSettings.Bending=t.bending,void 0!=t.middle&&(t.item.DesignerSettings.X=t.middle.x,t.item.DesignerSettings.Y=t.middle.y))},this.destroy=function(){this.control.destroy(),this.activePoint.destroy(),this.touchpoints.forEach(function(e){e.destroy()}),void 0!=this.bar&&this.bar.destroy()}}function WorkflowDesignerTransitionManagerTempControl(e){this.x=e.x,this.y=e.y,this.manager=e.manager,this.control=void 0,this.Draw=function(e,t){this.control=new Konva.Group({x:0,y:0,rotation:0}),this.line=new Konva.Line({points:[this.x,this.y,e,t],stroke:"#FFCC99",strrokeWidth:1});var i=Math.atan2(t-this.y,e-this.x);this.arrow=WorkflowDesignerCommon.createArrowByAngle(e,t,i,20,"#FFCC99"),this.control.add(this.line),this.control.add(this.arrow),this.manager.Layer.add(this.control)},this.Redraw=function(e){this.line.setPoints([this.x,this.y,e.x,e.y]);var t=Math.atan2(e.y-this.y,e.x-this.x);WorkflowDesignerCommon.updateArrowByAngle(this.arrow,e.x,e.y,t,20,"#FFCC99")},this.Delete=function(){this.control.destroy()}}function WorkflowDesignerActivityManager(){this.type="WorkflowDesignerActivityManager",this.init=function(e){this.graph=e,this.Layer=new Konva.Layer,this.graph.Stage.add(this.Layer),this.Layer.setZIndex(1)},this.ItemControls=new Array,this.draw=function(){null!=this.ItemControls&&this.ItemControls.forEach(function(e){e.destroy()}),this.ItemControls=new Array;var e=this;void 0!=this.graph.data.Activities&&this.graph.data.Activities.forEach(function(t){var i,n,a=void 0;if(e.graph.Settings.group!=t.DesignerSettings.Group){if(void 0!=t.DesignerSettings.InlineElementSettings&&t.DesignerSettings.InlineElementSettings.Group==e.graph.Settings.group){if(""!=t.DesignerSettings.InlineElementSettings.X&&""!=t.DesignerSettings.InlineElementSettings.Y)i=Number(t.DesignerSettings.InlineElementSettings.X),n=Number(t.DesignerSettings.InlineElementSettings.Y);else{var o=e.GetDefaultPosition();i=o.x,n=o.y}a=new WorkflowDesignerActivityControl({x:i,y:n,item:t,graph:e.graph,manager:e,group:!0})}}else{if(""!=t.DesignerSettings.X&&""!=t.DesignerSettings.Y)i=Number(t.DesignerSettings.X),n=Number(t.DesignerSettings.Y);else{var o=e.GetDefaultPosition();i=o.x,n=o.y}var a=new WorkflowDesignerActivityControl({x:i,y:n,item:t,graph:e.graph,manager:e})}void 0!=a&&(e.ItemControls.push(a),a.Draw(),a.Sync())}),this.Layer.batchDraw()},this.CreateNewActivity=function(e,t){void 0==e&&(e=this.GetDefaultPosition()),void 0==t&&(t={IsAutoSchemeUpdate:!0,IsForSetState:!0}),void 0==t.Name&&(t.Name=this.GetDefaultName()),0==this.graph.data.Activities.length&&(t.IsInitial=!0),t.DesignerSettings&&(t.DesignerSettings=new{X:e.x,Y:e.y});var i=new WorkflowDesignerActivityControl({x:e.x,y:e.y,item:t,graph:this.graph,manager:this});return this.graph.data.Activities.push(t),this.ItemControls.push(i),i.Draw(),i.Sync(),i},this.CreateNewInline=function(e,t){void 0==e&&(e=this.GetDefaultPosition()),void 0==t&&(t={IsAutoSchemeUpdate:!1,IsForSetState:!1,ActivityType:"Inline"}),void 0==t.Name&&(t.Name=this.GetDefaultName()),0==this.graph.data.Activities.length&&(t.IsInitial=!0),t.DesignerSettings&&(t.DesignerSettings=new{X:e.x,Y:e.y});var i=new WorkflowDesignerActivityControl({x:e.x,y:e.y,item:t,graph:this.graph,manager:this});return this.graph.data.Activities.push(t),this.ItemControls.push(i),i.Draw(),i.Sync(),i},this.GetDefaultName=function(){for(var e=WorkflowDesignerConstants.ActivityNamePrefix,t=1,i=0;i<this.graph.data.Activities.length;i++){this.graph.data.Activities[i].Name==e+t&&(t++,i=-1)}return e+t},this.GetDefaultPosition=function(){for(var e=this.graph.CorrectPossition({x:60,y:100},this.Layer),t=2*this.graph.Settings.DefaultMoveStep/this.Layer.getScaleX(),i=0;i<this.ItemControls.length;i++){var n=this.ItemControls[i].control.getPosition();n.x==e.x&&n.y==e.y&&(e.x+=t,e.y+=t,i=-1)}return e},this.find=function(e){if("object"==typeof e&&void 0!=e.Name)return this.find(e.Name);for(var t=0;t<this.ItemControls.length;t++)if(this.ItemControls[t].item.Name===e)return this.ItemControls[t]},this.findGroup=function(e,t){for(var i=0;i<this.graph.data.Activities.length;i++){var n=this.graph.data.Activities[i];if(n.DesignerSettings.Group==e&&void 0!=n.DesignerSettings.InlineElementSettings&&n.DesignerSettings.InlineElementSettings.Group==t)return this.find(n.Name)}},this.getIntersectingActivity=function(e){for(var t=0;t<this.ItemControls.length;t++){var i=this.ItemControls[t];if(i.getIntersectingActivity(e))return i}},this.LayerSetOffset=function(e){this.Layer.setOffset(e)},this.LayerScale=function(e){var t=(e.scale,e.delta);this.Layer.setScale({x:this.Layer.getScale().x+t,y:this.Layer.getScale().y+t})},this.LayerScaleNorm=function(e){this.Layer.setScale({x:1,y:1}),this.Layer.setOffset({x:0,y:0})},this.redrawTransitions=function(){return void 0==this.cTransition&&(this.cTransition=this.graph.GetComponentByType("WorkflowDesignerTransitionManager")),this.cTransition.batchDraw()},this.batchDraw=function(){this.Layer.batchDraw()},this.SelectAll=function(){this.ItemControls.forEach(function(e){e.Select()})},this.DeselectAll=function(){this.ItemControls.forEach(function(e){e.Deselect()})},this.GetSizeForSaveAsImage=function(e){for(var t=0;t<this.ItemControls.length;t++){var i=this.ItemControls[t],n=i.rectangle.getAbsolutePosition(),a=n.x,o=n.y,r=a+i.rectangle.getWidth()*this.Layer.getScaleX(),s=o+i.rectangle.getHeight()*this.Layer.getScaleX();a<e.x1&&(e.x1=a),o<e.y1&&(e.y1=o),r>e.x2&&(e.x2=r),s>e.y2&&(e.y2=s)}return e},this.GetSelected=function(){var e=new Array;return this.ItemControls.forEach(function(t){t.selected&&e.push(t)}),e},this.SelectByPosition=function(e){this.ItemControls.forEach(function(t){t.getIntersectingActivityRect(e)&&t.Select()})},this.SelectByItem=function(e){this.ItemControls.forEach(function(t){t.item==e&&t.Select()})},this.ObjectMove=function(e){this.ItemControls.forEach(function(t){t.selected&&e.sender!=t&&t.ObjectMove(e.changepos)}),this.redrawTransitions()},this.createTransitionAndActivity=function(e){var t={x:e.control.getX()+e.rectangle.attrs.width+100,y:e.control.getY()},i=this.CreateNewActivity(t);this.graph.GetComponentByType("WorkflowDesignerTransitionManager").CreateNewTransition(e,i),this.graph.redrawAll()},this.createTransition=function(e){return this.graph.GetComponentByType("WorkflowDesignerTransitionManager").CreateNewTransition(e)},this.Clone=function(e){var t=JSON.parse(JSON.stringify(e.item));t.DesignerSettings.Y+=160,t.Name=this.CopySelectedGenUniqueValue(t.Name,this.graph.data.Activities,"Name"),this.graph.data.Activities.push(t),this.graph.Draw(this.graph.data),this.SelectByItem(t)},this.CopySelectedGenUniqueValue=function(e,t,i){for(var n=e,a=1;!0;a++){for(var o=!1,r=0;r<t.length;r++)if(t[r][i]==n){o=!0;break}if(!o)break;n=e+"_"+a}return n}}function WorkflowDesignerBackground(){this.type="WorkflowDesignerBackground",this.init=function(e){var t=this;this.graph=e,this.BackgroundLayer=new Konva.Layer,this.graph.Stage.add(this.BackgroundLayer),this.BackgroundLayer.setZIndex(0),this.SelectionLayer=new Konva.Layer,this.graph.Stage.add(this.SelectionLayer),this.SelectionLayer.setZIndex(1),WorkflowDesignerCommon.loadImage(this.graph.Settings.imagefolder+"wfe.grid.png",function(e){t.RectBG.setFillPatternImage(e),t.BackgroundLayer.batchDraw()}),this.RectBG=new Konva.Rect({x:0,y:0,width:5e3,height:5e3,draggable:!1,dragBoundFunc:function(e){var i=t.graph.Settings.DefaultMoveStep*t.BackgroundLayer.getScaleX(),n=t.graph.Settings.DefaultMoveStep*t.BackgroundLayer.getScaleY(),a={x:Math.round(e.x/i)*i,y:Math.round(e.y/n)*n},o=t.BackgroundLayer.getScaleX(),r=t.BackgroundLayer.getScaleY(),s=t.graph.Stage.width()/o,l=t.graph.Stage.height()/r;return t.RectBG.width()+e.x/o-s<0&&t.RectBG.width(t.RectBG.width()+s),t.RectBG.height()+e.y/r-l<0&&t.RectBG.height(t.RectBG.height()+l),t.graph.GraphLayerSetOffset(-a.x/o,-a.y/r),a},designerparam:"background"}),this.BackgroundLayer.add(this.RectBG),this.BackgroundLayer.batchDraw(),this.graph.Stage.on("mousedown.background",function(e){"background"===e.target.attrs.designerparam&&(1!=t._movemodeenabled?t._mousedownpos=t.graph.CorrectPossition({x:e.evt.offsetX,y:e.evt.offsetY},t.SelectionLayer):t.graph.DeselectAll())}),this.graph.Stage.on("mousemove.background",function(e){if(1!=t._movemodeenabled&&void 0!=t._mousedownpos){var i=t.graph.CorrectPossition({x:e.evt.offsetX,y:e.evt.offsetY},t.SelectionLayer);t.DrawSelectionRect(i)}}),this.graph.Stage.on("mouseup.background",function(e){if(!t._movemodeenabled&&void 0!=t._mousedownpos){var i=t.getSelectionRectPos()
;void 0==i?e.evt.ctrlKey||t.graph.DeselectAll():(Math.abs(i.xl-i.xr)>10||Math.abs(i.yl-i.yr)>10)&&(t.graph.DeselectAll(),t.graph.ComponentsExecute("SelectByPosition",i),t.graph.onSelectionChanged())}t._mousedownpos=void 0,t.DeleteSelectionRect()})},this.setMoveModeEnabled=function(e){this._movemodeenabled=Boolean(e),this.RectBG.setDraggable(this._movemodeenabled),this.graph.setParam("movemodeenabled",this._movemodeenabled)},this.updatePosition=function(e){var t=this.RectBG.getPosition(),i={x:-t.x-e.x,y:-t.y-e.y};this.RectBG.setPosition({x:-i.x,y:-i.y}),this.graph.ComponentsExecute("LayerSetOffset",{x:i.x,y:i.y})},this.setPosition=function(e){this.RectBG.setPosition({x:-e.x,y:-e.y}),this.graph.ComponentsExecute("LayerSetOffset",{x:e.x,y:e.y})},this.LayerScale=function(e){var t=(e.scale,e.delta);this.BackgroundLayer.setScale({x:this.BackgroundLayer.getScale().x+t,y:this.BackgroundLayer.getScale().y+t})},this.LayerScaleNorm=function(){this.BackgroundLayer.setScale({x:1,y:1}),this.SelectionLayer.setScale({x:1,y:1}),this.RectBG.setPosition({x:0,y:0})},this.DrawSelectionRect=function(e){void 0==this.RectSelection?(this.RectSelection=new Konva.Rect({x:this._mousedownpos.x,y:this._mousedownpos.y,width:e.x-this._mousedownpos.x,height:e.y-this._mousedownpos.y,draggable:!1,fill:"#66CCFF",opacity:.2}),this.SelectionLayer.add(this.RectSelection)):(this.RectSelection.setWidth(e.x-this._mousedownpos.x),this.RectSelection.setHeight(e.y-this._mousedownpos.y)),this.SelectionLayer.batchDraw()},this.DeleteSelectionRect=function(e){this.RectSelection&&(this.RectSelection.destroy(),this.RectSelection=void 0,this.SelectionLayer.batchDraw())},this.getSelectionRectPos=function(){if(void 0!=this.RectSelection){var e=this.RectSelection.getAbsolutePosition(),t=e.x,i=e.y,n=t+this.RectSelection.getWidth()*this.SelectionLayer.getScaleX(),a=i+this.RectSelection.getHeight()*this.SelectionLayer.getScaleX();return{xl:Math.min(t,n),yl:Math.min(i,a),xr:Math.max(t,n),yr:Math.max(i,a)}}}}function WorkflowDesignerTooltip(e,t,i,n,a,o){var r=function(e,t){if(0==t.getScaleX()||0==t.getScaleY())return{x:t.getOffsetX(),y:0};var i=void 0==a?0:a;return{x:e.x/t.getScaleX()+t.getOffsetX()+i,y:e.y/t.getScaleY()+t.getOffsetY()}};t.on("mouseover",function(){if(void 0!=t.ToolTip){var a=r(t.getAbsolutePosition(),e);t.ToolTip.position({x:a.x+t.getWidth()/2,y:a.y+n,opacity:1}),t.ToolTip.show()}else{var a=r(t.getAbsolutePosition(),e),s=new Konva.Label({x:a.x+t.getWidth()/2,y:a.y+n,opacity:1});s.add(new Konva.Tag({fill:"#3D4D59",pointerDirection:void 0==o?"up":o,pointerWidth:13,pointerHeight:7,lineJoin:"round",shadowColor:"#3D4D59",shadowBlur:10,shadowOffset:10,shadowOpacity:0,cornerRadius:5})),s.add(new Konva.Text({text:i,fontFamily:"Arial",fontSize:12,padding:5,fill:"white"})),e.add(s),t.ToolTip=s}e.batchDraw()}),t.on("mouseleave",function(){void 0!=t.ToolTip&&(t.ToolTip.hide(),e.batchDraw())})}function WorkflowDesignerBar(e,t,i,n){var a="v"===n,o=new Konva.Group({x:i.x,y:i.y}),r=new Konva.Rect({x:0,y:0,width:a?30:30*t.length,height:a?30*t.length:30,fill:WorkflowDesignerConstants.BarColor,cornerRadius:5});o.add(r);var s=0;return t.forEach(function(t){if(t.offset=s,t.separator){s+=10;var i=a?[5,t.offset+5,25,t.offset+5]:[t.offset+5,5,t.offset+5,25];t.cObject=new Konva.Line({points:i,stroke:WorkflowDesignerConstants.BarSeparatorColor,strokeWidth:2}),o.add(t.cObject)}else s+=30,WorkflowDesignerCommon.loadImage(t.img,function(i){if(!e.destroyed){var n=a?{x:5,y:t.offset+5}:{x:5+t.offset,y:5};t.offset,t.offset,t.group=new Konva.Group({x:n.x-5,y:n.y-5,width:30,height:30}),t.bg=new Konva.Rect({x:0,y:0,width:30,height:30,cornerRadius:5}),1==t.active&&t.bg.setFill(WorkflowDesignerConstants.ButtonActive),t.group.add(t.bg),t.cImageToolbar=new Konva.Image({x:5,y:5,image:i,width:20,height:20,strokeWidth:0}),t.group.add(t.cImageToolbar);var r=function(){void 0!=t.cImageToolbar.ToolTip&&t.cImageToolbar.ToolTip.hide(),void 0!=t.click&&t.click()};t.group.on("click",r),t.group.on("touchend",r),t.group.on("mouseover",function(){t.bg.setFill(WorkflowDesignerConstants.ButtonActive),e.batchDraw()}),t.group.on("mouseleave",function(){void 0!=t.active&&0!=t.active||(t.bg.setFill(""),e.batchDraw())}),t.group.add(t.cImageToolbar),o.add(t.group),void 0!=t.title&&""!=t.title&&WorkflowDesignerTooltip(e,t.cImageToolbar,t.title,30),e.batchDraw()}})}),1==a?r.setHeight(s):r.setWidth(s),o}function WorkflowDesignerToolbar(){this.type="WorkflowDesignerToolbar",this.graph=void 0;var e=this;this.init=function(t){this.graph=t,this.Layer=new Konva.Layer,this.graph.Stage.add(this.Layer),this.Layer.setZIndex(10),this.InitItems(),this.MainToolbarDraw(20,20),this.SideToolbarDraw(e.graph.Settings.graphwidth-70,90),this.graph.Settings.hideInfoBlock||this.CreateInfoBlock();var i=this.GetWorkflowDesignerBackground();void 0!=i&&i.RectBG.setDraggable(!1),this.graph.getParam("movemodeenabled")&&e.ToolbarMovePress(),this.graph.getParam("exinfo")&&e.ToolbarExInfoPress()},this.MainToolbarDraw=function(e,t){var i=0;for(var n in this.Items)Array.isArray(this.Items[n])&&this.Items[n].length>0&&(i=this.ToolbarDraw(this.Items[n],e+i,t),i+=10)},this.SideToolbarDraw=function(t,i){var n=this.SideItems,a=new Konva.Group({x:t,y:i}),o=new Konva.Rect({x:0,y:0,width:50,fill:"#FFFFFF",shadowEnabled:!0,shadowBlur:10,shadowOpacity:.3,cornerRadius:4});a.add(o);var r=0;n.forEach(function(t){t.offset=r,1==t.separator?(r+=1,t.cObject=new Konva.Line({points:[10,t.offset+3,40,t.offset+3],stroke:WorkflowDesignerConstants.BarSeparatorColor,strokeWidth:2}),a.add(t.cObject)):(r+=45,e.loadImageHandler(void 0,{item:t,x:0,y:t.offset,container:a,tooltipX:25,tooltipY:-25,direction:"right"}),WorkflowDesignerCommon.loadImage(t.img,function(e,t){t.container.image(e),this.Layer.destroyed||this.Layer.batchDraw()}.bind(e),{container:t.cImageToolbar}))}),a.add(new Konva.Line({points:[10,r+3,40,r+3],stroke:WorkflowDesignerConstants.BarSeparatorColor,strokeWidth:2})),this.scaleText=new Konva.Text({text:"100%",fontFamily:"Arial",fontStyle:"Bold",fontSize:12,padding:5,fill:"black",x:4,y:r+16,align:"center",width:41}),a.add(this.scaleText),r+=40,o.height(r+5),this.Layer.add(a),this.SideToolbar=a},this.ToolbarDraw=function(t,i,n){var a=new Konva.Group({x:i,y:n}),o=new Konva.Rect({x:0,y:0,height:50,fill:"#FFFFFF",shadowEnabled:!0,shadowBlur:10,shadowOpacity:.3,cornerRadius:4});a.add(o);var r=0;return t.forEach(function(t){t.offset=r,1==t.separator?(r+=1,t.cObject=new Konva.Line({points:[t.offset+3,10,t.offset+3,40],stroke:WorkflowDesignerConstants.BarSeparatorColor,strokeWidth:2}),a.add(t.cObject)):(r+=45,e.loadImageHandler(void 0,{item:t,x:t.offset,y:0,container:a}),WorkflowDesignerCommon.loadImage(t.img,function(e,t){t.container.image(e),this.Layer.destroyed||this.Layer.batchDraw()}.bind(e),{container:t.cImageToolbar}))}),o.width(r+5),this.Layer.add(a),i+r},this.loadImageHandler=function(t,i){var n=i.item;n.group=new Konva.Group({x:i.x,y:i.y,width:40,height:40}),n.bg=new Konva.Rect({x:5,y:5,width:40,height:40,cornerRadius:4}),n.group.add(n.bg),1==n.active&&n.bg.setFill(WorkflowDesignerConstants.ButtonActive),n.cImageToolbar=new Konva.Image({x:15,y:15,image:t,width:20,height:20,strokeWidth:0}),1==n.disabled&&n.cImageToolbar.opacity(.3),n.group.add(n.cImageToolbar),n.group.on("click",function(){n.disabled!==!0&&void 0!=n.click&&n.click(n)}),n.group.on("touchend",function(){n.disabled!==!0&&void 0!=n.click&&n.click(n)}),n.group.on("mouseover",function(){1!=n.disabled&&(n.bg.setFill(WorkflowDesignerConstants.ButtonActive),e.Layer.batchDraw())}),n.group.on("mouseleave",function(){void 0!=n.active&&0!=n.active||(n.bg.setFill(""),e.Layer.batchDraw())}),i.container.add(n.group),WorkflowDesignerTooltip(this.Layer,n.group,n.title,void 0==i.tooltipX?55:i.tooltipX,void 0==i.tooltipY?5:i.tooltipY,i.direction),this.Layer.batchDraw()},this.draw=function(){this.GraphRedrawAll()},this.GraphRedrawAll=function(){this.UpdateInfoBlock(),this.Layer.batchDraw()},this.changeSize=function(e,t){void 0!=this.info&&this.info.position({x:e-320,y:t-70}),void 0!=this.SideToolbar&&this.SideToolbar.position({x:e-70,y:90})},this.CreateInfoBlock=function(){var e=this.graph.Settings.imagefolder,t=e+"wfe.add.png",i=e+"wfe.transitons2.png",n=e+"wfe.commands.png",a={x:0,y:0};this.info=new Konva.Group(a);var o=new Konva.Rect({x:0,y:0,height:50,width:300,fill:"#FFFFFF",shadowEnabled:!0,shadowBlur:10,shadowOpacity:.3,cornerRadius:4});this.info.add(o);var r=5;this.infoText1=new Konva.Text({fontFamily:"Arial",fontStyle:"Bold",fontSize:12,padding:5,fill:"black",x:r,y:16,align:"center",width:60}),this.info.add(this.infoText1),r+=this.infoText1.width()+5,WorkflowDesignerCommon.loadImage(t,function(e,t){t.container.add(new Konva.Image({x:t.x,y:t.y,image:e,width:20,height:20,strokeWidth:0}))},{container:this.info,x:r,y:15}),r+=30,this.info.add(new Konva.Line({points:[r,10,r,40],stroke:WorkflowDesignerConstants.BarSeparatorColor,strokeWidth:2})),r+=5,this.infoText2=new Konva.Text({fontFamily:"Arial",fontStyle:"Bold",fontSize:12,padding:5,fill:"black",x:r,y:16,align:"center",width:60}),this.info.add(this.infoText2),r+=this.infoText2.width()+5,WorkflowDesignerCommon.loadImage(i,function(e,t){t.container.add(new Konva.Image({x:t.x,y:t.y,image:e,width:20,height:20,strokeWidth:0}))},{container:this.info,x:r,y:15}),r+=30,this.info.add(new Konva.Line({points:[r,10,r,40],stroke:WorkflowDesignerConstants.BarSeparatorColor,strokeWidth:2})),r+=5,this.infoText3=new Konva.Text({fontFamily:"Arial",fontStyle:"Bold",fontSize:12,padding:5,fill:"black",x:r,y:16,align:"center",width:60}),this.info.add(this.infoText3),r+=this.infoText3.width()+5,WorkflowDesignerCommon.loadImage(n,function(e,t){t.container.add(new Konva.Image({x:t.x,y:t.y,image:e,width:20,height:20,strokeWidth:0}))},{container:this.info,x:r,y:15}),r+=30,o.width(r),this.UpdateInfoBlock(),a={x:this.graph.Settings.graphwidth-320,y:this.graph.Settings.graphheight-70},this.info.position(a),this.Layer.add(this.info)},this.UpdateInfoBlock=function(){var e=this.GetInfoBlockTextValue();if(void 0!=this.infoText1){var t=String(e.activity),i="black";void 0!=e.activityLimit&&(t+="/"+e.activityLimit,e.activityLimit<e.activity&&(i="#C0392B")),this.infoText1.setText(t),this.infoText1.setFill(i)}if(void 0!=this.infoText2){var n=String(e.transition),i="black";void 0!=e.transitionLimit&&(n+="/"+e.transitionLimit,e.transitionLimit<e.transition&&(i="#C0392B")),this.infoText2.setText(n),this.infoText2.setFill(i)}if(void 0!=this.infoText3){var a=String(e.command),i="black";void 0!=e.commandLimit&&(a+="/"+e.commandLimit,e.commandLimit<e.command&&(i="#C0392B")),this.infoText3.setText(a),this.infoText3.setFill(i)}},this.GetInfoBlockTextValue=function(){var e={activity:0,transition:0,command:0,activityLimit:void 0,transitionLimit:void 0,commandLimit:void 0};if(void 0!=this.graph.data&&(e.activity=this.graph.data.Activities.length,e.transition=this.graph.data.Transitions.length,e.command=this.graph.data.Commands.length,void 0!=this.graph.data.AdditionalParams)){var t=this.graph.data.AdditionalParams;void 0!=t.MaxNumberOfActivities&&t.MaxNumberOfActivities!=-1&&(e.activityLimit=t.MaxNumberOfActivities),void 0!=t.MaxNumberOfTransitions&&t.MaxNumberOfTransitions!=-1&&(e.transitionLimit=t.MaxNumberOfTransitions),void 0!=t.MaxNumberOfCommands&&t.MaxNumberOfCommands!=-1&&(e.commandLimit=t.MaxNumberOfCommands)}return e},this.ToolbarMovePress=function(){var e=this.GetWorkflowDesignerBackground();e.setMoveModeEnabled(!e._movemodeenabled);var t=this.GetItemByCode("move");e._movemodeenabled?(t.active=!0,void 0!=t.bg&&t.bg.setFill(WorkflowDesignerConstants.ButtonActive)):(t.active=void 0,void 0!=t.bg&&t.bg.setFill("")),this.Layer.batchDraw()},this.ToolbarExInfoPress=function(){var e=this.GetItemByCode("exinfo");this.exinfo?(e.active=void 0,void 0!=e.bg&&e.bg.setFill(""),this.exinfo=!1,this.graph.setParam("exinfo",!1)):(e.active=!0,void 0!=e.bg&&e.bg.setFill(WorkflowDesignerConstants.ButtonActive),this.exinfo=!0,this.graph.setParam("exinfo",!0)),void 0!=this.graph.Draw&&this.graph.Draw(this.graph.data)},this.ToolbarInlinePress=function(){this.graph.data.CanBeInlined?this.graph.setInlinedFlag(!1):this.graph.setInlinedFlag(!0)},this.onChangeScheme=function(){var t=this.GetItemByCode("inline");if(void 0!=t&&void 0!=t.cImageToolbar){var i=this.graph.data.CanBeInlined?t.img2:t.img;WorkflowDesignerCommon.loadImage(i,function(e,t){t.container.image(e),this.Layer.destroyed||this.Layer.batchDraw()}.bind(e),{container:t.cImageToolbar})}},this.GetWorkflowDesignerBackground=function(){return this.graph.GetComponentByType("WorkflowDesignerBackground")},this.CreateActivity=function(){this.graph.GetComponentByType("WorkflowDesignerActivityManager").CreateNewActivity(),this.graph.redrawAll(),this.graph.StoreGraphData()},this.CreateInline=function(){this.graph.GetComponentByType("WorkflowDesignerActivityManager").CreateNewInline(),this.graph.redrawAll(),this.graph.StoreGraphData()},this.AutoArrangement=function(){if(0!=e.graph.data.Activities.length){var t=new Array,i=new Array;if(e.graph.data.Activities.forEach(function(n){(void 0==n.DesignerSettings||n.DesignerSettings.Group==e.graph.Settings.group||void 0!=n.DesignerSettings.InlineElementSettings&&n.DesignerSettings.InlineElementSettings.Group==e.graph.Settings.group)&&(t.push(n),n.IsInitial&&i.push(n))}),0!=t.length){t.forEach(function(t){if(!t.IsInitial){for(var n=!0,a=0;a<e.graph.data.Transitions.length;a++){var o=e.graph.data.Transitions[a];if("Direct"==o.Classifier&&o.To==t){n=!1;break}}n&&i.push(t)}}),0==i.length&&i.push(t[0]);var n={x:80,y:120},a={x:300,y:140},o=Array(),r=function(t,i,n){var s={x:i.x,y:i.y};n||(s.x+=a.x);for(var l=new Array,d=0;d<t.length;d++){var c=t[d];void 0==c.DesignerSettings&&(c.DesignerSettings={}),!n&&$.inArray(c,o)>=0||(c.DesignerSettings.Group==e.graph.Settings.group?c.DesignerSettings.X=s.x:void 0!=c.DesignerSettings.InlineElementSettings&&c.DesignerSettings.InlineElementSettings.Group==e.graph.Settings.group&&(c.DesignerSettings.InlineElementSettings.X=s.x),o.push(c),l.push(c))}for(var d=0;d<l.length;d++){var c=l[d];d>0&&(s.y+=a.y);var h=new Array;e.graph.data.Transitions.forEach(function(e){"Direct"==e.Classifier&&e.From==c&&h.push(e.To)}),c.DesignerSettings.Group==e.graph.Settings.group?c.DesignerSettings.Y=s.y:void 0!=c.DesignerSettings.InlineElementSettings&&c.DesignerSettings.InlineElementSettings.Group==e.graph.Settings.group&&(c.DesignerSettings.InlineElementSettings.Y=s.y);var u=r(h,{x:s.x,y:s.y});s.y=u.y}return{x:s.x,y:s.y}};r(i,n,!0),e.graph.data.Transitions.forEach(function(t){void 0==t.DesignerSettings&&(t.DesignerSettings={}),void 0!=t.From.DesignerSettings&&void 0!=t.To.DesignerSettings&&t.From.DesignerSettings.Group!=e.graph.Settings.group&&t.To.DesignerSettings.Group!=e.graph.Settings.group||(t.DesignerSettings.X=void 0,t.DesignerSettings.Y=void 0)}),e.graph.Draw(e.graph.data),this.graph.StoreGraphData()}}},this.CopySelectedGenUniqueValue=function(e,t,i){for(var n=e,a=1;!0;a++){for(var o=!1,r=0;r<t.length;r++)if(t[r][i]==n){o=!0;break}if(!o)break;n=e+"_"+a}return n},this.CopySelected=function(){var t=this.graph.GetComponentByType("WorkflowDesignerActivityManager"),i=this.graph.GetComponentByType("WorkflowDesignerTransitionManager"),n=t.GetSelected(),a=i.GetSelected();if(0!=n.length||0!=a.length){var o=[];n.forEach(function(t){if(!t.group){var i=JSON.parse(JSON.stringify(t.item));i.DesignerSettings.Y+=160,i.Name=e.CopySelectedGenUniqueValue(i.Name,e.graph.data.Activities,"Name"),o.push({oldItem:t.item,newItem:i}),e.graph.data.Activities.push(i)}});var r=[];a.forEach(function(t){for(var i=t.item.From,n=t.item.To,a=0;a<o.length;a++)i==o[a].oldItem&&(i=o[a].newItem),n==o[a].oldItem&&(n=o[a].newItem);var s=JSON.parse(JSON.stringify(t.item));s.Name=e.CopySelectedGenUniqueValue(s.Name,e.graph.data.Transitions,"Name"),s.From=i,s.To=n,r.push({oldItem:t.item,newItem:s}),e.graph.data.Transitions.push(s)}),WorkflowDesignerCommon.DataCorrection(e.graph.data),e.graph.Draw(e.graph.data),o.forEach(function(e){t.SelectByItem(e.newItem)}),r.forEach(function(e){i.SelectByItem(e.newItem)}),this.graph.StoreGraphData(),this.graph.onSelectionChanged(!0)}},this.EditLocalization=function(){var e=this,t=WorkflowDesignerConstants.LocalizationFormLabel,i={type:"table",title:t.Title,width:"800px",data:this.graph.data.Localization,datadefault:{Culture:WorkflowDesignerConstants.DefaultCulture,Type:"State"},elements:[{name:t.ObjectName,field:"ObjectName",type:"input"},{name:t.Type,field:"Type",type:"select",displayfield:"Name",valuefield:"Value",datasource:[{Name:t.Types[0],Value:"Command"},{Name:t.Types[1],Value:"State"},{Name:t.Types[2],Value:"Parameter"}]},{name:t.IsDefault,field:"IsDefault",type:"checkbox"},{name:t.Culture,field:"Culture",type:"input"},{name:t.Value,field:"Value",type:"input"}],readonly:this.graph.Settings.readonly,saveFunc:function(t){e.SyncTable(e.graph.data.Localization,t,i),e.graph.StoreGraphData()}};if(void 0!=this.graph.Settings.forms&&void 0!=this.graph.Settings.forms.localization)return void this.graph.Settings.forms.localization(i);var n=new WorkflowDesignerForm(i),a=function(e,t){return!(!n.CheckRequired(e,["ObjectName","Type","Culture","Value"],WorkflowDesignerConstants.FieldIsRequired)||!n.CheckUnique(e,["ObjectName","Type","Culture"],WorkflowDesignerConstants.FieldMustBeUnique))&&(n.ClearTempField(e),n.parameters.saveFunc(e),!0)};n.showModal(a)},this.EditParameters=function(){var e=WorkflowDesignerConstants.ParameterFormLabel,t=this,i=function(e,i,n){for(var a=void 0,o=e.getEditData(e.parameters),r=0;r<o.length;r++){var s=o[r];if(s.control_InitialValue.id===i.id){a=s.Type;break}}void 0!=a&&t.graph.designer.getemptytype(encodeURIComponent(a),n)},n={type:"table",title:e.Title,data:this.graph.data.Parameters,datadefault:{Purpose:"Persistence"},keyproperty:"Name",elements:[{name:e.Name,field:"Name",type:"input"},{name:e.Type,field:"Type",type:"input",datasource:this.graph.getTypeNames(),width:"35%"},{name:e.Purpose,field:"Purpose",type:"select",displayfield:"Name",datasource:[{Name:"Temporary"},{Name:"Persistence"},{Name:"System"}]},{name:e.InitialValue,field:"InitialValue",type:"json",width:"25%",getemptytype:i}],top:$('<div style="float: right; margin-bottom: 15px;"></div>'),beforerowadded:function(e){void 0!=e.Type&&(e.Type=decodeURIComponent(e.Type))},onrowadded:function(e){var t=e.find("[name=Purpose]"),i=t[0];t.change(function(){r(e)}),void 0!=i&&"System"!==i.value&&e.find('[name=Purpose] option[value="System"]').remove(),r(e)},graph:t.graph,readonly:this.graph.Settings.readonly,saveFunc:function(e){t.SyncTable(t.graph.data.Parameters,e,n);for(var i=0;i<t.graph.data.Parameters.length;i++){var a=t.graph.data.Parameters[i].Type;t.graph.data.Parameters[i].Type=encodeURIComponent(a)}t.graph.Draw(t.graph.data),t.graph.StoreGraphData()},cancelFunc:function(e){for(var i=0;i<t.graph.data.Parameters.length;i++){var n=t.graph.data.Parameters[i].Type;t.graph.data.Parameters[i].Type=encodeURIComponent(n)}}};if(void 0!=this.graph.Settings.forms&&void 0!=this.graph.Settings.forms.parameters)return void this.graph.Settings.forms.parameters(n);var a=function(){for(var e=$(c.window.find(".WorkflowDesignerTable"))[0],t=0;t<e.rows.length;t++){var i=$(e.rows[t]),n=i.find("[name=Purpose]")[0];void 0!=n&&"System"===n.value&&i.hide()}},o=function(){for(var e=$(c.window.find(".WorkflowDesignerTable"))[0],t=0;t<e.rows.length;t++){var i=$(e.rows[t]),n=i.find("[name=Purpose]")[0];void 0!=n&&"System"===n.value&&i.show()}},r=function(e){var t=e.find("[name=Purpose]")[0];void 0!=t&&"System"===t.value?(e.find(":input").attr("readonly",!0),e.find("[name=Purpose]").attr("disabled",!0),e.find("[name=InitialValue]").val(""),e.find(".btnDelete").remove()):void 0!=t&&"Temporary"===t.value?(e.find("[name=InitialValue]").attr("readonly",!0),e.find("[name=InitialValue]").val("")):void 0!=t&&"Persistence"===t.value&&e.find("[name=InitialValue]").attr("readonly",!1)},s=function(){for(var e=$(c.window.find(".WorkflowDesignerTable"))[0],t=0;t<e.rows.length;t++){r($(e.rows[t]))}},l=function(e,t){return!(!c.CheckRequired(e,["Name","Type","Purpose","Parameter"],WorkflowDesignerConstants.FieldIsRequired)||!c.CheckUnique(e,["Name"],WorkflowDesignerConstants.FieldMustBeUnique))&&(c.ClearTempField(e),c.parameters.saveFunc(e),!0)},d=function(e,t){c.parameters.cancelFunc(e)},c=new WorkflowDesignerForm(n),h=$('<div class="ui slider checkbox"></div>'),u=$('<input type="checkbox" />');u.click(function(e,t){u[0].checked?o():a(),WorkflowDesignerCommon.modal(c.window,"refresh")}),h.append(u),h.append("<label>"+WorkflowDesignerConstants.ParameterFormLabel.ShowSystemParameters+"</label>"),n.top.append(h),c.showModal(l,!1,d),a(),s(),WorkflowDesignerCommon.modal(c.window,"refresh")},this.getGlobalCodeActionsForDelete=function(e,t){var i=[];return e.forEach(function(n){if(n.IsGlobal){for(var a=!1,o=0;o<e.length;o++)if(n.Name==e[o].Name&&n.IsGlobal!=e[o].IsGlobal){a=!0;break}for(var r=!1,o=0;o<t.length;o++)if(1==a){if(n.Name==t[o].Name&&t[o].IsGlobal){r=!0;break}}else if(n.Name==t[o].Name){r=!0;break}0==r&&i.push(n.Name)}}),i},this.EditProcessInfo=function(){function e(e){return $.extend({type:"table",elements:[{name:o.ParametersNameLabel,field:"Name",type:"input"},{name:o.ParametersValueLabel,field:"Value",type:"json"}]},e)}function t(e,t,i){$.each(i,function(i,n){"System"===n.Purpose?e.push(n):t.push(n)})}function i(){return r?{type:"accordion",data:s.systemParameters,elements:[e({name:o.SystemParametersTabName})]}:e({data:s.systemParameters,name:o.SystemParametersTabName})}function n(){return r?{type:"accordion",name:o.ProcessParametersTabName,data:s.processParameters,tabKey:"ProcessParameters",elements:[e(null)]}:e({data:s.processParameters,name:o.ProcessParametersTabName,tabKey:"ProcessParameters"})}function a(e,t,i,n){function a(e,t){return $.extend({type:"table",elements:e},t)}if(r){var s={};return s[o.RootProcess]=l.graph.data.AdditionalParams[e],$.each(l.graph.data.AdditionalParams.SubprocessInfo,function(t,i){s[t]=i[e]}),{type:"accordion",name:t,data:s,tabKey:i,elements:[a(n,null)]}}return a(n,{data:l.graph.data.AdditionalParams[e],name:t,tabKey:i})}var o=WorkflowDesignerConstants.ProcessInfoFormLabel,r=this.graph.data.AdditionalParams.SubprocessCurrentActivities.length,s={systemParameters:{},processParameters:{}};r?(s.systemParameters[o.RootProcess]=new Array,s.processParameters[o.RootProcess]=new Array,t(s.systemParameters[o.RootProcess],s.processParameters[o.RootProcess],this.graph.data.AdditionalParams.ProcessParameters),$.each(this.graph.data.AdditionalParams.SubprocessInfo,function(e,i){s.systemParameters[e]=new Array,s.processParameters[e]=new Array,t(s.systemParameters[e],s.processParameters[e],i.ProcessParameters)})):(s.systemParameters=new Array,s.processParameters=new Array,t(s.systemParameters,s.processParameters,this.graph.data.AdditionalParams.ProcessParameters));var l=this,d={type:"tabs",title:o.Title,width:"95%",readonly:!0,graph:l.graph,elements:[{name:o.SystemParametersTabName,type:"form",tabKey:"SystemParameters",data:this.graph.data.AdditionalParams,elements:[{name:o.IsObsolete,field:"IsObsolete",type:"checkbox"},{name:o.DefiningParameters,field:"DefiningParameters",type:"textarea"},i()]},n(),a("ProcessHistory",o.HistoryTabName,"History",[{name:o.HistoryTabFromLabel,field:"FromActivityName",type:"input"},{name:o.HistoryTabFromStateLabel,field:"FromStateName",type:"input"},{name:o.HistoryTabToLabel,field:"ToActivityName",type:"input"},{name:o.HistoryTabToStateLabel,field:"ToStateName",type:"input"},{name:o.HistoryTabExecutorIdLabel,field:"ExecutorIdentityId",type:"input"},{name:o.HistoryTabActorIdLabel,field:"ActorIdentityId",type:"input"},{name:o.HistoryTabTimeLabel,field:"TransitionTime",type:"input"},{name:o.HistoryTabTriggerNameLabel,field:"TriggerName",type:"input"},{name:o.HistoryTabTransitionClassifierNameLabel,field:"TransitionClassifier",type:"transitionclassifier"}]),a("ProcessTimers",o.TimersTabName,"Timers",[{name:o.TimersTabNameLabel,field:"Name",type:"input"},{name:o.TimersTabValueLabel,field:"NextExecutionDateTime",type:"input"}])]};if(void 0!=this.graph.Settings.forms&&void 0!=this.graph.Settings.forms.processinfo)return void this.graph.Settings.forms.processinfo(d);var c=new WorkflowDesignerForm(d),h=function(e,t){return!0};c.showModal(h)},this.Items={First:[],Second:[],Third:[]},this.SideItems=[],this.InitItems=function(){var t=this.graph.Settings.imagefolder;this.graph.Settings.readonly||(this.Items.First.push({code:"undo",title:WorkflowDesignerConstants.ToolbarLabel.Undo,img:t+"wfe.undo.png",click:function(){e.graph.Undo()}}),this.Items.First.push({code:"redo",title:WorkflowDesignerConstants.ToolbarLabel.Redo,img:t+"wfe.redo.png",click:function(){e.graph.Redo()}}),this.Items.First.push({separator:!0}),this.Items.First.push({title:WorkflowDesignerConstants.ToolbarLabel.CreateActivity,img:t+"wfe.add.png",click:function(){e.CreateActivity()}}),this.Items.First.push({title:WorkflowDesignerConstants.ToolbarLabel.CreateInline,img:t+"wfe.inline.png",click:function(){e.CreateInline()}}),this.Items.First.push({code:"copy",disabled:!0,title:WorkflowDesignerConstants.ToolbarLabel.CopySelected,img:t+"wfe.copy.png",click:function(){e.CopySelected()}}),this.Items.First.push({code:"delete",disabled:!0,title:WorkflowDesignerConstants.ToolbarLabel.Delete,img:t+"wfe.remove.png",click:function(){e.graph.DeleteSelected()}})),this.graph.Settings.hideElementsToolbar||this.graph.Settings.notshowwindows||(this.Items.Second.push({title:WorkflowDesignerConstants.ToolbarLabel.Actors,img:t+"wfe.actors.png",click:function(){WorkflowDesignerWindows.EditActors(e)}}),this.Items.Second.push({title:WorkflowDesignerConstants.ToolbarLabel.Commands,img:t+"wfe.commands.png",click:function(){WorkflowDesignerWindows.EditCommands(e)}}),this.Items.Second.push({title:WorkflowDesignerConstants.ToolbarLabel.Timers,img:t+"wfe.timers.png",click:function(){WorkflowDesignerWindows.EditTimer(e)}}),this.graph.Settings.disableCodeActions!==!0&&this.Items.Second.push({title:WorkflowDesignerConstants.ToolbarLabel.CodeActions,img:t+"wfe.codeactions.png",click:function(){WorkflowDesignerWindows.EditCodeActions(e)}}),this.Items.Second.push({title:WorkflowDesignerConstants.ToolbarLabel.Parameters,img:t+"wfe.parameters.png",click:function(){e.EditParameters()}}),this.Items.Second.push({title:WorkflowDesignerConstants.ToolbarLabel.Localization,img:t+"wfe.localization.png",click:function(){e.EditLocalization()}}),this.graph.designer&&this.graph.designer.data&&this.graph.designer.data.AdditionalParams&&this.graph.designer.data.AdditionalParams.ProcessParameters&&this.Items.Second.push({title:WorkflowDesignerConstants.ToolbarLabel.ProcessInfo,img:t+"wfe.context.png",click:function(){e.EditProcessInfo()}})),this.graph.Settings.readonly||this.Items.Second.push({code:"inline",title:WorkflowDesignerConstants.ToolbarLabel.Inline,img:t+"wfe.inline.off.png",img2:t+"wfe.inline.on.png",click:function(){e.ToolbarInlinePress()}}),void 0!=this.graph.Settings.apiurl&&this.Items.Third.push({title:WorkflowDesignerConstants.ToolbarLabel.Refresh,img:t+"wfe.refresh.png",click:function(){e.graph.Refresh()}}),this.graph.Settings.disableobjectmovements||this.Items.Third.push({title:WorkflowDesignerConstants.ToolbarLabel.AutoArrangement,img:t+"wfe.autoarrangment.png",click:function(){e.AutoArrangement()}}),this.Items.Third.length>0&&this.Items.Third.push({separator:!0}),this.Items.Third.push({code:"exinfo",title:WorkflowDesignerConstants.ToolbarLabel.Info,img:t+"wfe.information.png",click:function(){e.ToolbarExInfoPress()}}),this.graph.Settings.hideLegend||this.Items.Third.push({title:WorkflowDesignerConstants.ToolbarLabel.Legend,img:t+"wfe.help.png",click:function(){e.ShowLegend()}}),this.SideItems=[{code:"move",title:WorkflowDesignerConstants.ToolbarLabel.Move,img:t+"wfe.move.png",click:function(){e.ToolbarMovePress()}},{separator:!0}],void 0==this.graph.Settings.group&&this.SideItems.push({code:"fullscreen",title:WorkflowDesignerConstants.ToolbarLabel.FullScreen,img:t+"wfe.fullscreen.png",click:function(){e.graph.onFullScreenClick()}}),this.SideItems.push({title:WorkflowDesignerConstants.ToolbarLabel.ZoomPositionDefault,img:t+"wfe.defaultzoom.png",click:function(){e.graph.GraphLayerScaleNorm()}}),this.SideItems.push({title:WorkflowDesignerConstants.ToolbarLabel.ZoomIn,img:t+"wfe.zoomin.png",click:function(){e.graph.GraphLayerScale(.1)}}),this.SideItems.push({title:WorkflowDesignerConstants.ToolbarLabel.ZoomOut,img:t+"wfe.zoomout.png",click:function(){e.graph.GraphLayerScale(-.1)}}),e.graph.Stage.getContent().addEventListener("wheel",function(t){var i=e.GetWorkflowDesignerBackground(),n=i.BackgroundLayer.scaleX(),a={x:t.offsetX/n-i.RectBG.x(),y:t.offsetY/n-i.RectBG.y()},o=t.deltaY>0?-.1:.1,r=n+o,s={x:a.x-a.x/r,y:a.y-a.y/r},l={x:((1-n)*t.offsetX/n-i.RectBG.x())/r,y:((1-n)*t.offsetY/n-i.RectBG.y())/r};s.x+=l.x,s.y+=l.y,e.graph.GraphLayerScale(o,s)})},this.LayerScaleNorm=function(e){this.updateScaleText(e)},this.LayerScale=function(e){var t=e.scale,i=e.delta;this.updateScaleText(t+i)},this.updateScaleText=function(t){void 0!=e.graph._bg&&this.scaleText.text(Math.floor(100*t)+"%")},this.GetItemByCode=function(e){for(var t in this.Items)for(var i=0;i<this.Items[t].length;i++){var n=this.Items[t][i];if(n.code==e)return n}for(var i=0;i<this.SideItems.length;i++){var n=this.SideItems[i];if(n.code==e)return n}},this.SyncTable=function(e,t,i){if(void 0==i.keyproperty){e.splice(0,e.length);for(var n=0;n<t.length;n++){var a={};i.elements.forEach(function(e){a[e.field]=t[n][e.field]}),e.push(a)}}else{for(var n=e.length-1;n>=0;n--){var o=$.grep(t,function(t){return e[n][i.keyproperty]==t.keyproperty});0==o.length?e.splice(n,1):i.elements.forEach(function(t){e[n][t.field]=o[0][t.field]})}for(var n=0;n<t.length;n++){var o=$.grep(e,function(e){return t[n][i.keyproperty]==e[i.keyproperty]});if(0==o.length){var a={};i.elements.forEach(function(e){a[e.field]=t[n][e.field]}),e.push(a)}}}},this.ShowLegend=function(){if(void 0!=this.graph.Settings.forms&&void 0!=this.graph.Settings.forms.legend)return void this.graph.Settings.forms.legend();var e=this.graph.Settings.imagefolder,t=$('<image src="'+e+'wfe.legend.png" height="'+.7*this.graph.Stage.getHeight()+'"/>'),i=$('<div class="ui modal"></div>').append($('<div class="content" style="text-align: center;"></div>').append(t));WorkflowDesignerCommon.modal(i,"show")},this.setItemDisabled=function(e,t){for(var i in this.Items)for(var n=0;n<this.Items[i].length;n++){var a=this.Items[i][n];if(a.code==e){a.disabled=t,void 0!=a.cImageToolbar&&a.cImageToolbar.opacity(t?.3:1);break}}for(var n=0;n<this.SideItems.length;n++)if(this.SideItems[n].code==e){this.SideItems[n].disabled=t,void 0!=this.Items[n].cImageToolbar&&this.Items[n].cImageToolbar.opacity(t?.3:1);break}},this.setItemActive=function(e,t){for(var i in this.Items)for(var n=0;n<this.Items[i].length;n++){var a=this.Items[i][n];if(a.code==e){a.active=t,void 0!=a.bg&&a.bg.setFill(t?WorkflowDesignerConstants.ButtonActive:"");break}}for(var n=0;n<this.SideItems.length;n++)if(this.SideItems[n].code==e){this.SideItems[n].active=t,void 0!=this.SideItems[n].bg&&this.SideItems[n].bg.setFill(t?WorkflowDesignerConstants.ButtonActive:"");break}},this.destroy=function(){this.Layer.destroyed=!0,void 0!==e&&(void 0!==e.Layer&&null!==e.Layer&&e.Layer.destroy(),e=void 0)}}function WorkflowDesignerKeyboard(){this.type="WorkflowDesignerKeyboard",this.init=function(e){this.graph=e,this.subscribe()},this.destroy=function(){this.unsubscribe()},this.subscribe=function(){var e=this.graph.container,t=document.getElementById(e);this.ev=!1;var i=this;t.onmouseover=function(){i.ev=!0},t.onmouseout=function(){i.ev=!1},this._keyProcessing=function(e){i.keyProcessing(e)},document.addEventListener("keydown",this._keyProcessing,!1)},this.unsubscribe=function(){var e=this.graph.container,t=document.getElementById(e);void 0!=t&&(t.onmouseover=void 0,t.onmouseout=void 0),document.removeEventListener("keydown",this._keyProcessing)},
this.keyProcessing=function(e){if(this.ev!==!1){const t=e.key;if("Control"!==t){var i=!1;return e.ctrlKey?"a"==t?this.graph.SelectAll():"c"==t?this.toolbarExec("CopySelected"):"e"!=t||this.graph.Settings.readonly?"i"==t?this.toolbarExec("ToolbarExInfoPress"):"m"==t?this.toolbarExec("ToolbarMovePress"):"y"!=t||this.graph.Settings.readonly?"z"!=t||this.graph.Settings.readonly?i=!0:this.graph.Undo():this.graph.Redo():this.toolbarExec("CreateActivity"):e.altKey&&"Enter"==t?this.graph.onFullScreenClick():"Delete"!=t||this.graph.Settings.readonly?"ArrowUp"==t?this.objectsMove(0,-1):"ArrowDown"==t?this.objectsMove(0,1):"ArrowLeft"==t?this.objectsMove(-1,0):"ArrowRight"==t?this.objectsMove(1,0):i=!0:this.graph.DeleteSelected(),0==i?void e.preventDefault():void 0}}},this.objectsMove=function(e,t){var i=this.graph.GetComponentByType("WorkflowDesignerActivityManager");if(void 0!=i){var n=this.graph.Settings.DefaultMoveStep;0==i.GetSelected().length?this.graph.GraphUpdatePosition({x:e*n,y:t*n}):(i.ObjectMove({changepos:{x:e*n,y:t*n}}),i.batchDraw())}},this.toolbarExec=function(e){var t=this.graph.GetComponentByType("WorkflowDesignerToolbar");void 0!=t&&void 0!=t[e]&&t[e]()}}function ParametersControl(e){this.parentForm=e}function DefaultValueControl(e,t,i){this.parentForm=e,this.prefix=i,this.parameter=t}function JsonControl(e,t,i){this.parentForm=e,this.prefix=i,this.parameter=t}function InputControl(e){this.parentForm=e}function CheckboxControl(e){this.parentForm=e}function SelectControl(e){this.parentForm=e}var WorkflowDesignerConstants={ActivityColor:"#ECF0F1",ActivityTextColor:"#2D3436",ActivityInitialColor:"#27AE60",ActivityInitialTextColor:"#FFFFFF",ActivityFinalColor:"#2980B9",ActivityFinalTextColor:"#FFFFFF",ActivityShape:"#CECECE",SelectColor:"#F39C12",SelectTextColor:"#FFFFFF",SelectSubProcessColor:"#e3b015",SelectSubProcessTextColor:"#FFFFFF",ButtonActive:"#D4D8D9",BarColor:"#EDF1F2",BarSeparatorColor:"#D9DEE0",DeleteConfirm:"Are you sure you want to delete selected item(s)?",DeleteConfirmCurrent:"Are you sure you want to delete this item?",FieldIsRequired:"Field is required!",FieldMustBeUnique:"Field must be unique!",ButtonTextDelete:"Delete",ButtonTextCreate:"Create",ButtonTextSave:"Save",ButtonTextYes:"Yes",ButtonTextNo:"No",ButtonTextCancel:"Cancel",ButtonTextClose:"Close",ButtonTextUndo:"Undo",ButtonTextRedo:"Redo",SaveConfirm:"Save changes?",CloseWithoutSaving:"Close without saving?",TransitionAuto:"Auto",DialogConfirmText:"Question",None:"None",Warning:"Warning",InfoBlockLabel:{Activity:"Activities: ",Transition:"Transitions: ",Command:"Commands: "},ActivityNamePrefix:"Activity_",ActivityFormLabel:{Title:"Activity",TitleForInline:"Activity Inline",Name:"Name",State:"State",IsInitial:"Initial",IsFinal:"Final",IsForSetState:"For set state",IsAutoSchemeUpdate:"Auto scheme update",Implementation:"Implementation",PreExecutionImplementation:"PreExecution Implementation",ImpOrder:"Order",ImpAction:"Action",ImpActionParameter:"Action parameter",AlwaysConditionShouldBeSingle:"Always condition should be single",OtherwiseConditionShouldBeSingle:"Otherwise condition should be single",Annotations:"Annotations",AnnotationName:"Name",AnnotationValue:"Value",Scheme:"Inline scheme"},TransitionFormLabel:{Title:"Transition",Name:"Name",From:"From activity",To:"To activity",Classifier:"Classifier",Restrictions:"Restrictions",RestrictionsType:"Type",RestrictionsActor:"Actor",Condition:"Condition",ConditionType:"Type",ConditionAction:"Action",ResultOnPreExecution:"Result on PreExecution",Trigger:"Trigger",TriggerType:"Type",TriggerCommand:"Command",TriggerTimer:"Timer",ConditionActionParameter:"Action parameter",ConditionInversion:"Invert action result",ConditionsConcatenationType:"Conditions concatenation type",AllowConcatenationType:"Concat allow as",RestrictConcatenationType:"Concat restrict as",ConditionsListShouldNotBeEmpty:"Conditions list should not be empty",IsFork:"Is fork",MergeViaSetState:"Merge subprocess via set state",DisableParentStateControl:"Disable parent process control",ShowConcatParameters:"Show concatenation",HideConcatParameters:"Hide concatenation",Annotations:"Annotations",AnnotationName:"Name",AnnotationValue:"Value",InlinedFinalActivityName:"Inlined Final Activity Name"},LocalizationFormLabel:{Title:"Localization",ObjectName:"ObjectName",Type:"Type",IsDefault:"IsDefault",Culture:"Culture",Value:"Value",Types:["Command","State","Parameter"]},TimerFormLabel:{Title:"Timers",Name:"Name",Type:"Type",Value:"Value",Types:["Command","State","Parameter"],NotOverrideIfExists:"Do not override timer if exists"},ParameterFormLabel:{Title:"Parameters",Name:"Name",Type:"Type",Purpose:"Purpose",Value:"Value",InitialValue:"InitialValue",ShowSystemParameters:"Show system parameters"},ActorFormLabel:{Title:"Actors",Name:"Name",Rule:"Rule",Value:"Value"},CommandFormLabel:{Title:"Command",Name:"Name",InputParameters:"Input Parameters",InputParametersName:"Name",InputParametersIsRequired:"Required",InputParametersParameter:"Parameter",InputParametersDefaultValue:"Default"},ProcessInfoFormLabel:{Title:"Additional Parameters",IsObsolete:"IsObsolete",DefiningParameters:"Defining parameters",ProcessParameters:"Process parameters",SystemParametersTabName:"System Parameters",ProcessParametersTabName:"Process Parameters",HistoryTabName:"History",TimersTabName:"Timers",HistoryTabFromLabel:"From",HistoryTabFromStateLabel:"From State",HistoryTabToLabel:"To",HistoryTabToStateLabel:"To State",HistoryTabExecutorIdLabel:"Executor Id",HistoryTabActorIdLabel:"Actor Id",HistoryTabTimeLabel:"Time",HistoryTabTriggerNameLabel:"Trigger Name",HistoryTabTransitionClassifierNameLabel:"",ParametersNameLabel:"Name",ParametersValueLabel:"Value",TimersTabNameLabel:"Name",TimersTabValueLabel:"Value",RootProcess:"Root Process"},CodeActionsFormLabel:{Title:"Code actions",Name:"Name",ActionCode:"Action code",IsGlobal:"Is global",IsAsync:"Async",Type:"Type",GlobalDeleteMessage:"You've deleted the Global CodeAction.<br/><b>Other schemes won't be able to call this CodeAction!</b>",UnGlobalMessage:"You've changed the state of the global flag.<br/>There will be created a Local CodeAction based on this Global CodeAction after saving this scheme.",EditParameters:"Edit parameters",Parameters:"Parameters",Text:"Text",Number:"Number",Checkbox:"Checkbox",Dropdown:"Dropdown",DateTime:"Date/Time",Values:"Values",DropdownName:"Name",DropdownValue:"Value",DropdownShouldContainValues:"Dropdown should contain values",IsRequired:"Required",DefaultValue:"Default value",Json:"Json"},EditParametersFormlabel:{Title:"Edit parameter values",NumberRequired:"Should be a numeric value",DateShouldBeInISOFormat:"Date/Time parameter should be in ISO8601 format",SwitchToJson:"Switch to JSON editor",SwitchToConstructor:"Switch to parameter values editor",InvalidJson:"JSON object is invalid or does not match the model"},ToolbarLabel:{CreateActivity:"Create activity",CreateInline:"Create inline (template)",CopySelected:"Copy selected",Undo:"Undo",Redo:"Redo",Move:"Move",ZoomIn:"Zoom In",ZoomOut:"Zoom Out",ZoomPositionDefault:"Zoom default",FullScreen:"Full Screen",Refresh:"Refresh",AutoArrangement:"Auto arrangement",Actors:"Actors",Commands:"Commands",Parameters:"Parameters",Localization:"Localization",Timers:"Timers",AdditionalParameters:"Additional Parameters",CodeActions:"Code actions",Info:"Extended info",Delete:"Delete",Clone:"Clone",Settings:"Settings",CreateTransition:"Create a transition",CreateActivityTransition:"Create an activity and a transition",Legend:"Legend",ProcessInfo:"Process Info",Inline:"The scheme can be inlined"},ErrorActivityIsInitialCountText:"One element must be marked flag Initial",ErrorActivityIsFinalCountText:"This scheme is Inlined. One or more elements must be marked flag Final",ErrorReadOnlySaveText:"The Designer in ReadOnly mode, you can't save it.",ErrorInvalidObjectsSaveText:function(e){return"Can't save the schema. Those objects are in invalid state: "+e},BrokenReferencesDialogText:"This schema contains references to Actions, Conditions or Rules that aren't defined by this schema or current action providers. Do you want to keep them?",FormMaxHeight:700,EditCodeSettings:{Height:600,Width:1e3,CodeHeight:390,MessageBoxHeight:400,MessageBoxWidth:600,SuccessBoxHeight:150,SuccessBoxWidth:300},EditCodeLabel:{Title:"Edit code",EditCodeButton:"Edit code",Usings:"Usings",Compile:"Compile",CompileSucceeded:"Compilation succeeded.",Success:"Success",Error:"Error",OK:"OK",ShowUsings:"Show usings",HideUsings:"Hide usings"},EditJSONSettings:{Height:600,Width:1e3,CodeHeight:480},EditJSONLabel:{Title:"Edit value in JSON",CreateEmptyType:"Create",Format:"Format"},OverviewMap:{show:!0,width:300,height:150},UndoDepth:200,DefaultCulture:"en-US"},WorkflowDesignerCommon={modal:function(e,t){var i=void 0;void 0!=e.semanticmodal?i="semanticmodal":void 0!=e.modal?i="modal":console.error("SemanticUI is not defined!"),void 0!=i&&(e[i](t),void 0==t||void 0==t.onApprove&&void 0==t.onDeny||void 0!=e.keyup&&e.keyup(function(n){if(13===n.keyCode){if(null!==n.originalEvent&&void 0!==n.originalEvent&&n.currentTarget!==n.originalEvent.target)return;void 0!=t.onApprove&&0!=t.onApprove()&&e[i]("hide")}else 27===n.keyCode&&(void 0!=t.onDeny?0!=t.onDeny()&&e[i]("hide"):e[i]("hide"))}))},createArrowByAngle:function(e,t,i,n,a){return void 0==a&&(a="red"),new Konva.Wedge({x:e,y:t,radius:n,angle:40,fill:a,rotation:180*i/Math.PI-200})},updateArrowByAngle:function(e,t,i,n,a,o){void 0==o&&(o="red"),e.setPosition({x:t,y:i}),e.setRadius(a),e.setFill(o),e.setRotation(180*n/Math.PI-200)},createUUID:function(){for(var e=[],t="0123456789abcdef",i=0;i<36;i++)e[i]=t.substr(Math.floor(16*Math.random()),1);return e[14]="4",e[19]=t.substr(3&e[19]|8,1),e[8]=e[13]=e[18]=e[23]="-",e.join("")},DataCorrection:function(e){void 0==e.AdditionalParams&&(e.AdditionalParams={}),void 0==e.AdditionalParams.Actions&&(e.AdditionalParams.Actions=[]),void 0==e.AdditionalParams.Conditions&&(e.AdditionalParams.Conditions=[]),void 0==e.AdditionalParams.Rules&&(e.AdditionalParams.Rules=[]);var t=function(e,t,i){if(void 0!=e&&void 0!=t){var n=$.grep(t,function(t){return e==t[i]});return n.length>0?n[0]:void 0}};e.Transitions.forEach(function(i){void 0!=i.From&&(i.From=t(i.From.Name,e.Activities,"Name")),void 0!=i.To&&(i.To=t(i.To.Name,e.Activities,"Name")),void 0!=i.Restrictions&&i.Restrictions.forEach(function(i){i.Actor&&(i.Actor=t(i.Actor.Name,e.Actors,"Name"))}),void 0!=i.Trigger&&void 0!=i.Trigger.Command&&(i.Trigger.Command=t(i.Trigger.Command.Name,e.Commands,"Name"),i.Trigger.Command||(i.Trigger.NameRef=null)),void 0!=i.Trigger&&void 0!=i.Trigger.Timer&&(i.Trigger.Timer=t(i.Trigger.Timer.Name,e.Timers,"Name"),i.Trigger.Timer||(i.Trigger.NameRef=null))}),e.Commands.forEach(function(i){void 0!=i.InputParameters&&i.InputParameters.forEach(function(i){i.Parameter=t(i.Parameter.Name,e.Parameters,"Name")})})},download:function(e,t,i){if(e&&t){var n=new Array;t.forEach(function(e){var t=$('<input type="hidden"/>');t.attr("name",e.name),t.attr("value",e.value),n.push(t)});var a=$('<form action="'+e+'" method="'+(i||"post")+'"></form>');a.append(n),a.appendTo("body").submit().remove()}},defineLocalStorage:function(){Object.defineProperty(window,"localStorage",new function(){var e=[],t={};Object.defineProperty(t,"getItem",{value:function(e){return e?this[e]:null},writable:!1,configurable:!1,enumerable:!1}),Object.defineProperty(t,"key",{value:function(t){return e[t]},writable:!1,configurable:!1,enumerable:!1}),Object.defineProperty(t,"setItem",{value:function(e,t){e&&(document.cookie=escape(e)+"="+escape(t)+"; expires=Tue, 19 Jan 2038 03:14:07 GMT; path=/")},writable:!1,configurable:!1,enumerable:!1}),Object.defineProperty(t,"length",{get:function(){return e.length},configurable:!1,enumerable:!1}),Object.defineProperty(t,"removeItem",{value:function(e){e&&(document.cookie=escape(e)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/")},writable:!1,configurable:!1,enumerable:!1}),Object.defineProperty(t,"clear",{value:function(){if(e.length)for(var t in e)document.cookie=escape(t)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/"},writable:!1,configurable:!1,enumerable:!1}),this.get=function(){var i;for(var n in t)i=e.indexOf(n),i===-1?t.setItem(n,t[n]):e.splice(i,1),delete t[n];for(e;e.length>0;e.splice(0,1))t.removeItem(e[0]);for(var a,o,r=0,s=document.cookie.split(/\s*;\s*/);r<s.length;r++)a=s[r].split(/\s*=\s*/),a.length>1&&(t[o=unescape(a[0])]=unescape(a[1]),e.push(o));return t},this.configurable=!1,this.enumerable=!0})},imageCache:[],loadImage:function(e,t,i){for(var n,a=0;a<WorkflowDesignerCommon.imageCache.length;a++){var o=WorkflowDesignerCommon.imageCache[a];if(o.src==e){n=o;break}}return void 0!=n?(void 0!=t&&t(n,i),n):(n=new Image,void 0!=t&&(n.onload=function(){t(n,i)}),n.src=e,n)},getTextWidth:function(e,t){var i=WorkflowDesignerCommon.TmpCanvas||(WorkflowDesignerCommon.TmpCanvas=document.createElement("canvas")),n=i.getContext("2d");return n.font=t,n.measureText(e).width},defineArrayIncludes:function(){Array.prototype.includes||Object.defineProperty(Array.prototype,"includes",{value:function(e,t){function i(e,t){return e===t||"number"==typeof e&&"number"==typeof t&&isNaN(e)&&isNaN(t)}if(null==this)throw new TypeError('"this" is null or not defined');var n=Object(this),a=n.length>>>0;if(0===a)return!1;for(var o=0|t,r=Math.max(o>=0?o:a-Math.abs(o),0);r<a;){if(i(n[r],e))return!0;r++}return!1}})}};!function(e,t,i,n){"use strict";t=void 0!==t&&t.Math==Math?t:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")(),e.fn.modal=function(n){var a,o=e(this),r=e(t),s=e(i),l=e("body"),d=o.selector||"",c=(new Date).getTime(),h=[],u=arguments[0],m="string"==typeof u,g=[].slice.call(arguments,1),f=t.requestAnimationFrame||t.mozRequestAnimationFrame||t.webkitRequestAnimationFrame||t.msRequestAnimationFrame||function(e){setTimeout(e,0)};return o.each(function(){var o,p,v,y,w,S,b,C,D,T=e.isPlainObject(n)?e.extend(!0,{},e.fn.modal.settings,n):e.extend({},e.fn.modal.settings),k=T.selector,x=T.className,A=T.namespace,_=T.error,I="."+A,P="module-"+A,N=e(this),W=e(T.context),F=N.find(k.close),M=this,L=N.data(P),O=!1;D={initialize:function(){D.verbose("Initializing dimmer",W),D.create.id(),D.create.dimmer(),D.refreshModals(),D.bind.events(),T.observeChanges&&D.observeChanges(),D.instantiate()},instantiate:function(){D.verbose("Storing instance of modal"),L=D,N.data(P,L)},create:{dimmer:function(){var t={debug:T.debug,variation:!T.centered&&"top aligned",dimmerName:"modals"},i=e.extend(!0,t,T.dimmerSettings);if(void 0===e.fn.dimmer)return void D.error(_.dimmer);D.debug("Creating dimmer"),y=W.dimmer(i),T.detachable?(D.verbose("Modal is detachable, moving content into dimmer"),y.dimmer("add content",N)):D.set.undetached(),w=y.dimmer("get dimmer")},id:function(){b=(Math.random().toString(16)+"000000000").substr(2,8),S="."+b,D.verbose("Creating unique id for element",b)}},destroy:function(){D.verbose("Destroying previous modal"),N.removeData(P).off(I),r.off(S),w.off(S),F.off(I),W.dimmer("destroy")},observeChanges:function(){"MutationObserver"in t&&(C=new MutationObserver(function(e){D.debug("DOM tree modified, refreshing"),D.refresh()}),C.observe(M,{childList:!0,subtree:!0}),D.debug("Setting up mutation observer",C))},refresh:function(){D.remove.scrolling(),D.cacheSizes(),D.can.useFlex()||D.set.modalOffset(),D.set.screenHeight(),D.set.type()},refreshModals:function(){p=N.siblings(k.modal),o=p.add(N)},attachEvents:function(t,i){var n=e(t);i=e.isFunction(D[i])?D[i]:D.toggle,n.length>0?(D.debug("Attaching modal events to element",t,i),n.off(I).on("click"+I,i)):D.error(_.notFound,t)},bind:{events:function(){D.verbose("Attaching events"),N.on("click"+I,k.close,D.event.close).on("click"+I,k.approve,D.event.approve).on("click"+I,k.deny,D.event.deny),r.on("resize"+S,D.event.resize)},scrollLock:function(){y.get(0).addEventListener("touchmove",D.event.preventScroll,{passive:!1})}},unbind:{scrollLock:function(){y.get(0).removeEventListener("touchmove",D.event.preventScroll,{passive:!1})}},get:{id:function(){return(Math.random().toString(16)+"000000000").substr(2,8)}},event:{approve:function(){if(O||T.onApprove.call(M,e(this))===!1)return void D.verbose("Approve callback returned false cancelling hide");O=!0,D.hide(function(){O=!1})},preventScroll:function(e){e.preventDefault()},deny:function(){if(O||T.onDeny.call(M,e(this))===!1)return void D.verbose("Deny callback returned false cancelling hide");O=!0,D.hide(function(){O=!1})},close:function(){D.hide()},click:function(t){if(!T.closable)return void D.verbose("Dimmer clicked but closable setting is disabled");var n=e(t.target),a=n.closest(k.modal).length>0,o=e.contains(i.documentElement,t.target);!a&&o&&D.is.active()&&(D.debug("Dimmer clicked, hiding all modals"),D.remove.clickaway(),T.allowMultiple?D.hide():D.hideAll())},debounce:function(e,t){clearTimeout(D.timer),D.timer=setTimeout(e,t)},keyboard:function(e){27==e.which&&(T.closable?(D.debug("Escape key pressed hiding modal"),D.hide()):D.debug("Escape key pressed, but closable is set to false"),e.preventDefault())},resize:function(){y.dimmer("is active")&&(D.is.animating()||D.is.active())&&f(D.refresh)}},toggle:function(){D.is.active()||D.is.animating()?D.hide():D.show()},show:function(t){t=e.isFunction(t)?t:function(){},D.refreshModals(),D.set.dimmerSettings(),D.set.dimmerStyles(),D.showModal(t)},hide:function(t){t=e.isFunction(t)?t:function(){},D.refreshModals(),D.hideModal(t)},showModal:function(t){t=e.isFunction(t)?t:function(){},D.is.animating()||!D.is.active()?(D.showDimmer(),D.cacheSizes(),D.can.useFlex()?D.remove.legacy():(D.set.legacy(),D.set.modalOffset(),D.debug("Using non-flex legacy modal positioning.")),D.set.screenHeight(),D.set.type(),D.set.clickaway(),!T.allowMultiple&&D.others.active()?D.hideOthers(D.showModal):(T.allowMultiple&&T.detachable&&N.detach().appendTo(w),T.onShow.call(M),T.transition&&void 0!==e.fn.transition&&N.transition("is supported")?(D.debug("Showing modal with css animations"),N.transition({debug:T.debug,animation:T.transition+" in",queue:T.queue,duration:T.duration,useFailSafe:!0,onComplete:function(){T.onVisible.apply(M),T.keyboardShortcuts&&D.add.keyboardShortcuts(),D.save.focus(),D.set.active(),T.autofocus&&D.set.autofocus(),t()}})):D.error(_.noTransition))):D.debug("Modal is already visible")},hideModal:function(t,i){if(t=e.isFunction(t)?t:function(){},D.debug("Hiding modal"),T.onHide.call(M,e(this))===!1)return void D.verbose("Hide callback returned false cancelling hide");(D.is.animating()||D.is.active())&&(T.transition&&void 0!==e.fn.transition&&N.transition("is supported")?(D.remove.active(),N.transition({debug:T.debug,animation:T.transition+" out",queue:T.queue,duration:T.duration,useFailSafe:!0,onStart:function(){D.others.active()||i||D.hideDimmer(),T.keyboardShortcuts&&D.remove.keyboardShortcuts()},onComplete:function(){T.onHidden.call(M),D.remove.dimmerStyles(),D.restore.focus(),t()}})):D.error(_.noTransition))},showDimmer:function(){y.dimmer("is animating")||!y.dimmer("is active")?(D.debug("Showing dimmer"),y.dimmer("show")):D.debug("Dimmer already visible")},hideDimmer:function(){if(!y.dimmer("is animating")&&!y.dimmer("is active"))return void D.debug("Dimmer is not visible cannot hide");D.unbind.scrollLock(),y.dimmer("hide",function(){D.remove.clickaway(),D.remove.screenHeight()})},hideAll:function(t){var i=o.filter("."+x.active+", ."+x.animating);t=e.isFunction(t)?t:function(){},i.length>0&&(D.debug("Hiding all visible modals"),D.hideDimmer(),i.modal("hide modal",t))},hideOthers:function(t){var i=p.filter("."+x.active+", ."+x.animating);t=e.isFunction(t)?t:function(){},i.length>0&&(D.debug("Hiding other modals",p),i.modal("hide modal",t,!0))},others:{active:function(){return p.filter("."+x.active).length>0},animating:function(){return p.filter("."+x.animating).length>0}},add:{keyboardShortcuts:function(){D.verbose("Adding keyboard shortcuts"),s.on("keyup"+I,D.event.keyboard)}},save:{focus:function(){e(i.activeElement).closest(N).length>0||(v=e(i.activeElement).blur())}},restore:{focus:function(){v&&v.length>0&&v.focus()}},remove:{active:function(){N.removeClass(x.active)},legacy:function(){N.removeClass(x.legacy)},clickaway:function(){w.off("click"+S)},dimmerStyles:function(){w.removeClass(x.inverted),y.removeClass(x.blurring)},bodyStyle:function(){""===l.attr("style")&&(D.verbose("Removing style attribute"),l.removeAttr("style"))},screenHeight:function(){D.debug("Removing page height"),l.css("height","")},keyboardShortcuts:function(){D.verbose("Removing keyboard shortcuts"),s.off("keyup"+I)},scrolling:function(){y.removeClass(x.scrolling),N.removeClass(x.scrolling)}},cacheSizes:function(){N.addClass(x.loading);var n=N.prop("scrollHeight"),a=N.outerWidth(),o=N.outerHeight();void 0!==D.cache&&0===o||(D.cache={pageHeight:e(i).outerHeight(),width:a,height:o+T.offset,scrollHeight:n+T.offset,contextHeight:"body"==T.context?e(t).height():y.height()},D.cache.topOffset=-(D.cache.height/2)),N.removeClass(x.loading),D.debug("Caching modal and container sizes",D.cache)},can:{useFlex:function(){return"auto"==T.useFlex?T.detachable&&!D.is.ie():T.useFlex},fit:function(){var e=D.cache.contextHeight,t=D.cache.contextHeight/2,i=D.cache.topOffset,n=D.cache.scrollHeight,a=D.cache.height,o=T.padding,r=t+i;return n>a?r+n+o<e:a+2*o<e}},is:{active:function(){return N.hasClass(x.active)},ie:function(){var e=!t.ActiveXObject&&"ActiveXObject"in t,i="ActiveXObject"in t;return e||i},animating:function(){return N.transition("is supported")?N.transition("is animating"):N.is(":visible")},scrolling:function(){return y.hasClass(x.scrolling)},modernBrowser:function(){return!(t.ActiveXObject||"ActiveXObject"in t)}},set:{autofocus:function(){var e=N.find("[tabindex], :input").filter(":visible"),t=e.filter("[autofocus]"),i=t.length>0?t.first():e.first();i.length>0&&i.focus()},clickaway:function(){w.on("click"+S,D.event.click)},dimmerSettings:function(){if(void 0===e.fn.dimmer)return void D.error(_.dimmer);var t={debug:T.debug,dimmerName:"modals",closable:"auto",useFlex:D.can.useFlex(),variation:!T.centered&&"top aligned",duration:{show:T.duration,hide:T.duration}},i=e.extend(!0,t,T.dimmerSettings);T.inverted&&(i.variation=void 0!==i.variation?i.variation+" inverted":"inverted"),W.dimmer("setting",i)},dimmerStyles:function(){T.inverted?w.addClass(x.inverted):w.removeClass(x.inverted),T.blurring?y.addClass(x.blurring):y.removeClass(x.blurring)},modalOffset:function(){var e=D.cache.width,t=D.cache.height;N.css({marginTop:T.centered&&D.can.fit()?-(t/2):0,marginLeft:-(e/2)}),D.verbose("Setting modal offset for legacy mode")},screenHeight:function(){D.can.fit()?l.css("height",""):(D.debug("Modal is taller than page content, resizing page height"),l.css("height",D.cache.height+2*T.padding))},active:function(){N.addClass(x.active)},scrolling:function(){y.addClass(x.scrolling),N.addClass(x.scrolling),D.unbind.scrollLock()},legacy:function(){N.addClass(x.legacy)},type:function(){D.can.fit()?(D.verbose("Modal fits on screen"),D.others.active()||D.others.animating()||(D.remove.scrolling(),D.bind.scrollLock())):(D.verbose("Modal cannot fit on screen setting to scrolling"),D.set.scrolling())},undetached:function(){y.addClass(x.undetached)}},setting:function(t,i){if(D.debug("Changing setting",t,i),e.isPlainObject(t))e.extend(!0,T,t);else{if(void 0===i)return T[t];e.isPlainObject(T[t])?e.extend(!0,T[t],i):T[t]=i}},internal:function(t,i){if(e.isPlainObject(t))e.extend(!0,D,t);else{if(void 0===i)return D[t];D[t]=i}},debug:function(){!T.silent&&T.debug&&(T.performance?D.performance.log(arguments):(D.debug=Function.prototype.bind.call(console.info,console,T.name+":"),D.debug.apply(console,arguments)))},verbose:function(){!T.silent&&T.verbose&&T.debug&&(T.performance?D.performance.log(arguments):(D.verbose=Function.prototype.bind.call(console.info,console,T.name+":"),D.verbose.apply(console,arguments)))},error:function(){T.silent||(D.error=Function.prototype.bind.call(console.error,console,T.name+":"),D.error.apply(console,arguments))},performance:{log:function(e){var t,i,n;T.performance&&(t=(new Date).getTime(),n=c||t,i=t-n,c=t,h.push({Name:e[0],Arguments:[].slice.call(e,1)||"",Element:M,"Execution Time":i})),clearTimeout(D.performance.timer),D.performance.timer=setTimeout(D.performance.display,500)},display:function(){var t=T.name+":",i=0;c=!1,clearTimeout(D.performance.timer),e.each(h,function(e,t){i+=t["Execution Time"]}),t+=" "+i+"ms",d&&(t+=" '"+d+"'"),(void 0!==console.group||void 0!==console.table)&&h.length>0&&(console.groupCollapsed(t),console.table?console.table(h):e.each(h,function(e,t){console.log(t.Name+": "+t["Execution Time"]+"ms")}),console.groupEnd()),h=[]}},invoke:function(t,i,n){var o,r,s,l=L;return i=i||g,n=M||n,"string"==typeof t&&void 0!==l&&(t=t.split(/[\. ]/),o=t.length-1,e.each(t,function(i,n){var a=i!=o?n+t[i+1].charAt(0).toUpperCase()+t[i+1].slice(1):t;if(e.isPlainObject(l[a])&&i!=o)l=l[a];else{if(void 0!==l[a])return r=l[a],!1;if(!e.isPlainObject(l[n])||i==o)return void 0!==l[n]&&(r=l[n],!1);l=l[n]}})),e.isFunction(r)?s=r.apply(n,i):void 0!==r&&(s=r),e.isArray(a)?a.push(s):void 0!==a?a=[a,s]:void 0!==s&&(a=s),r}},m?(void 0===L&&D.initialize(),D.invoke(u)):(void 0!==L&&L.invoke("destroy"),D.initialize())}),void 0!==a?a:this},e.fn.modal.settings={name:"Modal",namespace:"modal",useFlex:"auto",offset:0,silent:!1,debug:!1,verbose:!1,performance:!0,observeChanges:!1,allowMultiple:!1,detachable:!0,closable:!0,autofocus:!0,inverted:!1,blurring:!1,centered:!0,dimmerSettings:{closable:!1,useCSS:!0},keyboardShortcuts:!0,context:"body",queue:!1,duration:500,transition:"scale",padding:50,onShow:function(){},onVisible:function(){},onHide:function(){return!0},onHidden:function(){},onApprove:function(){return!0},onDeny:function(){return!0},selector:{close:"> .close",approve:".actions .positive, .actions .approve, .actions .ok",deny:".actions .negative, .actions .deny, .actions .cancel",modal:".ui.modal"},error:{dimmer:"UI Dimmer, a required component is not included in this page",method:"The method you called is not defined.",notFound:"The element you specified could not be found"},className:{active:"active",animating:"animating",blurring:"blurring",inverted:"inverted",legacy:"legacy",loading:"loading",scrolling:"scrolling",undetached:"undetached"}}}(jQuery,window,document),function(){function e(e){t(e);var i=e.parent().next().next().children(),n=e.val(),a=i[0].rebuild(n);i.remove(),e.parent().next().next().append(a)}function t(e){var t=e.parent().next().next().next().children();"Dropdown"===e.val()?t.show():t.hide()}function i(e,t){return n(e,t,!0),!0}function n(e,t,i){var n=e.parent().parent(),a=n.parent().prev(),o=t.getEditData({type:"table",control:n,elements:t.parameters.elements[4].elements});i&&o.splice(e[0].rowIndex-1,1);var r=a.children(),s=r.val();if(""===s){var l=!1;$.each(r[0].options,function(e,t){return 0===e||(""===t.value?(l=!0,!1):void 0)}),l||(s=void 0)}var d=r[0].rebuild("Dropdown",s,o);r.remove(),a.append(d)}ParametersControl.prototype.generate=function(a,o,r){var s=this,l=$('<button class="ui button basic">'+WorkflowDesignerConstants.CodeActionsFormLabel.EditParameters+"</button>");return l[0].id=s.parentForm.generateid(a.field,r),l[0].name=s.parentForm.getElementCode(a),l[0].parameters=o,l.on("click",function(){var o=WorkflowDesignerConstants.CodeActionsFormLabel,r={type:"table",title:o.EditParameters,width:"800px",data:l[0].parameters,keyproperty:"Name",onrowadded:function(e){t(e.find("[name=Type]"))},elements:[{name:o.Name,field:"Name",type:"input"},{name:o.Type,field:"Type",type:"select",displayfield:"Name",valuefield:"Value",onchange:e,datasource:[{Name:o.Text,Value:"Text"},{Name:o.Number,Value:"Number"},{Name:o.Checkbox,Value:"Checkbox"},{Name:o.Dropdown,Value:"Dropdown"},{Name:o.DateTime,Value:"DateTime"},{Name:o.Json,Value:"Json"}]},{name:o.IsRequired,field:"IsRequired",type:"checkbox"},{name:o.DefaultValue,field:"DefaultValue",type:"defaultvalue",typeswitcher:"Type"},{name:o.Values,field:"DropdownValues",type:"table",onrowdelete:i,onrowchanged:n,elements:[{name:o.DropdownName,code:"DropdownValueName",field:"Name",type:"input"},{name:o.DropdownValue,code:"DropdownValueValue",field:"Value",type:"input"}]}],readonly:a.graph.Settings.readonly,onHidden:function(){setTimeout(function(){WorkflowDesignerCommon.modal(s.parentForm.window,"show")},10)}},d=new WorkflowDesignerForm(r),c=function(e,t){var i=!0,n=null;return t.length>1?(i&=e.CheckRequired(t,["Name","Type"],WorkflowDesignerConstants.FieldIsRequired),i&=e.CheckUnique(t,["Name"],WorkflowDesignerConstants.FieldMustBeUnique)):i&=e.CheckRequired(t,["Type"],WorkflowDesignerConstants.FieldIsRequired),i&&$.each(t,function(t,a){if("Dropdown"===a.Type){if(void 0===a.DropdownValues||!a.DropdownValues.length)return i=!1,$(a.control_DropdownValues).after('<div class="error-message">'+o.DropdownShouldContainValues+"</div>"),!1;if(!e.CheckUnique(a.DropdownValues,["Name"],WorkflowDesignerConstants.FieldMustBeUnique)||!e.CheckUnique(a.DropdownValues,["Value"],WorkflowDesignerConstants.FieldMustBeUnique))return i=!1,!1}if(""!==a.DefaultValue&&null!==a.DefaultValue&&(n=Validation.checkType(a.Type,a.DefaultValue)))return d.ControlAddError(a.control_DefaultValue,n),i=!1,!1}),i},h=function(e){return!!c(d,e)&&(d.ClearTempField(e),l[0].parameters=e,!0)};WorkflowDesignerCommon.modal(s.parentForm.window,"hide"),d.showModal(h),d.window.find("[name=Type]").each(function(e,i){t($(i))})}),l}}(),DefaultValueControl.prototype.generate=function(e,t){return this.build(t.Type,e,t.DropdownValues)},DefaultValueControl.prototype.build=function(e,t,i){var n=this,a=null;switch(e){case"Text":case"Number":case"DateTime":a=new InputControl(n.parentForm).generate(n.parameter,t,n.prefix);break;case"Checkbox":a=new CheckboxControl(n.parentForm).generate($.extend({indeterminable:!0},n.parameter),t,n.prefix);break;case"Dropdown":a=new SelectControl(n.parentForm).generate($.extend({displayfield:"Name",valuefield:"Value",datasource:i},n.parameter),t,n.prefix);break;case"Json":a=new JsonControl(n.parentForm,n.parameter,n.prefix).generateBasicControl(t);break;default:a=$("<div></div>")}return a[0].rebuild=function(e,t,i){return n.build(e,t,i)},a},function(){function e(e,a,o,r){var s=!1,l=null,d=WorkflowDesignerConstants.EditParametersFormlabel,c=$('<div style="float: right; margin-bottom: 15px;"></div>'),h=$('<a href="#" class="btnAdd"></a>');h[0].innerHTML=d.SwitchToJson,h.on("click",function(){return s=!0,WorkflowDesignerCommon.modal(l.window,"hide"),!1}),c.append(h);var u={type:"form",title:d.Title,width:"800px",readonly:e.parameter.graph.Settings.readonly,onHidden:function(){setTimeout(function(){if(s){s=!1;var t=l.getEditData(l.parameters),r={};$.each(o,function(e,n){paramValue=t[n.Name],r=i(n,paramValue,r)}),$(".ace_editor").remove(),n(e,a,{initialValue:JSON.stringify(r),paramsInfo:o})()}else WorkflowDesignerCommon.modal(e.parentForm.window,"show")},10)},bottom:c[0],elements:new Array};if(void 0!==r)""===o[0].Name?(u.data={},u.data[""]=r):u.data=r;else if(""===o[0].Name){if(u.data={},a[0].value)try{u.data[""]=JSON.parse(a[0].value)}catch(e){"Text"!==o[0].Type&&"Dropdown"!==o[0].Type&&"DateTime"!==o[0].Type||(u.data[""]=a[0].value)}}else{if(a[0].value)try{u.data=JSON.parse(a[0].value)}catch(e){}u.data||(u.data={}),$.each(o,function(e,t){var i=u.data[t.Name];void 0!==i&&null!==i&&""!==i||(u.data[t.Name]=t.DefaultValue)})}$.each(o,function(e,t){switch(t.Type){case"Text":case"Number":case"DateTime":u.elements.push({type:"input",name:t.Name,field:t.Name});break;case"Checkbox":u.elements.push({type:"checkbox",name:t.Name,field:t.Name,indeterminable:!0});break;case"Dropdown":u.elements.push({type:"select",name:t.Name,displayfield:"Name",valuefield:"Value",datasource:t.DropdownValues,field:t.Name});break;case"Json":u.elements.push({type:"json",name:t.Name,field:t.Name})}}),l=new WorkflowDesignerForm(u);var m=function(n){var r=null,s=!0,l={};return $.each(o,function(a,o){
r=n[o.Name];var d=t(r,o);d?(s=!1,e.parentForm.ControlAddError(n["control_"+o.Name],d)):l=i(o,r,l)}),s&&(1!=o.length||"Text"!==o[0].Type&&"Dropdown"!==o[0].Type&&"DateTime"!==o[0].Type?a[0].value=JSON.stringify(l):a[0].value=l),s};l.showModal(m)}function t(e,t){return!t.IsRequired||void 0!==e&&null!==e&&""!==e?Validation.checkType(t.Type,e):WorkflowDesignerConstants.FieldIsRequired}function i(e,t,i){if(""===e.Name)if("Text"!==e.Type&&""===t)i=null;else if("Number"===e.Type)i=Number(t);else if("Json"===e.Type)try{i=JSON.parse(t)}catch(e){i=t}else i=t;else if("Text"!==e.Type&&""===t)i[e.Name]=null;else if("Number"===e.Type)i[e.Name]=Number(t);else if("Json"===e.Type)try{i[e.Name]=JSON.parse(t)}catch(n){i[e.Name]=t}else i[e.Name]=t;return i}function n(i,n,o){var r=$('<div class="ui modal WorkflowDesignerDialogChild"><div class="header">'+WorkflowDesignerConstants.EditJSONLabel.Title+'</div><div id="'+n[0].id+'_editor" style="height:'+WorkflowDesignerConstants.EditJSONSettings.CodeHeight+'px">'+n[0].value+"</div></div>");r[0].id=n[0].id+"_form";var s=!1,l=$('<div class="actions"></div>');if(void 0!==o){var d=$('<div style="display: inline-block"></div>'),c=$('<a href="#" class="btnAdd"></a>');c[0].innerHTML=WorkflowDesignerConstants.EditParametersFormlabel.SwitchToConstructor,c.on("click",function(){return s=!0,WorkflowDesignerCommon.modal(r,"hide"),!1}),d.append(c),l.append(d)}if(!n[0].readOnly){var h=$('<div class="ui button">'+WorkflowDesignerConstants.EditJSONLabel.Format+"</div>");h.click(function(){var e=ace.edit(n[0].id+"_editor"),t=ace.edit(n[0].id+"_editor").getValue();e.setValue(i.parentForm.toPrettyJSON(t)),e.clearSelection()}),l.append(h)}if(void 0!=i.parameter.getemptytype&&!n[0].readOnly){var u=$('<div class="ui button">'+WorkflowDesignerConstants.EditJSONLabel.CreateEmptyType+"</div>");u.click(function(){var e=i.parameter;void 0!=e.getemptytype&&e.getemptytype(i.parentForm,n[0],function(e){if(void 0!=e&&""!==e){var t=ace.edit(n[0].id+"_editor");t.setValue(i.parentForm.toPrettyJSON(e)),t.clearSelection()}})}),l.append(u)}return n[0].readOnly?l.append('<div class="ui secondary cancel button">'+WorkflowDesignerConstants.ButtonTextClose+"</div>"):(l.append('<div class="ui primary ok button">'+WorkflowDesignerConstants.ButtonTextSave+"</div>"),l.append('<div class="ui secondary cancel button">'+WorkflowDesignerConstants.ButtonTextCancel+"</div>")),r.append(l),function(){void 0!==o&&WorkflowDesignerCommon.modal(i.parentForm.window,"hide"),WorkflowDesignerCommon.modal(r,{closable:!1,allowMultiple:!0,onApprove:function(){var e=ace.edit(n[0].id+"_editor").getValue();if(o){i.parentForm.ClearError();var s=null;try{s=JSON.parse(e)}catch(e){return a(r),!1}if(""===o.paramsInfo[0].Name){if(t(s,o.paramsInfo[0]))return a(r),!1}else{var l=!1;if($.each(o.paramsInfo,function(e,i){if(t(s[i.Name],i))return l=!0,!1}),l)return a(r),!1}}n[0].value=i.parentForm.toCompactJSON(e)},onHidden:function(){if(s){s=!1;var t=ace.edit(n[0].id+"_editor").getValue(),a=null;try{a=JSON.parse(t)}catch(e){}e(i,n,o.paramsInfo,a)}else setTimeout(function(){WorkflowDesignerCommon.modal(i.parentForm.window,"show")},10)},dimmerSettings:{opacity:.2,duration:{show:0,hide:0}},transition:"fade"}),WorkflowDesignerCommon.modal(r,"show");var l=ace.edit(n[0].id+"_editor");n[0].readOnly?l.setOptions({readOnly:!0}):l.setOptions({readOnly:!1}),l.getSession().setMode("ace/mode/json"),l.setValue(i.parentForm.toPrettyJSON(void 0!==o?o.initialValue:n[0].value)),l.clearSelection()}}function a(e){$(".header",e).after('<div class="error-message" style="padding: 4px">'+WorkflowDesignerConstants.EditParametersFormlabel.InvalidJson+"</div>")}JsonControl.prototype.generateParameterControl=function(e,t){var i=this,n=null;switch(i.parameter.parametertype){case"Action":n=t.ActionName;break;case"Condition":t.Action&&(n=t.Action.ActionName);break;case"RuleCheck":n=t.Rule}return i.build(n,e)},JsonControl.prototype.generateBasicControl=function(e){var t=this,i=$('<input type="text"></input>');i[0].id=t.parentForm.generateid(t.parameter.field,t.prefix),i[0].name=t.parentForm.getElementCode(t.parameter),void 0!==e&&null!==e&&("object"==typeof e?i[0].value=JSON.stringify(e):i[0].value=e),t.parentForm.isReadOnly()&&i.attr("readonly",!0);var a=$('<a class="btnCodeActions"></a>');a[0].id=i[0].id+"_button",a.on("click",n(t,i)),t.parentForm.addAutoComplete(t.parameter,i);var o=$('<div style="width:100%;"></div>').append($('<div style="width:16px; float:right; margin-right:7px;margin-top: 10px;"></div>').append(a)).append($('<div style="margin-right:30px"></div>').append(i));return o[0].rebuild=function(e,i){return t.build(e,i)},o},JsonControl.prototype.build=function(t,i){var n=this,a=null;if(t&&(a=n.parameter.graph.getActionParameterDefinition(t,n.parameter.parametertype)),!(a&&a.length||("RuleCheck"===n.parameter.parametertype&&(a=n.parameter.graph.getActionParameterDefinition(t,"RuleGet")),a&&a.length)))return n.generateBasicControl(i);null!==i&&""!==i||""!==a[0].Name||(i=a[0].DefaultValue);var o=$('<input type="text"></input>');o[0].id=n.parentForm.generateid(n.parameter.field,n.prefix),o[0].name=n.parentForm.getElementCode(n.parameter),void 0!==i&&(o[0].value=i),n.parentForm.isReadOnly()&&o.attr("readonly",!0);var r=$('<a class="btnCodeActions"></a>');r[0].id=o[0].id+"_button",r.on("click",function(){e(n,o,a)});var s=$('<div style="width:100%;"></div>').append($('<div style="width:16px; float:right; margin-right:7px;margin-top: 10px;"></div>').append(r)).append($('<div style="margin-right:30px"></div>').append(o));return s[0].rebuild=function(e,t){return n.build(e,t)},s}}(),InputControl.prototype.generate=function(e,t,i){var n=this,a=$('<input type="text"></input>');return a[0].id=n.parentForm.generateid(e.field,i),a[0].name=n.parentForm.getElementCode(e),void 0!==t&&(a[0].value=t),n.parentForm.isReadOnly()&&a.attr("readonly",!0),n.parentForm.addAutoComplete(e,a),void 0!==e.onchange&&a.on("change",function(){e.onchange(a)}),a.data("initial-value",t),a},CheckboxControl.prototype.generate=function(e,t,i){var n=this,a=$('<input type="checkbox"></input>');return a[0].id=n.parentForm.generateid(e.field,i),a[0].checked=t,a[0].name=n.parentForm.getElementCode(e),n.parentForm.isReadOnly()&&a.attr("disabled","disabled"),a=$('<div class="ui checkbox"></div>').append(a).append("<label></label>"),!e.indeterminable||null!==t&&void 0!==t&&""!==t||a.checkbox("set indeterminate"),a},SelectControl.prototype.generate=function(e,t,i){var n=this,a=$('<select class="ui selection dropdown"></select>'),o=!1;return a[0].id=n.parentForm.generateid(e.field,i),a[0].name=n.parentForm.getElementCode(e),a.append($("<option></option>")),void 0!==e.datasource&&e.datasource.forEach(function(i){var r=$("<option></option>");void 0===e.displayfield?(r[0].value=i,r[0].innerHTML=i):(r[0].innerHTML=i[e.displayfield],void 0!==e.valuefield?r[0].value=i[e.valuefield]:r[0].value=i[e.displayfield]),r[0].value!=t||o||(r[0].selected="selected",o=!0),n.parentForm.isReadOnly()&&a.attr("disabled","disabled"),a.append(r)}),void 0!==e.onchange&&a.on("change",function(){e.onchange(a)}),a};var Validation={checkType:function(e,t){var i=WorkflowDesignerConstants.EditParametersFormlabel;switch(e){case"Number":if(isNaN(t)||t===!0||t===!1)return i.NumberRequired;break;case"DateTime":if(""!==t&&null!==t&&void 0!==t&&!moment(t,moment.ISO_8601).isValid())return i.DateShouldBeInISOFormat}return null}},WorkflowDesignerWindows=WorkflowDesignerWindows||{};WorkflowDesignerWindows.EditCodeActions=function(){function e(e,t){var i=[];return e.forEach(function(n){if(n.IsGlobal){for(var a=!1,o=0;o<e.length;o++)if(n.Name==e[o].Name&&n.IsGlobal!=e[o].IsGlobal){a=!0;break}for(var r=!1,o=0;o<t.length;o++)if(a){if(n.Name==t[o].Name&&t[o].IsGlobal){r=!0;break}}else if(n.Name==t[o].Name){r=!0;break}r&&i.push(n.Name)}}),i}function t(e,t){var i=0,n=0;$.each(t,function(t,a){switch(a.type){case"Action":for(i=0;i<e.Activities.length;i+=1){var o=e.Activities[i];if("Inline"!==o.ActivityType){if(o.Implementation)for(n=0;n<o.Implementation.length;n+=1)o.Implementation[n].ActionName===a.initial&&(o.Implementation[n].ActionName=a.current);if(o.Implementation)for(n=0;n<o.PreExecutionImplementation.length;n+=1)o.PreExecutionImplementation[n].ActionName===a.initial&&(o.PreExecutionImplementation[n].ActionName=a.current)}}break;case"Condition":for(i=0;i<e.Transitions.length;i+=1){var r=e.Transitions[i];for(n=0;n<r.Conditions.length;n+=1){var s=r.Conditions[n];"Action"===s.Type&&s.Action.ActionName===a.initial&&(s.Action.ActionName=a.current)}}break;case"RuleGet":case"RuleCheck":for(i=0;i<e.Actors.length;i+=1)e.Actors[i].Rule===a.initial&&(e.Actors[i].Rule=a.current)}})}return function(i){var n=WorkflowDesignerConstants.CodeActionsFormLabel,a={type:"table",title:n.Title,data:i.graph.data.CodeActions,datadefault:{},elements:[{name:n.Name,field:"Name",type:"input"},{name:n.Type,field:"Type",type:"select",displayfield:"Name",datasource:[{Name:"Action"},{Name:"Condition"},{Name:"RuleGet"},{Name:"RuleCheck"}]},{name:n.IsGlobal,field:"IsGlobal",type:"checkbox"},{name:n.IsAsync,field:"IsAsync",type:"checkbox"},{name:n.ActionCode,field:"ActionCode",type:"code"},{name:n.Parameters,field:"ParameterDefinitions",type:"parameters",graph:i.graph}],graph:i.graph,readonly:i.graph.Settings.readonly,onrowadded:function(e,t){e.find("[name=Type]").change(function(){r(e)}),r(e),e.find("[name=IsGlobal]").change(function(){this.checked||t.InfoDialog(WorkflowDesignerConstants.Warning,WorkflowDesignerConstants.CodeActionsFormLabel.UnGlobalMessage,"mini")})},onrowdelete:function(e,t){return e.find("[name=IsGlobal]")[0].checked&&t.InfoDialog(WorkflowDesignerConstants.Warning,WorkflowDesignerConstants.CodeActionsFormLabel.GlobalDeleteMessage,"mini"),!0},saveFunc:function(e,n){i.SyncTable(i.graph.data.CodeActions,e,a);for(var o=0;o<i.graph.data.CodeActions.length;o++){var r=i.graph.data.CodeActions[o].ActionCode,s=i.graph.data.CodeActions[o].ParameterDefinitions;if(i.graph.data.CodeActions[o].ActionCode=encodeURIComponent(r.code),i.graph.data.CodeActions[o].Usings=encodeURIComponent(r.usings),void 0!==s&&null!==s){var l={};i.graph.data.CodeActions[o].ParameterDefinitions=new Array,$.each(s,function(e,t){l={Name:t.Name,Type:t.Type,IsRequired:t.IsRequired,DefaultValue:t.DefaultValue},"Dropdown"===l.Type&&(l.DropdownValues=new Array,$.each(t.DropdownValues,function(e,t){l.DropdownValues.push({Name:t.Name,Value:t.Value})})),i.graph.data.CodeActions[o].ParameterDefinitions.push(l)})}}n.length&&t(i.graph.data,n),WorkflowDesignerCommon.DataCorrection(i.graph.data),i.graph.Draw(i.graph.data),i.graph.StoreGraphData()}};if(void 0!=i.graph.Settings.forms&&void 0!=i.graph.Settings.forms.codeactions)return void i.graph.Settings.forms.codeactions(a);var o=new WorkflowDesignerForm(a),r=function(e){var t=e.find("[name=Type]")[0],i=e.find("[name=IsAsync]");void 0===t||"RuleGet"!==t.value&&"RuleCheck"!==t.value?i.attr("disabled",!1):(i.attr("disabled",!0),i.attr("checked",!1))},s=function(t,n){for(var a=0;a<t.length;a++){var r=t[a];void 0===r.ActionCode||void 0!==r.ActionCode.code&&r.ActionCode.code||("Action"===r.Type?r.ActionCode.code="return;":"Condition"===r.Type?r.ActionCode.code="return false;":"RuleGet"===r.Type?r.ActionCode.code="return new List<string>();":"RuleCheck"===r.Type&&(r.ActionCode.code="return false;"))}if(o.CheckRequired(t,["Name","Type","ActionCode.code"],WorkflowDesignerConstants.FieldIsRequired)&&o.CheckUnique(t,["Name","Type","IsGlobal"],WorkflowDesignerConstants.FieldMustBeUnique)){for(var s=new Array,a=0;a<t.length;a++){var r=t[a],l=$(r.control_Name).data("initial-value"),d=r.Name;l!==d&&s.push({initial:l,current:d,type:r.Type})}o.ClearTempField(t);var c=e(i.graph.data.CodeActions,t);return c.length>0&&i.graph.designer.deleteGlobalCodeAction(c,function(e){return e.isError&&o.InfoDialog(WorkflowDesignerConstants.EditCodeLabel.Error,e.errorMessage),!1}),o.parameters.saveFunc(t,s),!0}return!1};o.showModal(s)}}();var WorkflowDesignerWindows=WorkflowDesignerWindows||{};WorkflowDesignerWindows.EditTimer=function(){return function(e){var t=WorkflowDesignerConstants.TimerFormLabel,i={type:"table",title:t.Title,width:"800px",data:e.graph.data.Timers,keyproperty:"Name",elements:[{name:t.Name,field:"Name",type:"input"},{name:t.Type,field:"Type",type:"select",datasource:e.graph.data.AdditionalParams.TimerTypes},{name:t.Value,field:"Value",type:"input"},{name:t.NotOverrideIfExists,field:"NotOverrideIfExists",type:"checkbox"}],readonly:e.graph.Settings.readonly,saveFunc:function(t){e.SyncTable(e.graph.data.Timers,t,i),WorkflowDesignerCommon.DataCorrection(e.graph.data),e.graph.Draw(e.graph.data),e.graph.StoreGraphData()}};if(void 0!=e.graph.Settings.forms&&void 0!=e.graph.Settings.forms.timers)return void e.graph.Settings.forms.timers(i);var n=new WorkflowDesignerForm(i),a=function(t,i){return!(!n.CheckRequired(t,["Name","Type","Value"],WorkflowDesignerConstants.FieldIsRequired)||!n.CheckUnique(t,["Name"],WorkflowDesignerConstants.FieldMustBeUnique))&&(n.ClearTempField(t),void 0==e.graph.data.Timers&&(e.graph.data.Timers=[]),n.parameters.saveFunc(t),!0)};n.showModal(a)}}();var WorkflowDesignerWindows=WorkflowDesignerWindows||{};WorkflowDesignerWindows.EditActors=function(){return function(e){var t=WorkflowDesignerConstants.ActorFormLabel,i={type:"table",title:t.Title,width:"800px",data:e.graph.data.Actors,keyproperty:"Name",elements:[{name:t.Name,field:"Name",type:"input"},{name:t.Rule,field:"Rule",type:"select",datasource:e.graph.getActorNames(),onchange:function(e){var t=$(e),i=t.closest("tr").find("[name=actoractionparam]").closest("td"),n=i.children(),a=n[0].rebuild($(e).val(),n.find("input").val());n.remove(),i.append(a)}},{name:t.Value,field:"Value",type:"jsonparameter",code:"actoractionparam",graph:e.graph,parametertype:"RuleCheck",openautocompleteonclick:!0,datasource:function(t,i){var n=$(this).closest("tr"),a=n.find("[name=Rule]")[0].value;i(e.graph.getAutoCompleteSuggestions("ruleparameter",a,t))}}],graph:e.graph,readonly:e.graph.Settings.readonly,saveFunc:function(t){e.SyncTable(e.graph.data.Actors,t,i),WorkflowDesignerCommon.DataCorrection(e.graph.data),e.graph.Draw(e.graph.data),e.graph.StoreGraphData()}};if(void 0!=e.graph.Settings.forms&&void 0!=e.graph.Settings.forms.actors)return void e.graph.Settings.forms.actors(i);var n=new WorkflowDesignerForm(i),a=function(e,t){return!(!n.CheckRequired(e,["Name","Rule"],WorkflowDesignerConstants.FieldIsRequired)||!n.CheckUnique(e,["Name"],WorkflowDesignerConstants.FieldMustBeUnique))&&(n.ClearTempField(e),n.parameters.saveFunc(e),!0)};n.showModal(a)}}();var WorkflowDesignerWindows=WorkflowDesignerWindows||{};WorkflowDesignerWindows.EditCommands=function(){return function(e){var t=WorkflowDesignerConstants.CommandFormLabel,i=function(t,i,n){for(var a=void 0,o=void 0,r=t.getEditData(t.parameters),s=0;s<r.length;s++){var l=r[s];if(void 0!=l.InputParameters)for(var d=0;d<l.InputParameters.length;d++)if(l.InputParameters[d].control_DefaultValue.id===i.id){o=l.InputParameters[d].Parameter.Name;break}}if(void 0!=o)for(var c=e.graph.data.Parameters,s=0;s<c.length;s++)if(c[s].Name===o){a=c[s].Type;break}void 0!=a&&e.graph.graph.getemptytype(a,n)},n={type:"table",title:t.Title,width:"900px",data:e.graph.data.Commands,datadefault:{},keyproperty:"Name",elements:[{name:t.Name,field:"Name",type:"input"},{name:t.InputParameters,field:"InputParameters",type:"table",elements:[{name:t.InputParametersName,code:"ipname",field:"Name",type:"input",width:"30%"},{name:t.InputParametersParameter,code:"ipparameter",field:"Parameter.Name",type:"select",displayfield:"Name",datasource:e.graph.getNonSystemParameters()},{name:t.InputParametersIsRequired,code:"iisrequired",field:"IsRequired",type:"checkbox"},{name:t.InputParametersDefaultValue,code:"idefaultvalue",field:"DefaultValue",type:"json",width:"40%",getemptytype:i}]}],graph:e.graph,readonly:e.graph.Settings.readonly,saveFunc:function(t){e.SyncTable(e.graph.data.Commands,t,n),WorkflowDesignerCommon.DataCorrection(e.graph.data),e.graph.Draw(e.graph.data),e.graph.StoreGraphData()}};if(void 0!=e.graph.Settings.forms&&void 0!=e.graph.Settings.forms.commands)return void e.graph.Settings.forms.commands(n);var a=new WorkflowDesignerForm(n),o=function(e,t){var i=!0;return i&=e.CheckRequired(t,["Name"],WorkflowDesignerConstants.FieldIsRequired),i&=e.CheckUnique(t,["Name"],WorkflowDesignerConstants.FieldMustBeUnique),t.forEach(function(t){e.CheckRequired(t.InputParameters,["Name","Parameter.Name"],WorkflowDesignerConstants.FieldIsRequired)||(i=!1)}),i},r=function(e){return!!o(a,e)&&(a.ClearTempField(e),a.parameters.saveFunc(e),!0)};a.showModal(r)}}();var WorkflowDesignerWindows=WorkflowDesignerWindows||{};WorkflowDesignerWindows.ConfirmDialog=function(){return function(e,t,i,n,a){var o=$('<div tabindex="0" class="ui mini modal WorkflowDesignerConfirmDialog"></div>');o.append($('<div class="header">'+WorkflowDesignerConstants.DialogConfirmText+"</div>")),o.append($('<div class="content scrolling"><p>'+e+"</p></div>"));var r=$('<div class="actions"></div>').append('<div tabindex="1" class="ui primary ok button">'+t+"</div>").append('<div class="ui secondary  cancel button">'+n+"</div>");o.append(r),WorkflowDesignerCommon.modal(o,{onApprove:function(){i()},onDeny:function(){a()},allowMultiple:!0,dimmerSettings:{opacity:.2,duration:{show:0,hide:0}},transition:"fade"}),WorkflowDesignerCommon.modal(o,"show")}}(),function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.moment=t()}(this,function(){"use strict";function e(){return Qe.apply(null,arguments)}function t(e){return e instanceof Array||"[object Array]"===Object.prototype.toString.call(e)}function i(e){return null!=e&&"[object Object]"===Object.prototype.toString.call(e)}function n(e){return void 0===e}function a(e){return"number"==typeof e||"[object Number]"===Object.prototype.toString.call(e)}function o(e){return e instanceof Date||"[object Date]"===Object.prototype.toString.call(e)}function r(e,t){var i,n=[];for(i=0;i<e.length;++i)n.push(t(e[i],i));return n}function s(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function l(e,t){for(var i in t)s(t,i)&&(e[i]=t[i]);return s(t,"toString")&&(e.toString=t.toString),s(t,"valueOf")&&(e.valueOf=t.valueOf),e}function d(e,t,i,n){return pe(e,t,i,n,!0).utc()}function c(e){return null==e._pf&&(e._pf={empty:!1,unusedTokens:[],unusedInput:[],overflow:-2,charsLeftOver:0,nullInput:!1,invalidMonth:null,invalidFormat:!1,userInvalidated:!1,iso:!1,parsedDateParts:[],meridiem:null,rfc2822:!1,weekdayMismatch:!1}),e._pf}function h(e){if(null==e._isValid){var t=c(e),i=et.call(t.parsedDateParts,function(e){return null!=e}),n=!isNaN(e._d.getTime())&&t.overflow<0&&!t.empty&&!t.invalidMonth&&!t.invalidWeekday&&!t.weekdayMismatch&&!t.nullInput&&!t.invalidFormat&&!t.userInvalidated&&(!t.meridiem||t.meridiem&&i);if(e._strict&&(n=n&&0===t.charsLeftOver&&0===t.unusedTokens.length&&void 0===t.bigHour),null!=Object.isFrozen&&Object.isFrozen(e))return n;e._isValid=n}return e._isValid}function u(e){var t=d(NaN);return null!=e?l(c(t),e):c(t).userInvalidated=!0,t}function m(e,t){var i,a,o;if(n(t._isAMomentObject)||(e._isAMomentObject=t._isAMomentObject),n(t._i)||(e._i=t._i),n(t._f)||(e._f=t._f),n(t._l)||(e._l=t._l),n(t._strict)||(e._strict=t._strict),n(t._tzm)||(e._tzm=t._tzm),n(t._isUTC)||(e._isUTC=t._isUTC),n(t._offset)||(e._offset=t._offset),n(t._pf)||(e._pf=c(t)),n(t._locale)||(e._locale=t._locale),0<it.length)for(i=0;i<it.length;i++)n(o=t[a=it[i]])||(e[a]=o);return e}function g(t){m(this,t),this._d=new Date(null!=t._d?t._d.getTime():NaN),this.isValid()||(this._d=new Date(NaN)),!1===nt&&(nt=!0,e.updateOffset(this),nt=!1)}function f(e){return e instanceof g||null!=e&&null!=e._isAMomentObject}function p(e){return e<0?Math.ceil(e)||0:Math.floor(e)}function v(e){var t=+e,i=0;return 0!==t&&isFinite(t)&&(i=p(t)),i}function y(e,t,i){var n,a=Math.min(e.length,t.length),o=Math.abs(e.length-t.length),r=0;for(n=0;n<a;n++)(i&&e[n]!==t[n]||!i&&v(e[n])!==v(t[n]))&&r++;return r+o}function w(t){!1===e.suppressDeprecationWarnings&&"undefined"!=typeof console&&console.warn&&console.warn("Deprecation warning: "+t)}function S(t,i){var n=!0;return l(function(){if(null!=e.deprecationHandler&&e.deprecationHandler(null,t),n){for(var a,o=[],r=0;r<arguments.length;r++){if(a="","object"==typeof arguments[r]){for(var s in a+="\n["+r+"] ",arguments[0])a+=s+": "+arguments[0][s]+", ";a=a.slice(0,-2)}else a=arguments[r];o.push(a)}w(t+"\nArguments: "+Array.prototype.slice.call(o).join("")+"\n"+(new Error).stack),n=!1}return i.apply(this,arguments)},i)}function b(t,i){null!=e.deprecationHandler&&e.deprecationHandler(t,i),at[t]||(w(i),at[t]=!0)}function C(e){return e instanceof Function||"[object Function]"===Object.prototype.toString.call(e)}function D(e,t){var n,a=l({},e);for(n in t)s(t,n)&&(i(e[n])&&i(t[n])?(a[n]={},l(a[n],e[n]),l(a[n],t[n])):null!=t[n]?a[n]=t[n]:delete a[n]);for(n in e)s(e,n)&&!s(t,n)&&i(e[n])&&(a[n]=l({},a[n]));return a}function T(e){null!=e&&this.set(e)}function k(e,t){var i=e.toLowerCase();ot[i]=ot[i+"s"]=ot[t]=e}function x(e){return"string"==typeof e?ot[e]||ot[e.toLowerCase()]:void 0}function A(e){var t,i,n={};for(i in e)s(e,i)&&(t=x(i))&&(n[t]=e[i]);return n}function _(e,t){rt[e]=t}function I(e,t,i){var n=""+Math.abs(e),a=t-n.length;return(0<=e?i?"+":"":"-")+Math.pow(10,Math.max(0,a)).toString().substr(1)+n}function P(e,t,i,n){var a=n;"string"==typeof n&&(a=function(){return this[n]()}),e&&(ct[e]=a),t&&(ct[t[0]]=function(){return I(a.apply(this,arguments),t[1],t[2])}),i&&(ct[i]=function(){return this.localeData().ordinal(a.apply(this,arguments),e)})}function N(e,t){return e.isValid()?(t=W(t,e.localeData()),dt[t]=dt[t]||function(e){var t,i,n,a=e.match(st);for(t=0,i=a.length;t<i;t++)ct[a[t]]?a[t]=ct[a[t]]:a[t]=(n=a[t]).match(/\[[\s\S]/)?n.replace(/^\[|\]$/g,""):n.replace(/\\/g,"");return function(t){var n,o="";for(n=0;n<i;n++)o+=C(a[n])?a[n].call(t,e):a[n];return o}}(t),dt[t](e)):e.localeData().invalidDate()}function W(e,t){function i(e){return t.longDateFormat(e)||e}var n=5;for(lt.lastIndex=0;0<=n&&lt.test(e);)e=e.replace(lt,i),lt.lastIndex=0,n-=1;return e}function F(e,t,i){Tt[e]=C(t)?t:function(e,n){return e&&i?i:t}}function M(e,t){return s(Tt,e)?Tt[e](t._strict,t._locale):new RegExp(L(e.replace("\\","").replace(/\\(\[)|\\(\])|\[([^\]\[]*)\]|\\(.)/g,function(e,t,i,n,a){return t||i||n||a})))}function L(e){return e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}function O(e,t){var i,n=t;for("string"==typeof e&&(e=[e]),a(t)&&(n=function(e,i){i[t]=v(e)}),i=0;i<e.length;i++)kt[e[i]]=n}function E(e,t){O(e,function(e,i,n,a){n._w=n._w||{},t(e,n._w,n,a)})}function R(e){return G(e)?366:365}function G(e){return e%4==0&&e%100!=0||e%400==0}function Y(t,i){return function(n){return null!=n?(V(this,t,n),e.updateOffset(this,i),this):B(this,t)}}function B(e,t){return e.isValid()?e._d["get"+(e._isUTC?"UTC":"")+t]():NaN}function V(e,t,i){e.isValid()&&!isNaN(i)&&("FullYear"===t&&G(e.year())&&1===e.month()&&29===e.date()?e._d["set"+(e._isUTC?"UTC":"")+t](i,e.month(),$(i,e.month())):e._d["set"+(e._isUTC?"UTC":"")+t](i))}function $(e,t){if(isNaN(e)||isNaN(t))return NaN;var i,n=(t%(i=12)+i)%i;return e+=(t-n)/12,1===n?G(e)?29:28:31-n%7%2}function H(e,t){var i;if(!e.isValid())return e;if("string"==typeof t)if(/^\d+$/.test(t))t=v(t);else if(!a(t=e.localeData().monthsParse(t)))return e;return i=Math.min(e.date(),$(e.year(),t)),e._d["set"+(e._isUTC?"UTC":"")+"Month"](t,i),e}function U(t){return null!=t?(H(this,t),e.updateOffset(this,!0),this):B(this,"Month")}function j(){function e(e,t){return t.length-e.length}var t,i,n=[],a=[],o=[];for(t=0;t<12;t++)i=d([2e3,t]),n.push(this.monthsShort(i,"")),a.push(this.months(i,"")),o.push(this.months(i,"")),o.push(this.monthsShort(i,""));for(n.sort(e),a.sort(e),o.sort(e),t=0;t<12;t++)n[t]=L(n[t]),a[t]=L(a[t]);for(t=0;t<24;t++)o[t]=L(o[t]);this._monthsRegex=new RegExp("^("+o.join("|")+")","i"),this._monthsShortRegex=this._monthsRegex,this._monthsStrictRegex=new RegExp("^("+a.join("|")+")","i"),this._monthsShortStrictRegex=new RegExp("^("+n.join("|")+")","i")}function q(e){var t;if(e<100&&0<=e){var i=Array.prototype.slice.call(arguments);i[0]=e+400,t=new Date(Date.UTC.apply(null,i)),isFinite(t.getUTCFullYear())&&t.setUTCFullYear(e)}else t=new Date(Date.UTC.apply(null,arguments));return t}function J(e,t,i){var n=7+t-i;return-((7+q(e,0,n).getUTCDay()-t)%7)+n-1}function K(e,t,i,n,a){var o,r,s=1+7*(t-1)+(7+i-n)%7+J(e,n,a);return r=s<=0?R(o=e-1)+s:s>R(e)?(o=e+1,s-R(e)):(o=e,s),{year:o,dayOfYear:r}}function z(e,t,i){var n,a,o=J(e.year(),t,i),r=Math.floor((e.dayOfYear()-o-1)/7)+1;return r<1?n=r+X(a=e.year()-1,t,i):r>X(e.year(),t,i)?(n=r-X(e.year(),t,i),a=e.year()+1):(a=e.year(),n=r),{week:n,year:a}}function X(e,t,i){var n=J(e,t,i),a=J(e+1,t,i);return(R(e)-n+a)/7}function Z(e,t){return e.slice(t,7).concat(e.slice(0,t))}function Q(){function e(e,t){return t.length-e.length}var t,i,n,a,o,r=[],s=[],l=[],c=[];for(t=0;t<7;t++)i=d([2e3,1]).day(t),n=this.weekdaysMin(i,""),a=this.weekdaysShort(i,""),o=this.weekdays(i,""),r.push(n),s.push(a),l.push(o),c.push(n),c.push(a),c.push(o);for(r.sort(e),s.sort(e),l.sort(e),c.sort(e),t=0;t<7;t++)s[t]=L(s[t]),l[t]=L(l[t]),c[t]=L(c[t]);this._weekdaysRegex=new RegExp("^("+c.join("|")+")","i"),this._weekdaysShortRegex=this._weekdaysRegex,this._weekdaysMinRegex=this._weekdaysRegex,this._weekdaysStrictRegex=new RegExp("^("+l.join("|")+")","i"),this._weekdaysShortStrictRegex=new RegExp("^("+s.join("|")+")","i"),this._weekdaysMinStrictRegex=new RegExp("^("+r.join("|")+")","i")}function ee(){return this.hours()%12||12}function te(e,t){P(e,0,0,function(){return this.localeData().meridiem(this.hours(),this.minutes(),t)})}function ie(e,t){return t._meridiemParse}function ne(e){return e?e.toLowerCase().replace("_","-"):e}function ae(e){var t=null;if(!Et[e]&&"undefined"!=typeof module&&module&&module.exports)try{t=Mt._abbr,require("./locale/"+e),oe(t)}catch(e){}return Et[e]}function oe(e,t){var i;return e&&((i=n(t)?se(e):re(e,t))?Mt=i:"undefined"!=typeof console&&console.warn&&console.warn("Locale "+e+" not found. Did you forget to load it?")),Mt._abbr}function re(e,t){if(null===t)return delete Et[e],null;var i,n=Ot;if(t.abbr=e,null!=Et[e])b("defineLocaleOverride","use moment.updateLocale(localeName, config) to change an existing locale. moment.defineLocale(localeName, config) should only be used for creating a new locale See http://momentjs.com/guides/#/warnings/define-locale/ for more info."),n=Et[e]._config;else if(null!=t.parentLocale)if(null!=Et[t.parentLocale])n=Et[t.parentLocale]._config;else{if(null==(i=ae(t.parentLocale)))return Rt[t.parentLocale]||(Rt[t.parentLocale]=[]),Rt[t.parentLocale].push({name:e,config:t}),null;n=i._config}return Et[e]=new T(D(n,t)),Rt[e]&&Rt[e].forEach(function(e){re(e.name,e.config)}),oe(e),Et[e]}function se(e){var i;if(e&&e._locale&&e._locale._abbr&&(e=e._locale._abbr),!e)return Mt;if(!t(e)){if(i=ae(e))return i;e=[e]}return function(e){for(var t,i,n,a,o=0;o<e.length;){for(t=(a=ne(e[o]).split("-")).length,i=(i=ne(e[o+1]))?i.split("-"):null;0<t;){if(n=ae(a.slice(0,t).join("-")))return n;if(i&&i.length>=t&&y(a,i,!0)>=t-1)break;t--}o++}return Mt}(e)}function le(e){var t,i=e._a;return i&&-2===c(e).overflow&&(t=i[1]<0||11<i[1]?1:i[2]<1||i[2]>$(i[0],i[1])?2:i[3]<0||24<i[3]||24===i[3]&&(0!==i[4]||0!==i[5]||0!==i[6])?3:i[4]<0||59<i[4]?4:i[5]<0||59<i[5]?5:i[6]<0||999<i[6]?6:-1,c(e)._overflowDayOfYear&&(t<0||2<t)&&(t=2),c(e)._overflowWeeks&&-1===t&&(t=7),c(e)._overflowWeekday&&-1===t&&(t=8),c(e).overflow=t),e}function de(e,t,i){return null!=e?e:null!=t?t:i}function ce(t){var i,n,a,o,r,s=[];if(!t._d){var l,d;for(l=t,d=new Date(e.now()),a=l._useUTC?[d.getUTCFullYear(),d.getUTCMonth(),d.getUTCDate()]:[d.getFullYear(),d.getMonth(),d.getDate()],t._w&&null==t._a[2]&&null==t._a[1]&&function(e){var t,i,n,a,o,r,s,l;if(null!=(t=e._w).GG||null!=t.W||null!=t.E)o=1,r=4,i=de(t.GG,e._a[0],z(ve(),1,4).year),n=de(t.W,1),((a=de(t.E,1))<1||7<a)&&(l=!0);else{o=e._locale._week.dow,r=e._locale._week.doy;var d=z(ve(),o,r);i=de(t.gg,e._a[0],d.year),n=de(t.w,d.week),null!=t.d?((a=t.d)<0||6<a)&&(l=!0):null!=t.e?(a=t.e+o,(t.e<0||6<t.e)&&(l=!0)):a=o}n<1||n>X(i,o,r)?c(e)._overflowWeeks=!0:null!=l?c(e)._overflowWeekday=!0:(s=K(i,n,a,o,r),e._a[0]=s.year,e._dayOfYear=s.dayOfYear)}(t),null!=t._dayOfYear&&(r=de(t._a[0],a[0]),(t._dayOfYear>R(r)||0===t._dayOfYear)&&(c(t)._overflowDayOfYear=!0),n=q(r,0,t._dayOfYear),t._a[1]=n.getUTCMonth(),t._a[2]=n.getUTCDate()),i=0;i<3&&null==t._a[i];++i)t._a[i]=s[i]=a[i];for(;i<7;i++)t._a[i]=s[i]=null==t._a[i]?2===i?1:0:t._a[i];24===t._a[3]&&0===t._a[4]&&0===t._a[5]&&0===t._a[6]&&(t._nextDay=!0,t._a[3]=0),t._d=(t._useUTC?q:function(e,t,i,n,a,o,r){var s;return e<100&&0<=e?(s=new Date(e+400,t,i,n,a,o,r),isFinite(s.getFullYear())&&s.setFullYear(e)):s=new Date(e,t,i,n,a,o,r),s}).apply(null,s),o=t._useUTC?t._d.getUTCDay():t._d.getDay(),null!=t._tzm&&t._d.setUTCMinutes(t._d.getUTCMinutes()-t._tzm),t._nextDay&&(t._a[3]=24),t._w&&void 0!==t._w.d&&t._w.d!==o&&(c(t).weekdayMismatch=!0)}}function he(e){var t,i,n,a,o,r,s=e._i,l=Gt.exec(s)||Yt.exec(s);if(l){for(c(e).iso=!0,t=0,i=Vt.length;t<i;t++)if(Vt[t][1].exec(l[1])){a=Vt[t][0],n=!1!==Vt[t][2];break}if(null==a)return void(e._isValid=!1);if(l[3]){for(t=0,i=$t.length;t<i;t++)if($t[t][1].exec(l[3])){o=(l[2]||" ")+$t[t][0];break}if(null==o)return void(e._isValid=!1)}if(!n&&null!=o)return void(e._isValid=!1);if(l[4]){if(!Bt.exec(l[4]))return void(e._isValid=!1);r="Z"}e._f=a+(o||"")+(r||""),ge(e)}else e._isValid=!1}function ue(e,t,i,n,a,o){var r=[function(e){var t=parseInt(e,10);return t<=49?2e3+t:t<=999?1900+t:t}(e),Pt.indexOf(t),parseInt(i,10),parseInt(n,10),parseInt(a,10)];return o&&r.push(parseInt(o,10)),r}function me(e){var t,i,n,a=Ut.exec(e._i.replace(/\([^)]*\)|[\n\t]/g," ").replace(/(\s\s+)/g," ").replace(/^\s\s*/,"").replace(/\s\s*$/,""));if(a){var o=ue(a[4],a[3],a[2],a[5],a[6],a[7]);if(t=a[1],i=o,n=e,t&&Wt.indexOf(t)!==new Date(i[0],i[1],i[2]).getDay()&&(c(n).weekdayMismatch=!0,!(n._isValid=!1)))return;e._a=o,e._tzm=function(e,t,i){if(e)return jt[e];if(t)return 0;var n=parseInt(i,10),a=n%100;return(n-a)/100*60+a}(a[8],a[9],a[10]),e._d=q.apply(null,e._a),e._d.setUTCMinutes(e._d.getUTCMinutes()-e._tzm),c(e).rfc2822=!0}else e._isValid=!1}function ge(t){if(t._f!==e.ISO_8601)if(t._f!==e.RFC_2822){t._a=[],c(t).empty=!0;var i,n,a,o,r,l,d,h,u=""+t._i,m=u.length,g=0;for(a=W(t._f,t._locale).match(st)||[],i=0;i<a.length;i++)o=a[i],(n=(u.match(M(o,t))||[])[0])&&(0<(r=u.substr(0,u.indexOf(n))).length&&c(t).unusedInput.push(r),u=u.slice(u.indexOf(n)+n.length),g+=n.length),ct[o]?(n?c(t).empty=!1:c(t).unusedTokens.push(o),l=o,h=t,null!=(d=n)&&s(kt,l)&&kt[l](d,h._a,h,l)):t._strict&&!n&&c(t).unusedTokens.push(o);c(t).charsLeftOver=m-g,0<u.length&&c(t).unusedInput.push(u),t._a[3]<=12&&!0===c(t).bigHour&&0<t._a[3]&&(c(t).bigHour=void 0),c(t).parsedDateParts=t._a.slice(0),c(t).meridiem=t._meridiem,t._a[3]=function(e,t,i){var n;return null==i?t:null!=e.meridiemHour?e.meridiemHour(t,i):(null!=e.isPM&&((n=e.isPM(i))&&t<12&&(t+=12),n||12!==t||(t=0)),t)}(t._locale,t._a[3],t._meridiem),ce(t),le(t)}else me(t);else he(t)}function fe(s){var d,p,v,y,w=s._i,S=s._f;return s._locale=s._locale||se(s._l),null===w||void 0===S&&""===w?u({nullInput:!0}):("string"==typeof w&&(s._i=w=s._locale.preparse(w)),f(w)?new g(le(w)):(o(w)?s._d=w:t(S)?function(e){var t,i,n,a,o;if(0===e._f.length)return c(e).invalidFormat=!0,e._d=new Date(NaN);for(a=0;a<e._f.length;a++)o=0,t=m({},e),null!=e._useUTC&&(t._useUTC=e._useUTC),t._f=e._f[a],ge(t),h(t)&&(o+=c(t).charsLeftOver,o+=10*c(t).unusedTokens.length,c(t).score=o,(null==n||o<n)&&(n=o,i=t));l(e,i||t)}(s):S?ge(s):n(p=(d=s)._i)?d._d=new Date(e.now()):o(p)?d._d=new Date(p.valueOf()):"string"==typeof p?(v=d,null===(y=Ht.exec(v._i))?(he(v),!1===v._isValid&&(delete v._isValid,me(v),!1===v._isValid&&(delete v._isValid,
e.createFromInputFallback(v)))):v._d=new Date(+y[1])):t(p)?(d._a=r(p.slice(0),function(e){return parseInt(e,10)}),ce(d)):i(p)?function(e){if(!e._d){var t=A(e._i);e._a=r([t.year,t.month,t.day||t.date,t.hour,t.minute,t.second,t.millisecond],function(e){return e&&parseInt(e,10)}),ce(e)}}(d):a(p)?d._d=new Date(p):e.createFromInputFallback(d),h(s)||(s._d=null),s))}function pe(e,n,a,o,r){var s,l={};return!0!==a&&!1!==a||(o=a,a=void 0),(i(e)&&function(e){if(Object.getOwnPropertyNames)return 0===Object.getOwnPropertyNames(e).length;var t;for(t in e)if(e.hasOwnProperty(t))return!1;return!0}(e)||t(e)&&0===e.length)&&(e=void 0),l._isAMomentObject=!0,l._useUTC=l._isUTC=r,l._l=a,l._i=e,l._f=n,l._strict=o,(s=new g(le(fe(l))))._nextDay&&(s.add(1,"d"),s._nextDay=void 0),s}function ve(e,t,i,n){return pe(e,t,i,n,!1)}function ye(e,i){var n,a;if(1===i.length&&t(i[0])&&(i=i[0]),!i.length)return ve();for(n=i[0],a=1;a<i.length;++a)i[a].isValid()&&!i[a][e](n)||(n=i[a]);return n}function we(e){var t=A(e),i=t.year||0,n=t.quarter||0,a=t.month||0,o=t.week||t.isoWeek||0,r=t.day||0,s=t.hour||0,l=t.minute||0,d=t.second||0,c=t.millisecond||0;this._isValid=function(e){for(var t in e)if(-1===xt.call(Kt,t)||null!=e[t]&&isNaN(e[t]))return!1;for(var i=!1,n=0;n<Kt.length;++n)if(e[Kt[n]]){if(i)return!1;parseFloat(e[Kt[n]])!==v(e[Kt[n]])&&(i=!0)}return!0}(t),this._milliseconds=+c+1e3*d+6e4*l+1e3*s*60*60,this._days=+r+7*o,this._months=+a+3*n+12*i,this._data={},this._locale=se(),this._bubble()}function Se(e){return e instanceof we}function be(e){return e<0?-1*Math.round(-1*e):Math.round(e)}function Ce(e,t){P(e,0,0,function(){var e=this.utcOffset(),i="+";return e<0&&(e=-e,i="-"),i+I(~~(e/60),2)+t+I(~~e%60,2)})}function De(e,t){var i=(t||"").match(e);if(null===i)return null;var n=((i[i.length-1]||[])+"").match(/([\+\-]|\d\d)/gi)||["-",0,0],a=60*n[1]+v(n[2]);return 0===a?0:"+"===n[0]?a:-a}function Te(t,i){var n,a;return i._isUTC?(n=i.clone(),a=(f(t)||o(t)?t.valueOf():ve(t).valueOf())-n.valueOf(),n._d.setTime(n._d.valueOf()+a),e.updateOffset(n,!1),n):ve(t).local()}function ke(e){return 15*-Math.round(e._d.getTimezoneOffset()/15)}function xe(){return!!this.isValid()&&this._isUTC&&0===this._offset}function Ae(e,t){var i,n,o,r=e,l=null;return Se(e)?r={ms:e._milliseconds,d:e._days,M:e._months}:a(e)?(r={},t?r[t]=e:r.milliseconds=e):(l=zt.exec(e))?(i="-"===l[1]?-1:1,r={y:0,d:v(l[2])*i,h:v(l[3])*i,m:v(l[4])*i,s:v(l[5])*i,ms:v(be(1e3*l[6]))*i}):(l=Xt.exec(e))?(i="-"===l[1]?-1:1,r={y:_e(l[2],i),M:_e(l[3],i),w:_e(l[4],i),d:_e(l[5],i),h:_e(l[6],i),m:_e(l[7],i),s:_e(l[8],i)}):null==r?r={}:"object"==typeof r&&("from"in r||"to"in r)&&(o=function(e,t){var i;return e.isValid()&&t.isValid()?(t=Te(t,e),e.isBefore(t)?i=Ie(e,t):((i=Ie(t,e)).milliseconds=-i.milliseconds,i.months=-i.months),i):{milliseconds:0,months:0}}(ve(r.from),ve(r.to)),(r={}).ms=o.milliseconds,r.M=o.months),n=new we(r),Se(e)&&s(e,"_locale")&&(n._locale=e._locale),n}function _e(e,t){var i=e&&parseFloat(e.replace(",","."));return(isNaN(i)?0:i)*t}function Ie(e,t){var i={};return i.months=t.month()-e.month()+12*(t.year()-e.year()),e.clone().add(i.months,"M").isAfter(t)&&--i.months,i.milliseconds=+t-+e.clone().add(i.months,"M"),i}function Pe(e,t){return function(i,n){var a;return null===n||isNaN(+n)||(b(t,"moment()."+t+"(period, number) is deprecated. Please use moment()."+t+"(number, period). See http://momentjs.com/guides/#/warnings/add-inverted-param/ for more info."),a=i,i=n,n=a),Ne(this,Ae(i="string"==typeof i?+i:i,n),e),this}}function Ne(t,i,n,a){var o=i._milliseconds,r=be(i._days),s=be(i._months);t.isValid()&&(a=null==a||a,s&&H(t,B(t,"Month")+s*n),r&&V(t,"Date",B(t,"Date")+r*n),o&&t._d.setTime(t._d.valueOf()+o*n),a&&e.updateOffset(t,r||s))}function We(e,t){var i=12*(t.year()-e.year())+(t.month()-e.month()),n=e.clone().add(i,"months");return-(i+(t-n<0?(t-n)/(n-e.clone().add(i-1,"months")):(t-n)/(e.clone().add(i+1,"months")-n)))||0}function Fe(e){var t;return void 0===e?this._locale._abbr:(null!=(t=se(e))&&(this._locale=t),this)}function Me(){return this._locale}function Le(e,t){return(e%t+t)%t}function Oe(e,t,i){return e<100&&0<=e?new Date(e+400,t,i)-ti:new Date(e,t,i).valueOf()}function Ee(e,t,i){return e<100&&0<=e?Date.UTC(e+400,t,i)-ti:Date.UTC(e,t,i)}function Re(e,t){P(0,[e,e.length],0,t)}function Ge(e,t,i,n,a){var o;return null==e?z(this,n,a).year:((o=X(e,n,a))<t&&(t=o),function(e,t,i,n,a){var o=K(e,t,i,n,a),r=q(o.year,0,o.dayOfYear);return this.year(r.getUTCFullYear()),this.month(r.getUTCMonth()),this.date(r.getUTCDate()),this}.call(this,e,t,i,n,a))}function Ye(e,t){t[6]=v(1e3*("0."+e))}function Be(e){return e}function Ve(e,t,i,n){var a=se(),o=d().set(n,t);return a[i](o,e)}function $e(e,t,i){if(a(e)&&(t=e,e=void 0),e=e||"",null!=t)return Ve(e,t,i,"month");var n,o=[];for(n=0;n<12;n++)o[n]=Ve(e,n,i,"month");return o}function He(e,t,i,n){"boolean"==typeof e?a(t)&&(i=t,t=void 0):(t=e,e=!1,a(i=t)&&(i=t,t=void 0)),t=t||"";var o,r=se(),s=e?r._week.dow:0;if(null!=i)return Ve(t,(i+s)%7,n,"day");var l=[];for(o=0;o<7;o++)l[o]=Ve(t,(o+s)%7,n,"day");return l}function Ue(e,t,i,n){var a=Ae(t,i);return e._milliseconds+=n*a._milliseconds,e._days+=n*a._days,e._months+=n*a._months,e._bubble()}function je(e){return e<0?Math.floor(e):Math.ceil(e)}function qe(e){return 4800*e/146097}function Je(e){return 146097*e/4800}function Ke(e){return function(){return this.as(e)}}function ze(e){return function(){return this.isValid()?this._data[e]:NaN}}function Xe(e){return(0<e)-(e<0)||+e}function Ze(){if(!this.isValid())return this.localeData().invalidDate();var e,t,i=_i(this._milliseconds)/1e3,n=_i(this._days),a=_i(this._months);t=p((e=p(i/60))/60),i%=60,e%=60;var o=p(a/12),r=a%=12,s=n,l=t,d=e,c=i?i.toFixed(3).replace(/\.?0+$/,""):"",h=this.asSeconds();if(!h)return"P0D";var u=h<0?"-":"",m=Xe(this._months)!==Xe(h)?"-":"",g=Xe(this._days)!==Xe(h)?"-":"",f=Xe(this._milliseconds)!==Xe(h)?"-":"";return u+"P"+(o?m+o+"Y":"")+(r?m+r+"M":"")+(s?g+s+"D":"")+(l||d||c?"T":"")+(l?f+l+"H":"")+(d?f+d+"M":"")+(c?f+c+"S":"")}var Qe,et;et=Array.prototype.some?Array.prototype.some:function(e){for(var t=Object(this),i=t.length>>>0,n=0;n<i;n++)if(n in t&&e.call(this,t[n],n,t))return!0;return!1};var tt,it=e.momentProperties=[],nt=!1,at={};e.suppressDeprecationWarnings=!1,e.deprecationHandler=null,tt=Object.keys?Object.keys:function(e){var t,i=[];for(t in e)s(e,t)&&i.push(t);return i};var ot={},rt={},st=/(\[[^\[]*\])|(\\)?([Hh]mm(ss)?|Mo|MM?M?M?|Do|DDDo|DD?D?D?|ddd?d?|do?|w[o|w]?|W[o|W]?|Qo?|YYYYYY|YYYYY|YYYY|YY|gg(ggg?)?|GG(GGG?)?|e|E|a|A|hh?|HH?|kk?|mm?|ss?|S{1,9}|x|X|zz?|ZZ?|.)/g,lt=/(\[[^\[]*\])|(\\)?(LTS|LT|LL?L?L?|l{1,4})/g,dt={},ct={},ht=/\d\d/,ut=/\d{3}/,mt=/\d{4}/,gt=/[+-]?\d{6}/,ft=/\d\d?/,pt=/\d\d\d\d?/,vt=/\d\d\d\d\d\d?/,yt=/\d{1,3}/,wt=/\d{1,4}/,St=/[+-]?\d{1,6}/,bt=/[+-]?\d+/,Ct=/Z|[+-]\d\d(?::?\d\d)?/gi,Dt=/[0-9]{0,256}['a-z\u00A0-\u05FF\u0700-\uD7FF\uF900-\uFDCF\uFDF0-\uFF07\uFF10-\uFFEF]{1,256}|[\u0600-\u06FF\/]{1,256}(\s*?[\u0600-\u06FF]{1,256}){1,2}/i,Tt={},kt={};P("Y",0,0,function(){var e=this.year();return e<=9999?""+e:"+"+e}),P(0,["YY",2],0,function(){return this.year()%100}),P(0,["YYYY",4],0,"year"),P(0,["YYYYY",5],0,"year"),P(0,["YYYYYY",6,!0],0,"year"),k("year","y"),_("year",1),F("Y",bt),F("YY",ft,ht),F("YYYY",wt,mt),F("YYYYY",St,gt),F("YYYYYY",St,gt),O(["YYYYY","YYYYYY"],0),O("YYYY",function(t,i){i[0]=2===t.length?e.parseTwoDigitYear(t):v(t)}),O("YY",function(t,i){i[0]=e.parseTwoDigitYear(t)}),O("Y",function(e,t){t[0]=parseInt(e,10)}),e.parseTwoDigitYear=function(e){return v(e)+(68<v(e)?1900:2e3)};var xt,At=Y("FullYear",!0);xt=Array.prototype.indexOf?Array.prototype.indexOf:function(e){var t;for(t=0;t<this.length;++t)if(this[t]===e)return t;return-1},P("M",["MM",2],"Mo",function(){return this.month()+1}),P("MMM",0,0,function(e){return this.localeData().monthsShort(this,e)}),P("MMMM",0,0,function(e){return this.localeData().months(this,e)}),k("month","M"),_("month",8),F("M",ft),F("MM",ft,ht),F("MMM",function(e,t){return t.monthsShortRegex(e)}),F("MMMM",function(e,t){return t.monthsRegex(e)}),O(["M","MM"],function(e,t){t[1]=v(e)-1}),O(["MMM","MMMM"],function(e,t,i,n){var a=i._locale.monthsParse(e,n,i._strict);null!=a?t[1]=a:c(i).invalidMonth=e});var _t=/D[oD]?(\[[^\[\]]*\]|\s)+MMMM?/,It="January_February_March_April_May_June_July_August_September_October_November_December".split("_"),Pt="Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_");P("w",["ww",2],"wo","week"),P("W",["WW",2],"Wo","isoWeek"),k("week","w"),k("isoWeek","W"),_("week",5),_("isoWeek",5),F("w",ft),F("ww",ft,ht),F("W",ft),F("WW",ft,ht),E(["w","ww","W","WW"],function(e,t,i,n){t[n.substr(0,1)]=v(e)}),P("d",0,"do","day"),P("dd",0,0,function(e){return this.localeData().weekdaysMin(this,e)}),P("ddd",0,0,function(e){return this.localeData().weekdaysShort(this,e)}),P("dddd",0,0,function(e){return this.localeData().weekdays(this,e)}),P("e",0,0,"weekday"),P("E",0,0,"isoWeekday"),k("day","d"),k("weekday","e"),k("isoWeekday","E"),_("day",11),_("weekday",11),_("isoWeekday",11),F("d",ft),F("e",ft),F("E",ft),F("dd",function(e,t){return t.weekdaysMinRegex(e)}),F("ddd",function(e,t){return t.weekdaysShortRegex(e)}),F("dddd",function(e,t){return t.weekdaysRegex(e)}),E(["dd","ddd","dddd"],function(e,t,i,n){var a=i._locale.weekdaysParse(e,n,i._strict);null!=a?t.d=a:c(i).invalidWeekday=e}),E(["d","e","E"],function(e,t,i,n){t[n]=v(e)});var Nt="Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),Wt="Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),Ft="Su_Mo_Tu_We_Th_Fr_Sa".split("_");P("H",["HH",2],0,"hour"),P("h",["hh",2],0,ee),P("k",["kk",2],0,function(){return this.hours()||24}),P("hmm",0,0,function(){return""+ee.apply(this)+I(this.minutes(),2)}),P("hmmss",0,0,function(){return""+ee.apply(this)+I(this.minutes(),2)+I(this.seconds(),2)}),P("Hmm",0,0,function(){return""+this.hours()+I(this.minutes(),2)}),P("Hmmss",0,0,function(){return""+this.hours()+I(this.minutes(),2)+I(this.seconds(),2)}),te("a",!0),te("A",!1),k("hour","h"),_("hour",13),F("a",ie),F("A",ie),F("H",ft),F("h",ft),F("k",ft),F("HH",ft,ht),F("hh",ft,ht),F("kk",ft,ht),F("hmm",pt),F("hmmss",vt),F("Hmm",pt),F("Hmmss",vt),O(["H","HH"],3),O(["k","kk"],function(e,t,i){var n=v(e);t[3]=24===n?0:n}),O(["a","A"],function(e,t,i){i._isPm=i._locale.isPM(e),i._meridiem=e}),O(["h","hh"],function(e,t,i){t[3]=v(e),c(i).bigHour=!0}),O("hmm",function(e,t,i){var n=e.length-2;t[3]=v(e.substr(0,n)),t[4]=v(e.substr(n)),c(i).bigHour=!0}),O("hmmss",function(e,t,i){var n=e.length-4,a=e.length-2;t[3]=v(e.substr(0,n)),t[4]=v(e.substr(n,2)),t[5]=v(e.substr(a)),c(i).bigHour=!0}),O("Hmm",function(e,t,i){var n=e.length-2;t[3]=v(e.substr(0,n)),t[4]=v(e.substr(n))}),O("Hmmss",function(e,t,i){var n=e.length-4,a=e.length-2;t[3]=v(e.substr(0,n)),t[4]=v(e.substr(n,2)),t[5]=v(e.substr(a))});var Mt,Lt=Y("Hours",!0),Ot={calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},longDateFormat:{LTS:"h:mm:ss A",LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D, YYYY",LLL:"MMMM D, YYYY h:mm A",LLLL:"dddd, MMMM D, YYYY h:mm A"},invalidDate:"Invalid date",ordinal:"%d",dayOfMonthOrdinalParse:/\d{1,2}/,relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",ss:"%d seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},months:It,monthsShort:Pt,week:{dow:0,doy:6},weekdays:Nt,weekdaysMin:Ft,weekdaysShort:Wt,meridiemParse:/[ap]\.?m?\.?/i},Et={},Rt={},Gt=/^\s*((?:[+-]\d{6}|\d{4})-(?:\d\d-\d\d|W\d\d-\d|W\d\d|\d\d\d|\d\d))(?:(T| )(\d\d(?::\d\d(?::\d\d(?:[.,]\d+)?)?)?)([\+\-]\d\d(?::?\d\d)?|\s*Z)?)?$/,Yt=/^\s*((?:[+-]\d{6}|\d{4})(?:\d\d\d\d|W\d\d\d|W\d\d|\d\d\d|\d\d))(?:(T| )(\d\d(?:\d\d(?:\d\d(?:[.,]\d+)?)?)?)([\+\-]\d\d(?::?\d\d)?|\s*Z)?)?$/,Bt=/Z|[+-]\d\d(?::?\d\d)?/,Vt=[["YYYYYY-MM-DD",/[+-]\d{6}-\d\d-\d\d/],["YYYY-MM-DD",/\d{4}-\d\d-\d\d/],["GGGG-[W]WW-E",/\d{4}-W\d\d-\d/],["GGGG-[W]WW",/\d{4}-W\d\d/,!1],["YYYY-DDD",/\d{4}-\d{3}/],["YYYY-MM",/\d{4}-\d\d/,!1],["YYYYYYMMDD",/[+-]\d{10}/],["YYYYMMDD",/\d{8}/],["GGGG[W]WWE",/\d{4}W\d{3}/],["GGGG[W]WW",/\d{4}W\d{2}/,!1],["YYYYDDD",/\d{7}/]],$t=[["HH:mm:ss.SSSS",/\d\d:\d\d:\d\d\.\d+/],["HH:mm:ss,SSSS",/\d\d:\d\d:\d\d,\d+/],["HH:mm:ss",/\d\d:\d\d:\d\d/],["HH:mm",/\d\d:\d\d/],["HHmmss.SSSS",/\d\d\d\d\d\d\.\d+/],["HHmmss,SSSS",/\d\d\d\d\d\d,\d+/],["HHmmss",/\d\d\d\d\d\d/],["HHmm",/\d\d\d\d/],["HH",/\d\d/]],Ht=/^\/?Date\((\-?\d+)/i,Ut=/^(?:(Mon|Tue|Wed|Thu|Fri|Sat|Sun),?\s)?(\d{1,2})\s(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s(\d{2,4})\s(\d\d):(\d\d)(?::(\d\d))?\s(?:(UT|GMT|[ECMP][SD]T)|([Zz])|([+-]\d{4}))$/,jt={UT:0,GMT:0,EDT:-240,EST:-300,CDT:-300,CST:-360,MDT:-360,MST:-420,PDT:-420,PST:-480};e.createFromInputFallback=S("value provided is not in a recognized RFC2822 or ISO format. moment construction falls back to js Date(), which is not reliable across all browsers and versions. Non RFC2822/ISO date formats are discouraged and will be removed in an upcoming major release. Please refer to http://momentjs.com/guides/#/warnings/js-date/ for more info.",function(e){e._d=new Date(e._i+(e._useUTC?" UTC":""))}),e.ISO_8601=function(){},e.RFC_2822=function(){};var qt=S("moment().min is deprecated, use moment.max instead. http://momentjs.com/guides/#/warnings/min-max/",function(){var e=ve.apply(null,arguments);return this.isValid()&&e.isValid()?e<this?this:e:u()}),Jt=S("moment().max is deprecated, use moment.min instead. http://momentjs.com/guides/#/warnings/min-max/",function(){var e=ve.apply(null,arguments);return this.isValid()&&e.isValid()?this<e?this:e:u()}),Kt=["year","quarter","month","week","day","hour","minute","second","millisecond"];Ce("Z",":"),Ce("ZZ",""),F("Z",Ct),F("ZZ",Ct),O(["Z","ZZ"],function(e,t,i){i._useUTC=!0,i._tzm=De(Ct,e)});e.updateOffset=function(){};var zt=/^(\-|\+)?(?:(\d*)[. ])?(\d+)\:(\d+)(?:\:(\d+)(\.\d*)?)?$/,Xt=/^(-|\+)?P(?:([-+]?[0-9,.]*)Y)?(?:([-+]?[0-9,.]*)M)?(?:([-+]?[0-9,.]*)W)?(?:([-+]?[0-9,.]*)D)?(?:T(?:([-+]?[0-9,.]*)H)?(?:([-+]?[0-9,.]*)M)?(?:([-+]?[0-9,.]*)S)?)?$/;Ae.fn=we.prototype,Ae.invalid=function(){return Ae(NaN)};var Zt=Pe(1,"add"),Qt=Pe(-1,"subtract");e.defaultFormat="YYYY-MM-DDTHH:mm:ssZ",e.defaultFormatUtc="YYYY-MM-DDTHH:mm:ss[Z]";var ei=S("moment().lang() is deprecated. Instead, use moment().localeData() to get the language configuration. Use moment().locale() to change languages.",function(e){return void 0===e?this.localeData():this.locale(e)}),ti=126227808e5;P(0,["gg",2],0,function(){return this.weekYear()%100}),P(0,["GG",2],0,function(){return this.isoWeekYear()%100}),Re("gggg","weekYear"),Re("ggggg","weekYear"),Re("GGGG","isoWeekYear"),Re("GGGGG","isoWeekYear"),k("weekYear","gg"),k("isoWeekYear","GG"),_("weekYear",1),_("isoWeekYear",1),F("G",bt),F("g",bt),F("GG",ft,ht),F("gg",ft,ht),F("GGGG",wt,mt),F("gggg",wt,mt),F("GGGGG",St,gt),F("ggggg",St,gt),E(["gggg","ggggg","GGGG","GGGGG"],function(e,t,i,n){t[n.substr(0,2)]=v(e)}),E(["gg","GG"],function(t,i,n,a){i[a]=e.parseTwoDigitYear(t)}),P("Q",0,"Qo","quarter"),k("quarter","Q"),_("quarter",7),F("Q",/\d/),O("Q",function(e,t){t[1]=3*(v(e)-1)}),P("D",["DD",2],"Do","date"),k("date","D"),_("date",9),F("D",ft),F("DD",ft,ht),F("Do",function(e,t){return e?t._dayOfMonthOrdinalParse||t._ordinalParse:t._dayOfMonthOrdinalParseLenient}),O(["D","DD"],2),O("Do",function(e,t){t[2]=v(e.match(ft)[0])});var ii=Y("Date",!0);P("DDD",["DDDD",3],"DDDo","dayOfYear"),k("dayOfYear","DDD"),_("dayOfYear",4),F("DDD",yt),F("DDDD",ut),O(["DDD","DDDD"],function(e,t,i){i._dayOfYear=v(e)}),P("m",["mm",2],0,"minute"),k("minute","m"),_("minute",14),F("m",ft),F("mm",ft,ht),O(["m","mm"],4);var ni=Y("Minutes",!1);P("s",["ss",2],0,"second"),k("second","s"),_("second",15),F("s",ft),F("ss",ft,ht),O(["s","ss"],5);var ai,oi=Y("Seconds",!1);for(P("S",0,0,function(){return~~(this.millisecond()/100)}),P(0,["SS",2],0,function(){return~~(this.millisecond()/10)}),P(0,["SSS",3],0,"millisecond"),P(0,["SSSS",4],0,function(){return 10*this.millisecond()}),P(0,["SSSSS",5],0,function(){return 100*this.millisecond()}),P(0,["SSSSSS",6],0,function(){return 1e3*this.millisecond()}),P(0,["SSSSSSS",7],0,function(){return 1e4*this.millisecond()}),P(0,["SSSSSSSS",8],0,function(){return 1e5*this.millisecond()}),P(0,["SSSSSSSSS",9],0,function(){return 1e6*this.millisecond()}),k("millisecond","ms"),_("millisecond",16),F("S",yt,/\d/),F("SS",yt,ht),F("SSS",yt,ut),ai="SSSS";ai.length<=9;ai+="S")F(ai,/\d+/);for(ai="S";ai.length<=9;ai+="S")O(ai,Ye);var ri=Y("Milliseconds",!1);P("z",0,0,"zoneAbbr"),P("zz",0,0,"zoneName");var si=g.prototype;si.add=Zt,si.calendar=function(t,i){var n=t||ve(),a=Te(n,this).startOf("day"),o=e.calendarFormat(this,a)||"sameElse",r=i&&(C(i[o])?i[o].call(this,n):i[o]);return this.format(r||this.localeData().calendar(o,this,ve(n)))},si.clone=function(){return new g(this)},si.diff=function(e,t,i){var n,a,o;if(!this.isValid())return NaN;if(!(n=Te(e,this)).isValid())return NaN;switch(a=6e4*(n.utcOffset()-this.utcOffset()),t=x(t)){case"year":o=We(this,n)/12;break;case"month":o=We(this,n);break;case"quarter":o=We(this,n)/3;break;case"second":o=(this-n)/1e3;break;case"minute":o=(this-n)/6e4;break;case"hour":o=(this-n)/36e5;break;case"day":o=(this-n-a)/864e5;break;case"week":o=(this-n-a)/6048e5;break;default:o=this-n}return i?o:p(o)},si.endOf=function(t){var i;if(void 0===(t=x(t))||"millisecond"===t||!this.isValid())return this;var n=this._isUTC?Ee:Oe;switch(t){case"year":i=n(this.year()+1,0,1)-1;break;case"quarter":i=n(this.year(),this.month()-this.month()%3+3,1)-1;break;case"month":i=n(this.year(),this.month()+1,1)-1;break;case"week":i=n(this.year(),this.month(),this.date()-this.weekday()+7)-1;break;case"isoWeek":i=n(this.year(),this.month(),this.date()-(this.isoWeekday()-1)+7)-1;break;case"day":case"date":i=n(this.year(),this.month(),this.date()+1)-1;break;case"hour":i=this._d.valueOf(),i+=36e5-Le(i+(this._isUTC?0:6e4*this.utcOffset()),36e5)-1;break;case"minute":i=this._d.valueOf(),i+=6e4-Le(i,6e4)-1;break;case"second":i=this._d.valueOf(),i+=1e3-Le(i,1e3)-1}return this._d.setTime(i),e.updateOffset(this,!0),this},si.format=function(t){t||(t=this.isUtc()?e.defaultFormatUtc:e.defaultFormat);var i=N(this,t);return this.localeData().postformat(i)},si.from=function(e,t){return this.isValid()&&(f(e)&&e.isValid()||ve(e).isValid())?Ae({to:this,from:e}).locale(this.locale()).humanize(!t):this.localeData().invalidDate()},si.fromNow=function(e){return this.from(ve(),e)},si.to=function(e,t){return this.isValid()&&(f(e)&&e.isValid()||ve(e).isValid())?Ae({from:this,to:e}).locale(this.locale()).humanize(!t):this.localeData().invalidDate()},si.toNow=function(e){return this.to(ve(),e)},si.get=function(e){return C(this[e=x(e)])?this[e]():this},si.invalidAt=function(){return c(this).overflow},si.isAfter=function(e,t){var i=f(e)?e:ve(e);return!(!this.isValid()||!i.isValid())&&("millisecond"===(t=x(t)||"millisecond")?this.valueOf()>i.valueOf():i.valueOf()<this.clone().startOf(t).valueOf())},si.isBefore=function(e,t){var i=f(e)?e:ve(e);return!(!this.isValid()||!i.isValid())&&("millisecond"===(t=x(t)||"millisecond")?this.valueOf()<i.valueOf():this.clone().endOf(t).valueOf()<i.valueOf())},si.isBetween=function(e,t,i,n){var a=f(e)?e:ve(e),o=f(t)?t:ve(t);return!!(this.isValid()&&a.isValid()&&o.isValid())&&("("===(n=n||"()")[0]?this.isAfter(a,i):!this.isBefore(a,i))&&(")"===n[1]?this.isBefore(o,i):!this.isAfter(o,i))},si.isSame=function(e,t){var i,n=f(e)?e:ve(e);return!(!this.isValid()||!n.isValid())&&("millisecond"===(t=x(t)||"millisecond")?this.valueOf()===n.valueOf():(i=n.valueOf(),this.clone().startOf(t).valueOf()<=i&&i<=this.clone().endOf(t).valueOf()))},si.isSameOrAfter=function(e,t){return this.isSame(e,t)||this.isAfter(e,t)},si.isSameOrBefore=function(e,t){return this.isSame(e,t)||this.isBefore(e,t)},si.isValid=function(){return h(this)},si.lang=ei,si.locale=Fe,si.localeData=Me,si.max=Jt,si.min=qt,si.parsingFlags=function(){return l({},c(this))},si.set=function(e,t){if("object"==typeof e)for(var i=function(e){var t=[];for(var i in e)t.push({unit:i,priority:rt[i]});return t.sort(function(e,t){return e.priority-t.priority}),t}(e=A(e)),n=0;n<i.length;n++)this[i[n].unit](e[i[n].unit]);else if(C(this[e=x(e)]))return this[e](t);return this},si.startOf=function(t){var i;if(void 0===(t=x(t))||"millisecond"===t||!this.isValid())return this;var n=this._isUTC?Ee:Oe;switch(t){case"year":i=n(this.year(),0,1);break;case"quarter":i=n(this.year(),this.month()-this.month()%3,1);break;case"month":i=n(this.year(),this.month(),1);break;case"week":i=n(this.year(),this.month(),this.date()-this.weekday());break;case"isoWeek":i=n(this.year(),this.month(),this.date()-(this.isoWeekday()-1));break;case"day":case"date":i=n(this.year(),this.month(),this.date());break;case"hour":i=this._d.valueOf(),i-=Le(i+(this._isUTC?0:6e4*this.utcOffset()),36e5);break;case"minute":i=this._d.valueOf(),i-=Le(i,6e4);break;case"second":i=this._d.valueOf(),i-=Le(i,1e3)}return this._d.setTime(i),e.updateOffset(this,!0),this},si.subtract=Qt,si.toArray=function(){var e=this;return[e.year(),e.month(),e.date(),e.hour(),e.minute(),e.second(),e.millisecond()]},si.toObject=function(){var e=this;return{years:e.year(),months:e.month(),date:e.date(),hours:e.hours(),minutes:e.minutes(),seconds:e.seconds(),milliseconds:e.milliseconds()}},si.toDate=function(){return new Date(this.valueOf())},si.toISOString=function(e){if(!this.isValid())return null;var t=!0!==e,i=t?this.clone().utc():this;return i.year()<0||9999<i.year()?N(i,t?"YYYYYY-MM-DD[T]HH:mm:ss.SSS[Z]":"YYYYYY-MM-DD[T]HH:mm:ss.SSSZ"):C(Date.prototype.toISOString)?t?this.toDate().toISOString():new Date(this.valueOf()+60*this.utcOffset()*1e3).toISOString().replace("Z",N(i,"Z")):N(i,t?"YYYY-MM-DD[T]HH:mm:ss.SSS[Z]":"YYYY-MM-DD[T]HH:mm:ss.SSSZ")},si.inspect=function(){if(!this.isValid())return"moment.invalid(/* "+this._i+" */)";var e="moment",t="";this.isLocal()||(e=0===this.utcOffset()?"moment.utc":"moment.parseZone",t="Z");var i="["+e+'("]',n=0<=this.year()&&this.year()<=9999?"YYYY":"YYYYYY",a=t+'[")]';return this.format(i+n+"-MM-DD[T]HH:mm:ss.SSS"+a)},si.toJSON=function(){return this.isValid()?this.toISOString():null},si.toString=function(){return this.clone().locale("en").format("ddd MMM DD YYYY HH:mm:ss [GMT]ZZ")},si.unix=function(){return Math.floor(this.valueOf()/1e3)},si.valueOf=function(){return this._d.valueOf()-6e4*(this._offset||0)},si.creationData=function(){return{input:this._i,format:this._f,locale:this._locale,isUTC:this._isUTC,strict:this._strict}},si.year=At,si.isLeapYear=function(){return G(this.year())},si.weekYear=function(e){return Ge.call(this,e,this.week(),this.weekday(),this.localeData()._week.dow,this.localeData()._week.doy)},si.isoWeekYear=function(e){return Ge.call(this,e,this.isoWeek(),this.isoWeekday(),1,4)},si.quarter=si.quarters=function(e){return null==e?Math.ceil((this.month()+1)/3):this.month(3*(e-1)+this.month()%3)},si.month=U,si.daysInMonth=function(){return $(this.year(),this.month())},si.week=si.weeks=function(e){var t=this.localeData().week(this);return null==e?t:this.add(7*(e-t),"d")},si.isoWeek=si.isoWeeks=function(e){var t=z(this,1,4).week;return null==e?t:this.add(7*(e-t),"d")},si.weeksInYear=function(){var e=this.localeData()._week;return X(this.year(),e.dow,e.doy)},si.isoWeeksInYear=function(){return X(this.year(),1,4)},si.date=ii,si.day=si.days=function(e){if(!this.isValid())return null!=e?this:NaN;var t,i,n=this._isUTC?this._d.getUTCDay():this._d.getDay();return null!=e?(t=e,i=this.localeData(),e="string"!=typeof t?t:isNaN(t)?"number"==typeof(t=i.weekdaysParse(t))?t:null:parseInt(t,10),this.add(e-n,"d")):n},si.weekday=function(e){if(!this.isValid())return null!=e?this:NaN;var t=(this.day()+7-this.localeData()._week.dow)%7;return null==e?t:this.add(e-t,"d")},si.isoWeekday=function(e){if(!this.isValid())return null!=e?this:NaN;if(null==e)return this.day()||7;var t,i,n=(t=e,i=this.localeData(),"string"==typeof t?i.weekdaysParse(t)%7||7:isNaN(t)?null:t);return this.day(this.day()%7?n:n-7)},si.dayOfYear=function(e){var t=Math.round((this.clone().startOf("day")-this.clone().startOf("year"))/864e5)+1;return null==e?t:this.add(e-t,"d")},si.hour=si.hours=Lt,si.minute=si.minutes=ni,si.second=si.seconds=oi,si.millisecond=si.milliseconds=ri,si.utcOffset=function(t,i,n){var a,o=this._offset||0;if(!this.isValid())return null!=t?this:NaN;if(null==t)return this._isUTC?o:ke(this);if("string"==typeof t){if(null===(t=De(Ct,t)))return this}else Math.abs(t)<16&&!n&&(t*=60);return!this._isUTC&&i&&(a=ke(this)),this._offset=t,this._isUTC=!0,null!=a&&this.add(a,"m"),o!==t&&(!i||this._changeInProgress?Ne(this,Ae(t-o,"m"),1,!1):this._changeInProgress||(this._changeInProgress=!0,e.updateOffset(this,!0),this._changeInProgress=null)),this},si.utc=function(e){return this.utcOffset(0,e)},si.local=function(e){return this._isUTC&&(this.utcOffset(0,e),this._isUTC=!1,e&&this.subtract(ke(this),"m")),this},si.parseZone=function(){if(null!=this._tzm)this.utcOffset(this._tzm,!1,!0);else if("string"==typeof this._i){var e=De(/Z|[+-]\d\d:?\d\d/gi,this._i);null!=e?this.utcOffset(e):this.utcOffset(0,!0)}return this},si.hasAlignedHourOffset=function(e){return!!this.isValid()&&(e=e?ve(e).utcOffset():0,(this.utcOffset()-e)%60==0)},si.isDST=function(){return this.utcOffset()>this.clone().month(0).utcOffset()||this.utcOffset()>this.clone().month(5).utcOffset()},si.isLocal=function(){return!!this.isValid()&&!this._isUTC},si.isUtcOffset=function(){return!!this.isValid()&&this._isUTC},si.isUtc=xe,si.isUTC=xe,si.zoneAbbr=function(){return this._isUTC?"UTC":""},si.zoneName=function(){return this._isUTC?"Coordinated Universal Time":""},si.dates=S("dates accessor is deprecated. Use date instead.",ii),si.months=S("months accessor is deprecated. Use month instead",U),si.years=S("years accessor is deprecated. Use year instead",At),si.zone=S("moment().zone is deprecated, use moment().utcOffset instead. http://momentjs.com/guides/#/warnings/zone/",function(e,t){return null!=e?("string"!=typeof e&&(e=-e),this.utcOffset(e,t),this):-this.utcOffset()}),si.isDSTShifted=S("isDSTShifted is deprecated. See http://momentjs.com/guides/#/warnings/dst-shifted/ for more information",function(){if(!n(this._isDSTShifted))return this._isDSTShifted;var e={};if(m(e,this),(e=fe(e))._a){var t=e._isUTC?d(e._a):ve(e._a);this._isDSTShifted=this.isValid()&&0<y(e._a,t.toArray())}else this._isDSTShifted=!1;return this._isDSTShifted});var li=T.prototype;li.calendar=function(e,t,i){var n=this._calendar[e]||this._calendar.sameElse;return C(n)?n.call(t,i):n},li.longDateFormat=function(e){var t=this._longDateFormat[e],i=this._longDateFormat[e.toUpperCase()];return t||!i?t:(this._longDateFormat[e]=i.replace(/MMMM|MM|DD|dddd/g,function(e){return e.slice(1)}),this._longDateFormat[e])},li.invalidDate=function(){return this._invalidDate},li.ordinal=function(e){return this._ordinal.replace("%d",e)},li.preparse=Be,li.postformat=Be,li.relativeTime=function(e,t,i,n){var a=this._relativeTime[i];return C(a)?a(e,t,i,n):a.replace(/%d/i,e)},li.pastFuture=function(e,t){var i=this._relativeTime[0<e?"future":"past"];return C(i)?i(t):i.replace(/%s/i,t)},li.set=function(e){var t,i;for(i in e)C(t=e[i])?this[i]=t:this["_"+i]=t;this._config=e,this._dayOfMonthOrdinalParseLenient=new RegExp((this._dayOfMonthOrdinalParse.source||this._ordinalParse.source)+"|"+/\d{1,2}/.source)},li.months=function(e,i){return e?t(this._months)?this._months[e.month()]:this._months[(this._months.isFormat||_t).test(i)?"format":"standalone"][e.month()]:t(this._months)?this._months:this._months.standalone},li.monthsShort=function(e,i){return e?t(this._monthsShort)?this._monthsShort[e.month()]:this._monthsShort[_t.test(i)?"format":"standalone"][e.month()]:t(this._monthsShort)?this._monthsShort:this._monthsShort.standalone},li.monthsParse=function(e,t,i){var n,a,o;if(this._monthsParseExact)return function(e,t,i){var n,a,o,r=e.toLocaleLowerCase();if(!this._monthsParse)for(this._monthsParse=[],this._longMonthsParse=[],this._shortMonthsParse=[],n=0;n<12;++n)o=d([2e3,n]),this._shortMonthsParse[n]=this.monthsShort(o,"").toLocaleLowerCase(),this._longMonthsParse[n]=this.months(o,"").toLocaleLowerCase();return i?"MMM"===t?-1!==(a=xt.call(this._shortMonthsParse,r))?a:null:-1!==(a=xt.call(this._longMonthsParse,r))?a:null:"MMM"===t?-1!==(a=xt.call(this._shortMonthsParse,r))?a:-1!==(a=xt.call(this._longMonthsParse,r))?a:null:-1!==(a=xt.call(this._longMonthsParse,r))?a:-1!==(a=xt.call(this._shortMonthsParse,r))?a:null}.call(this,e,t,i);for(this._monthsParse||(this._monthsParse=[],this._longMonthsParse=[],this._shortMonthsParse=[]),n=0;n<12;n++){if(a=d([2e3,n]),i&&!this._longMonthsParse[n]&&(this._longMonthsParse[n]=new RegExp("^"+this.months(a,"").replace(".","")+"$","i"),this._shortMonthsParse[n]=new RegExp("^"+this.monthsShort(a,"").replace(".","")+"$","i")),i||this._monthsParse[n]||(o="^"+this.months(a,"")+"|^"+this.monthsShort(a,""),this._monthsParse[n]=new RegExp(o.replace(".",""),"i")),i&&"MMMM"===t&&this._longMonthsParse[n].test(e))return n;if(i&&"MMM"===t&&this._shortMonthsParse[n].test(e))return n;if(!i&&this._monthsParse[n].test(e))return n}},li.monthsRegex=function(e){return this._monthsParseExact?(s(this,"_monthsRegex")||j.call(this),e?this._monthsStrictRegex:this._monthsRegex):(s(this,"_monthsRegex")||(this._monthsRegex=Dt),this._monthsStrictRegex&&e?this._monthsStrictRegex:this._monthsRegex)},li.monthsShortRegex=function(e){return this._monthsParseExact?(s(this,"_monthsRegex")||j.call(this),e?this._monthsShortStrictRegex:this._monthsShortRegex):(s(this,"_monthsShortRegex")||(this._monthsShortRegex=Dt),this._monthsShortStrictRegex&&e?this._monthsShortStrictRegex:this._monthsShortRegex)},li.week=function(e){return z(e,this._week.dow,this._week.doy).week},li.firstDayOfYear=function(){return this._week.doy},li.firstDayOfWeek=function(){return this._week.dow},li.weekdays=function(e,i){var n=t(this._weekdays)?this._weekdays:this._weekdays[e&&!0!==e&&this._weekdays.isFormat.test(i)?"format":"standalone"];return!0===e?Z(n,this._week.dow):e?n[e.day()]:n},li.weekdaysMin=function(e){return!0===e?Z(this._weekdaysMin,this._week.dow):e?this._weekdaysMin[e.day()]:this._weekdaysMin},li.weekdaysShort=function(e){return!0===e?Z(this._weekdaysShort,this._week.dow):e?this._weekdaysShort[e.day()]:this._weekdaysShort},li.weekdaysParse=function(e,t,i){var n,a,o;if(this._weekdaysParseExact)return function(e,t,i){var n,a,o,r=e.toLocaleLowerCase();if(!this._weekdaysParse)for(this._weekdaysParse=[],this._shortWeekdaysParse=[],this._minWeekdaysParse=[],n=0;n<7;++n)o=d([2e3,1]).day(n),this._minWeekdaysParse[n]=this.weekdaysMin(o,"").toLocaleLowerCase(),this._shortWeekdaysParse[n]=this.weekdaysShort(o,"").toLocaleLowerCase(),this._weekdaysParse[n]=this.weekdays(o,"").toLocaleLowerCase();return i?"dddd"===t?-1!==(a=xt.call(this._weekdaysParse,r))?a:null:"ddd"===t?-1!==(a=xt.call(this._shortWeekdaysParse,r))?a:null:-1!==(a=xt.call(this._minWeekdaysParse,r))?a:null:"dddd"===t?-1!==(a=xt.call(this._weekdaysParse,r))?a:-1!==(a=xt.call(this._shortWeekdaysParse,r))?a:-1!==(a=xt.call(this._minWeekdaysParse,r))?a:null:"ddd"===t?-1!==(a=xt.call(this._shortWeekdaysParse,r))?a:-1!==(a=xt.call(this._weekdaysParse,r))?a:-1!==(a=xt.call(this._minWeekdaysParse,r))?a:null:-1!==(a=xt.call(this._minWeekdaysParse,r))?a:-1!==(a=xt.call(this._weekdaysParse,r))?a:-1!==(a=xt.call(this._shortWeekdaysParse,r))?a:null}.call(this,e,t,i);for(this._weekdaysParse||(this._weekdaysParse=[],this._minWeekdaysParse=[],this._shortWeekdaysParse=[],this._fullWeekdaysParse=[]),n=0;n<7;n++){if(a=d([2e3,1]).day(n),i&&!this._fullWeekdaysParse[n]&&(this._fullWeekdaysParse[n]=new RegExp("^"+this.weekdays(a,"").replace(".","\\.?")+"$","i"),this._shortWeekdaysParse[n]=new RegExp("^"+this.weekdaysShort(a,"").replace(".","\\.?")+"$","i"),this._minWeekdaysParse[n]=new RegExp("^"+this.weekdaysMin(a,"").replace(".","\\.?")+"$","i")),this._weekdaysParse[n]||(o="^"+this.weekdays(a,"")+"|^"+this.weekdaysShort(a,"")+"|^"+this.weekdaysMin(a,""),
this._weekdaysParse[n]=new RegExp(o.replace(".",""),"i")),i&&"dddd"===t&&this._fullWeekdaysParse[n].test(e))return n;if(i&&"ddd"===t&&this._shortWeekdaysParse[n].test(e))return n;if(i&&"dd"===t&&this._minWeekdaysParse[n].test(e))return n;if(!i&&this._weekdaysParse[n].test(e))return n}},li.weekdaysRegex=function(e){return this._weekdaysParseExact?(s(this,"_weekdaysRegex")||Q.call(this),e?this._weekdaysStrictRegex:this._weekdaysRegex):(s(this,"_weekdaysRegex")||(this._weekdaysRegex=Dt),this._weekdaysStrictRegex&&e?this._weekdaysStrictRegex:this._weekdaysRegex)},li.weekdaysShortRegex=function(e){return this._weekdaysParseExact?(s(this,"_weekdaysRegex")||Q.call(this),e?this._weekdaysShortStrictRegex:this._weekdaysShortRegex):(s(this,"_weekdaysShortRegex")||(this._weekdaysShortRegex=Dt),this._weekdaysShortStrictRegex&&e?this._weekdaysShortStrictRegex:this._weekdaysShortRegex)},li.weekdaysMinRegex=function(e){return this._weekdaysParseExact?(s(this,"_weekdaysRegex")||Q.call(this),e?this._weekdaysMinStrictRegex:this._weekdaysMinRegex):(s(this,"_weekdaysMinRegex")||(this._weekdaysMinRegex=Dt),this._weekdaysMinStrictRegex&&e?this._weekdaysMinStrictRegex:this._weekdaysMinRegex)},li.isPM=function(e){return"p"===(e+"").toLowerCase().charAt(0)},li.meridiem=function(e,t,i){return 11<e?i?"pm":"PM":i?"am":"AM"},oe("en",{dayOfMonthOrdinalParse:/\d{1,2}(th|st|nd|rd)/,ordinal:function(e){var t=e%10;return e+(1===v(e%100/10)?"th":1===t?"st":2===t?"nd":3===t?"rd":"th")}}),e.lang=S("moment.lang is deprecated. Use moment.locale instead.",oe),e.langData=S("moment.langData is deprecated. Use moment.localeData instead.",se);var di=Math.abs,ci=Ke("ms"),hi=Ke("s"),ui=Ke("m"),mi=Ke("h"),gi=Ke("d"),fi=Ke("w"),pi=Ke("M"),vi=Ke("Q"),yi=Ke("y"),wi=ze("milliseconds"),Si=ze("seconds"),bi=ze("minutes"),Ci=ze("hours"),Di=ze("days"),Ti=ze("months"),ki=ze("years"),xi=Math.round,Ai={ss:44,s:45,m:45,h:22,d:26,M:11},_i=Math.abs,Ii=we.prototype;return Ii.isValid=function(){return this._isValid},Ii.abs=function(){var e=this._data;return this._milliseconds=di(this._milliseconds),this._days=di(this._days),this._months=di(this._months),e.milliseconds=di(e.milliseconds),e.seconds=di(e.seconds),e.minutes=di(e.minutes),e.hours=di(e.hours),e.months=di(e.months),e.years=di(e.years),this},Ii.add=function(e,t){return Ue(this,e,t,1)},Ii.subtract=function(e,t){return Ue(this,e,t,-1)},Ii.as=function(e){if(!this.isValid())return NaN;var t,i,n=this._milliseconds;if("month"===(e=x(e))||"quarter"===e||"year"===e)switch(t=this._days+n/864e5,i=this._months+qe(t),e){case"month":return i;case"quarter":return i/3;case"year":return i/12}else switch(t=this._days+Math.round(Je(this._months)),e){case"week":return t/7+n/6048e5;case"day":return t+n/864e5;case"hour":return 24*t+n/36e5;case"minute":return 1440*t+n/6e4;case"second":return 86400*t+n/1e3;case"millisecond":return Math.floor(864e5*t)+n;default:throw new Error("Unknown unit "+e)}},Ii.asMilliseconds=ci,Ii.asSeconds=hi,Ii.asMinutes=ui,Ii.asHours=mi,Ii.asDays=gi,Ii.asWeeks=fi,Ii.asMonths=pi,Ii.asQuarters=vi,Ii.asYears=yi,Ii.valueOf=function(){return this.isValid()?this._milliseconds+864e5*this._days+this._months%12*2592e6+31536e6*v(this._months/12):NaN},Ii._bubble=function(){var e,t,i,n,a,o=this._milliseconds,r=this._days,s=this._months,l=this._data;return 0<=o&&0<=r&&0<=s||o<=0&&r<=0&&s<=0||(o+=864e5*je(Je(s)+r),s=r=0),l.milliseconds=o%1e3,e=p(o/1e3),l.seconds=e%60,t=p(e/60),l.minutes=t%60,i=p(t/60),l.hours=i%24,s+=a=p(qe(r+=p(i/24))),r-=je(Je(a)),n=p(s/12),s%=12,l.days=r,l.months=s,l.years=n,this},Ii.clone=function(){return Ae(this)},Ii.get=function(e){return e=x(e),this.isValid()?this[e+"s"]():NaN},Ii.milliseconds=wi,Ii.seconds=Si,Ii.minutes=bi,Ii.hours=Ci,Ii.days=Di,Ii.weeks=function(){return p(this.days()/7)},Ii.months=Ti,Ii.years=ki,Ii.humanize=function(e){if(!this.isValid())return this.localeData().invalidDate();var t,i,n,a,o,r,s,l,d,c,h,u=this.localeData(),m=(i=!e,n=u,a=Ae(t=this).abs(),o=xi(a.as("s")),r=xi(a.as("m")),s=xi(a.as("h")),l=xi(a.as("d")),d=xi(a.as("M")),c=xi(a.as("y")),(h=o<=Ai.ss&&["s",o]||o<Ai.s&&["ss",o]||r<=1&&["m"]||r<Ai.m&&["mm",r]||s<=1&&["h"]||s<Ai.h&&["hh",s]||l<=1&&["d"]||l<Ai.d&&["dd",l]||d<=1&&["M"]||d<Ai.M&&["MM",d]||c<=1&&["y"]||["yy",c])[2]=i,h[3]=0<+t,h[4]=n,function(e,t,i,n,a){return a.relativeTime(t||1,!!i,e,n)}.apply(null,h));return e&&(m=u.pastFuture(+this,m)),u.postformat(m)},Ii.toISOString=Ze,Ii.toString=Ze,Ii.toJSON=Ze,Ii.locale=Fe,Ii.localeData=Me,Ii.toIsoString=S("toIsoString() is deprecated. Please use toISOString() instead (notice the capitals)",Ze),Ii.lang=ei,P("X",0,0,"unix"),P("x",0,0,"valueOf"),F("x",bt),F("X",/[+-]?\d+(\.\d{1,3})?/),O("X",function(e,t,i){i._d=new Date(1e3*parseFloat(e,10))}),O("x",function(e,t,i){i._d=new Date(v(e))}),e.version="2.24.0",Qe=ve,e.fn=si,e.min=function(){return ye("isBefore",[].slice.call(arguments,0))},e.max=function(){return ye("isAfter",[].slice.call(arguments,0))},e.now=function(){return Date.now?Date.now():+new Date},e.utc=d,e.unix=function(e){return ve(1e3*e)},e.months=function(e,t){return $e(e,t,"months")},e.isDate=o,e.locale=oe,e.invalid=u,e.duration=Ae,e.isMoment=f,e.weekdays=function(e,t,i){return He(e,t,i,"weekdays")},e.parseZone=function(){return ve.apply(null,arguments).parseZone()},e.localeData=se,e.isDuration=Se,e.monthsShort=function(e,t){return $e(e,t,"monthsShort")},e.weekdaysMin=function(e,t,i){return He(e,t,i,"weekdaysMin")},e.defineLocale=re,e.updateLocale=function(e,t){if(null!=t){var i,n,a=Ot;null!=(n=ae(e))&&(a=n._config),(i=new T(t=D(a,t))).parentLocale=Et[e],Et[e]=i,oe(e)}else null!=Et[e]&&(null!=Et[e].parentLocale?Et[e]=Et[e].parentLocale:null!=Et[e]&&delete Et[e]);return Et[e]},e.locales=function(){return tt(Et)},e.weekdaysShort=function(e,t,i){return He(e,t,i,"weekdaysShort")},e.normalizeUnits=x,e.relativeTimeRounding=function(e){return void 0===e?xi:"function"==typeof e&&(xi=e,!0)},e.relativeTimeThreshold=function(e,t){return void 0!==Ai[e]&&(void 0===t?Ai[e]:(Ai[e]=t,"s"===e&&(Ai.ss=t-1),!0))},e.calendarFormat=function(e,t){var i=e.diff(t,"days",!0);return i<-6?"sameElse":i<-1?"lastWeek":i<0?"lastDay":i<1?"sameDay":i<2?"nextDay":i<7?"nextWeek":"sameElse"},e.prototype=si,e.HTML5_FMT={DATETIME_LOCAL:"YYYY-MM-DDTHH:mm",DATETIME_LOCAL_SECONDS:"YYYY-MM-DDTHH:mm:ss",DATETIME_LOCAL_MS:"YYYY-MM-DDTHH:mm:ss.SSS",DATE:"YYYY-MM-DD",TIME:"HH:mm",TIME_SECONDS:"HH:mm:ss",TIME_MS:"HH:mm:ss.SSS",WEEK:"GGGG-[W]WW",MONTH:"YYYY-MM"},e});